var csComp;!function(e){var t;!function(t){var r=function(){function e(){}return e}();t.Widget=r;var i=function(){function e(){this.shadow=!0}return e}();t.WidgetStyle=i;var a=function(){function t(e,t){this.enabled=!0,this.opacity=1,this.background="white",this.position="dashboard",this.renderer=function(e,t){},this.resize=function(e,t,r){},e&&(this.title=e),this.properties={},this.dataSets=[]}return t.serializeableData=function(e){var r={id:e.id,directive:e.directive,template:e.template,title:e.title,name:e.name,timeDependent:e.timeDependent,url:e.url,enabled:e.enabled,customStyle:e.customStyle,style:e.style,left:e.left,right:e.right,top:e.top,bottom:e.bottom,padding:e.padding,position:e.position,icon:e.icon,width:e.width,height:e.height,allowFullscreen:e.allowFullscreen,properties:e.properties,hover:e.hover,range:e.range,collapse:e.collapse,canCollapse:e.canCollapse,data:t.cloneWithout0(e.data)};return r},t.cloneWithout0=function(e){var t=this;if("object"!=typeof e)return e;if(e instanceof Array){var r=[];return e.forEach(function(e){r.push(t.cloneWithout0(e))}),r}var i={};for(var a in e)"_"!==a[0]&&(i[a]=this.cloneWithout0(e[a]));return i},t.prototype.start=function(){},t.prototype.init=function(){this.background="red",this.id||(this.id="widget"+e.Helpers.getGuid().replace("-","")),this.elementId=this.id,this.start()},t.prototype.updateDateRange=function(e){this.range=e},t}();t.BaseWidget=a;var o=function(){function r(){this.mapWidth="100%",this.alignMapRight=!1,this.mobile=!0,this.showTimeline=!0,this.draggable=!0,this.resizable=!0,this.showLeftmenu=!0,this.showRightmenu=!1,this.showLegend=!1,this.showBackgroundImage=!1,this.hideleftPanelToggle=!1,this.showDateSelector=!0,this.widgets=[]}return r.serializeableData=function(t){return{id:t.id,name:t.name,editMode:t.editMode,showMap:t.showMap,mapWidth:t.mapWidth,description:t.description,alignMapRight:t.alignMapRight,timeline:t.timeline,showTimeline:t.showTimeline,hideleftPanelToggle:t.hideleftPanelToggle,showDateselector:t.showDateSelector,showLeftmenu:t.showLeftmenu,showLegend:t.showLegend,showRightmenu:t.showRightmenu,showBackgroundImage:t.showBackgroundImage,background:t.background,backgroundimage:t.backgroundimage,visiblelayers:t.visiblelayers,baselayer:t.baselayer,viewBounds:t.viewBounds,widgets:e.Helpers.serialize(t.widgets,a.serializeableData),visibleLeftMenuItems:t.visibleLeftMenuItems,mobile:t.mobile,isLive:t.isLive}},r.deserialize=function(e,i){var a=this,o=$.extend(new r,e);return o.widgets=[],"undefined"==typeof e.isLive&&(e.isLive=!1),e.widgets&&e.widgets.forEach(function(e){a.addNewWidget(e,o,i)}),e.timeline&&(o.timeline=$.extend(new t.DateRange,e.timeline)),o},r.addNewWidget=function(t,r,i){return t.id||(t.id=e.Helpers.getGuid()),t.elementId="widget-"+t.id,t.parentDashboard=r,t.style&&"custom"!==t.style?(i.hasOwnProperty("widgetStyles")&&i.widgetStyles.hasOwnProperty(t.style)||(t.style="default"),t.effectiveStyle=i.widgetStyles[t.style]):t.effectiveStyle=t.customStyle,r.widgets.push(t),t},r}();t.Dashboard=o;var s=function(){function e(){}return e}();t.Timeline=s;var n=function(){function e(){}return e}();t.TimedDataSet=n;var c=function(){function e(e,t){this.id=e,this.title=t,this.data=[]}return e}();t.DataSet=c}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(){this.max=100,this.min=0}return t.prototype.activeValueText=function(){return e.Helpers.convertPropertyInfo(this.propertyType,this.activeValue)},t.prototype.addValue=function(e,t){this.timestamps.push(e),this.values.push(t),this.activeValue=t},t.prototype.serialize=function(){return JSON.stringify(t.serializeableData(this),function(e,t){return t},2)},t.serializeableData=function(e){return{id:e.id,title:e.title,type:e.type,propertyTypeKey:e.propertyTypeKey}},t}();t.SensorSet=r;var i=function(){function e(){this.sensors={}}return e.merge_sensor=function(e,t){var i=new r;for(var a in e)i[a]=e[a];for(var a in t)i[a]=t[a];return i},e.serializeableData=function(e){var t={id:e.id,url:e.url,type:e.type,title:e.title,sensors:{}};return t},e.LoadData=function(e,t,r){var i=this;null!=t.url&&e.get(t.url).success(function(e){if(null!=e){if(t.id=e.id,t.hasOwnProperty("sensors"))for(var a in e.sensors)e.sensors.hasOwnProperty(a)&&(t.sensors[a]=i.merge_sensor(t.sensors[a],e.sensors[a]));else t.sensors=e.sensors;t.title=e.title,r()}}).error(function(){console.log("Error on Data source -- do something ?")})},e}();t.DataSource=i}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){this.properties={}}return e}();e.Section=t;var r=function(){function e(){}return e}();e.Log=r;var i=function(){function e(){this.type="Feature",this._gui={included:!0,insideBBOX:!0},this.logs={}}return e.serialize=function(e){var t={};return t.id=e.id,t.layerId=e.layerId,t.type=e.type,t.geometry=e.geometry,t.properties=e.properties,t.logs=e.logs,e.timestamps&&(t.timestamps=e.timestamps),e.sensors&&(t.sensors=e.sensors),t},e}();e.Feature=i,function(e){e[e.None=0]="None",e[e.Image=1]="Image",e[e.Point=2]="Point",e[e.Square=3]="Square",e[e.Rectangle=4]="Rectangle",e[e.Line=5]="Line",e[e.Circle=6]="Circle",e[e.Freehand=7]="Freehand",e[e.Polyline=8]="Polyline",e[e.Polygon=9]="Polygon",e[e.MultiPolygon=10]="MultiPolygon"}(e.DrawingModeType||(e.DrawingModeType={}));e.DrawingModeType;!function(e){e[e.none=0]="none",e[e.bar=1]="bar",e[e.text=2]="text"}(e.featureFilterType||(e.featureFilterType={}));e.featureFilterType;!function(e){e[e.manual=0]="manual",e[e.automatic=1]="automatic"}(e.LayerActivationTypes||(e.LayerActivationTypes={}));e.LayerActivationTypes}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(e){var t=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(e.Feature);e.Feed=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){!function(e){e[e.GeoJson=0]="GeoJson",e[e.Kml=1]="Kml"}(t.LayerType||(t.LayerType={}));var r=(t.LayerType,function(){function r(){this._gui={}}return r.serializeableData=function(r){return{id:r.id,title:r.title,description:r.description,showTitle:r.showTitle,clustering:r.clustering,clusterLevel:r.clusterLevel,maxClusterRadius:r.maxClusterRadius,oneLayerActive:r.oneLayerActive,styleProperty:r.styleProperty,languages:r.languages,layers:e.Helpers.serialize(r.layers,t.ProjectLayer.serializeableData)}},r.deserialize=function(e){var t=$.extend(new r,e);return t.owsurl&&t.loadLayersFromOWS(),t.layers&&t.layers.forEach(function(e){e.opacity||(e.opacity=100)}),t},r.prototype.loadLayersFromOWS=function(e){var t=this;void 0===e&&(e=null),this.layers=[],null==e&&(e=angular.injector(["ng"])),e.invoke(function(e){e.get(t.owsurl).success(function(e){t.parseXML(e)}).error(function(e,r){console.log("Unable to load OWSurl: "+t.owsurl),console.log("          HTTP status: "+r)})})},r.prototype.parseXML=function(e){var t=this,r=this.owsurl.split("?")[0];$(e).find("Layer").each(function(){var e=$(this).children("Name").text();if(null!=e&&""!==e){var i=$(this).children("Title").text(),a=$(this).children("KeywordList").children('[vocabulary="defaultFeatureType"]').text(),o=$(this).children("KeywordList").children('[vocabulary="typeResourceURL"]').text(),s=t.buildLayer(r,i,e);""!=a&&(s.defaultFeatureType=a,s.typeUrl="data/resourceTypes/resources.json"),""!=o&&(s.typeUrl=o),t.layers.push(s)}})},r.prototype.buildLayer=function(r,i,a){var o={id:e.Helpers.getGuid(),reference:a,title:i,enabled:!1,group:this};this.owsgeojson?(o.type="geojson",o.url=r+"?service=wfs&request=getFeature&outputFormat=application/json&typeName="+a):(o.type="wms",o.wmsLayers=a,o.url=r);var s=jQuery.extend(new t.ProjectLayer,o);return s},r}());t.ProjectGroup=r;var i=function(){function e(){}return e}();t.GroupFilter=i;var a=function(){function e(e){var t=this;this.availableAspects=["strokeColor","fillColor","strokeWidth","height"],this.colorScales={},this.legends={},this.fixedColorRange=!1,e("WHITE_RED").then(function(e){t.colorScales[e]=["white","red"]}),e("GREEN_RED").then(function(e){t.colorScales[e]=["green","red"]}),e("RED_GREEN").then(function(e){t.colorScales[e]=["red","green"]}),e("BLUE_RED").then(function(e){t.colorScales[e]=["#F04030","#3040F0"]}),e("RED_BLUE").then(function(e){t.colorScales[e]=["#3040F0","#F04030"]}),e("WHITE_BLUE").then(function(e){t.colorScales[e]=["white","blue"]}),e("BLUE_WHITE").then(function(e){t.colorScales[e]=["blue","white"]}),e("WHITE_GREEN").then(function(e){t.colorScales[e]=["white","green"]}),e("GREEN_WHITE").then(function(e){t.colorScales[e]=["green","white"]}),e("WHITE_ORANGE").then(function(e){t.colorScales[e]=["white","#FF5500"]}),e("ORANGE_WHITE").then(function(e){t.colorScales[e]=["#FF5500","white"]}),e("RED_WHITE_BLUE").then(function(e){t.colorScales[e]=["red","white","blue"]})}return e}();t.GroupStyle=a;var o=function(){function e(){}return e}();t.Legend=o;var s=function(){function e(){}return e}();t.LegendEntry=s}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(){this.timeAware=!0,this._gui={},this.showFeatureNotifications=!0}return t.getFeatures=function(e){return e.data&&e.data.features?e.data.features:null},t.serializeableData=function(t){return{id:t.id,title:t.title,description:t.description,type:t.type,renderType:t.renderType,heatmapSettings:t.heatmapSettings,heatmapItems:e.Helpers.serialize(t.heatmapItems,Heatmap.HeatmapItem.serializeableData),url:t.url,typeUrl:t.typeUrl,sensors:t.sensors,sensorLink:t.sensorLink,wmsLayers:t.wmsLayers,opacity:t.opacity,isSublayer:t.isSublayer,BBOX:t.BBOX,refreshBBOX:t.refreshBBOX,refreshTimeInterval:t.refreshTimeInterval,quickRefresh:t.quickRefresh,languages:t.languages,events:t.events,dataSourceParameters:t.dataSourceParameters,defaultFeatureType:t.defaultFeatureType,defaultLegendProperty:t.defaultLegendProperty,defaultLegend:t.defaultLegend,useProxy:t.useProxy,isDynamic:t.isDynamic,isEditable:t.isEditable,useLog:t.useLog,tags:t.tags,hasSensorData:t.hasSensorData,timeAware:t.timeAware,fitToMap:t.fitToMap,minZoom:t.minZoom,maxZoom:t.maxZoom,localStorage:t.localStorage}},t}();t.ProjectLayer=r;var i=function(){function e(){this.maxNativeZoom=19}return e}();t.BaseLayer=i}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){e.availableZoomLevels=[{title:"decades",value:31536e7},{title:"years",value:31536e6},{title:"weeks",value:6048e5},{title:"days",value:864e5},{title:"hours",value:36e5},{title:"quarters",value:9e5},{title:"minutes",value:6e4},{title:"seconds",value:1e3},{title:"milliseconds",value:1}]}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){!function(e){e[e.Beginner=1]="Beginner",e[e.Intermediate=2]="Intermediate",e[e.Expert=3]="Expert",e[e.Admin=4]="Admin"}(t.Expertise||(t.Expertise={}));var r=t.Expertise,i=function(){function e(){this.leftPanelVisible=!1,this.rightPanelVisible=!1,this.dashboardVisible=!0,this.mapVisible=!0,this.mapWidth="100%",this.alignMapRight=!1,this.timelineVisible=!0}return e}();t.VisualState=i;var a=function(){function e(){var e=this;this.isExpanded=!1,this.enableLive=!0,this.enablePlay=!0,this.enableEvents=!0,this.enableFocus=!0,this.ismoveable=!0,this.startDate=function(){return e.focus<e.start&&(e.start=e.focus-e.range/5),new Date(e.start)},this.focusDate=function(){return new Date(e.focus)},this.endDate=function(){return e.focus>e.end&&(e.end=e.focus+e.range/5),new Date(e.end)}}return e.deserialize=function(t){var r=$.extend(new e,t);return"undefined"!=typeof r.focus&&null!==r.focus||(r.focus=Date.now()),"undefined"==typeof r.enableLive&&(r.enableLive=!0),"undefined"==typeof r.enablePlay&&(r.enablePlay=!0),"undefined"==typeof r.enableEvents&&(r.enableEvents=!0),"undefined"==typeof r.enableFocus&&(r.enableFocus=!0),"undefined"==typeof r.isExpanded&&(r.isExpanded=!1),"undefined"==typeof r.expandHeight&&(r.expandHeight=150),"undefined"==typeof r.updateDelay&&(r.updateDelay=500),r},e.prototype.setFocus=function(e,r,i){var a=this;this.focus=e.getTime(),r&&(this.start=r.getTime()),i&&(this.end=i.getTime());var o=this.end-this.start;this.range!==o&&(this.range=o,t.availableZoomLevels.some(function(e){return a.zoomLevel=e.value,a.zoomLevelName=e.title,e.value<a.range/10}))},e}();t.DateRange=a;var o=function(){function e(){this.widgetStyles={}}return e}();t.Solution=o;var s=function(){function e(){}return e}();t.SolutionProject=s,function(e){e[e.none=0]="none",e[e.local=1]="local",e[e.custom=2]="custom"}(t.authMethods||(t.authMethods={}));var n=t.authMethods,c=function(){function i(){this.expertMode=r.Expert,this.markers={},this.searchProviders=[]}return i.prototype.serialize=function(){return JSON.stringify(i.serializeableData(this),function(e,t){switch(e){case"timestamp":case"$$hashKey":case"div":return;default:return t}},2)},i.serializeFeatureType=function(e){return{name:e.name,style:e.style,propertyTypeKeys:e.propertyTypeKeys,showAllProperties:e.showAllProperties}},i.serializeableData=function(r){return{id:r.id,title:r.title,description:r.description,logo:r.logo,otpServer:r.otpServer,url:r.url,isDynamic:r.isDynamic,startPosition:r.startposition,timeLine:r.timeLine,opacity:r.opacity,mcas:r.mcas,profile:r.profile,datasources:e.Helpers.serialize(r.datasources,t.DataSource.serializeableData),dashboards:e.Helpers.serialize(r.dashboards,t.Dashboard.serializeableData),viewBounds:r.viewBounds,collapseAllLayers:r.collapseAllLayers,userPrivileges:r.userPrivileges,languages:r.languages,modeSelection:r.exportModeSelectionEnabled,expertMode:r.expertMode,baselayers:r.baselayers,featureTypes:r.featureTypes,propertyTypeData:r.propertyTypeData,groups:e.Helpers.serialize(r.groups,t.ProjectGroup.serializeableData,!0),layerDirectory:r.layerDirectory,eventTab:r.eventTab,searchProviders:r.searchProviders}},i.prototype.deserialize=function(e){var r=jQuery.extend(new i,e);r.solution=e.solution,"undefined"==typeof e.exportModeSelectionEnabled&&(r.exportModeSelectionEnabled=!0),"undefined"==typeof e.profile&&(r.profile={}),"undefined"==typeof r.profile.authenticationMethod&&(r.profile.authenticationMethod=n.local),e.opacity||(e.opacity=100),e.timeLine&&(r.timeLine=a.deserialize(e.timeLine)),e.dashboards&&(r.dashboards=[],e.dashboards.forEach(function(i){r.dashboards.push(t.Dashboard.deserialize(i,e.solution))})),r.mcas=[];for(var o in e.mcas){var s=new Mca.Models.Mca;r.mcas.push(s.deserialize(e.mcas[o]))}return r.propertyTypeData||(r.propertyTypeData={}),r.mcas||(r.mcas=[]),e.groups&&(r.groups=[],e.groups.forEach(function(e){r.groups.push(t.ProjectGroup.deserialize(e))})),"undefined"==typeof r.id&&(r.id=r.title),r},i}();t.Project=c}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function t(){}return t.serialize=function(t){var r={featureTypes:{},propertyTypeData:{},legends:{}};for(var i in t.featureTypes)r.featureTypes[i]=e.Project.serializeFeatureType(t.featureTypes[i]);for(var a in t.propertyTypeData)r.propertyTypeData[a]=t.propertyTypeData[a];for(var o in t.legends)r.legends[o]=t.legends[a];return JSON.stringify(r)},t}();e.TypeResource=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var ColorExt;!function(e){var t=function(){function e(){}return e.hsv2rgb=function(e,t,r){var i,a,o=[];if(0===t)i=[r,r,r];else switch(e/=60,a=Math.floor(e),o=[r*(1-t),r*(1-t*(e-a)),r*(1-t*(1-(e-a)))],a){case 0:i=[r,o[2],o[0]];break;case 1:i=[o[1],r,o[0]];break;case 2:i=[o[0],r,o[2]];break;case 3:i=[o[0],o[1],r];break;case 4:i=[o[2],o[0],r];break;default:i=[r,o[0],o[1]]}return"#"+i.map(function(e){return("0"+Math.round(255*e).toString(16)).slice(-2)}).join("")},e.toColor=function(t,r,i,a,o){var s=a+Math.floor(t/(i-r)*(o-a));return e.hsv2rgb(s,1,1)},e.rgbToHue=function(e){if(e){if("#"===e[0]&&(e=e.substr(1)),6!==e.length)return void console.log("Wrong rgb format: "+e);for(var t=parseInt(e.substring(0,2),16)/255,r=parseInt(e.substring(2,4),16)/255,i=parseInt(e.substring(4,6),16)/255,a=Math.atan2(Math.sqrt(3)*(r-i),2*(t-r-i));0>a;)a+=2*Math.PI;for(;a>=2*Math.PI;)a-=2*Math.PI;return a=180*a/Math.PI}},e.rgbToHex=function(e){return"#"+e.map(function(e){return("0"+e.toString(16)).slice(-2)}).join("")},e.colorNameToHex=function(e){var t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return"undefined"!=typeof t[e.toLowerCase()]&&t.hasOwnProperty(e.toLowerCase())?t[e.toLowerCase()]:"#000000"},e}();e.Utils=t}(ColorExt||(ColorExt={}));var csComp;!function(e){var t;!function(e){var t=1e-10,r=function(){function e(e){this.level=e,this.count=0,this.s=null}return e.prototype.addSegment=function(e,t){for(var r=this.s,i=null,a=null,o=!1,s=!1;r&&(null===i&&(this.pointsEqual(e,r.head.p)?(i=r,o=!0):this.pointsEqual(e,r.tail.p)&&(i=r)),null===a&&(this.pointsEqual(t,r.head.p)?(a=r,s=!0):this.pointsEqual(t,r.tail.p)&&(a=r)),null==a||null==i);)r=r.next;var n=(null!=i?1:0)|(null!=a?2:0);switch(n){case 0:var c={p:e,prev:null},l={p:t,next:null};c.next=l,l.prev=c,i={head:c,tail:l,next:this.s,prev:null,closed:!1},this.s&&(this.s.prev=i),this.s=i,++this.count;break;case 1:var p={p:t};o?(p.next=i.head,p.prev=null,i.head.prev=p,i.head=p):(p.next=null,p.prev=i.tail,i.tail.next=p,i.tail=p);break;case 2:var p={p:e};s?(p.next=a.head,p.prev=null,a.head.prev=p,a.head=p):(p.next=null,p.prev=a.tail,a.tail.next=p,a.tail=p);break;case 3:if(i===a){var p={p:i.tail.p,next:i.head,prev:null};i.head.prev=p,i.head=p,i.closed=!0;break}switch((o?1:0)|(s?2:0)){case 0:this.reverseList(i);case 1:a.tail.next=i.head,i.head.prev=a.tail,a.tail=i.tail,this.remove_seq(i);break;case 3:this.reverseList(i);case 2:i.tail.next=a.head,a.head.prev=i.tail,i.tail=a.tail,this.remove_seq(a)}}},e.prototype.remove_seq=function(e){e.prev?e.prev.next=e.next:this.s=e.next,e.next&&(e.next.prev=e.prev),--this.count},e.prototype.pointsEqual=function(e,r){var i=e.x-r.x,a=e.y-r.y;return t>i*i+a*a},e.prototype.reverseList=function(e){for(var t=e.head;t;){var r=t.next;t.next=t.prev,t.prev=r,t=r}var r=e.head;e.head=e.tail,e.tail=r},e}(),i=function(){function e(e){this.h=new Array(5),this.sh=new Array(5),this.xh=new Array(5),this.yh=new Array(5),e&&(this.drawContour=e)}return e.prototype.contour=function(e,r,i,a,o,s,n,c,l,p){var u=this.h,d=this.sh,h=this.xh,f=this.yh;this.drawContour;this.contours={};for(var y,m,g,v,S,b,$=function(e,t){return(u[t]*h[e]-u[e]*h[t])/(u[t]-u[e])},w=function(e,t){return(u[t]*f[e]-u[e]*f[t])/(u[t]-u[e])},T=0,L=0,E=0,C=0,M=[0,1,1,0],P=[0,0,1,1],_=[[[0,0,8],[0,2,5],[7,6,9]],[[0,3,4],[1,3,1],[4,3,0]],[[9,6,7],[5,2,0],[8,0,0]]],F=o-1;F>=a;F--)for(var x=r;i>x;x++){if(e[x][F]===p||e[x+1][F]===p||e[x][F+1]===p||e[x+1][F+1]===p)return;var O,A;if(O=Math.min(e[x][F],e[x][F+1]),A=Math.min(e[x+1][F],e[x+1][F+1]),S=Math.min(O,A),O=Math.max(e[x][F],e[x][F+1]),A=Math.max(e[x+1][F],e[x+1][F+1]),b=Math.max(O,A),!(b<l[0]&&S>l[c-1]))for(var I=0;c>I;I++)if(l[I]>=S&&l[I]<=b){for(var k=4;k>=0;k--)k>0?(u[k]=e[x+M[k-1]][F+P[k-1]]-l[I],h[k]=s[x+M[k-1]],f[k]=n[F+P[k-1]]):(u[0]=.25*(u[1]+u[2]+u[3]+u[4]),h[0]=.5*(s[x]+s[x+1]),f[0]=.5*(n[F]+n[F+1])),u[k]>t?d[k]=1:u[k]<-t?d[k]=-1:d[k]=0;for(k=1;4>=k;k++)if(y=k,m=0,g=4!=k?k+1:1,v=_[d[y]+1][d[m]+1][d[g]+1],0!=v){switch(v){case 1:T=h[y],E=f[y],L=h[m],C=f[m];break;case 2:T=h[m],E=f[m],L=h[g],C=f[g];break;case 3:T=h[g],E=f[g],L=h[y],C=f[y];break;case 4:T=h[y],E=f[y],L=$(m,g),C=w(m,g);break;case 5:T=h[m],E=f[m],L=$(g,y),C=w(g,y);break;case 6:T=h[g],E=f[g],L=$(y,m),C=w(y,m);break;case 7:T=$(y,m),E=w(y,m),L=$(m,g),C=w(m,g);break;case 8:T=$(m,g),E=w(m,g),L=$(g,y),C=w(g,y);break;case 9:T=$(g,y),E=w(g,y),L=$(y,m),C=w(y,m)}this.drawContour(T,E,L,C,l[I],I)}}}},e.prototype.drawContour=function(e,t,i,a,o,s){var n=this.contours[s];n||(n=this.contours[s]=new r(o)),n.addSegment({x:e,y:t},{x:i,y:a})},Object.defineProperty(e.prototype,"contourList",{get:function(){var e=[],t=this.contours;for(var r in t)for(var i=t[r].s,a=t[r].level;i;){var o=i.head,s=[];for(s.level=a,s.k=r;o&&o.p;)s.push(o.p),o=o.next;e.push(s),i=i.next}return e.sort(function(e,t){return e.k-t.k}),e},enumerable:!0,configurable:!0}),e}();e.Conrec=i}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={})),Date.prototype.getJulian=function(){return this/864e5+2440587.5},Date.prototype.getGMST=function(){var e=this.getJulian(),t=e-2451545;return(18.697374558+24.06570982441908*t)%24},Date.prototype.yyyymmdd=function(){var e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),r=this.getDate().toString();return e+(t[1]?t:"0"+t[0])+(r[1]?r:"0"+r[0])};var csComp;!function(e){var t;!function(e){var t=function(){function e(){this.theKeys=[],this.theValues=[]}return e.prototype.initialize=function(e){for(var t=0;t<e.length;t++)this[e[t].key]=e[t].value,this.theKeys.push(e[t].key),this.theValues.push(e[t].value)},e.prototype.add=function(e,t){this[e]=t,this.theKeys.push(e),this.theValues.push(t)},e.prototype.remove=function(e){var t=this.theKeys.indexOf(e,0);this.theKeys.splice(t,1),this.theValues.splice(t,1),delete this[e]},e.prototype.clear=function(){for(var e=this.theKeys.length;e>=0;e--){var t=this.theKeys[e];this.remove(t)}},e.prototype.count=function(){return this.theKeys.length},e.prototype.keys=function(){return this.theKeys},e.prototype.values=function(){return this.theValues},e.prototype.containsKey=function(e){return"undefined"!=typeof this[e]},e.prototype.toLookup=function(){return this},e}();e.Dictionary=t}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var esriJsonConverter;!function(e){var t=function(){function e(){this.esriCon={},this.gCon={}}return e.prototype.ringIsClockwise=function(e){var t,r=0,i=0,a=e.length,o=e[i];for(i;a-1>i;i++)t=e[i+1],r+=(t[0]-o[0])*(t[1]+o[1]),o=t;return r>=0},e.prototype.esriGeometryToGcGeometry=function(e){var t,r,i,a,o,s,n;if(e){if((e.x&&"NaN"!==e.x||0===e.x)&&(e.y&&"NaN"!==e.y||0===e.y))a="Point",i=[e.x,e.y];else if(e.points&&e.points.length)a="MultiPoint",i=e.points;else if(e.paths&&e.paths.length)o=e.paths,1===o.length?(a="LineString",i=o[0]):(a="MultiLineString",i=o);else if(e.rings&&e.rings.length){for(s=[],o=e.rings,r=0;r<o.length;r++)n=o[r],this.ringIsClockwise(n)?s.push([n]):s.length>0&&s[s.length-1].push(n);s.length>1?(i=s,a="MultiPolygon"):(i=s.pop(),a="Polygon")}return t=i&&a?{type:a,coordinates:i}:null}return t},e.prototype.esriFeatureToGcFeature=function(e){var t,r,i,a=null;if(e&&(a={type:"Feature"},e.geometry&&(a.geometry=this.esriGeometryToGcGeometry(e.geometry)),e.attributes)){r={},i=e.attributes;for(t in e.attributes)r[t]=e.attributes[t];a.properties=r}return a},e.prototype.toGeoJson=function(e){var t,r,i,a;if(e)if(e.features)for(t={type:"FeatureCollection",features:[]},i=e.features,r=0;r<i.length;r++)a=this.esriFeatureToGcFeature(i[r]),a&&t.features.push(a);else t=e.geometry?this.esriFeatureToGcFeature(e):this.esriGeometryToGcGeometry(e);return t},e.prototype.isCompatible=function(e,t){var r=!1;return("esriGeometryPoint"!==e&&"esriGeometryMultipoint"!==e||"Point"!==t&&"MultiPoint"!==t)&&("esriGeometryPolyline"!==e||"LineString"!==t&&"MultiLineString"!==t)?"esriGeometryPolygon"!==e||"Polygon"!==t&&"MultiPolygon"!==t||(r=!0):r=!0,r},e.prototype.gcGeomTypeToEsriGeomInfo=function(e){var t,r;return"Point"===e?t="esriGeometryPoint":"MultiPoint"===e?(t="esriGeometryMultipoint",r="points"):"LineString"===e||"MultiLineString"===e?(t="esriGeometryPolyline",r="paths"):"Polygon"!==e&&"MultiPolygon"!==e||(t="esriGeometryPolygon",r="rings"),{type:t,geomHolder:r}},e.prototype.gcPolygonCoordinatesToEsriPolygonCoordinates=function(e){var t,r,i,a=[];for(t=0,r=e.length;r>t;t++)i=e[t],0==t!=this.ringIsClockwise(i)&&(i=i.reverse()),a.push(i);return a},e.prototype.gcCoordinatesToEsriCoordinates=function(e){var t,r,i;if("MultiPoint"===e.type||"MultiLineString"===e.type)i=e.coordinates;else if("Point"===e.type||"LineString"===e.type)i=[e.coordinates];else if("Polygon"===e.type)i=this.gcPolygonCoordinatesToEsriPolygonCoordinates(e.coordinates);else if("MultiPolygon"===e.type)for(i=[],t=0,r=e.coordinates.length;r>t;t++)i.push(this.gcPolygonCoordinatesToEsriPolygonCoordinates(e.coordinates[t])[0]);return i},e.prototype.gcGeometryToEsriGeometry=function(e){var t,r,i,a,o,s;if("GeometryCollection"===e.type)for(i=[e.geometries.shift()],r=this.gcGeomTypeToEsriGeomInfo(i[0].type),a=0;a<e.geometries.length;a++)this.isCompatible(r.type,e.geometries[a].type)&&i.push(e.geometries[a]);else r=this.gcGeomTypeToEsriGeomInfo(e.type),i=[e];if("esriGeometryPoint"===r.type&&i.length>1&&(r=this.gcGeomTypeToEsriGeomInfo("MultiPoint")),t={spatialReference:{wkid:4326}},"esriGeometryPoint"===r.type)0===i[0].coordinates.length?(t.x=null,t.y=null):(t.x=i[0].coordinates[0],t.y=i[0].coordinates[1]);else for(t[r.geomHolder]=[],a=0;a<i.length;a++)for(s=this.gcCoordinatesToEsriCoordinates(i[a]),o=0;o<s.length;o++)t[r.geomHolder].push(s[o]);return t},e.prototype.gcFeatureToEsriFeature=function(e){var t,r,i;if(e&&(t={},e.geometry&&(t.geometry=this.gcGeometryToEsriGeometry(e.geometry)),e.properties)){i={};for(r in e.properties)i[r]=e.properties[r];t.attributes=i}return t},e.prototype.toEsri=function(e){var t,r,i,a;if(e)if("FeatureCollection"===e.type)for(t={features:[]},i=e.features,r=0;r<i.length;r++)a=this.gcFeatureToEsriFeature(i[r]),a&&t.features.push(a);else t="Feature"===e.type?this.gcFeatureToEsriFeature(e):this.gcGeometryToEsriGeometry(e);return t},e}();e.esriJsonConverter=t}(esriJsonConverter||(esriJsonConverter={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.getFeatureBounds=function(e){try{if(!e||!e.geometry)return[new L.LatLng(360,180)];var t=e.geometry.type||"Point";if(!e.geometry||!e.geometry.coordinates||e.geometry.coordinates.length<2&&"point"===e.geometry.type.toLowerCase())return null;switch(t){case"Point":return[new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0])];default:var r=d3.geo.bounds(e);return r&&r.length>1?new L.LatLngBounds([r[0][1],r[0][0]],[r[1][1],r[1][0]]):null}}catch(i){return null}},e.getBoundingBox=function(e){var t={};e=e.features;for(var r=0;r<e.length;r++)if(e[r].hasOwnProperty("geometry")){var i=d3.geo.bounds(e[r]);t.xMin=t.xMin<i[0][0]?t.xMin:i[0][0],t.xMax=t.xMax>i[1][0]?t.xMax:i[1][0],t.yMin=t.yMin<i[0][1]?t.yMin:i[0][1],t.yMax=t.yMax>i[1][1]?t.yMax:i[1][1]}return t.southWest=[t.yMin,t.xMin],t.northEast=[t.yMax,t.xMax],t},e.convertTopoToGeoJson=function(e){var t="string"==typeof e?JSON.parse(e):e,r={};r.featureTypes=e.featureTypes,r.features=[];for(var i in t.objects){var a=topojson.feature(t,t.objects[i]);a.features?a.features.forEach(function(e){return r.features.push(e)}):r.features.push(a)}return r},e.deg2rad=function(t){return t*e.Rad2Deg},e.rad2deg=function(t){return t/e.Rad2Deg},e.getCentroid=function(e){if(!e||0===e.length)return{type:"Point",coordinates:[0,0]};if(e[0]instanceof Array&&e[0][0]instanceof Array)if(e[0][0][0]instanceof Array){var t=[];e.forEach(function(e){t=t.concat(e[0])}),e=t}else e=e[0];var r=e.reduce(function(t,r){return[t[0]+r[0]/e.length,t[1]+r[1]/e.length]},[0,0]);return{type:"Point",coordinates:r}},e.getNorthmostCoordinate=function(e){if(!e||0===e.length)return{type:"Point",coordinates:[0,0]};if(e[0]instanceof Array&&e[0][0]instanceof Array)if(e[0][0][0]instanceof Array){var t=[];e.forEach(function(e){t=t.concat(e[0])}),e=t}else e=e[0];var r=e.reduce(function(e,t){return e[1]>t[1]?[e[0],e[1]]:[t[0],t[1]]},[0,0]);return{type:"Point",coordinates:r}},e.getEastmostCoordinate=function(e){if(!e||0===e.length)return{type:"Point",coordinates:[0,0]};if(e[0]instanceof Array&&e[0][0]instanceof Array)if(e[0][0][0]instanceof Array){var t=[];e.forEach(function(e){t=t.concat(e[0])}),e=t}else e=e[0];var r=e.reduce(function(e,t){return e[0]>t[0]?[e[0],e[1]]:[t[0],t[1]]},[0,0]);return{type:"Point",coordinates:r}},e.convertRDFeaturesToWGS84=function(t){!t||t.length<=0||t.forEach(function(t){switch(t.geometry.type.toLowerCase()){case"point":e.convertGeoJsonRDToWGS84(t.geometry.coordinates);break;case"linestring":case"polygon":t.geometry.coordinates.forEach(function(t){t.forEach(function(t){e.convertGeoJsonRDToWGS84(t)})});break;case"multipolygon":t.geometry.coordinates.forEach(function(t){t.forEach(function(t){t.forEach(function(t){e.convertGeoJsonRDToWGS84(t)})})})}})},e.convertGeoJsonRDToWGS84=function(t){var r=e.convertRDToWGS84(t[0],t[1]);t[0]=r.longitude,t[1]=r.latitude},e.convertRDToWGS84=function(e,t){var r=155e3,i=463e3,a=52.156160556,o=5.387638889,s=3236.0331637,n=5261.3028966,c=-32.5915821,l=105.9780241,p=-.2472814,u=2.4576469,d=-.8501341,h=-.8192156,f=-.0655238,y=-.0560092,m=-.0171137,g=.0560089,v=.0052771,S=-.0025614,b=-3859e-7,$=.001277,w=3314e-7,T=2574e-7,L=371e-7,E=-973e-7,C=143e-7,M=293e-7,P=-9e-6,_=291e-7,F=(e-r)*Math.pow(10,-5),x=(t-i)*Math.pow(10,-5),O=s*x+c*Math.pow(F,2)+p*Math.pow(x,2)+d*Math.pow(F,2)*x+f*Math.pow(x,3);O+=v*Math.pow(F,4)+m*Math.pow(F,2)*Math.pow(x,2)+L*Math.pow(x,4)+w*Math.pow(F,4)*x,O+=b*Math.pow(F,2)*Math.pow(x,3)+C*Math.pow(F,4)*Math.pow(x,2)+P*Math.pow(F,2)*Math.pow(x,4);var A=a+O/3600,I=n*F+l*F*x+h*Math.pow(F,3)+u*F*Math.pow(x,2)+y*Math.pow(F,3)*x;
I+=g*F*Math.pow(x,3)+T*Math.pow(F,5)+S*Math.pow(F,3)*Math.pow(x,2)+$*F*Math.pow(x,4),I+=M*Math.pow(F,5)*x+E*Math.pow(F,3)*Math.pow(x,3)+_*F*Math.pow(x,5);var k=o+I/3600,D=A+(-96.862-11.714*(A-52)-.125*(k-5))/1e5,R=k+(-37.902+.329*(A-52)-14.667*(k-5))/1e5;return{latitude:D,longitude:R}},e.log10=function(e){return Math.LOG10E*Math.log(e)},e.convertDegreesToMeters=function(t){var r=e.deg2rad(t),i=111132.92,a=-559.82,o=1.175,s=-.0023,n=111412.84,c=-93.5,l=.118,p=i+a*Math.cos(2*r)+o*Math.cos(4*r)+s*Math.cos(6*r),u=n*Math.cos(r)+c*Math.cos(3*r)+l*Math.cos(5*r);return{latitudeLength:p,longitudeLength:u}},e.createPolygonFeature=function(e,t){if(null===e)throw new Error("No coordinates passed");for(var r=0;r<e.length;r++)for(var i=e[r],a=0;a<i[i.length-1].length;a++)i.length<4&&new Error("Each LinearRing of a Polygon must have 4 or more Positions."),i[i.length-1][a]!==i[0][a]&&new Error("First and last Position are not equivalent.");var o={type:"Feature",geometry:{type:"Polygon",coordinates:e},properties:t};return o.properties||(o.properties={}),o},e.createFeatureCollection=function(e){return{type:"FeatureCollection",features:e}},e.createPointFeature=function(e,t,r,i){var a={type:"Feature",geometry:{type:"Point",coordinates:[e,t]},properties:r};return i&&i!=={}&&(a.sensors=i),a},e.createLineFeature=function(e,t){if(null===e)throw new Error("No coordinates passed");for(var r=0;r<e.length;r++){var i=e[r];i.length<2&&new Error("Each LineString of a Polygon must have 2 or more Positions.")}var a={type:"Feature",geometry:{type:"LineString",coordinates:e},properties:t};return a.properties||(a.properties={}),a},e.createPropertyType=function(e,t){if(e){var r={label:e,title:e,type:"text",visibleInCallOut:!0,canEdit:!0,isSearchable:!1};return t&&(r.section=t),r}},e.convertMileToKm=function(e){return e&&!isNaN(e)?1.609344*e:void 0},e.convertKmToMile=function(e){return e&&!isNaN(e)?.621371192*e:void 0},e.featureInsideBoundingBox=function(e,t){return"LineString"===e.geometry.type?this.pointInsidePolygon(e.geometry.coordinates[0],[t]):void 0},e.pointInsidePolygon=function(e,t){for(var r=e[0],i=e[1],a=t[0],o=!1,s=0,n=a.length-1;s<a.length;n=s++){var c=a[s][0],l=a[s][1],p=a[n][0],u=a[n][1],d=l>i!=u>i&&(p-c)*(i-l)/(u-l)+c>r;d&&(o=!o)}return o},e.pointInsideMultiPolygon=function(t,r){for(var i=!1,a=0;a<r.length;a++){var o=r[a];e.pointInsidePolygon(t,o)&&(i=!i)}return i},e.toBoundingBox=function(e){var t=[];return e.split(",").forEach(function(e){t.push(+e)}),new L.LatLngBounds([t[1],t[0]],[t[3],t[2]])},e.lon2tile=function(e,t){return Math.floor((e+180)/360*Math.pow(2,t))},e.lat2tile=function(t,r){return Math.floor((1-Math.log(Math.tan(t*e.Rad2Deg)+1/Math.cos(t*e.Rad2Deg))/Math.PI)/2*Math.pow(2,r))},e.slippyMapTiles=function(t,r){var i;i="string"==typeof r?e.toBoundingBox(r):r;var a=i.getNorth(),o=i.getSouth(),s=i.getWest(),n=i.getEast(),c=e.lat2tile(a,t),l=e.lon2tile(s,t),p=e.lat2tile(o,t),u=e.lon2tile(n,t),d=Math.abs(l-u)+1,h=Math.abs(c-p)+1;return{top:c,bottom:p,left:l,right:u,width:d,height:h}},e.Rad2Deg=Math.PI/180,e}();e.GeoExtensions=t}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){function r(e,t,i){if(void 0===i&&(i=!1),e&&e.hasOwnProperty("languages")&&e.languages.hasOwnProperty(t))for(var a in e.languages[t])e[a]=e.languages[t][a];if(i)for(var o in e)_.isObject(e[o])&&(e[o]=r(e[o],t,i));return e}function i(e,t,r){if(void 0===r&&(r=!1),"undefined"==typeof e||null===e||0===e.length)return null;var i=[];return e.forEach(function(e){r&&(e.hasOwnProperty("title")&&"_"===e.title[0]||e.hasOwnProperty("id")&&"_"===e.id[0])||i.push(t(e))}),i}function a(e){var t=this;if("object"!=typeof e)return e;if(e instanceof Array){var r=[];return e.forEach(function(e){r.push(t.cloneWithoutUnderscore(e))}),r}var i={};for(var a in e)"_"!==a[0]&&(i[a]=this.cloneWithoutUnderscore(e[a]));return i}function o(e){return e.indexOf("#")>=0?e.split("#")[1]:e}function s(e){if(e&&e.geometry&&e.geometry.type&&"point"===e.geometry.type.toLowerCase()||e.fType&&e.fType.style&&e.fType.style.drawingMode&&"point"===e.fType.style.drawingMode.toLowerCase()){var t={nameLabel:"Name",drawingMode:"Point",strokeWidth:1,strokeColor:"#0033ff",fillOpacity:1,strokeOpacity:0,opacity:1,fillColor:"#000000",stroke:!0,rotate:0,cornerRadius:50,iconHeight:32,iconWidth:32};return t}var r={nameLabel:"Name",drawingMode:"Polygon",strokeWidth:1,strokeColor:"#0033ff",fillOpacity:.75,strokeOpacity:1,opacity:.75,fillColor:"#FFFF00",stroke:!0,iconUri:"bower_components/csweb/dist-bower/images/marker.png"};return r}function n(t,r,i){if(i=i.replace(".",""),r=r.replace("."+i,"")+"."+i,navigator.msSaveBlob){var a=document.createElement("a");a.addEventListener("click",function(e){var a=new Blob([t],{type:"text/"+i+";charset=utf-8;"});navigator.msSaveBlob(a,r)},!1),document.body.appendChild(a),a.click(),document.body.removeChild(a)}else if(e.Helpers.supportsDataUri()){var o=document.createElement("a");document.body.appendChild(o),o.href="data:    text/"+i+";charset=utf-8,"+encodeURI(t),o.target="_blank",o.download=r,o.click(),document.body.removeChild(o)}else{var s=window.open("",i,"");s.document.body.innerHTML="<pre>"+t+"</pre>"}}function c(t,r,i){if(i=i.replace(".",""),r=r.replace("."+i,"")+"."+i,navigator.msSaveBlob){var a=document.createElement("a");a.addEventListener("click",function(e){for(var a=atob(t.split(",").pop()),o=[],s=512,n=0;n<a.length;n+=s){for(var c=a.slice(n,n+s),l=new Array(c.length),p=0;p<c.length;p++)l[p]=c.charCodeAt(p);var u=new Uint8Array(l);o.push(u)}var d=new Blob(o,{type:"image/"+i+";"});navigator.msSaveBlob(d,r)},!1),document.body.appendChild(a),a.click(),document.body.removeChild(a)}else if(e.Helpers.supportsDataUri()){var o=document.createElement("a");document.body.appendChild(o),o.href=encodeURI(t),o.target="_blank",o.download=r,o.click(),document.body.removeChild(o)}else{var s=window.open("",i,"");s.document.body.innerHTML="<pre>"+t+"</pre>"}}function l(e){return String.fromCharCode(e.charCodeAt(0)+1)}function p(){var e="Microsoft Internet Explorer"===navigator.appName,t=!!navigator.userAgent.match(/Trident\/7\./);return!(e||t)}function u(e){var t=d(e),r=e.map(function(e){var r=e-t,i=r*r;return i}),i=d(r),a=Math.sqrt(i);return{avg:t,stdDev:a}}function d(e){var t=e.reduce(function(e,t){return e+t},0),r=t/e.length;return r}function h(e){return f(e.fType,e)}function f(t,r){var i="";return r.hasOwnProperty("properties")?r.properties.hasOwnProperty("Name")?i=r.properties.Name:r.properties.hasOwnProperty("name")?i=r.properties.name:r.properties.hasOwnProperty("naam")&&(i=r.properties.naam):null!=t&&null!=t.style&&t.style.nameLabel&&(i=r.properties[t.style.nameLabel]),e.StringExt.isNullOrEmpty(i)||$.isNumeric(i)||(i=i.replace(/&amp;/g,"&")),""+i}function y(e,t,r){var i=[];if(e.propertyTypeKeys&&e.propertyTypeKeys.length>0&&"string"==typeof e.propertyTypeKeys){var a=e.propertyTypeKeys.split(/[,;]+/);a.forEach(function(r){if(t&&t.hasOwnProperty(r))i.push(t[r]);else if(null!=e._propertyTypeData){var a=$.grep(e._propertyTypeData,function(e){return e.label===r});a.length>=1&&i.push(a)}})}if(null!=e._propertyTypeData)if(e._propertyTypeData.forEach)e._propertyTypeData.forEach(function(e){i.push(e)});else for(var o in e._propertyTypeData)e._propertyTypeData.hasOwnProperty(o)&&i.push(e._propertyTypeData[o]);return i}function m(e,t){for(var r=e.split(";"),i=t,a=1;r.indexOf(i)>=0;)i=t+a,a++;return i}function g(t,r){var i={};i.label=r,i.title=r.replace("_"," "),i.isSearchable=!0,i.visibleInCallOut=!0,i.canEdit=!1;var a=t.properties[r];return e.StringExt.isDate(a)?i.type="date":e.StringExt.isNumber(a)?i.type="number":e.StringExt.isBoolean(a)?i.type="boolean":e.StringExt.isArray(a)?i.type="tags":e.StringExt.isBbcode(a)?i.type="bbcode":i.type="text",i}function v(e){var t=[];for(var r in e.properties)e.properties.hasOwnProperty(r)&&t.push(g(e,r));return t}function S(e,t){for(var r=t;e.hasOwnProperty(r);)t+=r,r+=1;return r}function b(t,r,i){var a=this,o=r;if(o._propertyTypeData&&o._propertyTypeData.length>0)o._propertyTypeData.forEach(function(e){a.updateSection(t.layer,e)});else for(var s in t.properties){var n;if(i&&(n=_.find(_.values(i.propertyTypeData),function(e){return e.label===s})),!n){n={},n.label=s,n.title=s.replace("_"," ");var c=t.properties[s];if(e.StringExt.isNumber(c)?n.type="number":e.StringExt.isBoolean(c)?n.type="boolean":e.StringExt.isBbcode(c)&&(n.type="bbcode"),i&&i.propertyTypeData){var l=S(i.propertyTypeData,s);l===s&&delete n.label,i.propertyTypeData[l]=n,i.propertyTypeData[l]=n}else r._propertyTypeData||(r._propertyTypeData=[]),r._propertyTypeData[s]=n;w(t.layer,n)}}return o}function w(t,r){if(t&&r&&("number"===r.type||r.hasOwnProperty("legend"))){t._gui.hasOwnProperty("sections")||(t._gui.sections={});var i=t._gui.sections,a=r.section?r.section:"general";i.hasOwnProperty(a)||(i[a]=new e.Services.Section),i[a].properties.hasOwnProperty(r.label)||(i[a].properties[r.label]=r)}}function T(e,t){var r={};return r.style=s(e),this.addPropertyTypes(e,r,t),r}function L(e,t){var r;if(void 0===t||null===t||!e.type)return t;switch(e.type){case"bbcode":e.stringFormat&&(t=String.format(e.stringFormat,t)),r=XBBCODE.process({text:t}).html;break;case"number":r=$.isNumeric(t)?isNaN(t)?"":e.stringFormat?String.format(e.stringFormat,parseFloat(t)):t.toString():t;break;case"options":r=$.isNumeric(t)?e.options[t]:t;break;case"rank":var i=t.split(",");if(2!==i.length)return t;r=e.stringFormat?String.format(e.stringFormat,i[0],i[1]):String.format("{0} / {1}",i[0],i[1]);break;case"hierarchy":var a=t.split(";"),o=a[0];a[1];r=o.toString();break;case"date":var s;s=$.isNumeric(t)?new Date(t):new Date(Date.parse(t)),r=e.stringFormat?String.format(e.stringFormat,s):s.toLocaleString();break;case"duration":if($.isNumeric(t)){var n=new Date(0),c=new Date(t),l=c.getHours()-n.getHours(),p=c.getMinutes()-n.getMinutes(),u=c.getSeconds()-n.getSeconds();r=("0"+l).slice(-2)+"h"+("0"+p).slice(-2)+"m"+("0"+u).slice(-2)+"s"}else r=t;break;default:r=e.stringFormat?String.format(e.stringFormat,t):t}return r}function E(e,r){if(e.properties.hasOwnProperty("Name"))return e;if(e.properties.hasOwnProperty("name"))return e.properties.Name=e.properties.name,e;if(e.properties.hasOwnProperty("NAME"))return e.properties.Name=e.properties.NAME,e;if(e.fType&&e.fType.style&&e.fType.style.nameLabel){var i=e.fType.style.nameLabel;if(e.properties.hasOwnProperty(i))return r&&r.hasOwnProperty(i)?e.properties.Name=L(r[i],e.properties[i]):e.properties.Name=e.properties[i],e}if(e.fType._propertyTypeData)for(var a=0;a<e.fType._propertyTypeData.length;a++){var o=e.fType._propertyTypeData[a];if("Name"===o.label&&o.stringFormat)return e.properties.Name=t.convertStringFormat(e,o.stringFormat),e}for(var s in e.properties)return e.properties.Name=s.toString(),e;return e.properties.Name=t.getGuid(),e}function C(e,r){for(var i=t.indexes(r,"{"),a=t.indexes(r,"}"),o=r,s=0;s<i.length;s++){var n=r.substring(i[s]+1,a[s]),c=e.properties.hasOwnProperty(n)?e.properties[n]:"";o=o.replace("{"+n+"}",c)}return o}function M(e,t){if(!e)return[];for(var r=[],i=0;i<e.length;i++)e.substr(i,t.length)===t&&r.push(i);return r}function P(){var e=(this.S4()+this.S4()+"-"+this.S4()+"-4"+this.S4().substr(0,3)+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()).toLowerCase();return e}function F(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function x(e){var t={type:"",features:[],featureTypes:{}};return e.project.groups.forEach(function(e){null!=e.filterResult&&e.filterResult.forEach(function(e){return t.features.push(e)})}),0===t.features.length&&(t.features=e.project.features),t.features.forEach(function(r){if(!t.featureTypes.hasOwnProperty(r.featureTypeName)){var i=e.getFeatureType(r);i.name||(i.name=r.featureTypeName.replace("_Default","")),t.featureTypes[r.featureTypeName]=i,i.propertyTypeKeys&&(i._propertyTypeData=[],i.propertyTypeKeys.split(/[,;]+/).forEach(function(t){e.propertyTypeData.hasOwnProperty(t)&&i._propertyTypeData.push(e.propertyTypeData[t])}))}}),t}function O(t,r,i,a,o,s,n,c){var l=new e.Services.RightPanelTab;return l.container=t,l.data=i,l.title=a,l.directive=r,l.popover=o||"",l.icon=s||"tachometer",l.replace=n,"undefined"!=typeof c&&(l.canClose=c),l}function A(e,t,r,i){var a=e.split(t)[0],o=e.split(t)[1],s=o.split(r),n={};return s.forEach(function(e){var t=e.split(i);n[t[0]]=isNaN(+t[1])?t[1]:+t[1]}),n.baseUrl=a,n}function I(e,t,r,i){var a=e.baseUrl+t;for(var o in e)e.hasOwnProperty(o)&&"baseUrl"!==o&&e[o]&&(a=a+o+i+e[o]+r);return a=a.substring(0,a.length-1)}function k(e,r){var i,a,o="undefined"==typeof r?e.effectiveStyle:r,s=o.iconUri,n="";switch(o.drawingMode){case"Line":break;case"Polygon":i='<img src="images/bom.png"></img>';break;case"Point":var c,l;if(o.hasOwnProperty("strokeWidth")&&o.strokeWidth>0?(c=o.iconWidth+2*o.strokeWidth,l=o.iconHeight+2*o.strokeWidth):(c=o.iconWidth,l=o.iconHeight),null!=o.innerTextProperty&&e.properties.hasOwnProperty(o.innerTextProperty)){var p=o.innerTextSize||12;a="pin"===o.marker?'<div class="pin-inner" style="font-size:'+p+'px;">'+e.properties[o.innerTextProperty]+"</div>":'<span style="font-size:'+p+'px;vertical-align:-webkit-baseline-middle">'+e.properties[o.innerTextProperty]+"</span>"}else null!=s&&(null!=s&&s.indexOf("{")>=0&&(s=t.convertStringFormat(e,s)),a='<img src="'+s+'" style="width:'+o.iconWidth+"px;height:"+o.iconHeight+"px;display:block;",o.rotate&&o.rotate>0&&(a+=";transform:rotate("+o.rotate+"deg)"),n='" />');isNaN(o.fillOpacity)&&(o.fillOpacity=1);var u=chroma(o.fillColor).alpha(+o.fillOpacity).rgba(),d="rgba("+u[0]+","+u[1]+","+u[2]+","+u[3]+")";switch(o.marker){case"pin":i=o.innerTextProperty?'<div class="pin" style="display:inline-block;vertical-align:bottom;text-align:center;'+("background:"+d+";")+("width:"+c+"px;")+("height:"+l+"px;")+("opacity:"+(o.opacity||1)+";")+('">'+a+"</div>"):'<div class="pin" style="display:inline-block;vertical-align:bottom;text-align:center;'+("background:"+d+";")+("width:"+c+"px;")+("height:"+l+"px;")+("opacity:"+(o.opacity||1)+";")+'"></div>'+a+("position:absolute;margin:"+o.strokeWidth+'px" />');break;case"bubble":i='<div class="bubble" style="display:inline-block;vertical-align:bottom;text-align:center;'+("background:"+d+";")+("width:"+c+"px;")+("height:"+l+"px;")+("opacity:"+(o.opacity||1)+";")+'"></div>'+a+("position:absolute;margin:"+o.strokeWidth+'px" />');break;default:var h=chroma(o.strokeColor).alpha(+o.strokeOpacity||1).rgba(),f="rgba("+h[0]+","+h[1]+","+h[2]+","+h[3]+")";i='<div style="display:inline-block;vertical-align:middle;text-align:center;'+("background:"+d+";")+("width:"+c+"px;")+("height:"+l+"px;")+("border-radius:"+o.cornerRadius+"%;")+"border-style:solid;"+("border-color:"+f+";")+("border-width:"+o.strokeWidth+"px;")+("opacity:"+(o.opacity||1)+";")+'">'+a+n+"</div>"}}var y={html:i,iconPlusBorderWidth:c,iconPlusBorderHeight:l};return y}t.translateObject=r,t.serialize=i,t.cloneWithoutUnderscore=a,t.getFeatureTypeName=o,t.getDefaultFeatureStyle=s,t.saveData=n,t.saveImage=c,t.nextChar=l,t.supportsDataUri=p,t.standardDeviation=u,t.average=d,t.getFeatureTitle=h,t.featureTitle=f,t.getPropertyTypes=y,t.getPropertyKey=m,t.getPropertyType=g,t.getMissingPropertyTypes=v,t.findUniqueKey=S,t.addPropertyTypes=b,t.updateSection=w,t.createDefaultType=T,t.convertPropertyInfo=L,t.setFeatureName=E,t.convertStringFormat=C,t.indexes=M,t.getGuid=P,t.S4=F,t.loadMapLayers=x,t.createRightPanelTab=O,t.parseUrlParameters=A,t.joinUrlParameters=I,t.createIconHtml=k}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e}();e.PieData=t;var r=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(t);e.AsterPieData=r;var i=function(){function e(){}return e.drawHistogram=function(t,r){var i=null!=r&&r.hasOwnProperty("id")?r.id:"myHistogram",a=null!=r&&r.hasOwnProperty("numberOfBins")?r.numberOfBins:10,o=null!=r&&r.hasOwnProperty("width")?r.width:200,s=null!=r&&r.hasOwnProperty("height")?r.height:150,n=null!=r&&r.hasOwnProperty("xLabel")?r.xLabel:"",c=null!=r&&r.hasOwnProperty("selectedValue")?r.selectedValue:null,l={top:0,right:6,bottom:24,left:6};o-=l.left+l.right,s-=l.top+l.bottom;var p="the_SVG_ID";e.clearSvg(p);var u=d3.format(",.0f"),d=Math.max.apply(null,t),h=Math.min.apply(null,t),f=d-h,y=e.getScale(f/a,d),m=0;Math.abs(y)>0&&(n+=" (x10^"+y+")",m=Math.pow(10,y));var g=function(e){return m>0?d3.round(e/m,0).toString():d3.round(e,0).toString()},v=d3.scale.linear().domain([0,a]).range([h,d]),S=d3.range(a+1).map(v),b=d3.scale.linear().domain([h,d]).range([0,o]),$=d3.svg.axis().scale(b).tickValues(S).tickFormat(g).orient("bottom"),w=d3.layout.histogram().bins(a)(t),T=d3.scale.linear().domain([0,d3.max(w,function(e){return e.y})]).range([s,0]),L=d3.select("#"+i).append("svg").attr("id",p).attr("width",o+l.left+l.right).attr("height",s+l.top+l.bottom).attr("style","display: block; margin: 0 auto;").append("g").attr("transform","translate("+l.left+","+l.top+")"),E=L.selectAll(".bar").data(w).enter().append("g").attr("class",function(e,t){return null!=c&&e.x<c&&c<e.x+w[t].dx?"bar highlight":"bar"}).attr("transform",function(e){return"translate("+b(e.x)+","+T(e.y)+")"});E.append("rect").attr("x",1).attr("width",b(h+w[0].dx)-1).attr("height",function(e){return s-T(e.y)});var C=function(e){return s-T(e)>6?u(e):""};E.append("text").attr("dy",".75em").attr("y",6).attr("x",b(h+w[0].dx)/2).attr("text-anchor","middle").text(function(e){return C(e.y)}),L.append("text").attr("class","x label").attr("text-anchor","end").attr("x",o).attr("y",s/2-6).text(n),L.append("g").attr("class","x axis").attr("transform","translate(0,"+s+")").call($)},e.getScale=function(e,t){for(var r=-5;5>r;r++){var i=Math.pow(10,r),a=d3.round(e/i,0),o=d3.round(t/i,0);if(a>0&&10>a&&o>0&&100>o)return r}return 0},e.drawMcaPlot=function(t,r){var i=null!=r&&r.hasOwnProperty("id")?r.id:"myHistogram",a=null!=r&&r.hasOwnProperty("numberOfBins")?r.numberOfBins:10,o=null!=r&&r.hasOwnProperty("width")?r.width:200,s=null!=r&&r.hasOwnProperty("height")?r.height:150,n=null!=r&&r.hasOwnProperty("xLabel")?r.xLabel:"",c=null!=r&&r.hasOwnProperty("xy")?r.xy:null,l=null!=r&&r.hasOwnProperty("featureValue")?r.featureValue:null,p={top:0,right:6,bottom:24,left:6};o-=p.left+p.right,s-=p.top+p.bottom;var u=i+"_histogram";e.clearSvg(u);var d,h,f,y=d3.format(",.0f");null!=c?(d=c.x[c.x.length-1],h=c.x[0],f=d-h,d+=f/10,h-=f/10):(d=Math.max.apply(null,t),h=Math.min.apply(null,t)),f=d-h;var m=e.getScale(f/a,d),g=0;n+=" (",Math.abs(m)>0&&(n+="x10^"+m,g=Math.pow(10,m));var v=function(e){return g>0?d3.round(e/g,0).toString():d3.round(e,0).toString()},S=d3.scale.linear().domain([0,a]).range([h,d]),b=d3.range(a+1).map(S),$=d3.scale.linear().domain([h,d]).range([0,o]),w=d3.svg.axis().scale($).tickValues(b).tickFormat(v).orient("bottom"),T=t.filter(function(e){return e>=h&&d>=e});if(T.length<3){var L=d3.select("#"+i).append("svg").attr("id",u).attr("width",o+p.left+p.right).attr("height",s+p.top+p.bottom).append("g").attr("transform","translate("+p.left+","+p.top+")");return void L.append("text").attr("class","x label").attr("text-anchor","center").attr("x",o/2).attr("y",s/2+6).text(" NO DATA IN RANGE")}n+=" "+T.length;var E=d3.layout.histogram().bins(a)(T),C=d3.scale.linear().domain([0,d3.max(E,function(e){return e.y})]).range([s,0]),M=d3.select("#"+i).append("svg").attr("id",u).attr("width",o+p.left+p.right).attr("height",s+p.top+p.bottom).attr("style","display: block; margin: 0 auto;").append("g").attr("transform","translate("+p.left+","+p.top+")"),P=M.selectAll(".bar").data(E).enter().append("g").attr("class","bar").attr("transform",function(e){return"translate("+$(e.x)+","+C(e.y)+")"});P.append("rect").attr("x",1).attr("width",$(h+E[0].dx)-1).attr("height",function(e){return s-C(e.y)});var _=function(e){return s-C(e)>6?y(e):""};if(P.append("text").attr("dy",".75em").attr("y",6).attr("x",$(h+E[0].dx)/2).attr("text-anchor","middle").text(function(e){return _(e.y)}),n+=")",M.append("text").attr("class","x label").attr("text-anchor","end").attr("x",o).attr("y",s/2-6).text(n),M.append("g").attr("class","x axis").attr("transform","translate(0,"+s+")").call(w),null!=c){var F=[];F.push({x:h,y:c.y[0]});for(var x=0;x<c.x.length;x++)F.push({x:c.x[x],y:c.y[x]});F.push({x:d,y:c.y[c.y.length-1]});var O=d3.scale.linear().domain([0,d3.max(F,function(e){return e.y})]).range([s-1,1]),A=d3.svg.line().x(function(e){return $(e.x)}).y(function(e){return O(e.y)}).interpolate("linear");M.append("svg:path").attr("d",A(F)).attr("stroke","red").attr("stroke-width",2).attr("fill","none"),null!=l&&(F=[],F.push({x:l,y:0}),F.push({x:l,y:s}),M.append("svg:path").attr("d",A(F)).attr("stroke","blue").attr("stroke-width",2).attr("fill","none"))}},e.drawPie=function(t,r,i,a,o){if(void 0===i&&(i="mcaPieChart"),void 0===a&&(a="Reds"),void 0===o&&(o="the_SVG_ID"),e.clearSvg(o),r){var s=t,n=t,c=Math.min(s,n)/2,l=0,p=d3.layout.pie().sort(null).value(function(e){return e.weight}),u=d3.tip().attr("class","d3-tip").offset([0,0]).html(function(e){return"<strong>"+e.data.label+": </strong><span style='color:orangered'>"+Math.round(100*e.data.weight)+"%</span>"}),d=d3.svg.arc().innerRadius(l).outerRadius(c),h=d3.svg.arc().innerRadius(l).outerRadius(c),f=d3.select("#"+i).append("svg").attr("id",o).attr("width",s).attr("height",n).attr("style","display: block; margin: 0 auto;").append("g").attr("transform","translate("+s/2+","+n/2+")"),y=chroma.scale(a).domain([0,r.length-1],r.length);f.selectAll(".solidArc").data(p(r)).enter().append("path").attr("fill",function(e,t){return e.data.color||y(t).hex()}).attr("class","solidArc").attr("stroke","gray").attr("d",d).on("mouseover",function(e,t){u.show(e,t)}).on("mouseout",u.hide),f.selectAll(".outlineArc").data(p(r)).enter().append("path").attr("fill","none").attr("stroke","gray").attr("class","outlineArc").attr("d",h)}},e.drawAsterPlot=function(t,r,i,a,o){if(void 0===i&&(i="mcaPieChart"),void 0===a&&(a="Reds"),void 0===o&&(o="the_SVG_ID"),e.clearSvg(o),r){var s=t,n=t,c=Math.min(s,n)/2,l=.3*c,p=d3.layout.pie().sort(null).value(function(e){return e.weight}),u=d3.tip().attr("class","d3-tip").offset([0,0]).html(function(e){return"<strong>"+e.data.label+': </strong> <span style="color:orangered">'+Math.round(100*e.data.weight)+"% x "+Math.round(e.data.score)+"&nbsp; = "+Math.round(e.data.weight*e.data.score)+"</span>"}),d=d3.svg.arc().innerRadius(l).outerRadius(function(e){return(c-l)*(e.data.score/100)+l}),h=d3.svg.arc().innerRadius(l).outerRadius(c),f=d3.select("#"+i).append("svg").attr("id",o).attr("width",s).attr("height",n).attr("style","display: block; margin: 0 auto;").append("g").attr("transform","translate("+s/2+","+n/2+")");try{f.call(u)}catch(y){console.log("Error: "+y.message)}var m=chroma.scale(a).domain([0,r.length-1],r.length),g=(f.selectAll(".solidArc").data(p(r)).enter().append("path").attr("fill",function(e,t){return e.data.color||m(t).hex()}).attr("class","solidArc").attr("stroke","gray").attr("d",d).on("mouseover",function(e,t){u.show(e,t)}).on("mouseout",u.hide),f.selectAll(".outlineArc").data(p(r)).enter().append("path").attr("fill","none").attr("stroke","gray").attr("class","outlineArc").attr("d",h),0),v=0;r.forEach(function(e){g+=e.weight,v+=e.weight*e.score}),f.append("svg:text").attr("class","aster-score").attr("dy",".35em").attr("text-anchor","middle").text(Math.round(v/g))}},e.clearSvg=function(e){var t=d3.select("#"+e);t&&t.remove()},e.pieColors=["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],e}();e.Plot=i}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){function t(e){return!a(e)&&!e}function r(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];for(var i=t.length;i--;)e=e.replace(new RegExp("\\{"+i+"\\}","gm"),t[i]);return e}function i(e){return moment(e,moment.ISO_8601).isValid()}function a(e){return!isNaN(parseFloat(e))&&isFinite(e)}function o(e){return"true"===e||"false"===e}function s(e){return e&&e.constructor===Array}function n(e){return!1}e.isNullOrEmpty=t,e.format=r,e.isDate=i,e.isNumber=a,e.isBoolean=o,e.isArray=s,e.isBbcode=n}(t=e.StringExt||(e.StringExt={}))}(csComp||(csComp={}));var StringFormat;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("stringy",["$compile",function(e){return{require:"ngModel",terminal:!1,restrict:"A",scope:{},link:function(e,t,r,i){e.$watch(function(){return i.$modelValue},function(e){t[0].innerText=String.format("{0:0,0}",i.$modelValue)})}}}])}(StringFormat||(StringFormat={})),String.prototype.score=function(e,t){"use strict";if(this===e)return 1;if(""===e)return 0;var r,i,a,o,s,n=0,c=this,l=c.toLowerCase(),p=c.length,u=e.toLowerCase(),d=e.length,h=0,f=1;if(t&&(o=1-t),t)for(s=0;d>s;s+=1)a=l.indexOf(u[s],h),-1===a?f+=o:(h===a?r=.7:(r=.1," "===c[a-1]&&(r+=.8)),c[a]===e[s]&&(r+=.1),n+=r,h=a+1);else for(s=0;d>s;s+=1){if(a=l.indexOf(u[s],h),-1===a)return 0;h===a?r=.7:(r=.1," "===c[a-1]&&(r+=.8)),c[a]===e[s]&&(r+=.1),n+=r,h=a+1}return i=.5*(n/p+n/d)/f,u[0]===l[0]&&.85>i&&(i+=.15),i};var csComp;!function(e){var t;!function(e){function t(e,t){if(t.activeLegend){var r="#000000",i=t.activeLegend,a=(i.id,i.legendEntries.length);if(0===a)return r;for(var o=0;a>o;){var s=i.legendEntries[o];if(e===s.stringValue)return s.color;o++}return r}return e}function r(e){if(e){var t=e&&e.style&&e.style.iconUri?e.style.iconUri:"bower_components/csweb/dist-bower/images/marker.png";return t.indexOf("{")>=0&&(t=t.replace("{","").replace("}","")),e&&null!=e.style&&null!=e.style.drawingMode&&"point"!=e.style.drawingMode.toLowerCase()?t.indexOf("_Media")<0?t:"cs/images/polygon.png":e&&null!=e.style&&null!=t?t:"bower_components/csweb/dist-bower/images/marker.png"}}function i(e,t,r){void 0===r&&(r="#000000");var i=t.legendEntries.length;if(0===i)return r;if("discretestrings"===t.legendKind.toLowerCase()){for(var a=0;i>a;){var o=t.legendEntries[a];if(e===o.stringValue)return o.color;a++}return r}return r}function a(e,t,r){void 0===r&&(r="#000000");var i=t.legendEntries.length;if(0===i)return r;if("discretestrings"===t.legendKind.toLowerCase()){for(var a=0;i>a;){var o=t.legendEntries[a];if(e.toString()===o.stringValue)return o.color;a++}return r}var s=t.legendEntries[0],n=t.legendEntries[i-1];if("interpolated"===t.legendKind.toLowerCase()){if(e<s.value)return s.color;if(e>n.value)return n.color;for(var a=0;i-1>a;){if(s=t.legendEntries[a],n=t.legendEntries[a+1],e>=s.value&&e<=n.value){var c=chroma.bezier([s.color,n.color]),l=c((e-s.value)/(n.value-s.value)).hex();return l}a++}return r}if("discrete"===t.legendKind.toLowerCase()){if(s.interval&&n.interval&&"undefined"!=typeof s.interval.min&&"undefined"!=typeof n.interval.max){if(e<s.interval.min)return s.color;if(e>n.interval.max)return n.color}for(var a=0;i>a;){var o=t.legendEntries[a];if(o.value){if(e===o.value)return o.color}else if(o.interval&&e>=o.interval.min&&e<=o.interval.max)return o.color;a++}return r}return r}function o(e,t){if(t.activeLegend)return a(e,t.activeLegend);var r=t.info.userMax||t.info.max,i=t.info.userMin||t.info.min;if(e>r)return t.colors[t.colors.length-1];if(i>e)return t.colors[0];var o=d3.scale.linear().domain([i,r]).range(t.colors),s=o(e).toString();return s}function s(e,t){return void 0===t&&(t="#000000"),e?"transparent"===e?"#00000000":4===e.length||7===e.length?e:9===e.length?"#"+e.substr(3,6):t:t}e.getColorFromStringValue=t,e.getImageUri=r,e.getColorFromStringLegend=i,e.getColorFromLegend=a,e.getColor=o,e.getColorString=s}(t=e.Helpers||(e.Helpers={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},FSM;!function(e){var t=function(){function e(e){this.fsm=e}return e.prototype.to=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this.toStates=e,this.fsm.addTransitions(this)},e.prototype.toAny=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(e[r]);this.toStates=t,this.fsm.addTransitions(this)},e}();e.Transitions=t;var r=function(){function e(e,t,r){this.fsm=e,this.from=t,this.to=r}return e}();e.TransitionFunction=r;var i=function(e){function t(t){e.call(this),this.fsm=t}return __extends(t,e),t.prototype.on=function(e,t){var r=this;this.forEach(function(i){t&&r.fsm.on(i.to,t),r.fsm.addEvent(e,i.from,i.to)})},t}(Array);e.TransitionFunctions=i;var a=function(){function e(e){this._transitionFunctions=[],this._onCallbacks={},this._exitCallbacks={},this._enterCallbacks={},this._triggers={},this.currentState=e,this._startState=e}return e.prototype.addTransitions=function(e){var t=this,a=new i(this);return e.fromStates.forEach(function(i){e.toStates.forEach(function(e){i===e||t._validTransition(i,e)||a.push(new r(t,i,e))})}),a.forEach(function(e){return t._transitionFunctions.push(e)}),a},e.prototype.addEvent=function(e,t,r){var i=t.toString();this._triggers[i]||(this._triggers[i]={}),this._triggers[i][e.toString()]=r},e.prototype.trigger=function(e){if("undefined"!=typeof e){var t=e.toString(),r=this.currentState.toString();this._triggers.hasOwnProperty(r)&&this._triggers[r].hasOwnProperty(t)&&this.go(this._triggers[r][t])}},e.prototype.on=function(e,t){var r=e.toString();return this._onCallbacks[r]||(this._onCallbacks[r]=[]),this._onCallbacks[r].push(t),this},e.prototype.onEnter=function(e,t){var r=e.toString();return this._enterCallbacks[r]||(this._enterCallbacks[r]=[]),this._enterCallbacks[r].push(t),this},e.prototype.onExit=function(e,t){var r=e.toString();return this._exitCallbacks[r]||(this._exitCallbacks[r]=[]),this._exitCallbacks[r].push(t),this},e.prototype.from=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var i=new t(this);return i.fromStates=e,i},e.prototype.fromAny=function(e){var r=[];for(var i in e)e.hasOwnProperty(i)&&r.push(e[i]);var a=new t(this);return a.fromStates=r,a},e.prototype._validTransition=function(e,t){return this._transitionFunctions.some(function(r){return r.from===e&&r.to===t})},e.prototype.canGo=function(e){return this.currentState===e||this._validTransition(this.currentState,e)},e.prototype.go=function(e){if(!this.canGo(e))throw new Error("Error no transition function exists from state "+this.currentState.toString()+" to "+e.toString());this._transitionTo(e)},e.prototype.onTransition=function(e,t){},e.prototype.reset=function(){this.currentState=this._startState},e.prototype._transitionTo=function(e){var t=this;this._exitCallbacks[this.currentState.toString()]||(this._exitCallbacks[this.currentState.toString()]=[]),this._enterCallbacks[e.toString()]||(this._enterCallbacks[e.toString()]=[]),this._onCallbacks[e.toString()]||(this._onCallbacks[e.toString()]=[]);var r=this._exitCallbacks[this.currentState.toString()].reduce(function(r,i){return r&&i.call(t,e)},!0),i=this._enterCallbacks[e.toString()].reduce(function(e,r){return e&&r.call(t,t.currentState)},!0);if(r&&i){var a=this.currentState;this.currentState=e,this._onCallbacks[this.currentState.toString()].forEach(function(r){r.call(t,a,e)}),this.onTransition(a,e)}},e}();e.FiniteStateMachine=a}(FSM||(FSM={}));var csComp;!function(e){!function(e){e[e.Js=0]="Js",e[e.Css=1]="Css"}(e.FileType||(e.FileType={}));var t=e.FileType,r=function(){function e(){}return e.twoDigitStr=function(e){var t;return t=e.toString(),1===t.length&&(t="0"+t),t},e.loadJsCssfile=function(r,i,a){if(!(e.loadedFiles.indexOf(r)>0))switch(e.loadedFiles.push(r),i){case t.Js:var o=document.createElement("script");o.setAttribute("type","text/javascript"),o.setAttribute("src",r),a&&(o.onload=function(e){a(e)}),document.getElementsByTagName("head")[0].appendChild(o);break;case t.Css:var s=document.createElement("link");
s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.setAttribute("href",r),a&&(s.onload=function(e){a(e)}),document.getElementsByTagName("head")[0].appendChild(s)}},e.loadedFiles=[],e}();e.Utils=r}(csComp||(csComp={}));var LayersDirective;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("validtitle",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,i){var a=function(e){var t="undefined"==typeof e||0===e.length;return t?void i.$setValidity("validtitle",!1):e.match(/^[a-zA-Z0-9\s]*$/)?(i.$setValidity("validtitle",!0),e):void i.$setValidity("validtitle",!1)};i.$parsers.unshift(a),i.$formatters.unshift(a)}}}),e.myModule.directive("validfeaturetypeid",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,i){var a=function(t){var r="undefined"==typeof t||0===t.length;if(r)return void i.$setValidity("validfeaturetypeid",!1);var a=e.featureType;return!a._isInitialized&&a._resource.featureTypes.hasOwnProperty(t)?void i.$setValidity("validfeaturetypeid",!1):(i.$setValidity("validfeaturetypeid",!0),t)};i.$parsers.unshift(a),i.$formatters.unshift(a)}}}),e.myModule.directive("duplicategroup",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,i){var a=function(t){if("undefined"==typeof t||""===t)return void i.$setValidity("duplicategroup",!1);var r=e.$parent.vm.groups.every(function(e){return e.title!==t});return i.$setValidity("duplicategroup",r),t};i.$parsers.unshift(a),i.$formatters.unshift(a)}}})}(LayersDirective||(LayersDirective={}));var Translations;!function(e){var t=function(){function e(){}return e.locale={CANCEL_BTN:"Cancel",OK_BTN:"OK",CLOSE:"Close",FROM:"from",TO:"to",ZOOM_IN:"Zoom in",ZOOM_OUT:"Zoom out",ZOOM_LEVEL_LOW:"Zoom level too low",ZOOM_IN_FOR_CONTOURS:"Zoom in to show contours",NAVIGATE:{TITLE:"Search results"},CREATE_SCATTER:"Create scatter with",EXPAND_ALL:"Expand all",COLLAPSE_ALL:"Collapse all",SELECT_ALL:"Select all",DESELECT_ALL:"Deselect all",CHOOSE_DROPDOWN:"Choose...",ENABLE_LOCATION_FILTER:"Enable location filter",DISABLE_LOCATION_FILTER:"Disable location filter",SELECT_A_FEATURE:"Select a feature",SELECT_FEATURE_FOR_WIDGET:"Please select a feature to show the widget.",SELECT_FEATURE_FOR_STYLE:"Please select a feature to before setting the style.",SELECT_LAYER_GROUP:"Select Layers",SELECT_CATEGORY:"Select Category",SELECT_PROPERTIES:"Select Properties",NO_RELATIONS_FOUND:"No relations can be shown for the selected feature. Either the zoom level is too low, there are too many features in the view or there are no relations defined.",BASESTYLES:"Baselayers",MAP:"Maps",MAP_LABEL:"Map",TABLE_LABEL:"Table",LAYERS:"Layers",DIRECTORY:"Available layers",CREATELAYER:"Create new layer",ADDFEATURES:"Add items",ADDTYPE:"Add new type",DONE:"done",FILTERS:"Filters",FILTER_INFO:'At the moment, no filters have been selected. In order to add a filter, click on an icon or area on the map, and click on the filter icon (<span class="fa fa-filter"></span>) in the right menu. This will create a filter for the selected property.',STYLES:"Styles",STYLE_INFO:'At the moment, no style has been selected. In order to add a style, click on an icon or area on the map, and click on the style icon (<span class="smallStyleIcon"></span>) in the right menu. This will create a filter for the selected property.',FEATURES:"Features",LEGEND:"Legend",SEARCH:"Search",HIDE_PANEL:"Hide this panel",EDIT_INDICATORS:"Edit indicators",RELATED_FEATURES:"Show related features",FEATURE_INFO:"Show information about the selected feature",MAP_FEATURES:"Map features",NEARBY_FEATURES:"Nearby features",TOGGLE_MENU:"Toggle menu visibility",DASHBOARD_SELECTION:"Dashboard selection",SETTINGS:"Settings",SPEEDS_TAOUFIK:"speed colors Taoufik",SPEEDS_GOOGLEMAPS:"speed colors Google Maps",VERWARMINGSSYSTEEM:"Heating system",PERCENTAGES_V1:"percentages v1",ORANGE_RED:"orange - red",WHITE_RED:"white - red",RED_WHITE:"red - white",RED_WHITE_BLUE:"red - white - blue",GREEN_RED:"green - red",RED_GREEN:"red - green",BLUE_RED:"blue - red",RED_BLUE:"red - blue",WHITE_BLUE:"white - blue",BLUE_WHITE:"blue - white",WHITE_GREEN:"white - green",GREEN_WHITE:"green - white",WHITE_ORANGE:"white - orange",ORANGE_WHITE:"orange - white",SAVE:"save",CONFIG:"config",EDIT:"edit",APPLY:"apply",REMOVE:"remove",FOCUSTIME:{OUT_OF_RANGE:"The timerange is out of scope",NOT_AVAILABLE:"Currently no sensor data available",LOADING:"Sensor data is being loaded, please wait"},STATS:{COUNT:"#",COUNT_TOOLTIP:"Count of selected items",MIN:"min",MIN_TOOLTIP:"Minimum of selected items",MAX:"max",MAX_TOOLTIP:"Maximum of selected items",MEAN:"",MEAN_TOOLTIP:"Mean of selected items",SUM:"",SUM_TOOLTIP:"Sum of selected items"},UTILS:{FILTER:"Use this property as filter",STYLE:"Use this property as style",STATS:"Show property statistics",CHART:"Show property in time",CONFIG:"Configure property"},EXPERTMODE:{BEGINNER:"Novice",INTERMEDIATE:"Intermediate",EXPERT:"Expert",ADMIN:"Admin",EXPLANATION:"Select your expertise in order to unlock more functionality."},LAYER_SERVICE:{RELOAD_PROJECT_TITLE:"Data is reloaded",RELOAD_PROJECT_MSG:"After switching the language, we need to reload all the map data. Our appologies for the inconvenience."},HEATMAP:{NAME:"Heatmaps",DESCRIPTION:'<h4>Heatmap</h4><p  style="text-align: left; margin-left:5px;">Heatmap highlights areas on the map that fulfill multiple selected criteria.',INFO:"At the moment, no map layers are loaded that contain a heatmap. Open another map layer to use it.",INFO_EXPERT:"At the moment, no map layers are loaded that contain a heatmap. Open another map layer to use it, or create a new heatmap using the wizard.",SHOW_FEATURE_MSG:"Select a feature on the map to see the heatmap.",TOTAL_RESULT:"Combined result",DELETE_MSG:'Delete "{0}"',DELETE_MSG2:"Are you sure?",EDITOR_TITLE:"Heatmap Editor",MAIN_FEATURE:"Select the main feature",PROPERTIES:"Select the properties",INTENSITY_SCALE:"Intensity scale",RESOLUTION:"Resolution",TITLE:"Title... *",TITLE_TAG:"Title",SCALE_MIN_TITLE:"[Min. scale]",SCALE_MAX_TITLE:"[Max. scale]",MIN_MAX_ZOOM:"Min./Max. zoom",AT_LOCATION_VALUE:"[Weight at location]",DISTANCE_MAX_VALUE:"[Ideal distance]",LOST_INTEREST_VALUE:"[Lost interest distance]",LINEAR_ASC_DESC:"Linearly increasing, then decreasing function.",ADD_HEATMAP:"Add a new heatmap.",DELETE_HEATMAP:"Delete the heatmap.",EDIT_HEATMAP:"Edit the heatmap.",EXPORT_HEATMAP:"Export the heatmap."},MCA:{NAME:"Multi-Criteria Analysis (MCA)",DESCRIPTION:'<h4>Multi-Criteria Analysis</h4><p  style="text-align: left; margin-left:5px;">MCA, is a method that combines multiple properties of a feature on the map into a new property. It achieves this by:<ol><li>Scaling each property to a range between 0 (no value) and 1 (maximum value).</li><li>Weighing each property relative to the others, where a weight less than 0 indicates you wish to avoid it, 0 is ignored, and a value greater than 0 is prefered.</li></ol> In fact, it is a kind of linear regression.',INFO:"At the moment, no map layers are loaded that contain a multi-criteria analysis. Open another map layer to see it.",INFO_EXPERT:"At the moment, no map layers are loaded that contain a multi-criteria analysis. Open another map layer to use it, or create a new MCA using the wizard.",SHOW_FEATURE_MSG:"Select a feature on the map to see the effects of the Multi-Criteria Analysis (MCA).",TOTAL_RESULT:"Combined result",DELETE_MSG:'Delete "{0}"',DELETE_MSG2:"Are you sure?",HAS_CATEGORY:"  Has category? ",HAS_RANK:"  Include rank? ",EDITOR_TITLE:"MCA Editor",MAIN_FEATURE:"Select the main feature",PROPERTIES:"Select the properties",INCLUDE_RANK:"  Show rank? ",RANK_TITLE:"[Rank title...]",TITLE:"Title... *",CATEGORY_MSG:"[Category...]",TOGGLE_SPARKLINE:"Show or hide bar charts and scoring function.",SCALE_MIN_TITLE:"[Min. scale]",SCALE_MAX_TITLE:"[Max. scale]",MIN_VALUE:"[Minimum (-2)]",MAX_VALUE:"[Maximum (+2)]",MIN_CUTOFF_VALUE:"[Ignore when below this value]",MAX_CUTOFF_VALUE:"[Ignore when above this value]",LINEAR:"Linearly increasing function between min and max.",SIGMOID:"Tangentially increasing function between min and max",GAUSSIAN:"Normal distribution increasing function between min and max.",ADD_MCA:"Add a new MCA.",DELETE_MCA:"Delete the MCA.",EDIT_MCA:"Edit the MCA.",SET_STYLE:"Set style"},PROJECTSETTINGS:{TITLE:"Project Settings",DESCRIPTION:"Settings"},CHOOSE_CATEGORY:"Choose category...",SHOW5:"Show 5 items",SHOW10:"Show 10 items",SHOW15:"Show 15 items",SHOW20:"Show 20 items",SHOW25:"Show 25 items",SHOW30:"Show 30 items",SHOW35:"Show 35 items",SHOW40:"Show 40 items",RISK_DIAGRAM_FOR:"Risk-diagram for a ",SAVE_FEATURE_DEPENDENCIES:"Save dependencies to the selected feature only",SAVE_FEATURETYPE_DEPENDENCIES:"Save dependencies to all features of this type",SAVE_MARVEL:"Save ",SAVE_EVERY_MARVEL:"Save every ",MARVEL_WATER_LEVEL:"Water level [m]",MARVEL_UPS_DURATION:"UPS duration [mins]",MARVEL_FEATURE_DEP:"Depends on",STATE:"State",EVENT_INFO:"Show a list of events",CLEAR_EVENTS:"Clear event log",SEARCH_PLACEHOLDER:"Municipality, address, ...",SAVE_AS_IMAGE:"Save as image",SAVE_AS_PDF:"Save as PDF",ROW_CHART_HELP:"Click one or multiple rows to apply a filter for the selected property.",CONVERT:"Convert",VIEW_PROJECT:"View your project",PASTE_HERE:"Paste your data here",OPTION:"Option"},e}();e.English=t}(Translations||(Translations={}));var Translations;!function(e){var t=function(){function e(){}return e.locale={CANCEL_BTN:"Annuler",OK_BTN:"D'accord",FROM:"de",TO:"",NAVIGATE:"Dbut",CREATE_SCATTER:"Crer scatter avec",EXPAND_ALL:"Dvelopper tout",COLLAPSE_ALL:"Rduire tout",SELECT_ALL:"Slectionner tout",DESELECT_ALL:"Tout dselectionner",CHOOSE_DROPDOWN:"Choisir...",ENABLE_LOCATION_FILTER:"Activez le filtre de localisation",DISABLE_LOCATION_FILTER:"filtre de localisation Dsactiver",SELECT_A_FEATURE:"Slectionnez une fonction",SELECT_FEATURE_FOR_WIDGET:"S'il vous plat slectionner une fonction pour afficher le widget.",SELECT_FEATURE_FOR_STYLE:"S'il vous plat slectionner une fonction  avant de dfinir le style.",SELECT_LAYER_GROUP:"Slectionner les couches",SELECT_CATEGORY:"Choisir une catgorie",SELECT_PROPERTIES:"Slectionnez Proprits",NO_RELATIONS_FOUND:"Aucune relation ne peuvent tre affichs pour la fonction slectionne. ",BASESTYLES:"Couches de base",MAP:"Cartes",MAP_LABEL:"Carte",TABLE_LABEL:"Table",LAYERS:"Couches",DIRECTORY:"couches disponibles",CREATELAYER:"Crer un nouveau calque",ADDFEATURES:"Ajouter des lments",ADDTYPE:"Ajouter nouveau type",DONE:"termin",FILTERS:"Filtres",FILTER_INFO:" l'heure actuelle, aucun filtre ont t slectionns. ",STYLES:"modes",STYLE_INFO:" l'heure actuelle, aucun style a t slectionn. ",FEATURES:"Caractristiques",LEGEND:"Lgende",SEARCH:"Chercher",HIDE_PANEL:"Cachez ce panneau",EDIT_INDICATORS:"Modifier les indicateurs",RELATED_FEATURES:"Afficher les caractristiques lies",FEATURE_INFO:"Affiche des informations sur la fonction slectionne",MAP_FEATURES:"caractristiques de la carte",NEARBY_FEATURES:"caractristiques  proximit",TOGGLE_MENU:"Menu Basculer la visibilit",DASHBOARD_SELECTION:"slection de tableau de bord",SETTINGS:"Paramtres",SPEEDS_GOOGLEMAPS:"couleurs de vitesse Google Maps",VERWARMINGSSYSTEEM:"Systme de chauffage",PERCENTAGES_V1:"pourcentages v1",ORANGE_RED:"rouge-orange",WHITE_RED:"blanc rouge",RED_WHITE:"rouge blanc",RED_WHITE_BLUE:"rouge - blanc - bleu",GREEN_RED:"vert rouge",RED_GREEN:"rouge vert",BLUE_RED:"bleu rouge",RED_BLUE:"rouge Bleu",WHITE_BLUE:"blanc bleu",BLUE_WHITE:"bleu blanc",WHITE_GREEN:"blanc - vert",GREEN_WHITE:"vert - blanc",WHITE_ORANGE:"blanc - orange,",ORANGE_WHITE:"d'orange - blanc",SAVE:"enregistrer",CONFIG:"config",EDIT:"modifier",APPLY:"appliquer",REMOVE:"retirer",STATS:{COUNT_TOOLTIP:"Dcompte des lments slectionns",COUNT:"#",MAX_TOOLTIP:"Maximum d'lments slectionns",MEAN_TOOLTIP:"Moyenne des lments slectionns",SUM_TOOLTIP:"Somme des lments slectionns",MIN_TOOLTIP:"Minimum d'lments slectionns",MAX:"max",MIN:"min",SUM:" ",MEAN:", mu"},UTILS:{STATS:"Voir les statistiques de l'immobilier",STYLE:"Utilisez cette proprit que le style",CONFIG:"Configurer la proprit",FILTER:"Utilisez cette proprit comme filtre",CHART:"Voir la proprit dans le temps"},EXPERTMODE:{ADMIN:"Administrateur",INTERMEDIATE:"Intermdiaire",BEGINNER:"Novice",EXPERT:"Expert",EXPLANATION:"Slectionnez votre expertise afin de dbloquer plus de fonctionnalits."},LAYER_SERVICE:{RELOAD_PROJECT_MSG:"Aprs le passage de la langue, nous avons besoin de recharger toutes les donnes cartographiques. ",RELOAD_PROJECT_TITLE:"Les donnes sont recharges"},HEATMAP:{DISTANCE_MAX_VALUE:"[La distance Idal]",TOTAL_RESULT:"rsultat combin",ADD_HEATMAP:"Ajouter un nouveau heatmap.",MIN_MAX_ZOOM:"Min max. ",RESOLUTION:"Rsolution",INFO_EXPERT:" l'heure actuelle, pas de couches de carte sont charges qui contiennent un heatmap. ",TITLE_TAG:"Titre",DELETE_HEATMAP:"Supprimer le heatmap.",NAME:"heatmaps",SCALE_MAX_TITLE:"[Max. ",EXPORT_HEATMAP:"Export de la heatmap.",SHOW_FEATURE_MSG:"Slectionnez une fonction sur la carte pour voir le heatmap.",EDITOR_TITLE:"Heatmap Editor",INFO:" l'heure actuelle, pas de couches de carte sont charges qui contiennent un heatmap. ",LINEAR_ASC_DESC:"augmenter linairement, puis diminution de la fonction.",DESCRIPTION:"<H4> Heatmap </ h4> <p style = `text-align: left; margin-left: 5px;`> Heatmap met en vidence les zones sur la carte qui remplissent plusieurs critres slectionns.",INTENSITY_SCALE:"chelle d'intensit",DELETE_MSG:"Supprimer `{0}`",MAIN_FEATURE:"Slectionnez la fonction principale",PROPERTIES:"Slectionnez les proprits",EDIT_HEATMAP:"Modifiez le heatmap.",DELETE_MSG2:"tes-vous sr?",SCALE_MIN_TITLE:"[Min. ",LOST_INTEREST_VALUE:"[Distance de l'intrt perdu]",TITLE:"Titre... *",AT_LOCATION_VALUE:"[Poids  l'emplacement]"},MCA:{SIGMOID:"Tangentiellement fonction croissante entre min et max",EDIT_MCA:"Modifiez le MCA.",TOTAL_RESULT:"rsultat combin",INCLUDE_RANK:"Afficher le rang?",GAUSSIAN:"Distribution normale fonction entre min et max croissante.",LINEAR:"fonction entre min et max augmenter linairement.",MAIN_FEATURE:"Slectionnez la fonction principale",PROPERTIES:"Slectionnez les proprits",CATEGORY_MSG:"[Catgorie...]",INFO_EXPERT:" l'heure actuelle, pas de couches de carte sont charges qui contiennent une analyse multi-critres. ",RANK_TITLE:"[Rank titre ...]",HAS_RANK:"Inclure rang?",DELETE_MSG:"Supprimer `{0}`",SHOW_FEATURE_MSG:"Slectionnez une fonction sur la carte pour voir les effets de l'analyse multi-critres (MCA).",MIN_VALUE:"[Minimum (-2)]",HAS_CATEGORY:"A catgorie?",EDITOR_TITLE:"MCA Editor",SCALE_MIN_TITLE:"[Min. ",DESCRIPTION:"<H4> analyse multicritres </ h4> <p style = `text-align: left; margin-left: 5px;`> MCA, est une mthode qui combine plusieurs proprits d'une entit sur la carte dans une nouvelle proprit. ",TOGGLE_SPARKLINE:"Afficher ou masquer les graphiques  barres et la fonction de notation.",MAX_VALUE:"[Maximum ( 2)]",TITLE:"Titre... *",MIN_CUTOFF_VALUE:"[Ignorer quand dessous de cette valeur]",SCALE_MAX_TITLE:"[Max. ",INFO:" l'heure actuelle, pas de couches de carte sont charges qui contiennent une analyse multi-critres. ",DELETE_MCA:"Supprimer le MCA.",MAX_CUTOFF_VALUE:"[Ignorer quand dessus de cette valeur]",DELETE_MSG2:"tes-vous sr?",ADD_MCA:"Ajouter un nouveau MCA.",NAME:"Analyse multi-critres (MCA)",SET_STYLE:"Set de style"},PROJECTSETTINGS:{DESCRIPTION:"Paramtres",TITLE:"Paramtres du projet"},CHOOSE_CATEGORY:"Choisir la catgorie ...",SHOW5:"Afficher 5 articles",SHOW10:"Afficher 10 articles",SHOW15:"Afficher 15 articles",SHOW20:"Afficher 20 articles",SHOW25:"Afficher 25 articles",SHOW30:"Afficher les 30 articles",SHOW35:"Afficher 35 articles",SHOW40:"Afficher 40 articles",RISK_DIAGRAM_FOR:"Risque-diagramme pour une",SAVE_FEATURE_DEPENDENCIES:"Enregistrer les dpendances  la fonction slectionne uniquement",SAVE_FEATURETYPE_DEPENDENCIES:"Enregistrer les dpendances  toutes les fonctionnalits de ce type",SAVE_MARVEL:"sauvegarder",SAVE_EVERY_MARVEL:"Enregistrer tous les",MARVEL_WATER_LEVEL:"Le niveau d'eau [m]",MARVEL_UPS_DURATION:"dure UPS [minutes]",MARVEL_FEATURE_DEP:"Dpend de",STATE:"Etat",EVENT_INFO:"Afficher une liste des vnements",CLEAR_EVENTS:"Effacer le journal des vnements"},e}();e.French=t}(Translations||(Translations={}));var Translations;!function(e){var t=function(){function e(){}return e.locale={CANCEL_BTN:"Annuleren",OK_BTN:"OK",CLOSE:"Sluit",FROM:"van",TO:"tot",ZOOM_IN:"Inzoomen",ZOOM_OUT:"Uitzoomen",ZOOM_LEVEL_LOW:"Zoom niveau te laag",ZOOM_IN_FOR_CONTOURS:"Zoom in om de contouren te tonen",NAVIGATE:{TITLE:"Zoekresultaten"},REMOVE:"Verwijder",CREATE_SCATTER:"Creeer spreidingsdiagram",EXPAND_ALL:"Alles uitklappen",COLLAPSE_ALL:"Alles inklappen",SELECT_ALL:"Selecteer alles",DESELECT_ALL:"Deselecteer alles",ENABLE_LOCATION_FILTER:"Activeer locatiefilter",SELECT_A_FEATURE:"Selecteer een feature",DISABLE_LOCATION_FILTER:"Deactiveer locatiefilter",SELECT_FEATURE_FOR_WIDGET:"Selecteer een gebied om de widget te tonen.",SELECT_FEATURE_FOR_STYLE:"Selecteer eerst een gebied, dan pas kan de stijl geactiveerd worden.",SELECT_LAYER_GROUP:"Selecteer lagen",SELECT_CATEGORY:"Selecteer categorie",SELECT_PROPERTIES:"Selecteer eigenschappen",NO_RELATIONS_FOUND:"Geen relaties voor het geselecteerde item gevonden. Ofwel het zoomniveau is te laag, er zijn teveel items zichtbaar of er zijn geen relaties gedefinierd.",CHOOSE_DROPDOWN:"Kies...",BASESTYLES:"Basiskaarten",MAP:"Kaarten",MAP_LABEL:"Kaart",TABLE_LABEL:"Tabel",LAYERS:"Kaartlagen",DIRECTORY:"Beschikbare lagen",CREATELAYER:"Nieuwe laag maken",ADDFEATURES:"Objecten toevoegen",ADDTYPE:"Nieuwe type toevoegen",FILTERS:"Filters",FILTER_INFO:'Momenteel zijn er geen filters geselecteerd. Klik op een icoon of gebied op de kaart, en klik op het filter icoontje (<span class="fa fa-filter"></span>) in het rechter menu om een filter toe te voegen. Dan wordt er een filter aangemaakt voor de geselecteerde eigenschap.',STYLES:"Stijlen",STYLE_INFO:'Momenteel zijn er geen stijlen geselecteerd. Klik op een icoon of gebied op de kaart, en klik op het stijl icoontje (<span class="smallStyleIcon"></span>) in het rechter menu om een stijl toe te voegen. Dan wordt er een stijl aangemaakt voor de geselecteerde eigenschap.',FEATURES:"Features",LEGEND:"Legenda",SEARCH:"Zoeken",HIDE_PANEL:"Verberg dit paneel",EDIT_INDICATORS:"Wijzig indicatoren",RELATED_FEATURES:"Toon gerelateerde features",FEATURE_INFO:"Toon informatie over de geselecteerde feature",MAP_FEATURES:"Kaartfeatures",NEARBY_FEATURES:"Dichtbijgelegen features",DASHBOARD_SELECTION:"Dashboardselectie",SETTINGS:"Instellingen",TOGGLE_MENU:"Wissel de zichtbaarheid van het menu",SPEEDS_TAOUFIK:"snelheden legenda Taoufik",SPEEDS_GOOGLEMAPS:"snelheden legenda Google Maps",VERWARMINGSSYSTEEM:"Verwarmingssysteem",PERCENTAGES_V1:"percentages v1",ORANGE_RED:"oranje - rood",WHITE_RED:"wit - rood",RED_WHITE_BLUE:"rood - wit - blauw",RED_WHITE:"rood - wit",GREEN_RED:"groen - rood",RED_GREEN:"rood - groen",BLUE_RED:"blauw - rood",RED_BLUE:"rood - blauw",WHITE_BLUE:"wit - blauw",BLUE_WHITE:"wit - groen",WHITE_GREEN:"wit - groen",GREEN_WHITE:"groen - wit",WHITE_ORANGE:"wit - oranje",ORANGE_WHITE:"oranje - wit",SAVE:"opslaan",APPLY:"toepassen",DONE:"klaar",CONFIG:"config",EDIT:"aanpassen",FOCUSTIME:{OUT_OF_RANGE:"De tijdscope is te groot. Gebruik de tijdbalk om deze te verkleinen",NOT_AVAILABLE:"Momenteel is er geen sensor data beschikbaar",LOADING:"Sensor data wordt geladen, even geduld"},STATS:{COUNT:"#",COUNT_TOOLTIP:"Aantal geselecteerde items",MIN:"min",MIN_TOOLTIP:"Minimum van geselecteerde items",MAX:"max",MAX_TOOLTIP:"Maximum van geselecteerde items",MEAN:"",MEAN_TOOLTIP:"Gemiddelde van geselecteerde items",SUM:"",SUM_TOOLTIP:"Som van geselecteerde items"},UTILS:{FILTER:"Gebruik dit kenmerk als filter",STYLE:"Gebruik dit kenmerk als stijl",STATS:"Toon de statistieken van dit kenmerk",CHART:"Toon het verloop van dit kenmerk in de tijd",CONFIG:"Configureer dit kenmerk"},EXPERTMODE:{BEGINNER:"Beginner",INTERMEDIATE:"Gevorderd",EXPERT:"Expert",ADMIN:"Admin",EXPLANATION:"Selecteer uw expertise om meer functionaliteit te kunnen gebruiken."},LAYER_SERVICE:{RELOAD_PROJECT_TITLE:"Data wordt opnieuw geladen",RELOAD_PROJECT_MSG:"Na het wisselen van de taal moet de kaartdata opnieuw ingelezen worden. Excuses voor het ongemak."},HEATMAP:{NAME:"Heatmaps",DESCRIPTION:'<h4>Toelichting heatmap</h4><div style="text-align: left; margin-left:5px;"><p>Heatmap laat gebieden op de kaart oplichten die voldoen aan bepaalde criteria.',INFO:"Momenteel zijn er geen kaartlagen geopend die heatmaps bevatten.",INFO_EXPERT:"Momenteel zijn er geen kaartlagen geopend die heatmaps bevatten. Open een kaartlaag en maak een nieuwe heatmap aan met behulp van de wizard.",SHOW_FEATURE_MSG:"Selecteer een feature op de kaart om de heatmap resultaten in detail te bekijken.",TOTAL_RESULT:"Gecombineerd resultaat",DELETE_MSG:'Verwijder "{0}"',DELETE_MSG2:"Weet u het zeker?",EDITOR_TITLE:"Heatmap Editor",MAIN_FEATURE:"Selecteer het type feature",PROPERTIES:"Selecteer de eigenschappen",RESOLUTION:"Resolutie",INTENSITY_SCALE:"Intensiteitsschaal",TITLE:"Titel... *",TITLE_TAG:"Titel",TOGGLE_SPARKLINE:"Toon of verberg de histogram en score functie.",SCALE_MIN_TITLE:"[Schaal max]",SCALE_MAX_TITLE:"[Schaal min]",MIN_MAX_ZOOM:"Min./Max. zoom",AT_LOCATION_VALUE:"[Waarde op locatie]",DISTANCE_MAX_VALUE:"[Ideale afstand]",LOST_INTEREST_VALUE:"[Negeer vanaf afstand]",LINEAR_ASC_DESC:"Linear toenemende, dan afnemende functie.",ADD_HEATMAP:"Maak een nieuwe heatmap.",DELETE_HEATMAP:"Verwijder de heatmap.",EDIT_HEATMAP:"Bewerk de heatmap.",EXPORT_HEATMAP:"Exporteer de heatmap."},MCA:{NAME:"Multi-Criteria Analyse (MCA)",DESCRIPTION:'<h4>Toelichting MCA</h4><div style="text-align: left; margin-left:5px;"><p>Multi-Criteria Analysis (MCA) is een methode die verschillende eigenschappen van een locatie of gebied op de kaart combineerd tot een nieuwe eigenschap. Dit gaat als volgt: <ol><li>Schaal iedere eigenschap tussen 0 (geen waarde) en 1 (maximum waarde).</li><li>Weeg iedere eigenschap relatief t.o.v. de andere gekozen eigenschappen, waar een gewicht onder 0 betekent dat je de eigenschap wil vermijden, 0 wordt genegeerd, en een waarde groter dan 0 betekent dat je dit wil bereiken.</li></ol>Met andere woorden, het is een vorm van lineare regressie.</p></div>',INFO:"Momenteel zijn er geen kaartlagen geopend die multi-criteria analyses bevatten. Open hiervoor een andere kaartlaag.",INFO_EXPERT:"Momenteel zijn er geen kaartlagen geopend die multi-criteria analyses bevatten. Open een kaartlaag en maak een nieuwe MCA aan met behulp van de wizard.",SHOW_FEATURE_MSG:"Selecteer een feature op de kaart om de Multi-Criteria Analyse (MCA) resultaten in detail te bekijken.",TOTAL_RESULT:"Gecombineerd resultaat",DELETE_MSG:'Verwijder "{0}"',DELETE_MSG2:"Weet u het zeker?",HAS_CATEGORY:"  Specificeer categorie? ",EDITOR_TITLE:"MCA Editor",MAIN_FEATURE:"Selecteer het type feature",PROPERTIES:"Selecteer de eigenschappen",INCLUDE_RANK:"  Toon een rangorde? ",RANK_TITLE:"[Titel voor de rangorde]",TITLE:"Titel... *",CATEGORY_MSG:"[Categorie...]",TOGGLE_SPARKLINE:"Toon of verberg de histogram en score functie.",SCALE_MIN_TITLE:"[Schaal max]",SCALE_MAX_TITLE:"[Schaal min]",MIN_VALUE:"[Ondergrens (-2)]",MAX_VALUE:"[Bovengrens (+2)]",MIN_CUTOFF_VALUE:"[Niet meewegen onder]",MAX_CUTOFF_VALUE:"[Niet meewegen boven]",LINEAR:"Linear toenemende functie tussen onder- en bovengrens.",SIGMOID:"Tangentieel toenemende functie tussen onder- en bovengrens.",GAUSSIAN:"Normale verdeling tussen onder- en bovengrens.",ADD_MCA:"Maak een nieuwe MCA.",DELETE_MCA:"Verwijder de MCA.",EDIT_MCA:"Bewerk de MCA.",SET_STYLE:"Activeer stijl"},PROJECTSETTINGS:{TITLE:"Project instellingen",DESCRIPTION:"Instellingen"},CHOOSE_CATEGORY:"Kies categorie...",SHOW5:"Toon 5 regels",SHOW10:"Toon 10 regels",SHOW15:"Toon 15 regels",SHOW20:"Toon 20 regels",SHOW25:"Toon 25 regels",SHOW30:"Toon 30 regels",SHOW35:"Toon 35 regels",SHOW40:"Toon 40 regels",RISK_DIAGRAM_FOR:"Risicodiagram voor een ",SAVE_FEATURE_DEPENDENCIES:"Sla de afhankelijkheden op alln voor het geselecteerde object",SAVE_FEATURETYPE_DEPENDENCIES:"Sla de afhankelijkheden op voor alle object van dit type",SAVE_MARVEL:"Bewaar ",SAVE_EVERY_MARVEL:"Bewaar ieder ",MARVEL_WATER_LEVEL:"Waterniveau [m]",MARVEL_UPS_DURATION:"Noodstroom duur [min]",MARVEL_FEATURE_DEP:"Afhankelijk van",STATE:"Status",EVENT_INFO:"Toon lijst van gebeurtenissen",CLEAR_EVENTS:"Lijst leegmaken",SEARCH_PLACEHOLDER:"Gemeente, adres, ...",SAVE_AS_IMAGE:"Opslaan als afbeelding",SAVE_AS_PDF:"Opslaan als PDF",ROW_CHART_HELP:"Klik op n of meerdere rijen om een filter toe te passen voor de geselecteerde eigenschap.",CONVERT:"Converteer",VIEW_PROJECT:"Bekijk je project",PASTE_HERE:"Plak hier uw data",OPTION:"Optie"},e}();e.Dutch=t}(Translations||(Translations={}));var Accessibility;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("accessibility",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Accessibility/Accessibility.tpl.html",replace:!0,transclude:!0,controller:e.AccessibilityCtrl}}])}(Accessibility||(Accessibility={}));var Accessibility;!function(e){var t=function(){function e(){this.id="accessibilityActions"}return e.prototype.stop=function(){},e.prototype.addFeature=function(e){},e.prototype.removeFeature=function(e){},e.prototype.selectFeature=function(e){console.log("accessibility:feature selected")},e.prototype.getLayerActions=function(e){return null},e.prototype.addLayer=function(e){},e.prototype.removeLayer=function(e){},e.prototype.getFeatureActions=function(e){var t={title:"Show accessibility"};t.callback=this.showAccessibility;var r={title:"Remove accessibility"};r.callback=this.removeAccessibility;var i={title:"Plan route from"};i.callback=this.planRouteFrom;var a={title:"Plan route to"};return a.callback=this.planRouteTo,[t,r,i,a]},e.prototype.getFeatureHoverActions=function(e){return[]},e.prototype.deselectFeature=function(e){},e.prototype.updateFeature=function(e){},e.prototype.showAccessibility=function(e,t){console.log("accessibility:showAccessibility");var r=t.findLayer("accessibility");if(r){var i=r.url.split("&"),a=-1;if(i.some(function(e,t){return"fromPlace"===e.substring(0,9)?(a=t,!0):!1}),"Point"!==e.geometry.type)return void console.log("Can only create accessibility layer from a Point");if(i[a]="fromPlace="+e.geometry.coordinates[1]+"%2C"+e.geometry.coordinates[0],r.url=i.join("&"),r.enabled)r.layerSource&&r.layerSource.refreshLayer(r);else{t.addLayer(r);var o=csComp.Helpers.createRightPanelTab("rightpanel","accessibility",r,"Accessibility options");t.$messageBusService.publish("rightpanel","activate",o)}}},e.prototype.removeAccessibility=function(e,t){console.log("accessibility:removeAccessibility");var r=t.findLayer("accessibility");if(r){var i=t.visual.rightPanelVisible;r.enabled&&t.removeLayer(r),delete r.data,t.visual.rightPanelVisible=i}},e.planRoute=function(e,t,r){var i=t.findLayer("tripplanner");if(i){var a=csComp.Helpers.parseUrlParameters(i.url,"?","&","=");a[r]=e.geometry.coordinates[1]+"%2C"+e.geometry.coordinates[0],i.url=csComp.Helpers.joinUrlParameters(a,"?","&","="),i.enabled?i.layerSource&&i.layerSource.refreshLayer(i):t.addLayer(i);var o=csComp.Helpers.createRightPanelTab("rightpanel","tripplanner",i,"Route planner");t.$messageBusService.publish("rightpanel","activate",o)}},e.prototype.planRouteFrom=function(t,r){console.log("accessibility:planRouteFrom"),e.planRoute(t,r,"fromPlace")},e.prototype.planRouteTo=function(t,r){console.log("accessibility:planRouteTo"),e.planRoute(t,r,"toPlace")},e.prototype.init=function(e){var t=this;console.log("init AccessibilityActionService"),this.layerService=e,this.layerService.$messageBusService.serverSubscribe("accessibility","msg",function(e,r){"restart"===r.data&&(t.layerService.$messageBusService.notify("restarting server","restarting",csComp.Services.NotifyLocation.TopRight),location.reload())})},e}();e.AccessibilityModel=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$http=t,this.$mapService=r,this.$layerService=i,this.$messageBusService=a,this.$dashboardService=o,this.urlKeys=["arriveBy","fromPlace","date","time","mode","walkSpeed","bikeSpeed","precisionMeters","cutoffSec"],this.scope=e,e.vm=this,this.layer=e.$parent.data,this.cutoffTimes=[],this.urlParameters={},this.bikeSpeedKm,this.walkSpeedKm,this.urlKeys.forEach(function(e){s.urlParameters[e]=0}),this.transportModes={},this.transportModes.Walking="WALK",this.transportModes.Biking="BICYCLE"}return e.prototype.refreshAccessibility=function(){if(this.$layerService.lastSelectedFeature){var e=this.$layerService.lastSelectedFeature;e.geometry&&"Point"===e.geometry.type&&(this.urlParameters.fromPlace=e.geometry.coordinates[1]+"%2C"+e.geometry.coordinates[0])}this.urlParameters.mode=this.transportMode,this.urlParameters.time=encodeURIComponent(this.time),this.walkSpeedKm&&(this.urlParameters.walkSpeed=csComp.Helpers.GeoExtensions.convertKmToMile(this.walkSpeedKm)),this.bikeSpeedKm&&(this.urlParameters.bikeSpeed=csComp.Helpers.GeoExtensions.convertKmToMile(this.bikeSpeedKm));var t=this.urlAddress+"?";for(var r in this.urlParameters)this.urlParameters.hasOwnProperty(r)&&"cutoffSec"!==r&&(t=t+r+"="+this.urlParameters[r]+"&");this.cutoffTimes.forEach(function(e){t=t+"&cutoffSec="+60*e}),console.log(t),this.layer.url=t,this.layer.enabled?this.layer.layerSource&&this.layer.layerSource.refreshLayer(this.layer):this.$layerService.addLayer(this.layer),this.$layerService.visual.rightPanelVisible=!0},e.prototype.parseUrl=function(){var e=this;this.urlParameters={},this.urlAddress=this.layer.url.split("?")[0];var t=this.layer.url.split("?")[1],r=t.split("&");r.forEach(function(t){var r=t.split("=");"cutoffSec"===r[0]&&e.cutoffTimes.push(+r[1]/60),e.urlParameters[r[0]]=isNaN(+r[1])?r[1]:+r[1]});var i=new Date(Date.now());this.time=("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2),this.urlParameters.date=i.getMonth()+1+"-"+i.getDate()+"-"+i.getFullYear(),this.transportMode=this.urlParameters.mode,this.urlParameters.hasOwnProperty("walkSpeed")&&(this.walkSpeedKm=+csComp.Helpers.GeoExtensions.convertMileToKm(this.urlParameters.walkSpeed).toFixed(2)),this.urlParameters.hasOwnProperty("bikeSpeed")&&(this.bikeSpeedKm=+csComp.Helpers.GeoExtensions.convertMileToKm(this.urlParameters.bikeSpeed).toFixed(2)),"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.addCutoffTime=function(){this.cutoffTimes.push(0),"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.removeCutoffTime=function(e){e<this.cutoffTimes.length&&e>-1&&this.cutoffTimes.splice(e,1),"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},e.$inject=["$scope","$http","mapService","layerService","messageBusService","dashboardService"],e}();e.AccessibilityCtrl=r}(Accessibility||(Accessibility={}));var BaseMapList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("baseMapList",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/BaseMapList/BaseMapList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.BaseMapListCtrl}}])}(BaseMapList||(BaseMapList={}));var BaseMapList;!function(e){var t=function(){function e(e,t,r,i){this.$scope=e,this.$layerService=t,
this.$mapService=r,this.$messageBusService=i,e.vm=this}return e.prototype.selectBaseLayer=function(e){var t=this.$layerService.$mapService.getBaselayer(e);this.$layerService.activeMapRenderer.changeBaseLayer(t),this.$layerService.$mapService.changeBaseLayer(e)},e.$inject=["$scope","layerService","mapService","messageBusService"],e}();e.BaseMapListCtrl=t}(BaseMapList||(BaseMapList={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("barChart",["$filter",function(e){return{terminal:!0,restrict:"EA",scope:{data:"=",update:"="},link:function(e,t,r){var i=d3.select(t[0]);i.append("div").attr("class","chart").selectAll("div").data(e.data).enter().append("div").transition().ease("elastic").style("width",function(e){return e+"%"}).text(function(e){return e+"%"})}}}])}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("bulletChart",["$filter",function(e){function t(e,t){if(e.data){var r=d3.bullet().width(e.width).height(e.height);$(t[0]).empty();var i=d3.select(t[0]),a=[];e.data&&(a=JSON.parse(e.data));var o=i.append("div").attr("class","chart").selectAll("div").data(a).enter().append("svg").attr("class","bullet").attr("width",e.width+15).attr("height",+e.height+40).append("g").attr("transform","translate(7,20)").call(r,!1),s=o.append("g").style("text-anchor","begin").attr("transform","translate(0,-5)");s.append("text").attr("class","title").text(function(e){return e.title}),s.append("text").attr("class","subtitle").attr("dy","1em").text(function(e){return e.subtitle})}}return{terminal:!0,restrict:"EA",scope:{data:"=",update:"=",width:"=",height:"@",margin:"@"},link:function(e,r,i){t(e,r),e.$watch("data",function(){t(e,r)}),e.$watch("update",function(){t(e,r)})}}}])}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t=function(){function e(){}return e.max=function(e){for(var t=e[0],r=0,i=1;i<e.length;i++)e[i]>t&&(r=i,t=e[i]);return{maxIndex:r,max:t}},e.min=function(e){for(var t=e[0],r=0,i=1;i<e.length;i++)e[i]<t&&(r=i,t=e[i]);return{minIndex:r,min:t}},e.timestampToString=function(e){var t=new Date(e),r=String.format("{0}-{1:00}-{2:00}",t.getFullYear(),t.getUTCMonth()+1,t.getUTCDate());return r},e.timestampToTimeString=function(e){var t=new Date(e),r=String.format("{0}:{2:00}:{2:00}",t.getHours(),t.getMinutes()+1,t.getSeconds());return r},e.windowResize=function(e){if(void 0!==e){var t=window.onresize;window.onresize=function(r){"function"==typeof t&&t(r),e(r)}}},e.initializeMargin=function(e,t){var r=e.$eval(t.margin)||{left:50,top:50,bottom:50,right:50};"object"!=typeof r&&(r={left:r,top:r,bottom:r,right:r}),e.margin=r},e.getD3Selector=function(e,t){if(e.id)return"#"+e.id;var r;return e["data-chartid"]?r=e["data-chartid"]:(r="chartid"+Math.floor(1000000001*Math.random()),angular.element(t).attr("data-chartid",r)),"[data-chartid="+r+"]"},e.initializeLegendMargin=function(e,t){var r=e.$eval(t.legendmargin)||{left:0,top:5,bottom:5,right:0};"object"!=typeof r&&(r={left:r,top:r,bottom:r,right:r}),e.legendmargin=r},e.defaultColor=function(){var e=d3.scale.category20().range();return function(t,r){return t.color||e[r%e.length]}},e.configureLegend=function(t,r,i){t.legend&&i.showlegend&&"true"===i.showlegend&&(e.initializeLegendMargin(r,i),t.legend.margin(r.legendmargin),t.legend.width(void 0===i.legendwidth?400:+i.legendwidth),t.legend.height(void 0===i.legendheight?20:+i.legendheight),t.legend.key(void 0===i.legendkey?function(e){return e.key}:r.legendkey()),t.legend.color(void 0===i.legendcolor?e.defaultColor():r.legendcolor()),t.legend.align(void 0===i.legendalign?!0:"true"===i.legendalign),t.legend.rightAlign(void 0===i.legendrightalign?!0:"true"===i.legendrightalign),t.legend.updateState(void 0===i.legendupdatestate?!0:"true"===i.legendupdatestate),t.legend.radioButtonMode(void 0===i.legendradiobuttonmode?!1:"true"===i.legendradiobuttonmode))},e.checkElementID=function(t,r,i,a,o){e.configureLegend(a,t,r);var s=e.getD3Selector(r,i);angular.isArray(o)&&0===o.length&&d3.select(s+" svg").remove(),d3.select(s+" svg").empty()&&d3.select(s).append("svg"),d3.select(s+" svg").attr("viewBox","0 0 "+t.width+" "+t.height).datum(o).transition().duration(void 0===r.transitionduration?250:+r.transitionduration).call(a)},e.updateDimensions=function(t,r,i,a){if(a){a.width(t.width).height(t.height);var o=e.getD3Selector(r,i);d3.select(o+" svg").attr("viewBox","0 0 "+t.width+" "+t.height),e.windowResize(a),t.chart.update()}},e}();e.ChartHelpers=t}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("circularChart",[function(){return{terminal:!0,restrict:"EA",scope:{value:"=",max:"=",title:"=",update:"=",valueString:"=",color:"=",valueClass:"@",titleClass:"@",animationDuration:"@",width:"@",height:"@",margin:"@"},link:function(e,t,r){var i=function(){if(null!=e.value&&null!=e.max){var r=(e.margin||{top:15,right:5,bottom:0,left:10},e.width||100),i=e.height||70,a=e.color||"purple",o=e.animationDuration||0;$(t[0]).empty();var s={hddrives:[e.value,e.max-e.value]},r=e.width,i=e.height,n=Math.min(r,i)/2,c=d3.scale.ordinal().range([a,"lightgray"]),l=d3.layout.pie().sort(null),p=d3.svg.arc().innerRadius(n-100).outerRadius(n-80),u=d3.select(t[0]).append("svg").attr("width",r).attr("height",i).append("g").attr("transform","translate("+r/3+","+i/3+")");u.selectAll("path").data(l(s.hddrives)).enter().append("path").attr("class","arc").attr("fill",function(e,t){return c(t)}).transition().delay(function(e,t){return t*o}).duration(o).attrTween("d",function(e){var t=d3.interpolate(e.startAngle+.1,e.endAngle);return function(r){return e.endAngle=t(r),p(e)}});u.append("text").attr("dy","-0.25em").style("text-anchor","middle").attr("class",e.valueClass).text(function(t){return e.valueString}),u.append("text").attr("dy","1em").style("text-anchor","middle").attr("class",e.titleClass).text(function(t){return e.title})}};i(),e.$watch("value",function(){i()}),e.$watch("color",function(){i()}),e.$watch("update",function(){i()})}}}])}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("singlevalueChart",["$filter",function(e){return{terminal:!0,restrict:"EA",scope:{data:"="},link:function(e,t,r){var i=d3.select(t[0]);i.append("div").attr("class","chart").selectAll("div").data(e.value).enter().append("div").transition().ease("elastic").style("width",function(e){return e+"%"}).text(function(e){return e+"%"})}}}])}(Charts||(Charts={}));var Charts;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("sparklineChart",["$filter",function(t){return{terminal:!0,restrict:"EA",scope:{timestamps:"=",sensor:"=",property:"=",update:"=",focusTime:"=",showaxis:"=",closed:"=",smooth:"=",width:"@",height:"@",margin:"@"},link:function(t,r,i){var a=function(){if(null!=t.timestamps&&null!=t.sensor&&t.timestamps.length>0){var i=t.margin||{top:15,right:5,bottom:0,left:10},a=t.width||100,o=t.height||70;console.log("heigth:"+o);var s="undefined"!=typeof t.showaxis&&t.showaxis,n="undefined"!=typeof t.closed&&t.closed,c="undefined"!=typeof t.smooth&&t.smooth,l=12;$(r[0]).empty();for(var p=d3.select(r[0]).append("svg:svg").attr("width",a).attr("height",o),u=s?{top:0,right:0,bottom:20,left:10}:{top:0,right:0,bottom:0,left:0},d=d3.scale.linear().range([i.left+u.left,a-i.left-i.right-u.left-u.right]),h=d3.scale.linear().range([o-i.bottom-u.bottom,i.top+u.top+l]),f=d3.bisector(function(e){return e.time}).left,y=d3.svg.line().interpolate(c?"cardinal":"linear").x(function(e){return d(e.time)}).y(function(e){return h(e.measurement)}),m=[],g=0;g<t.timestamps.length;g++){var v=t.property?t.property:"value",S=$.isArray(t.sensor[g])?t.sensor[g][v]:t.sensor[g];m.push({time:t.timestamps[g],measurement:S})}d.domain(d3.extent(m,function(e){return e.time})),h.domain(d3.extent(m,function(e){return e.measurement}));var b=[];n&&m.length>0&&b.push({time:m[0].time,measurement:0}),m.forEach(function(e){return b.push(e)}),n&&m.length>0&&b.push({time:m[m.length-1].time,measurement:0});var w=p.append("svg:path").attr("d",y(b)).attr("class","sparkline-path").style("fill",n?"steelblue":"none"),T=m.map(function(e){return e.measurement}),L=e.ChartHelpers.min(T),E=e.ChartHelpers.max(T);if(p.append("circle").attr("class","sparkcircle-max").attr("cx",d(m[E.maxIndex].time)).attr("cy",h(E.max)).attr("r",4),p.append("circle").attr("class","sparkcircle-min").attr("cx",d(m[L.minIndex].time)).attr("cy",h(L.min)).attr("r",4),s){var C=6,M=d3.min(d.range()),P=M-C,_=d3.max(d.range()),F=d3.max(h.range()),x=d3.min(h.range()),O=F+C;p.append("line").attr("x1",P).attr("y1",x).attr("x2",M).attr("y2",x).attr("stroke","black"),p.append("text").attr("x",P-2).attr("y",x).attr("dy",".35em").style("text-anchor","end").text(),p.append("line").attr("x1",P).attr("y1",F).attr("x2",M).attr("y2",F).attr("stroke","black"),p.append("text").attr("x",P-2).attr("y",F).attr("dy",".35em").style("text-anchor","end").text(d3.min(h.domain())),p.append("line").attr("x1",M).attr("y1",O).attr("x2",M).attr("y2",F).attr("stroke","black"),p.append("text").attr("x",M).attr("y",O+9).attr("dy",".35em").style("text-anchor","start").text(e.ChartHelpers.timestampToString(d3.min(d.domain()))),p.append("line").attr("x1",_).attr("y1",O).attr("x2",_).attr("y2",F).attr("stroke","black"),p.append("text").attr("x",_).attr("y",O+9).attr("dy",".35em").style("text-anchor","end").text(e.ChartHelpers.timestampToString(d3.max(d.domain())))}var A=p.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0).attr("opacity",0).attr("stroke","black"),I=p.append("text").attr("x",0).attr("y",0).attr("dy",".35em").attr("opacity",0).style("text-anchor","end").text(""),k=p.append("text").attr("x",0).attr("y",16).attr("dy",".35em").attr("opacity",0).style("text-anchor","end").text(""),D=p.append("text").attr("x",0).attr("y",0).attr("dy",".35em").attr("opacity",0).text(""),R=w.node(),B=R.getTotalLength();p.on("mouseover",function(){}).on("mouseout",function(){A.attr("opacity",0),I.attr("opacity",0),D.attr("opacity",0)}).on("mousemove",function(){for(var t,i=r[0].getBoundingClientRect().left,a=d3.event.clientX-i,o=a,s=B;;){t=Math.floor((o+s)/2);var n=R.getPointAtLength(t);if((t===s||t===o)&&n.x!==a)break;if(n.x>a)s=t;else{if(!(n.x<a))break;o=t}}var c=d.invert(d3.mouse(this)[0]),l=f(m,c,1);if(l>0&&l<m.length)var p=m[l-1],u=m[l],y=c-p.time>u.time-c?u:p;else y=0>=l?m[0]:m[m.length-1];a=d(y.time),A.attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",d3.max(h.range())+(C||0)).attr("opacity",1),I.attr("x",a-6).attr("y",8).attr("dy",".35em").attr("opacity",1).text(y===m[0]?"":e.ChartHelpers.timestampToString(y.time)),k.attr("x",a-6).attr("y",16).attr("dy",".35em").attr("opacity",1).text(y===m[0]?"":e.ChartHelpers.timestampToTimeString(y.time)),D.attr("x",a+6).attr("y",8).attr("dy",".35em").attr("opacity",1).text(y.measurement)})}};a(),t.$watchCollection("sensor",function(){a()}),t.$watch("update",function(){a()})}}}])}(Charts||(Charts={}));var Directives;!function(e){var t;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("clock",["dateFilter",function(e){return{restrict:"E",scope:{time:"@",format:"@"},link:function(t,r,i){function a(){r.html(e(t.time,t.format))}t.$watch("time",function(e){a()})}}}])}(t=e.Clock||(e.Clock={}))}(Directives||(Directives={}));var Helpers;!function(e){var t;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("contextMenu",function(e){var t=function(e,t,r){if(!i)var i=angular.element;i(t.currentTarget).addClass("context");var a=i("<div>");a.addClass("dropdown clearfix");var o=i("<ul>");o.addClass("dropdown-menu"),o.attr({role:"menu"}),o.css({display:"block",position:"absolute",left:t.pageX+"px",top:t.pageY+"px"}),angular.forEach(r,function(r,s){var n=i("<li>");if(null===r)n.addClass("divider");else{var c=i("<a>");c.attr({tabindex:"-1",href:"#"}),c.text("string"==typeof r[0]?r[0]:r[0].call(e,e)),n.append(c),n.on("click",function(o){o.preventDefault(),e.$apply(function(){i(t.currentTarget).removeClass("context"),a.remove(),r[1].call(e,e)})})}o.append(n)}),a.append(o);var s=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight);a.css({width:"100%",height:s+"px",position:"absolute",top:0,left:0,zIndex:9999}),i(document).find("body").append(a),a.on("mousedown",function(e){i(e.target).hasClass("dropdown")&&(i(t.currentTarget).removeClass("context"),a.remove())}).on("contextmenu",function(e){i(e.currentTarget).removeClass("context"),e.preventDefault(),a.remove()})};return function(e,r,i){r.on("contextmenu",function(r){e.$apply(function(){r.preventDefault();var a=e.$eval(i.contextMenu);if(!(a instanceof Array))throw'"'+i.contextMenu+'" not an array';t(e,r,a)})})}})}(t=e.ContextMenu||(e.ContextMenu={}))}(Helpers||(Helpers={}));var DataTable;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("datatable",["$compile",function(t){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/DataTable/DataTable.tpl.html",replace:!0,transclude:!0,controller:e.DataTableCtrl}}])}(DataTable||(DataTable={}));var DataTable;!function(e){var t=function(){function e(e,t,r,i){this.displayValue=e,this.originalValue=t,this.type=r,this.header=i}return e}();e.TableField=t;var r=function(){function e(e,t,r,i,a,o,s,n){var c=this;this.$scope=e,this.$http=t,this.$sce=r,this.$translate=i,this.$timeout=a,this.$layerService=o,this.$localStorageService=s,this.$messageBusService=n,this.mapLabel="map",this.numberOfItems=10,this.layerOptions=[],this.propertyTypes=[],this.headers=[],this.rows=[],e.vm=this,this.layerOptions&&this.layerOptions.length>0&&i("MAP_FEATURES").then(function(e){c.layerOptions[0].title=e}),this.bindToStorage("vm.numberOfItems",10),this.numberOfItems=s.get("vm.numberOfItems"),this.bindToStorage("vm.selectedLayerId",this.mapLabel),null!=this.$layerService.project&&null!=this.$layerService.project.groups&&(this.updateLayerOptions(),this.loadLayer(),this.selectAllBool=!1,i("SELECT_ALL").then(function(e){c.selectAllText=e}))}return e.prototype.bindToStorage=function(e,t){null===this.$localStorageService.get(e)&&this.$localStorageService.set(e,t),this.$localStorageService.bind(this.$scope,e)},e.prototype.updateLayerOptions=function(){var e=this,t={group:"",id:this.mapLabel,title:""};if(this.layerOptions.push(t),this.$translate("CHOOSE_CATEGORY").then(function(e){t.title=e}),null!=this.$layerService.project&&null!=this.$layerService.project.groups){this.$layerService.project.groups.forEach(function(t){t.layers.forEach(function(r){e.layerOptions.push({group:t.title,id:r.id,title:r.title})})});for(var r in this.$layerService.loadedLayers){if(null==this.selectedLayerId)return;var i=this.$layerService.loadedLayers[r];i.enabled&&(this.selectedLayerId=i.id)}}},e.prototype.loadLayer=function(){var e=this;if(!this.selectedLayerId||this.selectedLayerId===this.mapLabel)return this.loadMapLayers();var t=this.findLayerById(this.selectedLayerId);return null==t?this.loadMapLayers():void async.series([function(r){null!=t.typeUrl?e.$layerService.loadTypeResources(t.typeUrl,!0,function(){return r()}):r()},function(r){e.$http.get(t.url).success(function(i){e.processData(t,i,r)}).error(function(i,a,o,s){e.$messageBusService.notify("ERROR opening "+t.title,"Could not get the data."),t&&t.data&&t.data.features?e.processData(t,t.data,r):r()})}])},e.prototype.processData=function(e,t,r){var i=this;this.dataset=t,null==t.featureTypes&&(t.featureTypes={}),t.features&&(t.features.forEach(function(r){r.properties.hasOwnProperty("featureTypeId")?r.featureTypeName=e.typeUrl+"#"+r.properties.featureTypeId:null!=e.defaultFeatureType&&""!==e.defaultFeatureType&&(e.defaultFeatureType.indexOf("#")>-1?r.featureTypeName=e.defaultFeatureType:r.featureTypeName=e.typeUrl+"#"+e.defaultFeatureType),r.featureTypeName in t.featureTypes||(t.featureTypes[r.featureTypeName]=i.$layerService.getFeatureType(r))}),this.updatePropertyType(t,e)),r()},e.prototype.loadMapLayers=function(){var e=this;this.selectedLayerId=this.mapLabel;var t={type:"",features:[],featureTypes:{}};this.$layerService.project.groups.forEach(function(e){null!=e.filterResult&&e.filterResult.forEach(function(e){return t.features.push(e)})}),0===t.features.length&&(t.features=this.$layerService.project.features),t.features.forEach(function(r){r.featureTypeName in t.featureTypes||(t.featureTypes[r.featureTypeName]=e.$layerService.getFeatureType(r))}),this.dataset=t,this.updatePropertyType(t)},e.prototype.addPropertyType=function(e,t,r){t===r.label?e.splice(0,0,r):e.push(r)},e.prototype.updatePropertyType=function(e,t){var r=this;this.propertyTypes=[],this.headers=[],this.rows=[];var i,a,o=[],s=[];for(var n in e.featureTypes){if(i=e.featureTypes[n],a=i.style.nameLabel,i._propertyTypeData&&i._propertyTypeData.length>0)i._propertyTypeData.forEach(function(e){return r.addPropertyType(s,a,e)});else if(i.propertyTypeKeys){var c=i.propertyTypeKeys.split(/[,;]+/);c.forEach(function(e){var t;if(e in r.$layerService.propertyTypeData)t=r.$layerService.propertyTypeData[e];else if(i._propertyTypeData){var o=$.grep(i._propertyTypeData,function(t){return t.label===e});o.length>=1&&(t=o[0])}t&&r.addPropertyType(s,a,t)})}else if(t&&e.features&&e.features.length>0){var l=e.features[0];l.layer=t;for(var n in l.properties){var p=this.$layerService.getPropertyType(l,n);p&&this.addPropertyType(s,a,p)}}var u=this.$layerService.$mapService.isAdminExpert;s.forEach(function(e){(e.visibleInCallOut||"Name"===e.label||u)&&o.indexOf(e.title)<0&&(o.push(e.title),r.propertyTypes.push(e))})}this.propertyTypes.push(csComp.Helpers.GeoExtensions.createPropertyType("Lat")),this.propertyTypes.push(csComp.Helpers.GeoExtensions.createPropertyType("Lon"));for(var d=3,h=0;d>h;h++)this.headers.push(o[h]);this.rows=this.getRows()},e.prototype.toggleSelection=function(e){var t=this.headers.indexOf(e);t>-1?this.headers.splice(t,1):this.headers.push(e),this.rows=this.getRows()},e.prototype.findLayerById=function(e){for(var t=0;t<this.$layerService.project.groups.length;t++)for(var r=this.$layerService.project.groups[t],i=0;i<r.layers.length;i++){var a=r.layers[i];if(a.id===e)return a}return null},e.prototype.getRows=function(){var e=this,r=[this.headers.length];this.propertyTypes.forEach(function(t){var i=e.headers.indexOf(t.title);i>=0&&(r[i]=t)});var i,a=[];return this.dataset&&this.dataset.features&&this.dataset.features.forEach(function(e){var o,s=[];r.forEach(function(r){"Lat"===r.label?(i="Point"===e.geometry.type?e.geometry.coordinates[1]:"",o=i):"Lon"===r.label?(i="Point"===e.geometry.type?e.geometry.coordinates[0]:"",o=i):(o=e.properties[r.label],i=csComp.Helpers.convertPropertyInfo(r,o)),s.push(new t(i,o,r.type,r.title))}),a.push(s)}),a},e.prototype.sortOrderClass=function(e,t){return null!=t&&e===this.sortingColumn?"fa fa-sort-"+(t?"desc":"asc"):"fa fa-sort"},e.prototype.orderBy=function(e,t){this.sortingColumn=e,this.rows=this.rows.sort(function(r,i){var a;return a="number"===r[e].type||"date"===r[e].type?r[e].originalValue>i[e].originalValue:r[e].originalValue.toLowerCase()>i[e].originalValue.toLowerCase(),a===t?1:-1})},e.prototype.downloadGeoJson=function(){var e=this,t='{"type": "FeatureCollection","featureTypes": '+JSON.stringify(this.dataset.featureTypes,function(e,t){return"$$hashKey"===e?void 0:t});t+=', "features": [',this.dataset.features.forEach(function(e){var r=new csComp.Services.Feature;r.type=e.type,r.properties=e.properties,r.geometry=e.geometry,t+=JSON.stringify(r)+","}),t=t.substring(0,t.length-1)+"]}";var r=this.mapLabel;if(this.selectedLayerId!==this.mapLabel){var i=this.findLayerById(this.selectedLayerId);i&&(r=i.title.replace(" ","_"))}this.$timeout(function(){e.$layerService.project.serialize();console.log("Save settings: "),csComp.Helpers.saveData(t,r,"json")},0)},e.prototype.downloadCsv=function(){var e=this,t=[];t.push(this.headers.join(";"));for(var r=0;r<this.rows.length;r++)t.push(this.rows[r].map(function(e){return e.displayValue}).join(";"));var i=t.join("\r\n"),a=this.mapLabel;if(this.selectedLayerId!==this.mapLabel){var o=this.findLayerById(this.selectedLayerId);o&&(a=o.title.replace(" ","_"))}this.$timeout(function(){e.$layerService.project.serialize();console.log("Save settings: "),csComp.Helpers.saveData(i,a,"csv")},0)},e.prototype.selectAll=function(){var e=this;this.selectAllBool?(this.$translate("SELECT_ALL").then(function(t){e.selectAllText=t}),this.propertyTypes.forEach(function(t){var r=e.headers.indexOf(t.title);r>-1&&e.headers.splice(r,1)}),this.rows=this.getRows()):(this.$translate("DESELECT_ALL").then(function(t){e.selectAllText=t}),this.propertyTypes.forEach(function(t){e.headers.indexOf(t.title)<=-1&&e.headers.push(t.title)}),this.rows=this.getRows()),this.selectAllBool=!this.selectAllBool},e.prototype.toTrusted=function(e){try{return void 0===e||null===e?this.$sce.trustAsHtml(e):this.$sce.trustAsHtml(e.toString())}catch(t){return console.log(t+": "+e),""}},e.$inject=["$scope","$http","$sce","$translate","$timeout","layerService","localStorageService","messageBusService"],e}();e.DataTableCtrl=r}(DataTable||(DataTable={}));var EventTab;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("eventtab",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/EventTab/EventTab.tpl.html",replace:!0,transclude:!0,controller:e.EventTabCtrl}}])}(EventTab||(EventTab={}));var EventTab;!function(e){var t=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$location=t,this.$sce=r,this.$mapService=i,this.$layerService=a,this.$messageBusService=o,this.$translate=s,this.sidebarMessageReceived=function(e){switch(e){case"toggle":n.$scope.showMenu=!n.$scope.showMenu;break;case"show":n.$scope.showMenu=!0;break;case"hide":n.$scope.showMenu=!1}"$apply"!==n.$scope.$root.$$phase&&"$digest"!==n.$scope.$root.$$phase&&n.$scope.$apply()},this.scope=e,e.vm=this,e.showMenu=!1;var c={layerId:"eventlayerid",prio:1,roles:[],tags:[]},l={title:"Log",showFeatureTags:!0,id:"eventtab",filters:c,roles:[],fields:{title:"Name",updated:"updated",prio:"prio",description:"description"},propertyTags:["layerTitle","state"],timeReference:"timeline",orderBy:"Updated",actions:null,canShare:!1};this.kanban={featureTypesToAdd:[],columns:[l],canAdd:!1},this.debounceSendItems=_.debounce(this.sendTimelineItems,1e3),this.tlItems=[],this.newItems=[],this.tlGroups=[],this.$messageBusService.subscribe("eventtab",function(e,t){if(t&&e)switch(e){case"updated":n.addEvent(t);break;case"added":n.addEvent(t);break;case"reset":n.reset();break;case"zoomto":n.zoomTo(t);break;default:console.log("EventTab: Event type not found")}}),this.init()}return e.prototype.init=function(){var e=new csComp.Services.ProjectLayer;e.url="",e.id="eventlayerid",e.title="EventLayer",e.enabled=!1,e.type="geojson",e.data={},e.data.features=[],e.isDynamic=!1,this.layer=e},e.prototype.reset=function(){this.tlItems=[],this.newItems=[],this.tlGroups=[],this.sendTimelineItems(),this.sendTimelineGroups(),this.layer.data.features=[]},e.prototype.addUpdateEvent=function(e){var t;this.layer.data.features.some(function(r){return r.id===e.id?(t=r,!0):!1}),t.properties.updated=new Date},e.prototype.addEvent=function(e){var t=e.feature,r=e.config,i=(r.titleKey?r.titleKey:"Name",r.descriptionKey?r.descriptionKey:"state"),a=r.dateKey?r.dateKey:"timeline",o=new csComp.Services.Feature;o.layer=this.layer,o.geometry=t.geometry,o.fType=t.fType,o.effectiveStyle=t.effectiveStyle,o.type=t.type,o.id=csComp.Helpers.getGuid(),o._gui=t._gui,o.properties=t.properties;var s,n=csComp.Helpers.getPropertyTypes(t.fType,{});n.some(function(e){return e.hasOwnProperty&&e.hasOwnProperty("label")&&e.label===i&&e.hasOwnProperty("options")?(s=e.options[o.properties[i]],!0):!1}),"timeline"===a?(o.properties.date=new Date(this.$layerService.project.timeLine.focus),o.properties.updated=new Date(this.$layerService.project.timeLine.focus)):(o.properties.date=new Date(o.properties[a]),o.properties.updated=new Date(o.properties[a])),o.properties.layerTitle=t.layer?t.layer.id:"",o.properties.hasOwnProperty("tags")||(o.properties.tags=[]),this.kanban.columns[0].propertyTags.forEach(function(e){o.properties.hasOwnProperty(e)&&n.some(function(t){return t.hasOwnProperty&&t.hasOwnProperty("label")&&t.label===i?(o.properties.tags.push(csComp.Helpers.convertPropertyInfo(t,o.properties[e])),!0):!1})}),o.properties.description=s?s:o.properties[i],o.layerId="eventlayerid",this.addTimelineItem(o),this.layer.data.features.push(o)},e.prototype.addTimelineItem=function(e){var t={start:e.properties.updated,content:e.properties.Name,id:e.id,group:e.fType.name};if(!this.tlGroups.some(function(e){return t.group===e.title})){var r={content:e.fType.name,id:e.fType.name,title:e.fType.name};this.tlGroups.push(r),this.sendTimelineGroups()}this.newItems.push(t),this.debounceSendItems()},e.prototype.mergeItems=function(){var e=this,t={};this.newItems.forEach(function(e){t.hasOwnProperty(e.group)?t[e.group].push(e):t[e.group]=[e]}),Object.keys(t).forEach(function(r){if(1===t[r].length)e.tlItems.push(t[r][0]);else if(t[r].length>1){var i=t[r][0];i.content=t[r].length.toString()+" "+t[r][0].group+" updates",e.tlItems.push(i)}}),this.newItems=[]},e.prototype.sendTimelineItems=function(){this.mergeItems(),this.$messageBusService.publish("timeline","setItems",this.tlItems)},e.prototype.sendTimelineGroups=function(){this.$messageBusService.publish("timeline","setGroups",this.tlGroups)},e.prototype.zoomTo=function(e){if(e.hasOwnProperty("id")){var t;this.layer.data.features.some(function(r){return r.id===e.id?(t=r,!0):!1}),t&&this.$mapService.zoomTo(t,this.$mapService.map.getZoom())}},e.$inject=["$scope","$location","$sce","mapService","layerService","messageBusService","$translate"],e}();e.EventTabCtrl=t}(EventTab||(EventTab={}));var ExpertMode;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("expertMode",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/ExpertMode/ExpertMode.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.ExpertModeCtrl}}])}(ExpertMode||(ExpertMode={}));var ExpertMode;!function(e){var t=csComp.Services.Expertise,r=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$localStorageService=t,this.$layerService=r,this.$mapService=i,this.$messageBus=a,e.vm=this,e.expertMode=i.expertMode,a.subscribe("expertMode",function(t,r){"newExpertise"===t&&(e.expertMode=r)}),a.subscribe("project",function(e,t){o.$layerService.project&&(o.$scope.enabled=o.$layerService.project.exportModeSelectionEnabled)}),e.$watch("expertMode",function(){o.setExpertMode(e.expertMode)})}return e.prototype.getCssClass=function(){switch(this.$mapService.expertMode){case t.Beginner:return"beginnerUserIcon";case t.Intermediate:return"intermediateUserIcon";case t.Expert:return"expertUserIcon";case t.Admin:return"adminExpertUserIcon"}},e.prototype.setExpertMode=function(e){this.$messageBus.publish("expertMode","newExpertise",e)},e.$inject=["$scope","localStorageService","layerService","mapService","messageBusService"],e}();e.ExpertModeCtrl=r}(ExpertMode||(ExpertMode={}));var FeatureList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featureList",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/FeatureList/FeatureList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.FeatureListCtrl}}]).directive("bsPopover",function(){return function(e,t,r){t.find("a[rel=popover]").popover({placement:"right",html:"true"})}})}(FeatureList||(FeatureList={}));var FeatureList;!function(e){var t=function(){function e(e,t,r){this.$scope=e,this.$layerService=t,this.$mapService=r,e.vm=this,e.numberOfItems=10}return e.$inject=["$scope","layerService","mapService"],e}();e.FeatureListCtrl=t}(FeatureList||(FeatureList={}));var FeatureProps;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featureprops",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/FeatureProps/FeatureProps.tpl.html",replace:!0,transclude:!0,controller:e.FeaturePropsCtrl}}])}(FeatureProps||(FeatureProps={}));var FeatureProps;!function(e){var t=(function(){function e(e){this.position=e,this.closeButton=!0,this.autoPan=!0}return e}(),function(){function e(e,t,r,i,a,o,s,n,c,l,p,u,d,h){this.key=e,this.value=t,this.property=r,this.canFilter=i,this.canStyle=a,this.canShowStats=o,this.feature=s,this.isFilter=n,this.isSensor=c,this.description=l,this.propertyType=p,this.timestamps=u,this.sensor=d,this.isDraft=h,this.cors={},this._id=csComp.Helpers.getGuid()}return e}());e.CallOutProperty=t;var r=function(){function e(e){this.propertyTypes={},this.properties=[],this.sectionIcon=e}return e.prototype.showSectionIcon=function(){return!csComp.StringExt.isNullOrEmpty(this.sectionIcon)},e.prototype.addProperty=function(e,r,i,a,o,s,n,c,l,p,u){var d=n.sensors&&n.sensors.hasOwnProperty(i);d?this.properties.push(new t(e,r,i,a,o,s,n,c,d,l?l:null,p,n.timestamps,n.sensors[i],u)):this.properties.push(new t(e,r,i,a,o,s,n,c,d,l?l:null,p,null,null,u))},e.prototype.hasProperties=function(){return null!=this.properties&&this.properties.length>0},e}();e.CallOutSection=r;var i=function(){function e(e,t,i,a,o){var s=this;this.type=e,this.feature=t,this.propertyTypeData=i,this.layerservice=a,this.mapservice=o,this.sections={},this.sectionKeys=[],this.hasInfoSection=!1,this.setTitle(),this.setIcon(t);var n=new r("fa-info"),c=new r("fa-link");if(null!=e){if(t.fType.propertyTypeKeys){if(t.fType._propertyTypeData.forEach(function(e){(t.properties.hasOwnProperty(e.label)||"relation"===e.type)&&e.visibleInCallOut&&s.addProperty(e,t,n,c)}),t.fType.showAllProperties||this.mapservice.isAdminExpert)for(var l in t.properties){var p=csComp.Helpers.getPropertyType(t,l);this.addProperty(p,t,n,c,!0)}}else for(var l in t.properties){var p=a.getPropertyType(t,l);if(p)this.addProperty(p,t,n,c);else if(t.fType.showAllProperties||this.mapservice.isAdminExpert){var u=csComp.Helpers.getPropertyType(t,l);this.addProperty(u,t,n,c,!0)}}}n.properties.length>0?(this.hasInfoSection=!0,this.sections["Aaa Info"]=n,this.sectionKeys.push("Aaa Info")):this.hasInfoSection=!1,c.properties.length>0&&(this.sections.linkedfeatures=c,this.sectionKeys.push("linkedfeatures")),this.sectionKeys=this.sectionKeys.sort()}return e.prototype.addProperty=function(e,t,r,i,a){void 0===a&&(a=!1);var o=this.getOrCreateCallOutSection(e.section)||r;if(!o.propertyTypes.hasOwnProperty(e.label)){o.propertyTypes[e.label]=e;var s=t.properties[e.label];if("relation"===e.type&&e.visibleInCallOut&&t._gui&&t._gui.relations&&t._gui.relations.hasOwnProperty(e.label)){var n=t._gui.relations[e.label],c={type:"feature",label:"relatedfeature"};n.forEach(function(t){c.title=e.title,i.addProperty(t.id,csComp.Helpers.getFeatureTitle(t),c.label,!1,!1,!1,t,!1,e.description,c)})}var l=csComp.Helpers.convertPropertyInfo(e,s);if(e.canEdit||!csComp.StringExt.isNullOrEmpty(l)){
var p="number"===e.type||"text"===e.type||"options"===e.type||"date"===e.type||"boolean"===e.type;e.filterType&&(p="none"!==e.filterType.toLowerCase());var u="number"===e.type||"options"===e.type||"color"===e.type;e.styleType&&(u="none"!==e.styleType.toLowerCase());var d="undefined"==typeof e.canShowStats||e.canShowStats;e.visibleInCallOut&&o.addProperty(e.title,l,e.label,p,u,d,t,!1,e.description,e,a)}}},e.prototype.sectionCount=function(){return this.sectionKeys.length},e.prototype.firstSection=function(){var e=this.sections[this.sectionKeys[0]];return e},e.prototype.lastSection=function(){var e=this.sections[this.sectionKeys[this.sectionKeys.length-1]];return e},e.prototype.getOrCreateCallOutSection=function(e){return e?e in this.sections?this.sections[e]:(this.sections[e]=new r,this.sectionKeys.push(e),this.sections[e]):null},e.prototype.setTitle=function(){this.title=csComp.Helpers.featureTitle(this.type,this.feature)},e.prototype.setIcon=function(e){this.icon=null==this.type||null==this.type.style||!this.type.style.hasOwnProperty("iconUri")||this.type.style.iconUri.toLowerCase().indexOf("_media")>=0?"":this.type.style.iconUri.indexOf("{")>=0?csComp.Helpers.convertStringFormat(e,this.type.style.iconUri):this.type.style.iconUri},e}();e.CallOut=i;var a=function(){function e(e,t,r,i,a,o,s,n){var c=this;this.$scope=e,this.$location=t,this.$sce=r,this.$mapService=i,this.$layerService=a,this.$messageBusService=o,this.$translate=s,this.$compile=n,this.showMore=[],this.showChart=[],this.updateAllStatsDelay=_.debounce(this.updateAllStats,500),this.updateStatsDelay=function(e){_.debounce(c.getPropStats,500,!0)},this.sidebarMessageReceived=function(e){switch(e){case"toggle":c.$scope.showMenu=!c.$scope.showMenu;break;case"show":c.$scope.showMenu=!0;break;case"hide":c.$scope.showMenu=!1}"$apply"!==c.$scope.$root.$$phase&&"$digest"!==c.$scope.$root.$$phase&&c.$scope.$apply()},this.featureMessageReceived=function(e,t){var r=!0;switch(e){case"onFeatureDeselect":0===c.$layerService.selectedFeatures.length?c.$layerService.visual.rightPanelVisible=!1:c.updateAllStats();break;case"onFeatureSelect":r=!1,c.displayFeature(t),c.$scope.feature=c.$layerService.lastSelectedFeature,c.updateAllStats(),"$apply"!==c.$scope.$root.$$phase&&"$digest"!==c.$scope.$root.$$phase&&c.$scope.$root.$apply();break;case"onRelationsUpdated":c.setShowSimpleTimeline(),c.displayFeature(t),c.updateHierarchyLinks(t),c.$scope.feature=t,c.$scope.autocollapse(!0);break;case"onFeatureUpdated":c.displayFeature(c.$layerService.lastSelectedFeature),c.$scope.feature=c.$layerService.lastSelectedFeature;break;case"onFeatureRemoved":t===c.$layerService.lastSelectedFeature&&c.$messageBusService.publish("rightpanel","deactiveContainer","featureprops")}r&&"$apply"!==c.$scope.$root.$$phase&&"$digest"!==c.$scope.$root.$$phase&&c.$scope.$root.$apply()},this.timestamps=new Array,this.setDropdownTitle(),this.scope=e,e.vm=this,e.showMenu=!1,e.featureTabActivated=function(e,t){o.publish("FeatureTab","activated",{sectionTitle:e,section:t})},console.log("init featurepropsctrl"),o.subscribe("feature",this.featureMessageReceived);var l=function(){var e=0;return $("#featureTabs>li").each(function(){var t=$(this).outerWidth();e+=t}),e};e.autocollapse=function(e){void 0===e&&(e=!1);var t=$("#featureTabs");t.outerWidth()<l()||parseFloat(t.css("margin-left"))<0?($("#leftArr").show(),$("#rightArr").show(),e&&t.animate({"margin-left":"20px"},"slow")):($("#leftArr").hide(),$("#rightArr").hide(),e&&t.animate({"margin-left":"0px"},"slow"))},e.autocollapse(!0),e.tabs=$("#featureTabs"),e.tabScrollDelta=e.tabs.outerWidth(),this.displayFeature(this.$layerService.lastSelectedFeature),this.$scope.feature=this.$layerService.lastSelectedFeature,this.$messageBusService.subscribe("timeline",function(e,t){"updateFeatures"===e&&c.$scope.callOut&&c.updateAllStatsDelay()})}return e.prototype.updateAllStats=function(){var e=this;if(this.$scope.callOut)for(var t in this.$scope.callOut.sections){var r=this.$scope.callOut.sections[t];r.properties.forEach(function(t){t.showMore&&e.updateStatsDelay(t)})}},e.prototype.saveFeatureType=function(){var e=this.$layerService.findResourceByFeature(this.$scope.feature);e&&this.$layerService.saveResource(e)},e.prototype.savePropertyType=function(e){var t=e.propertyType;console.log("saving property"),console.log(t);var r=this.$layerService.findResourceByFeature(this.$scope.feature);if(e.isDraft){var i=csComp.Helpers.getPropertyKey(e.feature.fType.propertyTypeKeys,e.property);r.propertyTypeData[i]=t,e.feature.fType.propertyTypeKeys+=";"+i,e.isDraft=!1,this.$layerService.propertyTypeData[i]=t}this.$layerService.saveResource(r),this.displayFeature(this.$scope.feature)},e.prototype.selectProperty=function(e,t){this.lastSelectedProperty=e,t.stopPropagation()},e.prototype.openImage=function(e){window.open(e,"mywindow","width=600")},e.prototype.saveFeature=function(){this.$layerService.unlockFeature(this.$scope.feature),this.$layerService.saveFeature(this.$scope.feature,!0),this.$layerService.updateFeature(this.$scope.feature),this.displayFeature(this.$layerService.lastSelectedFeature)},e.prototype.startEditFeature=function(){this.$scope.feature._gui.editMode=!0,this.$layerService.updateFeature(this.$scope.feature)},e.prototype.editFeature=function(){var e=csComp.Helpers.createRightPanelTab("featuretype","featuretype",this.$layerService.lastSelectedFeature,"Edit group");this.$messageBusService.publish("rightpanel","activate",e),this.$layerService.updateFeature(this.$layerService.lastSelectedFeature)},e.prototype.setFilter=function(e,t){this.$layerService.setPropertyFilter(e),this.$layerService.visual.leftPanelVisible=!0,$('#leftPanelTab a[data-target="#filters"]').tab("show"),t.stopPropagation()},e.prototype.toTrusted=function(e){try{return void 0===e||null===e?this.$sce.trustAsHtml(e):this.$sce.trustAsHtml(e.toString())}catch(t){return console.log(t+": "+e),""}},e.prototype.openLayer=function(e){if(null!=e.feature&&e.feature.properties.hasOwnProperty(e.propertyType.label)){e.feature.properties[e.propertyType.label]}},e.prototype.setCorrelation=function(e,t){t.stopPropagation();var r=this.$layerService.getPropertyValues(e.feature.layer,e.property);for(var i in this.$scope.callOut.sections){var a=this.$scope.callOut.sections[i];a.properties.forEach(function(t){if(t.property!==e.property){var i=vg.util.cor(r,e.property,t.property);t.cors[e.property]={property:e.property,value:i}}})}},e.prototype.addSparkline=function(e){var t=$("#featurepropchart_"+e._id);t.empty(),this.showChart.indexOf(e.property)<0&&this.showChart.push(e.property);var r=this.$scope;r.item=e;try{var i=this.$compile('<sparkline-chart timestamps="item.timestamps" smooth="false" closed="false" sensor="item.sensor" width="320" height="100" showaxis="true"></sparkline-chart>')(r);t.append(i)}catch(a){console.log("Error adding sparkline")}},e.prototype.createSparkLineChart=function(e){if(e.showChart=!e.showChart,e.showChart)this.addSparkline(e);else{var t=$("#featurepropchart_"+e._id);t.empty()}},e.prototype.getPropStats=function(e){if(e.showMore){this.showMore.indexOf(e.property)<0&&this.showMore.push(e.property);var t=this.$layerService.getPropertyValues(e.feature.layer,e.property),r=(e.property,vg.util.summary(t,[e.property]));e.stats=r[0],e.stats.sum=e.stats.count*e.stats.mean}else this.showMore.indexOf(e.property)>=0&&(this.showMore=this.showMore.filter(function(t){return t!==e.property}))},e.prototype.displayFeature=function(e){var t=this;if(e&&(this.featureType=e.fType,"undefined"!=typeof e.sensors&&"undefined"==typeof e.timestamps&&(e.timestamps=this.$layerService.findLayer(e.layerId).timestamps),this.$scope.callOut=new i(this.featureType,e,this.$layerService.propertyTypeData,this.$layerService,this.$mapService),this.showMore.length>0||this.showChart.length>0))for(var r in this.$scope.callOut.sections){var a=this.$scope.callOut.sections[r];a.properties.forEach(function(e){e.showMore=t.showMore.indexOf(e.property)>=0,e.showChart=t.showChart.indexOf(e.property)>=0,e.showChart&&t.addSparkline(e),e.showMore&&t.getPropStats(e)})}},e.prototype.removeFeature=function(){this.$layerService.removeFeature(this.$scope.feature,!0)},e.prototype.updateHierarchyLinks=function(e){var t=this;e&&this.$layerService.project.groups.forEach(function(r){r.layers.forEach(function(r){"hierarchy"===r.type&&r.enabled&&r.data&&r.data.features&&r.data.features[0].fType.propertyTypeData.forEach(function(r){if("hierarchy"===r.type&&r.targetlayer===e.layerId){var i=t.$layerService.getFeatureType(e),a=csComp.Helpers.getPropertyTypes(e.fType,t.$layerService.propertyTypeData),o=!1;a.forEach(function(e){e.label===r.label&&(o=!0)}),o||i._propertyTypeData.push(r)}})})})},e.prototype.showSensorData=function(e){},e.prototype.setShowSimpleTimeline=function(){if(this.$mapService.timelineVisible||"undefined"==typeof this.$layerService.lastSelectedFeature||null==this.$layerService.lastSelectedFeature)return void(this.showSimpleTimeline=!1);var e=this.$layerService.lastSelectedFeature;this.showSimpleTimeline="undefined"!=typeof e.sensors&&null!==e.sensors,this.showSimpleTimeline&&this.setTimestamps()},e.prototype.setTimestamps=function(){var e=this.$layerService.lastSelectedFeature,t=this.$layerService.findLayer(e.layerId);if(!("undefined"!=typeof t.timestamps&&null!=t.timestamps||"undefined"!=typeof e.timestamps&&null!=e.timestamps))return[];var r=this.timestamps=new Array;(t.timestamps||e.timestamps).forEach(function(e){var t=new Date(e),i=String.format("{0}-{1:00}-{2:00}",t.getFullYear(),t.getUTCMonth()+1,t.getUTCDate());(t.getUTCHours()>0||t.getUTCMinutes()>0)&&(i+=String.format(" {0:00}:{1:00}",t.getUTCHours(),t.getUTCMinutes())),r.push({title:i,timestamp:e})});var i=this.$layerService.project.timeLine.focus;if(i>r[r.length-1].timestamp)this.focusTime=r[r.length-1].title,this.setTime(r[r.length-1]);else if(i<r[0].timestamp)this.focusTime=r[0].title,this.setTime(r[0]);else for(var a=1;a<r.length;a++)if(!(i>r[a].timestamp)){this.focusTime=r[a].title,this.setTime(r[a]);break}return r},e.prototype.zoomToDate=function(e){var t=new Date(e.toString());this.$layerService.project.timeLine.isLive=!1,this.$layerService.project.timeLine.setFocus(t),this.$messageBusService.publish("timeline","setFocus",t)},e.prototype.selectFeature=function(e){e&&this.$layerService.selectFeature(e)},e.prototype.setTime=function(e){this.focusTime=e.title,this.$layerService.project.timeLine.setFocus(new Date(e.timestamp)),this.$messageBusService.publish("timeline","focusChange",e.timestamp)},e.prototype.getFormattedDate=function(e,t){if(e){var r;return t&&t.hasOwnProperty("stringFormat")?(r=t.stringFormat,"Invalid date"===moment(e).format(r)?moment(e,"YYYYMMDD").format(r):moment(e).format(r)):moment(e).calendar()}},e.prototype.setDropdownTitle=function(){var e=this;this.$translate("CHOOSE_DROPDOWN").then(function(t){"string"==typeof t&&t.length>0?e.defaultDropdownTitle=t:e.defaultDropdownTitle="..."})},e.$inject=["$scope","$location","$sce","mapService","layerService","messageBusService","$translate","$compile"],e}();e.FeaturePropsCtrl=a}(FeatureProps||(FeatureProps={}));var FeatureRelations;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featurerelations",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/FeatureRelations/FeatureRelations.tpl.html",replace:!0,transclude:!0,controller:e.FeatureRelationsCtrl}}])}(FeatureRelations||(FeatureRelations={}));var FeatureRelations;!function(e){var t=(function(){function e(e){this.position=e,this.closeButton=!0,this.autoPan=!0}return e}(),function(){function e(){this.relations=[]}return e}());e.RelationGroup=t;var r=function(){function e(){}return e}();e.Relation=r;var i=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$location=t,this.$sce=r,this.$mapService=i,this.$layerService=a,this.$messageBusService=o,this.$translate=s,this.relations=[],this.sidebarMessageReceived=function(e){switch(e){case"toggle":n.$scope.showMenu=!n.$scope.showMenu;break;case"show":n.$scope.showMenu=!0;break;case"hide":n.$scope.showMenu=!1}"$apply"!==n.$scope.$root.$$phase&&"$digest"!==n.$scope.$root.$$phase&&n.$scope.$apply()},this.featureMessageReceived=function(e,t){switch(e){case"onFeatureSelect":n.initRelations(),n.$messageBusService.publish("feature","onRelationsUpdated",t)}"$apply"!==n.$scope.$root.$$phase&&"$digest"!==n.$scope.$root.$$phase&&n.$scope.$apply()},this.scope=e,e.vm=this,e.showMenu=!1,this.initRelations()}return e.prototype.selectRelation=function(e){this.$layerService.selectFeature(e.target),this.$mapService.zoomTo(e.target)},e.prototype.createNearbyRelation=function(e){var i=new t,a=this.$layerService.activeMapRenderer.getZoom();if(11>a)return i;this.$translate("NEARBY_FEATURES").then(function(e){i.title=e}),i.id=csComp.Helpers.getGuid(),i.relations=[];var o=this.$mapService.map.getBounds(),s=!1;if(this.$layerService.project.features.every(function(t){if(t.id!==e.id&&("Point"===t.geometry.type&&o.contains(new L.LatLng(t.geometry.coordinates[1],t.geometry.coordinates[0]))||"Polygon"===t.geometry.type&&o.contains(new L.LatLng(t.geometry.coordinates[0][0][1],t.geometry.coordinates[0][0][0])))){var a=new r;a.subject=e,a.target=t,a.title=csComp.Helpers.featureTitle(t.fType,t),a.icon=!t.fType||!t.fType.style||!t.fType.style.hasOwnProperty("iconUri")||t.fType.style.iconUri.toLowerCase().indexOf("_media")>=0?"":csComp.Helpers.convertStringFormat(t,t.fType.style.iconUri),i.relations.push(a)}return i.relations.length>40?(s=!0,!1):!0}),s)return i.relations.length=0,i;var n;return"Point"===e.geometry.type?n=new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]):"Polygon"===e.geometry.type&&(n=new L.LatLng(e.geometry.coordinates[0][0][1],e.geometry.coordinates[0][0][0])),n&&i.relations.sort(function(e,t){var r,i;return"Point"===e.target.geometry.type&&(r=new L.LatLng(e.target.geometry.coordinates[1],e.target.geometry.coordinates[0])),"Polygon"===e.target.geometry.type&&(r=new L.LatLng(e.target.geometry.coordinates[0][0][1],e.target.geometry.coordinates[0][0][0])),"Point"===t.target.geometry.type&&(i=new L.LatLng(t.target.geometry.coordinates[1],t.target.geometry.coordinates[0])),"Polygon"===t.target.geometry.type&&(i=new L.LatLng(t.target.geometry.coordinates[0][0][1],t.target.geometry.coordinates[0][0][0])),r&&i?n.distanceTo(r)-n.distanceTo(i):void 0}),i.relations.length>10&&i.relations.splice(10),i},e.prototype.initRelations=function(){this.relations=[];var e=this.$layerService.lastSelectedFeature;if(e.fType){this.$scope.title=csComp.Helpers.featureTitle(e.fType,e),!e.fType||!e.fType.style||!e.fType.style.hasOwnProperty("iconUri")||e.fType.style.iconUri.toLowerCase().indexOf("_media")>=0?this.$scope.icon="":this.$scope.icon=csComp.Helpers.convertStringFormat(e,e.fType.style.iconUri);var i=csComp.Helpers.getPropertyTypes(e.fType,this.$layerService.propertyTypeData);for(var a in i){var o=i[a];if("relation"===o.type){var s=new t;s.title=o.title,s.id=csComp.Helpers.getGuid(),s.relations=[],o.target&&(this.$layerService.project.features.forEach(function(t){if(e.properties.hasOwnProperty(o.subject)&&t.properties.hasOwnProperty(o.target)&&t.properties[o.target]===e.properties[o.subject]&&e.id!==t.id){var i=new r;i.subject=e,i.target=t,i.title=csComp.Helpers.featureTitle(t.fType,t),i.icon=!t.fType||!t.fType.style||!t.fType.style.hasOwnProperty("iconUri")||t.fType.style.iconUri.toLowerCase().indexOf("_media")>=0?"":t.fType.style.iconUri,s.relations.push(i)}}),s.relations.length>0&&(o.count=0,s.relations.forEach(function(t){t.target.fType.name===e.fType.name&&(o.count+=1)}))),s.relations.length>0&&this.relations.push(s)}}var n=this.createNearbyRelation(e);n.relations.length>0&&this.relations.push(n),this.showRelations=this.relations.length>0,this.showRelations?$("#linkedData").show():$("#linkedData").hide()}},e.prototype.getRelations=function(){return this.relations},e.$inject=["$scope","$location","$sce","mapService","layerService","messageBusService","$translate"],e}();e.FeatureRelationsCtrl=i}(FeatureRelations||(FeatureRelations={}));var FilterList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("filterList",["$window","$compile",function(t,r){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/FilterList/FilterList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!1,transclude:!1,controller:e.FilterListCtrl}}]).directive("bsPopover",function(){return function(e,t,r){t.find("a[rel=popover]").popover({placement:"right",html:"true"})}})}(FilterList||(FilterList={}));var FilterList;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,e.vm=this,this.noFilters=!0,this.locationFilterActive=!1,this.$messageBus.subscribe("filters",function(e){console.log("update filters"),i.noFilters=!0,i.locationFilterActive=!1,i.$layerService.project.groups.forEach(function(e){e.filters.length>0&&i.noFilters&&(i.noFilters=!1),e.filters.forEach(function(e){"location"===e.filterType&&i.locationFilterActive===!1&&(i.locationFilterActive=!0)})})})}return e.prototype.setLocationFilter=function(e){this.locationFilterActive||this.$layerService.setLocationFilter(e)},e.$inject=["$scope","layerService","messageBusService"],e}();e.FilterListCtrl=t}(FilterList||(FilterList={}));var IdvEdit;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}var i=function(){function e(e,t,r,i){this.$scope=e,this.$mapService=t,this.$layerService=r,this.$messageBusService=i,this.scope=e,e.vm=this,this.scan=e.$parent.data,console.log(this)}return e.prototype.toggleChart=function(e){e.enabled=!e.enabled},e.prototype.update=function(){this.scan.updateCharts()},e.prototype.reset=function(){alert("reset")},e.prototype["export"]=function(){this.scan.exportCsv()},e.$inject=["$scope","mapService","layerService","messageBusService"],e}();e.IdvEditCtrl=i,e.myModule.directive("idvedit",["$window","$compile",function(e,t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/IdvHelper/IdvEdit.tpl.html",link:function(e,t,r){},replace:!1,transclude:!1,controller:i}}])}(IdvEdit||(IdvEdit={}));var Idv;!function(e){var t=function(){function e(){this.defaultWidth=180}return e.prototype.reduceAddSum=function(e){return function(t,r){return++t.count,e.forEach(function(e){var i=parseFloat(r[e]);i>t.max&&(t.max=i),t[e]+=i}),t}},e.prototype.reduceRemoveSum=function(e){return function(t,r){return--t.count,e.forEach(function(e){var i=parseFloat(r[e]);i>t.max&&(t.max=i),t[e]-=i}),t}},e.prototype.reduceInitSum=function(e){var t={};return e.forEach(function(e){t[e]=0}),t},e.prototype.reduceAddAvg=function(e){return function(t,r){++t.count;var i=parseFloat(r[e]);return i>t.max&&(t.max=i),t.sum+=i,t.avg=t.sum/t.count,t}},e.prototype.reduceRemoveAvg=function(e){return function(t,r){return--t.count,t.sum-=parseFloat(r[e]),t.avg=t.sum/t.count,t}},e.prototype.reduceInitAvg=function(){return{count:0,sum:0,avg:0,max:0}},e.prototype.stop=function(){this.ndx=null},e.prototype.updateCharts=function(){var e=this;this.gridster&&($("#"+this.config.containerId).empty(),this.gridster.destroy()),$(".chart-title").css("visibility","visible");this.gridster=$("#"+this.config.containerId).gridster({widget_margins:[5,5],widget_base_dimensions:[this.defaultWidth-20,125],min_cols:6,resize:{enabled:!1},autogrow_cols:!0,draggable:{handle:"header"}}).data("gridster"),this.ndx=crossfilter(this.data),this.config.charts&&this.config.charts.forEach(function(t){e.addChart(t)}),dc.renderAll(),this.triggerFilter(this.config.charts[0]),"$apply"!==this.scope.$root.$$phase&&"$digest"!==this.scope.$root.$$phase&&this.scope.$apply()},e.prototype.loadDataSource=function(e){e()},e.prototype.resize=function(){$("#g-parent").css("height",$(window).height()-100),$("#g-parent").css("width",$(window).width()-100)},e.prototype.loadData=function(e,t){var r=this,i="records3";async.series([function(e){"undefined"!=typeof r.config.config?d3.json(r.config.config,function(t,i){t||(r.enums=i.Enums),e()}):e()},function(a){if(r.state="Laden data",window.indexedDB)if(r.config.localStorage){var o=window.indexedDB.open(r.config.data,9);o.onerror=function(e){window.indexedDB.deleteDatabase(r.config.data)},o.onsuccess=function(o){var s=event.target.result;if(s.objectStoreNames.contains(i)){var n=[];async.series([function(e){s.transaction(i,"readonly").objectStore(i).openCursor().onsuccess=function(t){var r=t.target.result;if(r){var i=r.value;i.data.forEach(function(e){return n.push(e)}),r["continue"]()}else e()}},function(a){n.length>0?(r.parseData(n,e,t),a()):(r.state="Verversen data",d3.csv(r.config.data,function(o,n){r.state="Opslaan data";var c=s.transaction(i,"readwrite").objectStore(i),l=[],p=0;n.forEach(function(e){l.push(e),l.length>1e5&&(c.add({id:p,data:l}),l=[],p+=1)}),r.parseData(n,e,t),a()}))}],function(e){a()})}else s.close()},o.onupgradeneeded=function(e){var t=event.target.result;t.createObjectStore(i,{keyPath:"id"})}}else d3.csv(r.config.data,function(i,o){r.parseData(o,e,t),a()});else window.alert("Deze browser is verouderd. Hierdoor zal de informatie trager laden")}],function(e){})},e.prototype.initCharts=function(e,t,r,i){var a=this;this.layerService=t,this.scope=e,this.state="Laden configuratie",this.resize(),this.config.refreshTimer&&setInterval(function(){a.loadData(r,i)},this.config.refreshTimer),this.loadData(r,i),$(window).resize(function(){a.resize()})},e.prototype.parseData=function(e,t,r){this.state="Verwerken data","$apply"!==this.scope.$$phase&&"$digest"!==this.scope.$$phase&&this.scope.$apply(),this.data=e,this.DataLoaded=!0,t(this.enums,e),this.updateCharts(),r()},e.prototype.reset=function(e){var t=_.findWhere(this.config.charts,{id:e});_.isUndefined(t)||(t.chart.filterAll(),dc.renderAll())},e.prototype.resetAll=function(){this.config.charts.forEach(function(e){_.isUndefined(e.chart)||e.chart.filterAll()}),dc.renderAll()},e.prototype.savePng=function(e,t){domtoimage.toPng(document.querySelector("#"+t)).then(function(t){csComp.Helpers.saveImage(t,e,"png")})["catch"](function(e){this.layerService.$messageBusService.notify("Error saving chart","When saving charts, only the latest version of chrome is supported")})},e.prototype.exportCsv=function(){this.layerService.$messageBusService.notify("Export to CSV","Export started, your download will start in a little while");var e=this.config.charts[0].dimension.filterAll().top(1/0),t=d3.csv.format(e),r=new Blob([t],{type:"text/plain;charset=utf-8"});saveAs(r,this.config.title+"_export.csv")},e.prototype.hasFilter=function(e){return!0},e.prototype.addSearchWidget=function(e){var t=this;this.createGridsterItem(e),e.dimension=this.ndx.dimension(function(t){return t.hasOwnProperty(e.property)?t[e.property]:null});var r="<input class='searchbutton' id='#"+e.id+"'></input><div id='data-count'><span class='filter-count'></span> geselecteerd van de <span class='total-count'></span> "+e.record+"</div>";$("#"+e.elementId).html(r),$(".searchbutton").keyup(function(r){var i=r.target.id.replace("#",""),a=r.target.value;if(!_.isUndefined(a)){var o=_.findWhere(t.config.charts,{id:i});_.isUndefined(o)||(o.dimension.filterFunction(function(e){return null!=e&&"function"==typeof e.toLowerCase?e.toLowerCase().indexOf(a.toLowerCase())>-1:!1}),o.dimension.top(1/0),dc.redrawAll()),t.triggerFilter(e)}});var i=this.ndx.groupAll();dc.dataCount("#data-count").dimension(this.ndx).group(i)},e.prototype.addSumCompare=function(e){this.createGridsterItem(e);var t=function(t){try{var r={width:200,height:200,data:[{name:"table",values:t,transform:[{type:"pie",field:"value"}]}],scales:[{name:"r",type:"sqrt",domain:{data:"table",field:"value"},range:[20,100]},{name:"color",type:"ordinal",domain:{data:"table",field:"position"},range:"category20"}],marks:[{type:"arc",from:{data:"table"},properties:{enter:{x:{field:{group:"width"},mult:.5},y:{field:{group:"height"},mult:.5},startAngle:{field:"layout_start"},endAngle:{field:"layout_end"},innerRadius:{value:20},outerRadius:{scale:"r",field:"value"},stroke:{value:"#fff"}},update:{fill:{scale:"color",field:"position"}},hover:{fill:{value:"pink"}}}},{type:"text",from:{data:"table"},properties:{enter:{x:{field:{group:"width"},mult:.5},y:{field:{group:"height"},mult:.5},radius:{scale:"r",field:"value",offset:8},theta:{field:"layout_mid"},fill:{value:"#000"},align:{value:"center"},baseline:{value:"middle"},text:{field:"title"}}}},{type:"text",from:{data:"table"},properties:{enter:{x:{field:{group:"width"},mult:.5},y:{field:{group:"height"},mult:.5,offset:-10},radius:{scale:"r",field:"value",offset:8},theta:{field:"layout_mid"},fill:{value:"#000"},align:{value:"center"},baseline:{value:"middle"},text:{field:"value"}}}}]};if(r){vg.embed("#"+e.elementId,r,function(t,r){e._view=t,$("#"+e.elementId).css("margin-left","30px")})}}catch(i){}};t([]),e.filtered=function(r){var i={};e.properties.forEach(function(e){return i[e]=0}),r.forEach(function(t){e.properties.forEach(function(e){t.hasOwnProperty(e)&&(i[e]+=Math.round(+t[e]))})});var a=[],o=0;for(var s in i)i[s]>0&&a.push({title:s,value:i[s],position:o}),o+=1;t(a)}},e.prototype.addLayerLink=function(e){var t=this;e.dimension=this.ndx.dimension(function(t){return t[e.property]}),e.group=e.dimension.group().reduceCount(),e.filtered=function(r){if(!_.isUndefined(e.layer)){var i=t.layerService.findLayer(e.layer);if(!_.isUndefined(i)&&i.enabled){var a={};i.data.features.forEach(function(t){t.properties.hasOwnProperty(e.featureProperty)&&(a[t.properties[e.featureProperty]]=t),delete t.properties[e.featureTargetProperty]});var o=e.group.all();o.forEach(function(t){if(a.hasOwnProperty(t.key)){var r=a[t.key];r.properties[e.featureTargetProperty]=t.value}}),t.layerService.updateLayerFeatures(i),i.group.styles.forEach(function(e){t.layerService.removeStyle(e)}),t.layerService.setStyleForProperty(i,e.featureTargetProperty)}}console.log("do filter with result")}},e.prototype.addChartItem=function(t){var r=this;switch(this.createGridsterItem(t),t.stat||(t.stat="count"),t.stat){case"sum":switch(t.dimension=this.ndx.dimension(function(e){return e[t.property]}),t.group=t.dimension.group().reduceSum(function(e){return{totaal_mensen_auto:+e[t.property]}}),t.type){case"pie":t.dimension=this.ndx.dimension(function(e){return e}),t.group=t.dimension.group().reduce(this.reduceAddSum(t.properties),this.reduceRemoveSum(t.properties),this.reduceInitSum(t.properties))}break;case"average":switch(t.type){case"row":t.dimension=this.ndx.dimension(function(e){return e[t.property]}),t.group=t.dimension.group().reduce(this.reduceAddAvg(t.secondProperty),this.reduceRemoveAvg(t.secondProperty),this.reduceInitAvg);break;case"line":case"bar":t.dimension=this.ndx.dimension(function(e){return e[t.time]}),t.group=t.dimension.group().reduce(this.reduceAddAvg(t.property),this.reduceRemoveAvg(t.property),this.reduceInitAvg);case"time":t.dimension=this.ndx.dimension(function(e){return e[t.time]}),t.group=t.dimension.group().reduce(this.reduceAddAvg(t.property),this.reduceRemoveAvg(t.property),this.reduceInitAvg)}break;case"pie":t.dimension=t.dimension,t.group=t.group;break;case"scatter":t.dimension=this.ndx.dimension(function(e){var r=+e[t.property];return r}),t.group=t.dimension.group();break;case"time":t.dimension=this.ndx.dimension(function(e){return e[t.time]});break;case"group":t.bins||(t.bins=20);var i=t.bins,a=d3.extent(this.data,function(e){return parseFloat(e[t.property])}),o=(a[1]-a[0])/i;t.dimension=this.ndx.dimension(function(e){var r=Math.floor(parseFloat(e[t.property])/o)*o;return r}),t.group=t.dimension.group().reduceCount();break;case"count":t.dimension=this.ndx.dimension(function(e){return e[t.property]}),t.group=t.dimension.group().reduceCount()}var s=t.width*this.defaultWidth-25,n=125*t.height-25;switch(t.type){case"table":var c=[];t.columns.forEach(function(e){c.push({label:e.title,format:function(t){return e.hasOwnProperty("type")&&"number"===e.type?d3.round(t[e.property],1):t[e.property]}})}),console.log("table:"+t.elementId),$("#"+t.elementId).addClass("widget-scrollable"),t.chart=dc.dataTable("#"+t.elementId),t.chart.width(s).height(n).dimension(t.dimension).group(function(e){e[t.time];return""}).size(1e3).columns(c);break;case"time":t.chart=dc.lineChart("#"+t.elementId),t.chart.width(s).height(n).x(d3.time.scale().domain([new Date(2011,0,1),new Date(2016,11,31)])).elasticX(!0).elasticY(!0).mouseZoomable(!0).renderHorizontalGridLines(!0).brushOn(!0).dimension(t.dimension).group(function(e){return e[t.time]}).renderHorizontalGridLines(!0).on("renderlet",function(e){e.selectAll("rect").on("click",function(e){})});break;case"line":t.chart=dc.lineChart("#"+t.elementId),t.chart.width(s).height(n).x(d3.scale.linear()).elasticX(!0).elasticY(!0).renderHorizontalGridLines(!1).dimension(t.dimension).group(t.group).mouseZoomable(!0).on("renderlet",function(e){e.selectAll("rect").on("click",function(e){})});break;case"pie":t.chart=dc.pieChart("#"+t.elementId),t.chart.width(s).height(n).slicesCap(10).innerRadius(10).dimension(t.dimension).group(t.group);break;case"bar":t.chart=dc.barChart("#"+t.elementId),t.chart.width(s).height(n).x(d3.scale.linear()).centerBar(!0).xUnits(function(){return 20}).elasticX(!0).elasticY(!0).renderHorizontalGridLines(!0).dimension(t.dimension).group(t.group);break;case"stackedbar":t.chart=dc.barChart("#"+t.elementId),t.chart.width(s).height(n).x(d3.scale.linear()).centerBar(!1).xUnits(function(){return 20}).elasticX(!0).elasticY(!0).renderHorizontalGridLines(!0).dimension(t.dimension).group(t.group);break;case"scatter":t.chart=dc.scatterPlot("#"+t.elementId),t.chart.width(s).height(n).symbolSize(3).x(d3.scale.linear()).y(d3.scale.linear()).elasticX(!0).elasticY(!0).dimension(t.dimension).group(t.group);break;case"row":switch(t.chart=dc.rowChart("#"+t.elementId),t.chart.width(s).height(n).gap(1).elasticX(!0).dimension(t.dimension).group(t.group).xAxis().ticks(4),t.ordering||(t.ordering="value"),t.ordering){case"days":t.chart.ordering(function(t){return e.days_en.indexOf(t.key)});break;case"months":t.chart.ordering(function(t){return e.months.indexOf(t.key)});break;case"value":t.chart.ordering(function(e){return-e.value})}t.cap&&t.chart.cap(t.cap)}!_.isUndefined(t.xaxis)&&_.isFunction(t.chart.xAxisLabel)&&t.chart.xAxisLabel(t.xaxis),!_.isUndefined(t.yaxis)&&_.isFunction(t.chart.yAxisLabel)&&t.chart.yAxisLabel(t.yaxis),t.marginLeft&&(t.chart.margins().left=t.marginLeft),t.chart.on("filtered",function(e,i){r.triggerFilter(t)}),"average"===t.stat&&t.chart.valueAccessor(function(e){return e.value.avg}),console.log("Add chart "+t.title)},e.prototype.triggerFilter=function(e){var t=e.dimension.top(1/0);this.config.charts.forEach(function(e){!_.isUndefined(e.filtered)&&_.isFunction(e.filtered)&&e.filtered(t)})},e.prototype.createGridsterItem=function(e){var t=this,r="<li id='li"+e.id+"'  style='padding:4px'><header class='chart-title'><div class='fa fa-ellipsis-v dropdown-toggle' data-toggle='dropdown'  style='float:right;cursor:pointer' type='button'></div>";r+="<ul class='dropdown-menu pull-right'><li class='dropdown-item'><a ng-click=\"resetFilter('"+e.id+"')\"'>reset filter</a></li><li class='dropdown-item'><a ng-click=\"resetAll()\">reset all filters</a></li><li class='dropdown-item'><a ng-click=\"disableFilter('"+e.id+"')\">disable filter</a></li><li class='dropdown-item'><a ng-click=\"savePng('"+e.title+"','"+e.elementId+"')\"'>save image</a></li>",r+="</ul>"+e.title+"</header><div id='"+e.elementId+"' ></li>",this.scope.resetFilter=function(e){t.reset(e)},this.scope.resetAll=function(){t.resetAll()},this.scope.savePng=function(e,r){t.savePng(e,r)},this.scope.disableFilter=function(e){var r=_.findWhere(t.config.charts,{id:e
});_.isUndefined(r)||(r.enabled=!1,t.updateCharts())};var i=this.layerService.$compile(r)(this.scope);this.gridster.add_widget(i,e.width,e.height)},e.prototype.addChart=function(e){if("undefined"==typeof e.enabled&&(e.enabled=!0),e.enabled)switch(e.id||(e.id=csComp.Helpers.getGuid()),e.containerId||(e.containerId=this.config.containerId),e.elementId="ddchart-"+e.id,e.title||(e.title=e.property),e.type||(e.type="row"),e.type){case"search":this.addSearchWidget(e);break;case"layer":this.addLayerLink(e);break;case"sumcompare":this.addSumCompare(e);break;default:this.addChartItem(e)}},e.days_nl=["zondag","maandag","dinsdag","woensdag","donderdag","vrijdag","zaterdag"],e.days_en=["sunday","monday","tuesday","wednesday","thursday","friday","saterday"],e.months=["jan","feb","mar","apr","may","jun","jul","aug","sep","okt","nov","dec"],e}();e.Idv=t}(Idv||(Idv={}));var Heatmap;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("heatmap",["$window","$compile",function(t,r,i){return{terminal:!0,restrict:"EA",scope:{},templateUrl:"directives/Heatmap/Heatmap.tpl.html",compile:function(e){var t=r(e);return function(e){t(e)}},replace:!0,transclude:!0,controller:e.HeatmapCtrl}}])}(Heatmap||(Heatmap={}));var Heatmap;!function(e){"use strict";var t=function(){function t(e,r,i,a,o,s,n,c){var l=this;this.$scope=e,this.$modal=r,this.$translate=i,this.$timeout=a,this.$localStorageService=o,this.$layerService=s,this.$mapService=n,this.messageBusService=c,this.heatmap=L.geoJson([]),this.heatmapModels=[],this.expertMode=!0,this.moveListenerInitialized=!1,this.projLayer=new csComp.Services.ProjectLayer,e.vm=this,c.subscribe("layer",function(e,t){switch(e){case"deactivate":t.type&&"heatmap"===t.type&&t.id===l.projLayer.id&&t!=l.projLayer&&(l.$layerService.removeLayer(l.projLayer),delete l.heatmapModel,l.initializeHeatmap());break;case"activated":t.type&&"heatmap"===t.type&&l.updateAvailableHeatmaps(),t.type&&"geojson"===t.type&&l.heatmapModel&&l.heatmapModel.heatmapSettings.referenceList.length>0&&t.reference&&t.reference==l.heatmapModel.heatmapSettings.referenceList[l.heatmapModel.heatmapSettings.referenceList.length-1]&&l.updateHeatmap()}}),c.subscribe("project",function(e){switch(e){case"loaded":l.expertMode=null!=s.project&&s.project.hasOwnProperty("userPrivileges")&&s.project.userPrivileges.hasOwnProperty("heatmap")&&s.project.userPrivileges.heatmap.hasOwnProperty("expertMode")&&s.project.userPrivileges.heatmap.expertMode,l.updateAvailableHeatmaps(),l.initializeHeatmap()}}),i("HEATMAP.DELETE_MSG").then(function(e){t.confirmationMsg1=e}),i("HEATMAP.DELETE_MSG2").then(function(e){t.confirmationMsg2=e})}return t.prototype.updateAvailableHeatmaps=function(){var t=this;if(this.heatmapModel){for(var r=0;r<this.heatmapModels.length;r++)if(this.heatmapModel.id==this.heatmapModels[r].id){this.heatmapModels.splice(r,1);break}this.heatmapModels.push(this.heatmapModel)}else this.heatmapModels=[],this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(r){r.layers.forEach(function(r){if("heatmap"===r.type){var i=new e.HeatmapModel(r.title);i.deserialize(r),t.heatmapModels.push(i),r.enabled&&(t.heatmapModel=i)}})})},t.prototype.createHeatmap=function(){this.heatmapModel=new e.HeatmapModel("Heatmap"),this.projLayer.data&&this.$layerService.removeLayer(this.projLayer),this.projLayer.type="heatmap",this.projLayer.renderType="heatmap",this.projLayer.enabled=!0,this.projLayer.group=new csComp.Services.ProjectGroup,this.projLayer.group.oneLayerActive=!0,this.projLayer.group.layers=[],this.projLayer.group.filters=[],this.projLayer.group.styles=[],this.projLayer.group.markers=[],this.projLayer.heatmapSettings=new e.HeatmapSettings,this.projLayer.heatmapItems=[],this.projLayer.id=csComp.Helpers.getGuid(),this.projLayer.quickRefresh=!1,this.heatmap=L.geoJson([]),this.showHeatmapEditor(this.heatmapModel)},t.prototype.editHeatmap=function(e){this.showHeatmapEditor(e)},t.prototype.exportHeatmap=function(e){var t=this;this.heatmapModel.heatmapSettings.referenceList=[],this.heatmapModel.heatmapItems.forEach(function(e){e.isSelected&&t.$layerService.project.groups.forEach(function(e){"Features"==e.title&&e.layers.forEach(function(e){e.enabled&&t.heatmapModel.heatmapSettings.addReference(e.reference)})})}),console.log("\n-----------------\nExported heatmap starts here: \n"),console.log(e.serialize()),console.log("\n-----------------\nExported heatmap ends here. \n"),this.messageBusService.notify("Heatmap exported successfully","Your heatmap was exported to the console successfully.",csComp.Services.NotifyLocation.TopLeft)},t.prototype.removeHeatmap=function(e){var r=this;if(e){var i=String.format(t.confirmationMsg1,e.title);this.messageBusService.confirm(i,t.confirmationMsg2,function(t){t&&r.$timeout(function(){r.deleteHeatmap(e),r.updateAvailableHeatmaps()},0)}),this.scopeApply()}},t.prototype.deleteHeatmap=function(e){var t=this;if(e){var r=this.heatmapModels.indexOf(e);r>=0&&this.heatmapModels.splice(r,1),this.$layerService.removeLayer(this.projLayer),this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(e){e.layers.forEach(function(e){"heatmap"===e.type&&e.id===t.projLayer.id&&t.$layerService.removeLayer(e)})}),delete this.heatmapModel,delete this.projLayer,this.projLayer=new csComp.Services.ProjectLayer,this.initializeHeatmap()}},t.prototype.showHeatmapEditor=function(t){var r=this,i=this.$modal.open({templateUrl:"directives/Heatmap/HeatmapEditorView.tpl.html",controller:e.HeatmapEditorCtrl,resolve:{heatmap:function(){return t}}});i.result.then(function(e){r.heatmapModel=e;var t=r.heatmapModels.indexOf(e);t>=0&&r.heatmapModels.splice(t,1),r.heatmapModels.push(e),r.updateHeatmap(),console.log("Updated heatmap")},function(){console.log("Modal dismissed at: "+new Date),delete r.heatmapModel})},t.prototype.scopeApply=function(){"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},t.prototype.getVotingClass=function(e){return null==e||null==this.heatmapModel||0===e.userWeight||e.userWeight<-5||e.userWeight>5?"disabledHeatmap":e.userWeight>0?"prefer":"avoid"},t.prototype.weightUpdated=function(){this.heatmapModel&&(this.heatmapModel.updateWeights(),this.projLayer.quickRefresh=!0,this.$layerService.addLayer(this.projLayer))},t.prototype.intensityScaleUpdated=function(){this.heatmapModel&&this.updateHeatmapWithoutRerendering()},t.prototype.resolutionUpdated=function(){this.heatmapModel&&this.updateHeatmap()},t.prototype.updateHeatmapWithoutRerendering=function(){this.projLayer.quickRefresh=!0,this.$layerService.addLayer(this.projLayer)},t.prototype.updateHeatmap=function(){var e=this;if(this.heatmapModel){this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(t){t.layers.forEach(function(t){"heatmap"===t.type&&t.id===e.heatmapModel.id&&t.mapLayer&&(e.$layerService.map.map.removeLayer(t.mapLayer),t.enabled=!0)})}),this.projLayer.quickRefresh=!1,this.projLayer.heatmapItems=this.heatmapModel.heatmapItems,this.projLayer.heatmapSettings=this.heatmapModel.heatmapSettings,this.projLayer.id=this.heatmapModel.id;var t=this.$mapService.getMap().getZoom();if(t<this.heatmapModel.heatmapSettings.minZoom||t>this.heatmapModel.heatmapSettings.maxZoom)return console.log("Heatmap is not supported for the current zoom level."),void this.$layerService.loadRequiredLayers(this.projLayer);this.$layerService.removeLayer(this.projLayer),this.$layerService.addLayer(this.projLayer)}},t.prototype.initializeHeatmap=function(){var t=this;this.projLayer.type="heatmap",this.projLayer.renderType="heatmap",this.projLayer.enabled=!1,this.projLayer.group=new csComp.Services.ProjectGroup,this.projLayer.group.oneLayerActive=!0,this.projLayer.group.layers=[],this.projLayer.group.filters=[],this.projLayer.group.styles=[],this.projLayer.group.markers=[],this.projLayer.mapLayer=new L.LayerGroup,this.projLayer.heatmapSettings=new e.HeatmapSettings,this.projLayer.heatmapItems=[],this.projLayer.data=JSON,this.projLayer.id="",this.projLayer.quickRefresh=!1,this.moveListenerInitialized||(this.$layerService.map.map.addEventListener("moveend",function(e){t.updateHeatmap()}),this.moveListenerInitialized=!0)},t.$inject=["$scope","$uibModal","$translate","$timeout","localStorageService","layerService","mapService","messageBusService"],t}();e.HeatmapCtrl=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){"use strict";var t=function(){function t(t,r,i,a,o,s){var n=this;this.$scope=t,this.$modalInstance=r,this.$layerService=i,this.$translate=a,this.messageBusService=o,this.heatmap=s,this.scoringFunctions=[],t.vm=this,this.scoringFunctions.push(new e.ScoringFunction(e.ScoringFunctionType.LinearAscendingDescending)),a("HEATMAP.LINEAR_ASC_DESC").then(function(e){n.scoringFunctions[0].title=e}),this.dataset=csComp.Helpers.loadMapLayers(i),s||(s=new e.HeatmapModel("Heatmap"));for(var c in this.dataset.featureTypes)if(this.dataset.featureTypes.hasOwnProperty(c)){var l=this.dataset.featureTypes[c];s.addHeatmapItem(new e.HeatmapItem(l.name,l));if(!l._propertyTypeData)continue;l._propertyTypeData.forEach(function(t){if("options"==t.type){var r=0;for(var i in t.options){var a=t.options[i],o=new e.HeatmapItem(a,l);o.propertyLabel=t.label,o.propertyTitle=t.title,o.optionIndex=r++,s.addHeatmapItem(o)}}})}}return t.prototype.save=function(){this.$modalInstance.close(this.heatmap)},t.prototype.cancel=function(){this.$modalInstance.dismiss("cancel")},t.prototype.toggleItemDetails=function(e){this.showItem=this.showItem==e?-1:e,console.log("Toggle item")},t.$inject=["$scope","$modalInstance","layerService","$translate","messageBusService","heatmap"],t}();e.HeatmapEditorCtrl=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){var t=function(){function t(t,r,i,a,o,s,n,c,l){void 0===i&&(i=0),void 0===a&&(a=1),void 0===o&&(o=!1),void 0===s&&(s=new e.IdealityMeasure),this.title=t,this.featureType=r,this.weight=i,this.userWeight=a,this.isSelected=o,this.idealityMeasure=s,this.propertyTitle=n,this.propertyLabel=c,this.optionIndex=l,this.heatspots=[],this.setScale(52)}return t.serializeableData=function(e){return{title:e.title,featureType:e.featureType,propertyTitle:e.propertyTitle,propertyLabel:e.propertyLabel,optionIndex:e.optionIndex,userWeight:e.userWeight,weight:e.weight,idealityMeasure:e.idealityMeasure,isSelected:e.isSelected}},t.prototype.calculateHeatspots=function(e,t,r,i,a,o,s){return this.isSelected&&this.featureType.name.replace("_Default","")===e.fType.name?(0===this.heatspots.length&&this.calculateHeatspot(t,r),this.propertyLabel?e.properties.hasOwnProperty(this.propertyLabel)&&e.properties[this.propertyLabel]===this.optionIndex?this.pinHeatspotToGrid(e,i,a,o,s):null:this.pinHeatspotToGrid(e,i,a,o,s)):null},t.prototype.calculateHeatspot=function(t,r){var i=this.idealityMeasure.lostInterestDistance,a=Math.floor(i/t),o=Math.floor(i/r),s=t*r,n=a*o;this.heatspots=new Array(n),this.heatspots.push(new e.Heatspot(0,0,this.idealityMeasure.atLocation));for(var c=-o;o>=c;c++)for(var l=-a;a>=l;l++){var p=Math.sqrt(c*c*s+l*l*s),u=this.idealityMeasure.computeIdealityAtDistance(p);0==c&&0==l||0==u||this.heatspots.push(new e.Heatspot(c,l,u))}},t.prototype.pinHeatspotToGrid=function(e,t,r,i,a){if("Point"!==e.geometry.type)return null;var o=new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]),s=i.pad(a);if(!s.contains(o))return null;var n=[],c=Math.floor((o.lng-i.getNorthWest().lng)/(i.getNorthEast().lng-i.getNorthWest().lng)*t),l=Math.floor((o.lat-i.getSouthWest().lat)/(i.getNorthWest().lat-i.getSouthWest().lat)*r);return this.heatspots.forEach(function(t){n.push(t.AddLocation(c,l,e.properties.Name))}),n},t.prototype.setScale=function(e){var r=csComp.Helpers.GeoExtensions.convertDegreesToMeters(e);t.meterToLatDegree=1/r.latitudeLength,t.meterToLonDegree=1/r.longitudeLength},t.prototype.select=function(){if(this.reset(),this.isSelected=!this.isSelected,this.isSelected)switch(this.featureType.style.drawingMode.toLowerCase()){case"point":case"image":this.idealityMeasure=new e.IdealityMeasure}else this.idealityMeasure=null},t.prototype.reset=function(){this.heatspots=[]},t.prototype.toString=function(){return this.propertyTitle?this.propertyTitle+"."+this.title+" ("+this.featureType.name+")":this.title},t.twoPi=2*Math.PI,t}();e.HeatmapItem=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){var t=function(){function t(t){this.title=t,this.heatmapItems=[],this.id="",this.horizCells=0,this.vertCells=0,this.cellWidth=0,this.cellHeight=0,this.dLat=0,this.dLng=0,this.title=t,this.heatmapSettings=new e.HeatmapSettings}return t.prototype.calculate=function(e,t,r){var i=this,a=(new Date).getTime();console.log("Calculating heatmap");var o=t.map.getBounds(),s=o.getNorthWest(),n=o.getNorthEast();this.SW=o.getSouthWest();var c=s.distanceTo(n),l=s.distanceTo(this.SW),p=csComp.Helpers.loadMapLayers(e),u=0;p.features.forEach(function(e){i.heatmapItems.forEach(function(e){e.idealityMeasure.lostInterestDistance>u&&(u=e.idealityMeasure.lostInterestDistance)})});var d,h=(c+2*u)/c,f=(l+2*u)/l,y=Math.max(h,f),m=c/l;switch(this.heatmapSettings.resolution){case 1:d=1e3;break;case 2:d=4e3;break;case 3:d=7e3;break;default:d=4e3}this.horizCells=Math.floor(Math.sqrt(d*m)),this.vertCells=Math.floor(this.horizCells/m),this.cellWidth=c/this.horizCells,this.cellHeight=l/this.vertCells,this.dLat=(n.lat-this.SW.lat)/this.vertCells,this.dLng=(n.lng-this.SW.lng)/this.horizCells;var g=0;this.intensityGrid=[],this.contributorGrid=[];for(var v=0;v<this.horizCells;v++){this.intensityGrid[v]=[],this.contributorGrid[v]=[];for(var S=0;S<this.vertCells;S++)this.intensityGrid[v][S]={},this.contributorGrid[v][S]={}}p.features.forEach(function(e){i.heatmapItems.forEach(function(t){var r=t.calculateHeatspots(e,i.cellWidth,i.cellHeight,i.horizCells,i.vertCells,o,y);r&&r.forEach(function(e){0!=e.intensity&&e.i>=0&&e.i<i.horizCells&&e.j>=0&&e.j<i.vertCells&&(i.intensityGrid[e.i][e.j].hasOwnProperty(t.toString())?i.intensityGrid[e.i][e.j][t.toString()]+=e.intensity:i.intensityGrid[e.i][e.j][t.toString()]=e.intensity,i.contributorGrid[e.i][e.j][e.contributor]=e.intensity,g+=1)})})});var b=(new Date).getTime();console.log("Created "+g+" heatspots in "+(b-a).toFixed(1)+" ms"),this.drawIntensityGrid(r);var $=(new Date).getTime();console.log("Calculated "+v*S+" cells in "+($-a).toFixed(1)+" ms")},t.prototype.drawIntensityGrid=function(e){var t=this.heatmapSettings.intensityScale/3*(this.heatmapSettings.intensityScale/3);e.clearLayers();var r={};this.heatmapItems.forEach(function(e){r[e.toString()]=e.weight});for(var i=0;i<this.horizCells;i++)for(var a=0;a<this.vertCells;a++){var o=0;for(var s in this.intensityGrid[i][a])this.intensityGrid[i][a].hasOwnProperty(s)&&(o+=r[s]*this.intensityGrid[i][a][s]);if(0!=o){var n=[[this.SW.lng+this.dLng*i,this.SW.lat+this.dLat*a],[this.SW.lng+this.dLng*(i+1),this.SW.lat+this.dLat*a],[this.SW.lng+this.dLng*(i+1),this.SW.lat+this.dLat*(a+1)],[this.SW.lng+this.dLng*i,this.SW.lat+this.dLat*(a+1)]],c={type:"Feature",geometry:{type:"Polygon",coordinates:[n]},properties:{Name:"Heatmap cell ("+i.toString()+", "+a.toString()+")",gridX:i,gridY:a,totalIntensity:(o*t).toFixed(3),contributors:JSON.stringify(this.contributorGrid[i][a],function(e,t){return t.toFixed?Number(t.toFixed(3)):t}),intensities:JSON.stringify(this.intensityGrid[i][a])}};e.addData(c)}}},t.prototype.updateWeights=function(){var e=0;this.heatmapItems.forEach(function(t){t.isSelected&&(e+=Math.abs(t.userWeight))}),this.heatmapItems.forEach(function(t){t.isSelected&&(0!=e?t.weight=t.userWeight/e:t.weight=0)})},t.prototype.addHeatmapItem=function(e){for(var t=e.featureType,r=e.title,i=0;i<this.heatmapItems.length;i++){var a=this.heatmapItems[i];if(a.featureType.name===t.name&&a.title===r)return}this.heatmapItems.push(e)},t.prototype.deserialize=function(t){var r=this;this.id=t.id;var i=t.heatmapSettings;this.heatmapSettings=new e.HeatmapSettings(i.referenceList,i.minZoom,i.maxZoom,i.intensityScale,i.resolution),this.heatmapItems=[];var a=t.heatmapItems;a.forEach(function(t){var i=new e.IdealityMeasure(t.idealityMeasure.idealDistance,t.idealityMeasure.atLocation,t.idealityMeasure.lostInterestDistance);if(t.propertyTitle)var a=new e.HeatmapItem(t.title,t.featureType,t.weight,t.userWeight,t.isSelected,i,t.propertyTitle,t.propertyLabel,t.optionIndex);else var a=new e.HeatmapItem(t.title,t.featureType,t.weight,t.userWeight,t.isSelected,i);r.addHeatmapItem(a)})},t.prototype.serialize=function(){var t=[];this.heatmapItems.forEach(function(r){if(r.isSelected){if(r.reset(),r.propertyTitle)var i=new e.HeatmapItem(r.title,{name:r.featureType.name},r.weight,r.userWeight,r.isSelected,r.idealityMeasure,r.propertyTitle,r.propertyLabel,r.optionIndex);else var i=new e.HeatmapItem(r.title,{name:r.featureType.name},r.weight,r.userWeight,r.isSelected,r.idealityMeasure);t.push(i)}});var r='{"id": "ID",\n"reference": "REFERENCE",\n"languages": {\n"nl": {"title": ';return r+=JSON.stringify(this.title),r+=',\n"description": "BESCHRIJVING"\n},\n"en": {"title": ',r+=JSON.stringify(this.title),r+=',\n"description": "DESCRIPTION"\n}\n},\n"description": "DESCRIPTION",\n',r+='"type":"Heatmap"',r+=',\n"heatmapSettings":'+JSON.stringify(this.heatmapSettings,null," "),r+=',\n"heatmapItems":',r+=JSON.stringify(t,null," "),r+=',\n"enabled":',r+=JSON.stringify(!1),r+=',\n"opacity":',r+=JSON.stringify(100),r+="\n}"},t}();e.HeatmapModel=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){var t=function(){function e(e,t,r,i,a){void 0===e&&(e=[]),void 0===t&&(t=10),void 0===r&&(r=15),void 0===i&&(i=3),void 0===a&&(a=2),this.referenceList=e,this.minZoom=t,this.maxZoom=r,this.intensityScale=i,this.resolution=a}return e.prototype.addReference=function(e){this.referenceList.indexOf(e)<0&&this.referenceList.push(e)},e}();e.HeatmapSettings=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){var t=function(){function e(e,t,r,i){this.i=e,this.j=t,this.intensity=r,this.contributor=i}return e.prototype.AddLocation=function(t,r,i){return new e(this.i+t,this.j+r,this.intensity,i)},e}();e.Heatspot=t}(Heatmap||(Heatmap={}));var Heatmap;!function(e){!function(e){e[e.LinearAscendingDescending=0]="LinearAscendingDescending"}(e.ScoringFunctionType||(e.ScoringFunctionType={}));var t=e.ScoringFunctionType,r=function(){function e(e){"undefined"!=typeof e&&null!=e&&(this.type=e),this.title=t[e].toString()}return Object.defineProperty(e.prototype,"cssClass",{get:function(){return t[this.type].toLowerCase()},enumerable:!0,configurable:!0}),e}();e.ScoringFunction=r;var i=function(){function e(){}return e}();e.ScoringFunctions=i;var a=function(){function e(e,t,r){void 0===e&&(e=500),void 0===t&&(t=.1),void 0===r&&(r=2e3),this.idealDistance=e,this.atLocation=t,this.lostInterestDistance=r}return e.prototype.computeIdealityAtDistance=function(e){var t=0;return e<this.idealDistance?t=this.atLocation>=1?1:this.atLocation+(1-this.atLocation)*e/this.idealDistance:e<this.lostInterestDistance&&(t=1-(e-this.idealDistance)/(this.lostInterestDistance-this.idealDistance)),t},e}();e.IdealityMeasure=a}(Heatmap||(Heatmap={}));var LanguageSwitch;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("languageSwitch",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/LanguageSwitch/LanguageSwitch.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.LanguageSwitchCtrl}}]).provider("$languages",function(){this.languages=[],this.$get=function(){return this.languages},this.setLanguages=function(e){this.languages=e}})}(LanguageSwitch||(LanguageSwitch={}));var LanguageSwitch;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.$translate=t,this.$languages=r,this.$layerService=i,this.$messageBus=a,e.vm=this;for(var o=0,s=0;s<r.length;s++)if(r[s].key===t.preferredLanguage()){o=s;break}this.language=r[o]}return e.prototype.switchLanguage=function(e){this.language=e,this.$translate.use(e.key),this.$messageBus.publish("language","newLanguage",e.key)},e.$inject=["$scope","$translate","$languages","layerService","messageBusService"],e}();e.LanguageSwitchCtrl=t}(LanguageSwitch||(LanguageSwitch={}));var KanbanBoard;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("kanbanboardEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/KanbanBoard/KanbanBoard-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function e(e,t,r,i,a,o,s,n){this.$scope=e,this.$timeout=t,this.$compile=r,this.$layerService=i,this.$templateCache=a,this.$messageBus=o,this.$mapService=s,this.$dashboardService=n,e.vm=this;var c=e.$parent;this.widget=c.data,this.propertyTypes=[];e.data=this.widget.data,this.allLayers=i.allLayers(),e.data&&e.data.columns&&e.data.columns.length>0&&(e.selectedColumn=e.data.columns[0]),console.log(e.data)}return e.prototype.selectColumn=function(){console.log(this.$scope.selectedColumn)},e.prototype.selectLayer=function(){console.log(this.layer),this.$messageBus.publish("typesource","","")},e.prototype.colorUpdated=function(e,t){t.color=e},e.$inject=["$scope","$timeout","$compile","layerService","$templateCache","messageBusService","mapService","dashboardService"],e}();e.KanbanBoardEditCtrl=i}(KanbanBoard||(KanbanBoard={}));var KanbanColumn;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("kanbanboard",[function(){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/KanbanBoard/KanbanBoard.tpl.html",replace:!1,transclude:!1,controller:e.KanbanBoardCtrl}}])}(KanbanColumn||(KanbanColumn={}));var KanbanColumn;!function(e){var t=function(){function e(){}return e}();e.KanbanConfig=t;var r=function(){function e(e,t,r){var i=this;if(this.$scope=e,this.$layerService=t,this.$messageBus=r,this.feeds=[],this.featureTypes={},e.vm=this,this.$scope.$root.hasOwnProperty("data"))this.kanban=this.$scope.$root.data;else{var a=e.$parent;this.kanban=a.widget.data}this.kanban.hasOwnProperty("canAdd")||(this.kanban.canAdd=!0),this.$messageBus.subscribe("typesource",function(e){i.initLayer()}),this.initLayer()}return e.prototype.addFeature=function(e){var t=new csComp.Services.Feature;t.properties={};var r=this.featureTypes[e];if(r.properties)for(var i in r.properties)t.properties[i]=JSON.parse(JSON.stringify(r.properties[i]));t.properties.date=new Date,t.properties.updated=new Date,t.properties.featureTypeId=e,t.properties.hasOwnProperty("Name")||(t.properties.Name=r.name),this.layer.data.features.push(t),this.$layerService.initFeature(t,this.layer),this.$layerService.editFeature(t)},e.prototype.initLayer=function(){if(console.log("kanban:loaded project"),this.kanban&&this.kanban.columns&&this.kanban.columns.length>0){var e=this.kanban.columns[0].filters.layerId;if(this.layer=this.$layerService.findLayer(e),this.layer&&this.layer.typeUrl&&this.$layerService.typesResources.hasOwnProperty(this.layer.typeUrl)){if(this.kanban.featureTypesToAdd){this.featureTypes={};for(var t in this.$layerService.typesResources[this.layer.typeUrl].featureTypes)this.kanban.featureTypesToAdd.indexOf(t)>-1&&(this.featureTypes[t]=this.$layerService.typesResources[this.layer.typeUrl].featureTypes[t])}else this.featureTypes=this.$layerService.typesResources[this.layer.typeUrl].featureTypes;console.log("feature types")}}},e.$inject=["$scope","layerService","messageBusService"],e}();e.KanbanBoardCtrl=r}(KanbanColumn||(KanbanColumn={}));var KanbanColumn;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("kanbanColumn",["$window","$compile",function(t,r){return{terminal:!0,restrict:"E",scope:{column:"=",layer:"=",providedlayer:"="},templateUrl:"directives/KanbanBoard/KanbanColumn.tpl.html",replace:!1,transclude:!1,controller:e.KanbanColumnCtrl}}])}(KanbanColumn||(KanbanColumn={}));var KanbanColumn;!function(e){var t=function(){function e(){}return e}();e.ColumnFilter=t;var r=function(){function e(){}return e}();e.Column=r;var i=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.mapService=i,this.sortOptions=[],e.vm=this,this.column=e.column,e.fields=this.column.fields,this.layer=e.layer,e.fields.hasOwnProperty("prio")&&(this.sortOptions=this.sortOptions.concat(["High priority","Low Priority"])),e.fields.hasOwnProperty("date")&&(this.sortOptions=this.sortOptions.concat(["New","Old"])),e.fields.hasOwnProperty("updated")&&(this.sortOptions=this.sortOptions.concat(["Updated"])),this.sortOptions=this.sortOptions.concat(["Title"]),this.initLayers(),this.$messageBus.subscribe("layer",function(e,t){"activated"===e&&a.initLayers()}),this.column.hasOwnProperty("canShare")||(this.column.canShare=!0),this.column.orderBy?this.setOrder(this.column.orderBy):this.setOrder(this.sortOptions[0]),e.columnFilter=function(t){var r=!0;if(!e.column)return!1;if(r&&a.column.filters.layerId!==t.layerId)return!1;if(a.column.filters.roles&&a.column.filters.roles.length>0&&t.properties.hasOwnProperty("roles")&&a.column.filters.roles.forEach(function(e){_.contains(t.properties.roles,e)||(r=!1)}),r&&a.column.filters.tags&&a.column.filters.tags.length>0&&a.column.filters.tags.length>0){if(!t.properties.hasOwnProperty("tags"))return!1;var i=t.properties.tags,o=!1;a.column.filters.tags.some(function(e){switch(e[0]){case"!":case"~":var t=e.substr(1,e.length-1);_.contains(i,t)&&(r=!1);break;case"-":o=!0;break;default:_.contains(i,e)||(r=!1)}return!r}),r&&o?(o=!1,a.column.filters.tags.some(function(e){switch(e[0]){case"-":var t=e.substr(1,e.length-1);_.contains(i,t)&&(o=!0)}return o})):o=!0,r=r&&o}return r},setInterval(function(){a.updateTime()},1e3)}return e.prototype.getClass=function(e){return"undefined"==typeof e.properties?"":e.properties.hasOwnProperty("question")?e.properties.hasOwnProperty("answered")&&e.properties.answered===!0?"isAnsweredQuestion":"isQuestion":""},e.prototype.clickPrio=function(e){},e.prototype.createForm=function(e){var t=this;e._gui.questions?(delete e._gui.questions,this.$layerService.unlockFeature(e)):this.$layerService.lockFeature(e)&&(e._gui.questions=[],e.properties[this.column.fields.question].forEach(function(r){var i=t.$layerService.getPropertyType(e,r);e._gui.questions.push({property:r,ptype:i})}))},e.prototype.sendForm=function(e){e.properties.answered=!0,delete e._gui.questions,this.$layerService.unlockFeature(e),this.$layerService.saveFeature(e,!0)},e.prototype.saveCategory=function(e,t,r){e.properties.answered=!0,e.properties[t]=r,delete e._gui.questions,this.$layerService.unlockFeature(e),this.$layerService.saveFeature(e,!0)},e.prototype.updateTime=function(){var e=this;this.$layerService.project.features.forEach(function(t){var r=e.column.fields.date;if(t.properties.hasOwnProperty(r))if(e.column.timeReference&&"timeline"===e.column.timeReference.toLowerCase()){var i=t.properties[r];t.hasOwnProperty("_gui")||(t._gui={}),t._gui.relativeTime=moment(i).from(moment(new Date(e.$layerService.project.timeLine.focus)))}else{var i=t.properties[r];t.hasOwnProperty("_gui")||(t._gui={}),t._gui.relativeTime=moment(i).fromNow()}return""})},e.prototype.toggleRole=function(e,t){e.properties.hasOwnProperty("roles")||(e.properties.roles=[]),-1===e.properties.roles.indexOf(t)?e.properties.roles.push(t):e.properties.roles=e.properties.roles.filter(function(e){return e!=t}),this.$layerService.saveFeature(e,!0)},e.prototype.logFilter=function(e){},e.prototype.startAction=function(e,t){this.$messageBus.publish("kanbanaction",e,t)},e.prototype.getPrioColor=function(e){var t=["white","black","red","orange","blue","green"];return e.properties.hasOwnProperty(this.column.fields.prio)?{"background-color":t[parseInt(e.properties[this.column.fields.prio])]}:{"background-color":"white"}},e.prototype.setOrder=function(e){switch(this.$scope.columnOrderTitle=e,this.column.orderBy=e,e){case"High priority":this.$scope.columnOrderBy="properties."+this.$scope.fields.prio;break;case"Low Priority":this.$scope.columnOrderBy="-properties."+this.$scope.fields.prio;break;case"New":this.$scope.columnOrderBy="-properties."+this.$scope.fields.date;break;case"Old":this.$scope.columnOrderBy="properties."+this.$scope.fields.date;break;case"Updated":this.$scope.columnOrderBy="-properties."+this.$scope.fields.updated;break;case"Title":this.$scope.columnOrderBy="properties."+this.$scope.fields.title}},e.prototype.updateFeature=function(e){this.$layerService.saveFeature(e,!0)},e.prototype.selectFeature=function(e){this.$messageBus.publish("kanban","onItemSelect",e),e.properties.hasOwnProperty(this.column.fields.question)?this.createForm(e):this.$layerService.selectFeature(e)},e.prototype.editFeature=function(e){this.$layerService.editFeature(e)},e.prototype.searchFeature=function(e){this.mapService.zoomTo(e,15)},e.prototype.initLayers=function(){if(!this.layer){var e=this.$scope.providedlayer;if(e)return void(this.layer=this.$scope.layer);var t=this.$scope.column,r=t.filters.layerId;this.layer=this.$layerService.findLayer(r),this.layer&&this.$layerService.addLayer(this.layer,function(e){})}},e.$inject=["$scope","layerService","messageBusService","mapService"],e}();e.KanbanColumnCtrl=i}(KanbanColumn||(KanbanColumn={}));var LayersDirective;!function(e){"use strict";var t=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$http=t,this.$modalInstance=r,this.layerService=i,this.translate=a,this.messageBusService=o,e.vm=this,this.project=this.layerService.project,this.project.layerDirectory&&t.get(this.project.layerDirectory).success(function(e){s.layers=e}).error(function(){console.log("AddLayerCtrl: error calling $http")})}return e.prototype.addGroup=function(){var e=this;if(!this.layerService.project.groups.some(function(t){return t.title===e.groupTitle})){var t=new csComp.Services.ProjectGroup;t.title=this.groupTitle,t.description=this.groupDescription,this.layerService.project.groups.push(t),this.layerService.initGroup(t),this.done()}},e.prototype.selectProjectLayer=function(e){this.selectedLayer=e},e.prototype.addProjectLayer=function(){var e=this.layerService.findGroupById(this.layerGroup);e&&(this.layerService.initLayer(e,this.selectedLayer),e.layers.push(this.selectedLayer)),this.done()},e.prototype.addLayer=function(){var e=this.layerService.findGroupById(this.layerGroup);if(e){var t=new csComp.Services.ProjectLayer;t.title=this.layerTitle,this.layerService.initLayer(e,t),e.layers.push(t);var r=csComp.Helpers.createRightPanelTab("edit","layeredit",t,"Edit layer");this.messageBusService.publish("rightpanel","activate",r)}this.done()},e.prototype.done=function(){this.$modalInstance.close("done")},e.prototype.cancel=function(){console.log("cancel"),this.$modalInstance.dismiss("cancel")},e.$inject=["$scope","$http","$modalInstance","layerService","$translate","messageBusService"],e}();e.AddLayerCtrl=t}(LayersDirective||(LayersDirective={}));var LayersDirective;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("layersDirective",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/LayersList/LayersDirective.tpl.html",replace:!0,transclude:!0,controller:e.LayersDirectiveCtrl}}]),e.myModule.directive("featureType",["$compile","layerService",function(e,t){var r=function(e){var r={};switch(r.fType=e,r.featureTypeName=r.fType.name,r._gui={},r.effectiveStyle=r.fType.style,t.calculateFeatureStyle(r),r.fType.style.drawingMode){case"Point":var i=csComp.Helpers.createIconHtml(r);return i.html;case"Line":var i=csComp.Helpers.createIconHtml(r);return i.html;case"Polygon":var i=csComp.Helpers.createIconHtml(r);return i.html}};return{restrict:"E",scope:{featuretype:"="},link:function(t,i,a){var o=e(r(t.featuretype))(t);i.html(o)}}}]),e.myModule.directive("featureType2",["$compile",function(e){
return{terminal:!0,restrict:"E",scope:{featuretype:"=featuretype"},template:"<h1>{{featuretype.name}}</h1>",replace:!0,transclude:!0,controller:function(e){console.log(e.featuretype)},link:function(e,t,r){}}}])}(LayersDirective||(LayersDirective={}));var LayersDirective;!function(e){var t=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$layerService=t,this.$messageBusService=r,this.$mapService=i,this.$dashboardService=a,this.$modal=o,this.$http=s,this.state="layers",this.updateLayerOpacity=_.debounce(function(e){console.log("update opacity"),e&&(e.renderType&&"gridlayer"===e.renderType.toLowerCase()?n.$layerService.updateCanvasOverlay(e):n.$layerService.updateLayerFeatures(e))},500),e.vm=this,e.options=function(e){return e.enabled?e.layerSource?e.layerSource.layerMenuOptions(e):void 0:null},this.allCollapsed=!1,this.$messageBusService.subscribe("project",function(e,t){n.project=t,"loaded"===e&&t&&(t.hasOwnProperty("collapseAllLayers")&&t.collapseAllLayers===!0?n.allCollapsed=!0:n.allCollapsed=!1)}),this.$messageBusService.subscribe("layerdrop",function(e,t){n.dropLayer(t)}),this.$messageBusService.subscribe("layer",function(e,t){"deactivate"===e&&t===n.layer&&n.stopEditingLayer(t),"startEditing"===e&&n.editLayer(t)}),this.$messageBusService.subscribe("featuretype",function(e,t){"startEditing"===e&&n.editFeaturetype(t),"stopEditing"===e&&n.editLayer(n.layer)})}return e.prototype.dropLayer=function(e){this.initGroups(),this.initResources(),this.$layerService.visual.leftPanelVisible=!0,$('#leftPanelTab a[data-target="#layers"]').tab("show"),this.state="createlayer",this.newLayer=e,this.newGroup=e.id,"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.editGroup=function(e){var t=csComp.Helpers.createRightPanelTab("edit","groupsettings",e,"Group Settings","Group Settings","cog",!0,!0);this.$messageBusService.publish("rightpanel","activate",t)},e.prototype.layerSettings=function(e){var t=csComp.Helpers.createRightPanelTab("edit","layersettings",e,"Layer Settings","Layer Settings","cog",!0,!0);this.$messageBusService.publish("rightpanel","activate",t)},e.prototype.addNewType=function(){if(this.resource){var e={drawingMode:"Point",iconUri:"/images/home.png",cornerRadius:50,fillColor:"yellow",iconWidth:30,iconHeight:30},t={};t.id="new type",t.name="new type",t.style=e,t.propertyTypeKeys="title,notes";t.id;this.editFeaturetype(t)}},e.prototype.dropdownpos=function(e){},e.prototype.deleteFeaturetype=function(e){if(!_.isUndefined(e)){var t=this.$layerService.findResourceByLayer(this.layer);if(!_.isUndefined(t)){var r=[];for(var i in t.featureTypes)t.featureTypes[i].id===e.id&&r.push(i);r.length>0&&(r.forEach(function(e){t.featureTypes[e]=null,delete t.featureTypes[e]}),this.$layerService.saveResource(t)),this.editLayer(this.layer)}}},e.prototype.editFeaturetype=function(e){this.resource&&this.resource.isDynamic&&(e._resource=this.resource,this.selectedFeatureType=e,this.state="editfeaturetype")},e.prototype.initGroups=function(){var e=this;this.groups=[],this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(t){return e.groups.push(t)});var t=new csComp.Services.ProjectGroup;t.id="<new>",t.title="<new group>",this.groups.push(t)},e.prototype.initDrag=function(e,t){var r=this;interact("#layerfeaturetype-"+e).draggable({onmove:function(e){var t=e.target,r=(parseFloat(t.getAttribute("data-x"))||0)+e.dx,i=(parseFloat(t.getAttribute("data-y"))||0)+e.dy;t.style.webkitTransform=t.style.transform="translate("+r+"px, "+i+"px)",t.setAttribute("data-x",r),t.setAttribute("data-y",i)},onend:function(i){console.log("Draggable: ",i),setTimeout(function(){var a=i.clientX,o=i.clientY,s=r.$layerService.activeMapRenderer.getLatLon(a,o);console.log(s);var n=new csComp.Services.Feature;n.layerId=t.id,n.geometry={type:"Point",coordinates:[s.lon,s.lat]};var c="new object",l=r.$layerService.findResourceByLayer(t);if(n.properties={featureTypeId:e,Name:c},l.featureTypes.hasOwnProperty(e)){var p=l.featureTypes[e];if(p._isInitialized||r.$layerService.initFeatureType(p,l),_.isArray(p._propertyTypeData))for(var u in p._propertyTypeData){p._propertyTypeData[u];p._propertyTypeData.forEach(function(e){n.properties[e.label]=e.title})}c=p.name}t.data.features.push(n),r.$layerService.initFeature(n,t),r.$layerService.activeMapRenderer.addFeature(n),r.$layerService.saveFeature(n),r.$layerService.selectFeature(n)},10),$(i.target).remove()}}).on("move",function(e){var t=e.interaction;if(t.pointerIsDown&&!t.interacting()&&e.currentTarget.classList.contains("drag-element-source")){var r=(e.target,{left:0,top:0}),i=e.currentTarget.cloneNode(!0);i.className=i.className.replace(/\bdrag-element-source\b/,""),r.left=e.clientX-20,r.top=e.clientY-20,$(i).css("left",r.left),$(i).css("top",r.top),$(i).css("z-index",1e3),$(document.body).append(i),t.start({name:"drag"},e.interactable,i)}else t.start({name:"drag"},e.interacFtable,e.currentTarget)})},e.prototype.selectProjectLayer=function(e){this.layer=e},e.prototype.exitDirectory=function(){this.layer=null,this.layerTitle="",this.state="layers"},e.prototype.editLayer=function(e){this.state="editlayer",e.layerSource.startEditing(e),this.layer=e,this.resource=null,this.layer.typeUrl&&this.$layerService.typesResources.hasOwnProperty(this.layer.typeUrl)&&(this.resource=this.$layerService.typesResources[this.layer.typeUrl])},e.prototype.stopEditingLayer=function(e){if(this.state="layers",e._gui.featureTypes)for(var t in e._gui.featureTypes)interact("#layerfeaturetype-"+t).onstart=null,interact("#layerfeaturetype-"+t).onmove=null,interact("#layerfeaturetype-"+t).onend=null;this.$layerService.stopEditingLayer(e)},e.prototype.setLayerOpacity=function(e){this.updateLayerOpacity(e)},e.prototype.loadAvailableLayers=function(){var e=this;this.mylayers=[],this.project.groups&&this.project.groups.forEach(function(t){t.layers.forEach(function(t){return e.mylayers.push(t.url)})}),this.project.layerDirectory&&$.getJSON(this.project.layerDirectory,function(t){e.directory=[];for(var r in t)e.directory.push(t[r])})},e.prototype.openDirectory=function(){this.initGroups(),this.loadAvailableLayers(),this.initResources(),this.state="directory"},e.prototype.initResources=function(){var e=this;this.resources={},this.project.groups&&(this.project.groups.forEach(function(t){t.layers&&t.layers.forEach(function(t){t.typeUrl&&!e.resources.hasOwnProperty(t.typeUrl)&&(e.resources[t.typeUrl]={title:t.typeUrl})})}),this.resources["<new>"]={title:"<new type file>"},this.layerResourceType="<new>")},e.prototype.createLayer=function(){this.initGroups(),this.loadAvailableLayers(),this.initResources(),this.$layerService.project.groups&&this.$layerService.project.groups.length>0?this.layerGroup=this.$layerService.project.groups[0].id:(this.layerGroup=new csComp.Services.ProjectGroup,this.layerGroup.id="<new>",this.layerGroup.title="<new group>",this.$layerService.project.groups=[]),this.state="createlayer",this.newLayer=new csComp.Services.ProjectLayer,this.newLayer.type="dynamicgeojson",this.newLayer.layerSource=this.$layerService.layerSources.dynamicgeojson},e.prototype.createNewLayer=function(){var e,t=this;if("<new>"===this.layerGroup){if(e=new csComp.Services.ProjectGroup,e.title=this.newGroup,this.$layerService.project.groups.some(function(e){return e.title===t.newGroup}))return void this.$messageBusService.notify("Error creating group","Group already exists");this.$layerService.project.groups.push(e),this.$layerService.initGroup(e)}else e=this.$layerService.findGroupById(this.layerGroup);if(e){var r=encodeURI(this.newLayer.title.toLowerCase());this.newLayer.id=r;var i=this.newLayer;"dynamicgeojson"===this.newLayer.type?(this.newLayer.url="api/layers/"+r,async.series([function(e){if("<new>"===t.layerResourceType){t.newLayer.typeUrl="api/resources/"+r;var i={id:r,title:t.newLayer.title,featureTypes:{},propertyTypeData:{}};t.newLayer.data&&t.newLayer.data.features&&t.newLayer.data.features.length>0&&(i.featureTypes.Default=csComp.Helpers.createDefaultType(t.newLayer.data.features[0],i)),t.$http.post("api/resources",i).success(function(t){e(null)}).error(function(r){t.$messageBusService.notifyError("Creating layer","Error creating new layer, resource already exists"),e(r)})}else t.newLayer.typeUrl=t.layerResourceType,e(null)},function(a){var o={id:r,title:i.title,isDynamic:!0,type:i.type,storage:"file",description:i.description,typeUrl:i.typeUrl,tags:i.tags,url:i.url,features:[]};t.newLayer.data&&(o.features=t.newLayer.data.features),t.$http.post("/api/layers/"+o.id,o).success(function(r){t.$layerService.initLayer(e,t.newLayer),e.layers.push(t.newLayer),t.$layerService.addLayer(t.newLayer),t.$layerService.saveProject(),a(null)}).error(function(e){t.$messageBusService.notifyError("Creating layer","Error creating new layer"),console.log("error adding layer"),a(e)})}],function(e){e||(t.$messageBusService.notifyError("Creating layer","Layer created"),t.exitDirectory())})):(this.$layerService.initLayer(e,this.newLayer),e.layers.push(this.newLayer),this.$layerService.addLayer(this.newLayer),this.exitDirectory())}},e.prototype.toggleLayer=function(e,t){var r=this;t.altKey?e.enabled?this.editLayer(e):this.$layerService.addLayer(e,function(){r.editLayer(e)}):this.$layerService.toggleLayer(e),"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.clickAction=function(e,t){e.callback(t,this.$layerService)},e.prototype.openLayerMenu=function(e,t){var r=this;console.log("open layer menu"),e.stopPropagation(),t._gui.options=[],this.$layerService.actionServices.forEach(function(e){if(_.isFunction(e.getLayerActions)){var r=e.getLayerActions(t);_.isArray(r)&&r.forEach(function(e){return t._gui.options.push(e)})}}),t._gui.options.push({title:"Layer Settings",callback:function(e,t){return r.layerSettings(e)}}),$(e.target).next().dropdown("toggle")},e.prototype.collapseAll=function(){this.$layerService.collapseAll(),this.allCollapsed=!0,"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.expandAll=function(){this.$layerService.expandAll(),this.allCollapsed=!1,"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.filterHiddenGroups=function(e){return"_"!==e.title[0]&&"_"!==e.id[0]},e.$inject=["$scope","layerService","messageBusService","mapService","dashboardService","$uibModal","$http"],e}();e.LayersDirectiveCtrl=t}(LayersDirective||(LayersDirective={}));var Legend;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("legendDirective",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Legend/Legend.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.LegendCtrl}}])}(Legend||(Legend={}));var Legend;!function(e){var t=function(){function e(){}return e}();e.LegendData=t;var r=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.passcount=1,e.vm=this;var a=e.$parent;if(this.widget=a.widget,this.parentWidget=$("#"+this.widget.elementId).parent(),this.widget&&this.widget.data&&(e.data=this.widget.data),this.widget&&this.widget.data&&this.widget.data.hasOwnProperty("propertyTypeKey"))var o=this.$layerService.propertyTypeData[e.data.propertyTypeKey];e.activeStyleProperty=o,e.data&&"lastSelectedLayer"===e.data.mode?this.$messageBus.subscribe("layer",function(t,r){"activated"===t&&(e.legend=null,r&&r.defaultLegend&&(e.legend=i.$layerService.getLayerLegend(r),console.log("activate new layer "+r.title)))}):e.data&&"lastSelectedStyle"===e.data.mode?(e.legend=this.createLegend(),e.$parent.hasOwnProperty("widget")&&(e.legend.hasOwnProperty("legendEntries")?e.$parent.widget.enabled=!0:e.$parent.widget.enabled=!1),this.subscribeHandle||(this.subscribeHandle=this.$messageBus.subscribe("updatelegend",function(t,r){switch(t){case"removelegend":i.$messageBus.unsubscribe(i.subscribeHandle);break;case"hidelegend":i.parentWidget.hide();break;default:i.parentWidget.show(),o&&o.legend&&(e.legend=o.legend,e.activeStyleProperty=o),(e.data.mode="lastSelectedStyle")&&(e.legend=i.createLegend(r),e.$parent.hasOwnProperty("widget")&&(e.legend.hasOwnProperty("legendEntries")?e.$parent.widget.enabled=!0:e.$parent.widget.enabled=!1)),"$apply"!=i.$scope.$root.$$phase&&"$digest"!=i.$scope.$root.$$phase&&i.$scope.$apply()}}))):(e.legend=this.widget.data,e.$parent.hasOwnProperty("widget")&&(e.legend.hasOwnProperty("legendEntries")?e.$parent.widget.enabled=!0:e.$parent.widget.enabled=!1))}return e.prototype.createLegend=function(e){var t=this;void 0===e&&(e=null);var r=new csComp.Services.Legend;if(e?this.$scope.activeStyleGroup=e.group:this.$layerService.project.groups.forEach(function(r){r.styles.forEach(function(i){i.enabled&&(e=i,t.$scope.activeStyleGroup=r)})}),!e)return r;var i=this.$layerService.propertyTypeData[e.property];return this.$scope.activeStyleProperty=i,i?i.legend?i.legend:(r.id=i.label+"legendcolors",r.legendKind="interpolated",r.description=i.title,r.legendEntries=[],e.activeLegend&&e.activeLegend.legendEntries?e.activeLegend.legendEntries.forEach(function(e){r.legendEntries.push(e)}):(r.legendEntries.push(this.createLegendEntry(e,i,e.info.min)),r.legendEntries.push(this.createLegendEntry(e,i,(e.info.min+e.info.max)/4)),r.legendEntries.push(this.createLegendEntry(e,i,2*(e.info.min+e.info.max)/4)),r.legendEntries.push(this.createLegendEntry(e,i,3*(e.info.min+e.info.max)/4)),r.legendEntries.push(this.createLegendEntry(e,i,e.info.max)),r.legendEntries=r.legendEntries.sort(function(e,t){return e.value-t.value})),r):r},e.prototype.createLegendEntry=function(e,t,r){var i=new csComp.Services.LegendEntry;return i.label=csComp.Helpers.convertPropertyInfo(t,r),i.label===r.toString()&&(e.info.max>100?i.label=String.format("{0:#,#}",r):i.label=String.format("{0:#,#.#}",r)),i.value=r,i.color=csComp.Helpers.getColor(r,e),i},e.prototype.getStyle=function(e,t,r){var i={"float":"left",position:"relative",top:"10px",background:"linear-gradient(to bottom, "+t.color+", "+e.legendEntries[e.legendEntries.length-r-2].color+")","border-left":"1px solid black","border-right":"1px solid black"};return 0===r?i["border-top"]="1px solid black":r===e.legendEntries.length-2&&(i["border-bottom"]="1px solid black"),i},e.prototype.toggleFilter=function(e,t){var r=this;if(e&&t){var i=this.$scope.activeStyleGroup,a=this.$scope.activeStyleProperty;if(i&&a){var o=i.filters.some(function(e){return e.property===a.label?(r.$layerService.removeFilter(e),!0):void 0});if(!o){var s=new csComp.Services.GroupFilter;s.property=a.label,s.id="buttonwidget_filter",s.group=i,s.filterType="row",s.title=a.title,s.rangex=[t.interval.min,t.interval.max],s.filterLabel=t.label,console.log("Setting filter"),this.$layerService.rebuildFilters(i),i.filters=i.filters.filter(function(e){return e.id!==s.id}),this.$layerService.setFilter(s,i),this.$layerService.visual.leftPanelVisible=!0,$("#filter-tab").click()}}}},e.$inject=["$scope","layerService","messageBusService"],e}();e.LegendCtrl=r}(Legend||(Legend={}));var LegendList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("legendList",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/LegendList/LegendList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.LegendListCtrl}}])}(LegendList||(LegendList={}));var LegendList;!function(e){var t=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$sce=t,this.$timeout=r,this.layerService=i,this.mapService=a,this.messageBusService=o,this.expressionService=s,this.isVisible=!1,e.vm=this,o.subscribe("project",function(e){switch(e){case"loaded":n.updateLegendItems()}}),o.subscribe("layer",function(e){switch(e){case"activated":case"deactivate":n.updateLegendItems()}}),o.subscribe("mapbbox",function(e,t){if("update"===e){var r=[];t.split(",").forEach(function(e){r.push(+e)}),n.bbox=new L.LatLngBounds([r[1],r[0]],[r[3],r[2]]),n.isVisible&&n.updateLegendItems()}}),e.$watch(function(){return $("#legend").is(":visible")},function(e){n.isVisible=e,e&&n.updateLegendItems()}),e.legendItems=[],e.numberOfItems=10}return e.prototype.updateLegendItems=function(){this.updateLegendItemsUsingFeatures()},e.prototype.updateLegendStatically=function(){var e=this,t=this.layerService.project;if(t){if(!t.hasOwnProperty("groups"))return void console.log("Creating legend failed: no groups found");var r=[],i={};t.groups.forEach(function(t){t.hasOwnProperty("layers")&&t.layers.forEach(function(t){if(t.enabled&&t.hasOwnProperty("typeUrl")&&t.hasOwnProperty("defaultFeatureType")){var a=t.typeUrl+"#"+t.defaultFeatureType,o=e.layerService.getFeatureTypeById(a);!i.hasOwnProperty(a)&&o&&o.hasOwnProperty("legendItems")&&o.legendItems.forEach(function(e){r.push({title:e.title,uri:e.uri||"",html:e.html||""})}),i[a]=!0}})}),this.$scope.legendItems=r}},e.prototype.updateLegendItemsUsingFeatureTypes=function(){var e=[],t=[];for(var r in this.layerService._featureTypes){var i=this.layerService._featureTypes[r],a=csComp.Helpers.getImageUri(i),o="",s=this.getName(r,i),n=s+a;t.indexOf(n)<0&&(t.push(n),e.push({title:s,uri:a,html:o}))}e.sort(function(e,t){return e.title>t.title?1:e.title<t.title?-1:0}),this.$scope.legendItems=e},e.prototype.updateLegendItemsUsingFeatures=function(){var e=this,t=!0,r={},i=[],a=[];return this.layerService.project&&0!==this.layerService.project.features.length?(this.layerService.project.features.forEach(function(o){if(o._gui.included){var s=csComp.Helpers.GeoExtensions.getFeatureBounds(o);if(!e.bbox||!s||e.bbox.contains(s)){var n=o.fType;if(n||(n=e.layerService.getFeatureType(o)),n&&!r.hasOwnProperty(n.name)){var c=n.style&&n.style.hasOwnProperty("iconUri")?csComp.Helpers.convertStringFormat(o,n.style.iconUri):csComp.Helpers.getImageUri(n),l=n.name||o.layer.title||(n.id?n.id.split("#").pop():"undefined"),p=l+c,u=a.indexOf(p);if(0>u){if(n.hasOwnProperty("legendItems"))return n.legendItems.forEach(function(e){i.push({title:e.title,uri:e.uri||"",html:e.html||""})}),t=!1,void(r[n.name]=!0);c.indexOf("_Media")>=0&&(o.effectiveStyle.iconUri="cs/images/polygon.png");var d=csComp.Helpers.createIconHtml(o).html;a.push(p),i.push({title:l,uri:c,html:d,count:1,expressions:n.legendExpr,features:[o]})}else i[u].features.push(o)}}}}),t&&i.sort(function(e,t){return e.title>t.title?1:e.title<t.title?-1:0}),i.forEach(function(t){if(t.count=t.features.length,t.expressions&&t.expressions.length>0){for(var r=0,i=t.expressions.length;i>r;r++){var a=t.expressions[r];a.calculation=e.expressionService.evalPropertyType(a,t.features,null)}delete t.features}}),void this.$timeout(function(){e.$scope.legendItems=i},0)):void(this.$scope.legendItems=i)},e.prototype.getName=function(e,t){return t.name||e.split("#").pop()},e.prototype.toTrusted=function(e){try{return void 0===e||null===e?this.$sce.trustAsHtml(e):this.$sce.trustAsHtml(e.toString())}catch(t){return console.log(t+": "+e),""}},e.$inject=["$scope","$sce","$timeout","layerService","mapService","messageBusService","expressionService"],e}();e.LegendListCtrl=t}(LegendList||(LegendList={}));var MapElement;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("map",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{mapid:"="},templateUrl:"directives/MapElement/MapElement.tpl.html",link:function(e,t,r){},replace:!1,transclude:!0,controller:e.MapElementCtrl}}])}(MapElement||(MapElement={}));var MapElement;!function(e){var t=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$layerService=t,this.mapService=r,this.$messageBusService=i,this.locale="en-us",this.options=["test","boe"],e.vm=this,this.initMap(),e.initMap=function(){return a.initMap()}}return e.prototype.initMap=function(){this.$layerService.selectRenderer("leaflet")},e.$inject=["$scope","layerService","mapService","messageBusService"],e}();e.MapElementCtrl=t}(MapElement||(MapElement={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Mca;!function(e){var t;!function(e){!function(e){e[e.Manual=0]="Manual",e[e.Ascending=1]="Ascending",e[e.Descending=2]="Descending",e[e.AscendingSigmoid=3]="AscendingSigmoid",e[e.DescendingSigmoid=4]="DescendingSigmoid",e[e.GaussianPeak=5]="GaussianPeak",e[e.GaussianValley=6]="GaussianValley"}(e.ScoringFunctionType||(e.ScoringFunctionType={}));var t=e.ScoringFunctionType,r=function(){function e(e){"undefined"!=typeof e&&null!=e&&(this.type=e),this.title=t[e].toString()}return Object.defineProperty(e.prototype,"cssClass",{get:function(){return t[this.type].toLowerCase()},enumerable:!0,configurable:!0}),e.createScores=function(e){var r;switch(e){default:case t.Ascending:r="[0,0 10,1]";break;case t.Descending:r="[0,1 10,0]";break;case t.AscendingSigmoid:r="[0,0.11 1,0.12 2,0.14 3,0.18 4,0.28 5,0.5 6,0.72 7,0.82 8,0.86 9,0.88 10,0.89]";break;case t.DescendingSigmoid:r="[0,0.89 1,0.88 2,0.86 3,0.82 4,0.72 5,0.5 6,0.28 7,0.18 8,0.14 9,0.12 10,0.11]";break;case t.GaussianPeak:r="[0,0 2,0.04 3,0.25 4,0.7 5,1 6,0.7 7,0.25 8,0.04 9,0]";break;case t.GaussianValley:r="[0,1 2,0.96 3,0.75 4,0.3 5,0 6,0.3 7,0.75 8,0.96 9,0]"}return r},e}();e.ScoringFunction=r;var i=function(){function e(){}return e}();e.ScoringFunctions=i;var a=function(){function e(){this.userWeight=1,this.criteria=[],this.isPlaUpdated=!1,this.isPlaScaled=!1,this._propValues=[],this._x=[],this._y=[]}return e.prototype.deserialize=function(t){var r=this;return this.title=t.title,this.description=t.description,this.label=t.label,this.color=t.color,this.userWeight=t.userWeight,this.weight=t.weight,this.isPlaScaled=t.isPlaScaled,this.scores=t.scores,this.minCutoffValue=t.minCutoffValue,this.maxCutoffValue=t.maxCutoffValue,this.minValue=t.minValue,this.maxValue=t.maxValue,t.criteria&&t.criteria.forEach(function(t){r.criteria.push((new e).deserialize(t))}),this},e.prototype.toJSON=function(){var e={};for(var t in this)"_"!==t[0]&&this.hasOwnProperty(t)&&(e[t]=this[t]);return e},e.prototype.requiresMinimum=function(){return this.scores&&this.scores.indexOf("min")>=0},e.prototype.requiresMaximum=function(){return this.scores&&this.scores.indexOf("max")>=0},e.prototype.getTitle=function(){return this.title?this.title:this.label},e.prototype.updatePla=function(e,t){var r=this;if(void 0===t&&(t=!1),!this.isPlaUpdated||t){if(this.criteria.length>0)return this.criteria.forEach(function(r){r.updatePla(e,t)}),void(this.isPlaUpdated=!0);if(null!=this.scores){var i=this.scores;this._propValues=[],(this.requiresMaximum()||this.requiresMinimum()||this.isPlaScaled)&&e.forEach(function(e){if(e.properties.hasOwnProperty(r.label)){var t=e.properties[r.label];$.isNumeric(t)&&r._propValues.push(t)}});var a=this.maxValue,o=this.minValue;if((this.isPlaScaled||this.requiresMaximum())&&(a=a||Math.max.apply(null,this._propValues),i.replace("max",a.toPrecision(3))),(this.isPlaScaled||this.requiresMinimum())&&(o=o||Math.min.apply(null,this._propValues),i.replace("min",o.toPrecision(3))),this.isPlaScaled){var s=csComp.Helpers.standardDeviation(this._propValues);a=a||Math.min(a,s.avg+2*s.stdDev),o=o||Math.max(o,s.avg-2*s.stdDev)}var n,c,l=i.split(/[^\d\.]+/).filter(function(e){return e.length>0}),p=a-o;if(null!=this.minValue||null!=this.maxValue?(n=p/10,c=o):(n=.08*p,c=o+.1*p),l.length%2!==0)throw Error(this.label+" does not have an even (x,y) pair in scores.");this._x.length=0,this._y.length=0;for(var u=0;u<l.length/2;u++){var d=parseFloat(l[2*u]);if(this.isPlaScaled&&(d=n*d+c),u>0&&this._x[u-1]>d)throw Error(this.label+": x should increment continuously.");this._x.push(d);var h=parseFloat(l[2*u+1]);0>h?h=0:h>1&&(h=1),this._y.push(h)}this.isPlaUpdated=!0}}},e.prototype.getScore=function(e){if(!this.isPlaUpdated)throw"Error: PLA must be updated for criterion "+this.title+"!";if(0!==this.criteria.length){var t=0;return this.criteria.forEach(function(r){t+=r.weight>0?r.weight*r.getScore(e):Math.abs(r.weight)*(1-r.getScore(e))}),this.weight>0?this.weight*t:Math.abs(this.weight)*(1-t)}if(!e.properties.hasOwnProperty(this.label))return 0;var r=e.properties[this.label];if(this.maxCutoffValue<=r||r<=this.minCutoffValue)return 0;if(r<this._x[0])return this._y[0];var i=this._x.length-1;if(r>this._x[i])return this._y[i];for(var a=0;a<this._x.length;a++)if(r<this._x[a]){var o=this._x[a-1],s=this._x[a],n=this._y[a-1],c=this._y[a];return(c-n)*(r-o)/(s-o)}return 0},e}();e.Criterion=a;var o=function(e){function t(t){e.call(this),this.id=csComp.Helpers.getGuid(),this.userWeightMax=5,this.featureIds=[],t?this.deserialize(t):(this.weight=1,this.isPlaUpdated=!1)}return __extends(t,e),Object.defineProperty(t.prototype,"rankLabel",{get:function(){return this.label+"#"},enumerable:!0,configurable:!0}),t.prototype.deserialize=function(t){return this.id=t.id,this.section=t.section,this.stringFormat=t.stringFormat,this.rankTitle=t.rankTitle,this.rankDescription=t.rankDescription,this.rankFormat=t.rankFormat,this.userWeightMax=t.userWeightMax,this.featureIds=t.featureIds,this.minCutoffValue=t.minCutoffValue,this.maxCutoffValue=t.maxCutoffValue,this.minValue=t.minValue,this.maxValue=t.maxValue,this.scaleMinValue=t.scaleMinValue,this.scaleMaxValue=t.scaleMaxValue,e.prototype.deserialize.call(this,t),this},t.prototype.update=function(){this.calculateWeights(),this.setColors()},t.prototype.calculateWeights=function(e){e||(e=this.criteria);var t=0;for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];i.criteria.length>0&&this.calculateWeights(i.criteria),t+=Math.abs(i.userWeight)}if(t>0)for(var a in e)if(e.hasOwnProperty(a)){var o=e[a];o.weight=o.userWeight/t}},t.prototype.setColors=function(){var e=chroma.scale("RdYlBu").domain([0,this.criteria.length-1],this.criteria.length),t=0,r=0;this.criteria.forEach(function(i){t+=i.criteria.length,i.color||(i.color=e(r++).hex())});var i=chroma.scale("PRGn").domain([0,t-1],t);r=0,this.criteria.forEach(function(e){e.criteria.forEach(function(e){e.color||(e.color=i(r++).hex())})})},t}(a);e.Mca=o}(t=e.Models||(e.Models={}))}(Mca||(Mca={}));var Mca;!function(e){"use strict";var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("mca",["$window","$compile","$templateCache",function(t,r){return{terminal:!0,restrict:"EA",scope:{},templateUrl:"directives/MCA/Mca.tpl.html",compile:function(e){var t=r(e);return function(e){t(e)}},replace:!0,transclude:!0,controller:e.McaCtrl}}])}(Mca||(Mca={}));var Mca;!function(e){"use strict";var t=function(){function t(r,i,a,o,s,n,c){var l=this;this.$scope=r,this.$uibModal=i,this.$translate=a,this.$timeout=o,this.$localStorageService=s,this.layerService=n,this.messageBusService=c,this.features=[],this.availableMcas=[],this.showAsterChart=!1,this.showDialog=!1,this.expertMode=!1,this.showSparkline=!1,this.featureMessageReceived=function(e,t){if(l.mca&&t){switch(e){case"onFeatureSelect":l.updateSelectedFeature(t,!0);break;case"onFeatureDeselect":l.showFeature=!1,l.selectedFeature=null,l.drawChart()}l.scopeApply()}},this.filtersMessageReceived=function(e,t){if(l.mca){switch(e){case"updated":l.updateMca(l.selectedCriterion||l.mca.criteria[0])}l.scopeApply()}},r.vm=this,c.subscribe("layer",function(e){switch(e){case"deactivate":l.updateAvailableMcas();break;case"activated":l.updateAvailableMcas(),l.calculateMca()}}),c.subscribe("project",function(r){switch(r){case"loaded":if(l.expertMode=null!=n.project&&n.$mapService.isExpert,"undefined"==typeof n.project.mcas||null==n.project.mcas)n.project.mcas=[];else{var i=[];n.project.mcas.forEach(function(t){return i.push(new e.Models.Mca(t))}),n.project.mcas=i}var a=l.$localStorageService.get(t.mcas);if("undefined"==typeof a||null===a)return;a.forEach(function(t){return l.saveMcaToProject(new e.Models.Mca(t))})}}),c.subscribe("feature",this.featureMessageReceived),c.subscribe("filters",this.filtersMessageReceived),a("MCA.DELETE_MSG").then(function(e){t.confirmationMsg1=e}),a("MCA.DELETE_MSG2").then(function(e){t.confirmationMsg2=e})}return t.prototype.saveMcaToProject=function(e){for(var t=this.layerService.project.mcas,r=0;r<t.length;r++)if(t[r].id===e.id)return void(t[r]=e);t.push(e)},t.prototype.getVotingClass=function(e){return null==e||null==this.mca||0===e.userWeight||e.userWeight<-this.mca.userWeightMax||e.userWeight>this.mca.userWeightMax?"disabledMca":e.userWeight>0?"prefer":"avoid"},t.prototype.toggleMcaChartType=function(){this.showAsterChart=!this.showAsterChart,this.drawChart(this.mca.criteria[0])},t.prototype.toggleSparkline=function(){this.showSparkline=!this.showSparkline,this.showSparkline&&this.drawChart()},t.prototype.weightUpdated=function(e){this.selectedCriterion=e,this.updateMca(e),this.saveMca(this.mca)},t.prototype.updateMca=function(e){this.selectedCriterion=e,this.features=[],this.calculateMca(),this.drawChart(e)},t.prototype.editMca=function(e){this.showMcaEditor(e)},t.prototype.createMca=function(){this.showMcaEditor(new e.Models.Mca)},t.prototype.showMcaEditor=function(t){var r=this,i=this.$uibModal.open({templateUrl:"directives/MCA/McaEditorView.tpl.html",controller:e.McaEditorCtrl,resolve:{mca:function(){return t}}});i.result.then(function(e){r.showSparkline=!1,r.saveMca(e),r.updateMca()},function(){})},t.prototype.removeMca=function(e){var r=this;if(e){var i=String.format(t.confirmationMsg1,e.title);this.messageBusService.confirm(i,t.confirmationMsg2,function(t){t&&r.$timeout(function(){r.deleteMca(e),r.mca&&r.updateMca()},0)}),this.scopeApply()}},t.prototype.getMcaIndex=function(e){for(var t=-1,r=this.layerService.project.mcas,i=0;i<r.length;i++)if(r[i].title===e.title){t=i;break}return t},t.prototype.saveMca=function(e){e&&(this.deleteMca(e),this.saveMcaToProject(e),this.saveMcaToLocalStorage(e),this.updateAvailableMcas(e))},t.prototype.deleteMca=function(e){if(e){var t=this.getMcaIndex(e);if(!(0>t)){var r=this.layerService.project.mcas;t>=0&&r.splice(t,1),this.deleteMcaFromLocalStorage(e),this.updateAvailableMcas()}}},t.prototype.saveMcaToLocalStorage=function(e){this.deleteMcaFromLocalStorage(e);var r=this.$localStorageService.get(t.mcas);"undefined"!=typeof r&&null!==r||(r=[]),r.push(e),this.$localStorageService.set(t.mcas,r)},t.prototype.deleteMcaFromLocalStorage=function(e){var r=this.$localStorageService.get(t.mcas);if("undefined"!=typeof r&&null!==r)for(var i=0;i<r.length;i++)if(r[i].id===e.id)return r.splice(i,1),void this.$localStorageService.set(t.mcas,r)},t.prototype.scopeApply=function(){"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},t.prototype.updateSelectedFeature=function(e,r){if(void 0===r&&(r=!1),"undefined"==typeof e||null==e)return void(this.featureIcon="");this.selectedFeature=e,this.featureIcon=null!=this.selectedFeature.fType&&null!=this.selectedFeature.fType.style?this.selectedFeature.fType.style.iconUri:"",e.properties.hasOwnProperty(this.mca.label)||(e.properties[this.mca.label]=null),this.showFeature=!0,this.properties=[];var i=t.createPropertyType(this.mca),a=csComp.Helpers.convertPropertyInfo(i,e.properties[i.label]);this.properties.push(new FeatureProps.CallOutProperty(i.title,a,i.label,!0,!0,!0,e,!1,!1,i.description,i)),this.mca.rankTitle&&(i=t.createRankPropertyType(this.mca),a=csComp.Helpers.convertPropertyInfo(i,e.properties[i.label]),this.properties.push(new FeatureProps.CallOutProperty(i.title,a,i.label,!1,!1,!0,e,!1,!1,i.description,i))),r&&this.drawChart()},t.prototype.drawChart=function(e){var t=this;if(this.selectedCriterion=e,
this.showChart=!0,this.showFeature&&e?this.showAsterChart?this.drawAsterPlot(e):this.drawHistogram(e):this.drawPieChart(e),this.showSparkline){var r=0;this.mca.criteria.forEach(function(e){var i="histogram_"+r++;if(0===e.criteria.length){var a=e._y;e.userWeight<0&&(a=a.map(function(e){return 1-e})),csComp.Helpers.Plot.drawMcaPlot(e._propValues,{id:i,width:220,height:70,xy:{x:e._x,y:a},featureValue:t.selectedFeature?t.selectedFeature.properties[e.label]:null})}else{var o=0;e.criteria.forEach(function(r){var a=r._y;e.userWeight<0&&(a=a.map(function(e){return 1-e})),csComp.Helpers.Plot.drawMcaPlot(r._propValues,{id:i+"_"+o++,width:220,height:70,xy:{x:r._x,y:a},featureValue:t.selectedFeature?t.selectedFeature.properties[r.label]:null})})}})}},t.prototype.getTitle=function(e){return e&&e.title||e.label},t.prototype.getParentOfSelectedCriterion=function(e){var t,r=this;return this.mca.update(),"undefined"==typeof e||this.mca.criteria.indexOf(e)>=0?(this.selectedCriterion=null,t=this.mca.criteria):this.mca.criteria.forEach(function(i){i.criteria.indexOf(e)>=0&&(r.selectedCriterion=i,t=i.criteria)}),t},t.prototype.drawHistogram=function(e){var r=this;if(this.mca&&this.selectedFeature){var i=this.getParentOfSelectedCriterion(e);if("undefined"!=typeof i&&null!=i){var a=[],o={id:t.mcaChartId,numberOfBins:10,width:240,height:100,selectedValue:this.selectedFeature.properties[this.mca.label]};this.features.forEach(function(e){if(e.properties.hasOwnProperty(r.mca.label)){var t=e.properties[r.mca.label];$.isNumeric(t)&&a.push(t)}}),csComp.Helpers.Plot.drawHistogram(a,o)}}},t.prototype.drawAsterPlot=function(e){var r=this;if(this.mca&&this.selectedFeature){var i=this.getParentOfSelectedCriterion(e);if("undefined"!=typeof i&&null!=i){var a=[],o=0;i.forEach(function(e){var t=e.getScore(r.selectedFeature),i=new csComp.Helpers.AsterPieData;i.id=o++,i.label=e.getTitle(),i.weight=Math.abs(e.weight),i.color=e.color,i.score=100*(e.weight>0?t:1-t),a.push(i)}),csComp.Helpers.Plot.drawAsterPlot(100,a,t.mcaChartId)}}},t.prototype.drawPieChart=function(e){if(this.mca){var r=this.getParentOfSelectedCriterion(e);if("undefined"!=typeof r&&null!=r){var i=[],a=0;r.forEach(function(e){var t=new csComp.Helpers.PieData;t.id=a++,t.label=e.getTitle(),t.weight=Math.abs(e.weight),t.color=e.color,i.push(t)}),csComp.Helpers.Plot.drawPie(100,i,t.mcaChartId)}}},t.prototype.updateAvailableMcas=function(e){var t=this;this.showChart=!1,this.mca=e,this.availableMcas=[],this.layerService.project.mcas&&this.layerService.project.mcas.forEach(function(e){e.featureIds&&e.featureIds.forEach(function(r){if(t.availableMcas.indexOf(e)<0&&t.layerService._featureTypes.hasOwnProperty(r)){t.availableMcas.push(e);var i=t.layerService._featureTypes[r];t.applyPropertyInfoToCriteria(e,i)}})}),!e&&this.availableMcas.length>0&&(this.mca=this.availableMcas[0],this.updateMca())},t.prototype.calculateMca=function(){var e=this;if(this.mca){var t=this.mca;t.featureIds.forEach(function(r){if(e.layerService._featureTypes.hasOwnProperty(r)&&(e.addPropertyInfo(r,t),e.layerService.project.groups.forEach(function(t){t.filters&&t.filters.length>0&&t.filterResult&&t.filterResult.length>0&&t.filterResult.forEach(function(t){null!=t.featureTypeName&&t.featureTypeName===r&&e.features.push(t)})}),0===e.features.length&&e.layerService.selectedFeatures.length>1&&e.layerService.selectedFeatures.forEach(function(t){null!=t.featureTypeName&&t.featureTypeName===r&&e.features.push(t)}),0===e.features.length&&e.layerService.project.features.forEach(function(t){null!=t.featureTypeName&&t.featureTypeName===r&&e.features.push(t)}),0!==e.features.length)){t.updatePla(e.features,!0),t.update();var i=[],a=0;if(e.features.forEach(function(r){var o=t.getScore(r);if(t.rankTitle){var s={score:o,index:a++};i.push(s)}r.properties[t.label]=100*o,e.layerService.calculateFeatureStyle(r),e.layerService.activeMapRenderer.updateFeature(r)}),t.rankTitle){i.sort(function(e,t){return t.score-e.score});for(var o=e.features.length,s=t.scaleMinValue?Math.abs(t.scaleMaxValue-t.scaleMinValue)+1:o,n=Math.ceil(o/s),c=t.scaleMinValue?t.scaleMaxValue>t.scaleMinValue?function(e){return t.scaleMaxValue-Math.round(e/n)}:function(e){return t.scaleMinValue+Math.round(e/n)}:function(e){return e},l=-1,p=1,u=0;o>u;u++){var d=i[u];d.score!==l&&(p=u+1),l=d.score,e.features[d.index].properties[t.label+"#"]=c(p)+","+s}}}}),this.updateSelectedFeature(this.selectedFeature,!1),this.selectedFeature&&this.messageBusService.publish("feature","onFeatureSelect",this.selectedFeature),this.groupStyle&&this.layerService.updateStyle(this.groupStyle)}},t.prototype.applyPropertyInfoToCriteria=function(e,t){var r=csComp.Helpers.getPropertyTypes(t,this.layerService.propertyTypeData);0!==r.length&&e.criteria.forEach(function(e){var t=e.label;r.forEach(function(r){r.label===t&&(e.title=r.title,e.description=r.description)})})},t.prototype.addPropertyInfo=function(e,r,i){void 0===i&&(i=!1);for(var a=this.layerService._featureTypes[e],o=csComp.Helpers.getPropertyTypes(a,this.layerService.propertyTypeData),s=-1,n=o.length-1;n>=0;n--)if(o[n].label===r.label){s=n;break}if(i||0>s){var c=t.createPropertyType(r);0>s?(a._propertyTypeData||(a._propertyTypeData=[]),a._propertyTypeData.push(c)):o[s]=c}if(r.rankTitle){for(s=-1,n=o.length-1;n>=0;n--)if(o[n].label===r.rankLabel){s=n;break}(i||0>s)&&(c=t.createRankPropertyType(r),0>s?a._propertyTypeData.push(c):o[s]=c)}},t.prototype.setStyle=function(e){this.groupStyle&&null!=this.groupStyle.group&&null!=this.groupStyle.group.styles&&this.groupStyle.group.styles.length>0&&this.groupStyle.group.styles.filter(function(e){return"fillColor"===e.visualAspect})[0].property===this.mca.label?this.layerService.updateStyle(this.groupStyle):(this.groupStyle=this.layerService.setStyle(e,!1),this.groupStyle.colors=["#F04030","#3040F0"],this.layerService.updateStyle(this.groupStyle))},t.prototype.findMcaById=function(e){var t;return this.availableMcas&&this.availableMcas.length>0&&(t=_.find(this.availableMcas,function(t){return t.id===e})),t},t.createPropertyType=function(e){var t={title:e.title,label:e.label,type:"number",maxValue:1,minValue:0,description:e.description,stringFormat:e.stringFormat,visibleInCallOut:!0,section:e.section||"MCA"};return t},t.createRankPropertyType=function(e){var t={title:e.rankTitle,label:e.rankLabel,type:"rank",description:e.rankDescription,stringFormat:e.rankFormat,visibleInCallOut:!0,section:e.section||"MCA"};return t},t.mcaChartId="mcaChart",t.mcas="MCAs",t.$inject=["$scope","$uibModal","$translate","$timeout","localStorageService","layerService","messageBusService"],t}();e.McaCtrl=t}(Mca||(Mca={}));var Mca;!function(e){"use strict";var t=function(){function t(t,r,i,a,o,s){var n=this;this.$scope=t,this.$uibModalInstance=r,this.$layerService=i,this.$translate=a,this.messageBusService=o,this.mca=s,this.propInfos=[],this.headers=[],this.scoringFunctions=[],t.vm=this,this.scoringFunctions.push(new e.Models.ScoringFunction(e.Models.ScoringFunctionType.Ascending)),this.scoringFunctions.push(new e.Models.ScoringFunction(e.Models.ScoringFunctionType.AscendingSigmoid)),this.scoringFunctions.push(new e.Models.ScoringFunction(e.Models.ScoringFunctionType.GaussianPeak)),a("MCA.LINEAR").then(function(e){n.scoringFunctions[0].title=e}),a("MCA.SIGMOID").then(function(e){n.scoringFunctions[1].title=e}),a("MCA.GAUSSIAN").then(function(e){n.scoringFunctions[2].title=e}),this.dataset=csComp.Helpers.loadMapLayers(this.$layerService),o.subscribe("layer",function(){n.dataset=csComp.Helpers.loadMapLayers(n.$layerService)}),this.mcaTitle=s.title,this.rankTitle=s.rankTitle,this.scaleMin=s.scaleMinValue,this.scaleMax=s.scaleMaxValue,this.selectedFeatureType=0===s.featureIds.length?"":this.dataset.featureTypes[s.featureIds[0]],this.selectedFeatureType?(this.updatePropertyInfo(this.selectedFeatureType),this.updatePropertyInfoUponEdit(s)):this.selectFirstFeatureType()}return t.prototype.updatePropertyInfoUponEdit=function(e,t){var r=this;e.criteria.forEach(function(e){if(e.label){var i=r.propInfos;for(var a in i)if(i.hasOwnProperty(a)){var o=i[a];if(o.label===e.label){o.isSelected=!0,o.minCutoffValue=e.minCutoffValue,o.maxCutoffValue=e.maxCutoffValue,o.minValue=e.minValue,o.maxValue=e.maxValue,o.userWeight=e.userWeight,t&&(o.category=t);break}}}else r.updatePropertyInfoUponEdit(e,e.title)})},t.prototype.loadPropertyTypes=function(){this.updatePropertyInfo(this.selectedFeatureType)},t.prototype.selectFirstFeatureType=function(){var e=this.dataset.featureTypes;for(var t in e)if(e.hasOwnProperty(t))return this.selectedFeatureType=e[t],void this.updatePropertyInfo(this.selectedFeatureType)},t.prototype.updatePropertyInfo=function(e){var t=this;this.propInfos=[],this.headers=[];var r=[],i=[];if(i.push({label:"Name",visibleInCallOut:!0,title:"Naam",type:"text",filterType:"text",isSelected:!1,scoringFunctionType:this.scoringFunctions[0].type}),null!=e.propertyTypeKeys){var a=e.propertyTypeKeys.split(/[,;]+/);a.forEach(function(r){if(t.$layerService.propertyTypeData.hasOwnProperty(r))i.push(t.$layerService.propertyTypeData[r]);else if(null!=e._propertyTypeData){var a=$.grep(e._propertyTypeData,function(e){return e.label===r});a.length>=1&&i.push(a)}})}else null!=e._propertyTypeData&&e._propertyTypeData.forEach(function(e){return i.push(e)});i.forEach(function(e){e.visibleInCallOut&&"number"===e.type&&e.label.indexOf("mca_")<0&&r.indexOf(e.title)<0&&(r.push(e.title),t.propInfos.push({title:e.title,label:e.label,stringFormat:e.stringFormat,isSelected:!1,maxValue:e.maxValue,minValue:e.minValue,defaultValue:e.defaultValue,description:e.description}))})},t.prototype.toggleSelection=function(e){var t=this.headers.indexOf(e);t>-1?this.headers.splice(t,1):this.headers.push(e)},t.prototype.isDisabled=function(){return"undefined"==typeof this.mcaTitle||0===this.mcaTitle.length?!0:0===this.propInfos.length||!this.propInfos.reduce(function(e,t){return e||t.isSelected})},t.prototype.save=function(){var t=new e.Models.Mca;t.title=this.mcaTitle||"New MCA criterion",t.label="mca_"+t.title.replace(" ","_"),t.stringFormat="{0:0.0}",this.rankTitle&&(t.rankTitle=this.rankTitle||"Rank",t.rankFormat="{0} / {1}"),this.scaleMin&&this.scaleMax&&(t.scaleMinValue=this.scaleMin,t.scaleMaxValue=this.scaleMax),t.userWeightMax=5;var r=this.dataset.featureTypes;for(var i in r)r.hasOwnProperty(i)&&r[i]===this.selectedFeatureType&&(t.featureIds=[i]);this.propInfos.forEach(function(r){if(r.isSelected){var i=new e.Models.Criterion;if(i.label=r.label,i.title=r.title,i.isPlaScaled=!0,i.description=r.description,i.userWeight=r.userWeight||1,i.minCutoffValue=r.minCutoffValue?+r.minCutoffValue:void 0,i.maxCutoffValue=r.maxCutoffValue?+r.maxCutoffValue:void 0,i.minValue=r.minValue?+r.minValue:void 0,i.maxValue=r.maxValue?+r.maxValue:void 0,r.scoringFunctionType===e.Models.ScoringFunctionType.Manual?i.scores=r.scores:i.scores=e.Models.ScoringFunction.createScores(r.scoringFunctionType),r.category){var a;for(var o in t.criteria)if(t.criteria.hasOwnProperty(o)){var s=t.criteria[o];if(s.title===r.category){a=s;break}}null==a&&(a=new e.Models.Criterion,a.title=r.category,a.isPlaUpdated=!1,t.criteria.push(a)),a.criteria.push(i)}else t.criteria.push(i)}}),this.$uibModalInstance.close(t)},t.prototype.cancel=function(){this.mcaTitle="",this.rankTitle="",this.headers=[],this.$uibModalInstance.dismiss("cancel")},t.prototype.toggleItemDetails=function(e){this.showItem=this.showItem==e?-1:e},t.$inject=["$scope","$uibModalInstance","layerService","$translate","messageBusService","mca"],t}();e.McaEditorCtrl=t}(Mca||(Mca={}));var Mobile;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("mobile",["$window","$compile",function(t,r){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Mobile/Mobile.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!1,transclude:!1,controller:e.MobileCtrl}}])}(Mobile||(Mobile={}));var Mobile;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.localStorageService=i,this.geoService=a,e.vm=this,this.$messageBus.subscribe("project",function(e,t){"loaded"===e&&(o.availableLayers=[],t.groups.forEach(function(e){e.layers.forEach(function(e){e.tags&&e.tags.indexOf("mobile")>=0&&o.availableLayers.push(e)})}),console.log("available layers"),console.log(o.availableLayers))}),r.subscribe("geo",function(e,t){switch(e){case"pos":var r=new csComp.Services.Feature;r.geometry={type:"Point",coordinates:[]},r.geometry.coordinates=[t.coords.longitude,t.coords.latitude],r.properties={Name:"test"},o.$layerService.activeMapRenderer.addFeature(r),o.$layerService.saveFeature(r)}}),this.geoService.start({})}return e.$inject=["$scope","layerService","messageBusService","localStorageService","geoService"],e}();e.MobileCtrl=t}(Mobile||(Mobile={}));var Navigate;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("navigate",["$window","$compile",function(t,r){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Navigate/Navigate.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!1,transclude:!1,controller:e.NavigateCtrl}}]).directive("bsPopover",function(){return function(e,t,r){t.find("a[rel=popover]").popover({placement:"right",html:"true"})}})}(Navigate||(Navigate={}));var Navigate;!function(e){var t=function(){function e(){}return e}();e.RecentFeature=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.localStorageService=i,this.$dashboardService=a,this.geoService=o,this.RecentLayers=[],this.mobileLayers=[],this.RecentFeatures=[],this.lastPost={longitude:0,latitude:0},this.searchResults=[],e.vm=this,this.$messageBus.subscribe("project",function(e,t){"loaded"===e&&(s.createSearchResultLayer(),s.initRecentLayers(),s.initRecentFeatures(),s.$layerService.isMobile&&s.initMobileLayers(t))}),this.$messageBus.subscribe("search",function(e,t){switch(e){case"update":s.searchResults=[],s.doSearch(t.query);break;case"reset":s.searchResults=[],s.$dashboardService._search.isActive=!1,s.clearSearchLayer();break;case"selectFirstResult":s.selectFirstResult()}})}return e.prototype.createSearchResultLayer=function(){var e="_search",t="_hidden";if(!this.$layerService.findLayer(e)&&(this.searchResultGroup=this.$layerService.findGroupById(t),!this.searchResultGroup)){this.searchResultGroup=new csComp.Services.ProjectGroup,this.searchResultGroup.title=t,this.$layerService.project.groups.push(this.searchResultGroup),this.$layerService.initGroup(this.searchResultGroup),this.searchResultLayer=new csComp.Services.ProjectLayer,this.searchResultLayer.title=e,this.searchResultLayer.fitToMap=!0,this.searchResultLayer.data={features:[]},this.$layerService.initLayer(this.searchResultGroup,this.searchResultLayer),this.searchResultGroup.layers.push(this.searchResultLayer);var r={};r.id=e,r.style={drawingMode:"Point",fillColor:"#00f",opacity:.8,innerTextProperty:"searchIndex",innerTextSize:24,marker:"pin"},this.$layerService.initFeatureType(r,null),this.$layerService._featureTypes[this.$layerService.project.url+"#"+r.id]=r}},e.prototype.clearSearchLayer=function(){var e=this;this.searchResultLayer&&this.searchResultLayer.data&&this.searchResultLayer.data&&(this.searchResultLayer.data.features.forEach(function(t){e.$layerService.activeMapRenderer.removeFeature(t)}),this.searchResultLayer.data.features.length=0)},e.prototype.updateSearchLayer=function(){var e=this;this.clearSearchLayer();var t="A",r=0;this.searchResults.forEach(function(i){i.searchIndex=t;var a=new csComp.Services.Feature;if(i.feature&&i.feature.geometry)switch(i.feature.geometry.type.toLowerCase()){case"point":a.geometry=i.feature.geometry;break;default:a.geometry=csComp.Helpers.GeoExtensions.getCentroid(i.feature.geometry.coordinates)}else a.geometry=i.location;a.layer=e.searchResultLayer,a.layerId=e.searchResultLayer.id,a.index=r++,a.id=csComp.Helpers.getGuid(),a.properties={Name:i.title,featureTypeId:"_search",searchIndex:t},a.fType=e.$layerService.getFeatureType(a),e.$layerService.calculateFeatureStyle(a),e.searchResultLayer.data.features.push(a),t=csComp.Helpers.nextChar(t)}),csComp.Services.GeojsonRenderer.render(this.$layerService,this.searchResultLayer,this.$layerService.activeMapRenderer)},e.prototype.fitMap=function(e){if(0!==this.searchResults.length){var t={xMin:NaN,xMax:NaN,yMin:NaN,yMax:NaN},r={};e.data.features.forEach(function(e){var r=e.geometry.coordinates;t.xMin=t.xMin<r[0]?t.xMin:r[0],t.xMax=t.xMax>r[0]?t.xMax:r[0],t.yMin=t.yMin<r[1]?t.yMin:r[1],t.yMax=t.yMax>r[1]?t.yMax:r[1]}),r.southWest=[t.yMin,t.xMin],r.northEast=[t.yMax,t.xMax],1===this.searchResults.length&&"point"===this.searchResults[0].location.type.toLowerCase()?this.$messageBus.publish("map","setzoom",{loc:r.southWest,zoom:16}):this.$messageBus.publish("map","setextent",r)}},e.prototype.selectFirstResult=function(){this.searchResults&&this.searchResults.length>0&&this.selectSearchResult(this.searchResults[0])},e.prototype.selectSearchResult=function(e){e.click&&e.click(e)},e.prototype.doSearch=function(e){var t=this;this.$layerService.actionServices.forEach(function(r){r.search&&r.search({query:e,results:t.searchResults},function(e,i){t.$dashboardService._search.isActive?(t.searchResults=t.searchResults.filter(function(e){return e.service!==r.id}),t.searchResults=t.searchResults.concat(i).sort(function(e,t){return t.score-e.score||-1}),t.updateSearchLayer(),"$apply"!==t.$scope.$root.$$phase&&"$digest"!==t.$scope.$root.$$phase&&t.$scope.$apply()):console.log("Ignoring old results")})})},e.prototype.leave=function(e){this.mobileLayer&&this.MyFeature&&(this.$layerService.removeFeature(this.MyFeature,!0),this.$layerService.activeMapRenderer.removeFeature(this.MyFeature),this.MyFeature=null),this.mobileLayer=null},e.prototype.join=function(e){var t=this;this.localStorageService.set("username",this.UserName),async.series([function(r){e.enabled?r():t.$layerService.addLayer(e,function(){r()})},function(r){t.mobileLayer=e;var i=new csComp.Services.Feature;i.layerId=t.mobileLayer.id,i.geometry={type:"Point",coordinates:[]},i.geometry.coordinates=[t.lastPost.longitude,t.lastPost.latitude],i.id=t.UserName,i.properties={Name:t.UserName},t.$layerService.initFeature(i,t.mobileLayer),t.$layerService.activeMapRenderer.addFeature(i),t.$layerService.saveFeature(i),t.MyFeature=i}])},e.prototype.initMobileLayers=function(e){var t=this;this.UserName=this.localStorageService.get("username"),this.UserName||(this.UserName="mobile user"),this.mobileLayers=[],e.groups.forEach(function(e){e.layers.forEach(function(e){e.tags&&e.tags.indexOf("mobile")>=0&&t.mobileLayers.push(e)})}),this.$layerService.isMobile&&(this.$messageBus.subscribe("geo",function(e,r){switch(e){case"pos":t.mobileLayer&&t.MyFeature&&(t.lastPost=r.coords,t.MyFeature.geometry.coordinates=[r.coords.longitude,r.coords.latitude],t.$layerService.activeMapRenderer.updateFeature(t.MyFeature),t.$layerService.saveFeature(t.MyFeature))}}),this.geoService.start({}))},e.prototype.updateRecentFeaturesList=function(){var e=this;setTimeout(function(){var t=e.localStorageService.get("recentfeatures");t&&(e.RecentFeatures=t,e.RecentFeatures.forEach(function(t){var r=e.$layerService.findLayer(t.layerId);r&&r.enabled&&(t.feature=e.$layerService.findFeature(r,t.id))}))},0)},e.prototype.selectFeature=function(e){this.$layerService.selectFeature(e,!1,!0)},e.prototype.initRecentFeatures=function(){var e=this;this.updateRecentFeaturesList(),this.$messageBus.subscribe("feature",function(t,r){if("onFeatureSelect"===t){e.RecentFeatures=e.RecentFeatures.filter(function(e){return e.id!==r.id});var i={id:r.id,name:csComp.Helpers.getFeatureTitle(r),layerId:r.layerId,feature:r};e.RecentFeatures.splice(0,0,i),e.RecentFeatures.length>5&&e.RecentFeatures.pop();var a=[];e.RecentFeatures.forEach(function(e){return a.push({id:e.id,name:e.name,layerId:e.layerId})}),e.localStorageService.set("recentfeatures",a),"$apply"!==e.$scope.$root.$$phase&&"$digest"!==e.$scope.$root.$$phase&&e.$scope.$root.$apply()}})},e.prototype.toggleLayer=function(e){this.$layerService.toggleLayer(e)},e.prototype.initRecentLayers=function(){var e=this,t=this.localStorageService.get("recentlayers");t&&t.forEach(function(t){var r=e.$layerService.findLayer(t);r&&e.RecentLayers.push(r)}),this.$messageBus.subscribe("layer",function(r,i){"activated"===r&&(e.RecentLayers=e.RecentLayers.filter(function(e){return e.id!==i.id}),e.RecentLayers.splice(0,0,i),e.RecentLayers.length>5&&e.RecentLayers.pop(),t=[],e.RecentLayers.forEach(function(e){return t.push(e.id)}),e.localStorageService.set("recentlayers",t),"$apply"!==e.$scope.$root.$$phase&&"$digest"!==e.$scope.$root.$$phase&&e.$scope.$apply()),e.updateRecentFeaturesList()})},e.$inject=["$scope","layerService","messageBusService","localStorageService","dashboardService","geoService"],e}();e.NavigateCtrl=r}(Navigate||(Navigate={}));var Search;!function(e){var t=function(){function e(){}return e}();e.NavigateSteps=t;var r=function(){function e(){}return e}();e.NavigateState=r}(Search||(Search={}));var OfflineSearch;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("offlineSearch",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/OfflineSearch/OfflineSearch.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.OfflineSearchCtrl}}])}(OfflineSearch||(OfflineSearch={}));var OfflineSearch;!function(e){var t=function(){function e(e,t,r,i,a,o){this.groupTitle=e,this.index=t,this.id=r,this.title=i,this.path=a,this.type=o,this.featureNames=[]}return e}();e.Layer=t;var r=function(){function e(e,t,r){this.v=Array(2),"number"==typeof e?(this.v[0]=e,this.v[1]=t):this.v=e}return Object.defineProperty(e.prototype,"layerIndex",{get:function(){return this.v[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"featureIndex",{get:function(){return this.v[1]},enumerable:!0,configurable:!0}),e.prototype.toJSON=function(){return this.v},e}();e.Entry=r;var i=function(){function e(){}return e}();e.KeywordIndex=i;var a=function(){function e(e,t){this.project=e,this.options=t,this.layers=[],this.keywordIndex={}}return e}();e.OfflineSearchResult=a}(OfflineSearch||(OfflineSearch={}));var OfflineSearch;!function(e){var t=function(){function e(e,t,r,i){this.title=e,this.layerTitle=t,this.groupTitle=r,this.entry=i,this.firstInGroup=!1}return e.prototype.toString=function(){return this.title},Object.defineProperty(e.prototype,"fullTitle",{get:function(){return this.groupTitle+" >> "+this.layerTitle+" >> "+this.title},enumerable:!0,configurable:!0}),e}();e.OfflineSearchResultViewModel=t;var r=function(){function r(e,t,r,i,a){var o=this;this.$scope=e,this.$http=t,this.$layerService=r,this.$mapService=i,this.$messageBus=a,this.isReady=!1,e.vm=this,a.subscribe("project",function(e){switch(e){case"loaded":var t=r.projectUrl.url.replace("project.json","offline_search_result.json");o.loadSearchResults(t)}}),a.subscribe("language",function(e,t){switch(e){case"newLanguage":}})}return r.prototype.loadSearchResults=function(t){var r=this;this.$http.get(t).success(function(t){r.offlineSearchResult=t;var i=t.keywordIndex,a={};for(var o in i)i.hasOwnProperty(o)&&i[o].forEach(function(t){a.hasOwnProperty(o)||(a[o]=[]),a[o].push(new e.Entry(t))});r.offlineSearchResult.keywordIndex=a,r.isReady=!0}).error(function(){console.log("OfflineSearch: error with $http ")})},r.prototype.getLocation=function(e,r){if(void 0===r&&(r=15),!this.isReady||null===e||e.length<3)return[];var i=e.toLowerCase().split(" "),a=i[i.length-1],o=this.offlineSearchResult.options.stopWords.filter(function(e){return e.indexOf(a)>-1});o.length>0&&i.splice(i.length-1,1),this.offlineSearchResult.options.stopWords.forEach(function(e){for(;i.indexOf(e)>-1;)i.splice(i.indexOf(e),1)});var s;for(var n in i){var c=this.getKeywordHits(i[n]);s=s?this.mergeResults(s,c):c}for(var l=[],p=this.offlineSearchResult.layers,u=r,d=0;u>0&&d<s.length;)for(var h=s[d++],f=Math.min(u,h.entries.length),y=0;f>y;y++){var m=h.entries[y],g=p[m.layerIndex];u--,l.push(new t(g.featureNames[m.featureIndex],g.title,g.groupTitle,m))}var v={};l.forEach(function(e){var t=e.groupTitle+" >> "+e.layerTitle;v.hasOwnProperty(t)||(v[t]=[]),v[t].push(e)}),l=[];for(var S in v)if(v.hasOwnProperty(S)){var b=!0;v[S].forEach(function(e){e.firstInGroup=b,l.push(e),b=!1})}return l},r.prototype.mergeResults=function(e,t){var r=[];return e.forEach(function(e){t.forEach(function(t){e.entries.forEach(function(i){t.entries.forEach(function(a){i.layerIndex===a.layerIndex&&i.featureIndex===a.featureIndex&&r.push({score:e.score*t.score,key:e.key+" "+t.key,entries:[i]})})})})}),r=r.sort(function(e,t){return t.score-e.score})},r.prototype.getKeywordHits=function(e){var t=[],r=this.offlineSearchResult.keywordIndex,i=Object.getOwnPropertyNames(r);return i.forEach(function(i){var a=i.score(e,null);.5>a||t.push({score:a,key:i,entries:r[i]})}),t=t.sort(function(e,t){return t.score-e.score})},r.prototype.onSelect=function(e){var t=this,r=e.entry.layerIndex,i=this.offlineSearchResult.layers[r],a=this.$layerService.findLayer(i.id);if(console.log(e),a){if(a.enabled)return void this.selectFeature(i.id,e.entry.featureIndex);var o=this.$messageBus.subscribe("layer",function(r,i){"activated"===r&&a.url===i.url&&(t.selectFeature(i.id,e.entry.featureIndex),t.$messageBus.unsubscribe(o))});this.$layerService.addLayer(a);var s=$("#layergroup_"+a.groupId);s.collapse("show")}},r.prototype.selectFeature=function(e,t){var r=this.$layerService.findFeatureByIndex(e,t);null!=r&&(this.$mapService.zoomTo(r),this.$layerService.selectFeature(r))},r.$inject=["$scope","$http","layerService","mapService","messageBusService"],r}();e.OfflineSearchCtrl=r}(OfflineSearch||(OfflineSearch={}));var ProfileHeader;!function(e){var t=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$localStorageService=t,this.$layerService=r,this.$mapService=i,this.$messageBus=a,this.profileService=o,e.vm=this,console.log("init profile service"),a.subscribe("project",function(e,t){s.$layerService.project&&(s.$scope.enabled=s.$layerService.project.profile.authenticationMethod!=csComp.Services.authMethods.none,console.log(s.$layerService.project.profile.authenticationMethod),s.$layerService.project.profile.authenticationMethod)})}return e.prototype.startLogin=function(){this.profileService.startLogin()},e.prototype.logout=function(){this.profileService.logoutUser()},e.$inject=["$scope","localStorageService","layerService","mapService","messageBusService","profileService"],e}();e.ProfileHeaderCtrl=t;var r="csComp";try{e.myModule=angular.module(r)}catch(i){e.myModule=angular.module(r,[])}e.myModule.directive("profileHeader",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Profile/ProfileHeader.tpl.html",compile:function(t){var r=e(t);return function(e){r(e)}},replace:!0,transclude:!0,controller:t}}])}(ProfileHeader||(ProfileHeader={}));var ProfileTab;!function(e){var t=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$localStorageService=t,this.$layerService=r,this.$mapService=i,this.$messageBus=a,this.profileService=o,e.vm=this,a.subscribe("project",function(e,t){s.$layerService.project&&(s.$scope.enabled=s.$layerService.project.profile.authenticationMethod!=csComp.Services.authMethods.none,console.log(s.$layerService.project.profile.authenticationMethod),s.$layerService.project.profile.authenticationMethod)})}return e.prototype.startLogin=function(){this.profileService.startLogin()},e.prototype.validateUser=function(){this.profileService.validateUser(this.userName,this.userPassword),this.userPassword=""},e.prototype.logout=function(){this.profileService.logoutUser()},e.$inject=["$scope","localStorageService","layerService","mapService","messageBusService","profileService"],e}();e.ProfileTabCtrl=t;var r="csComp";try{e.myModule=angular.module(r)}catch(i){e.myModule=angular.module(r,[])}e.myModule.directive("profiletab",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Profile/ProfileTab.tpl.html",compile:function(t){var r=e(t);return function(e){r(e)}},replace:!0,transclude:!0,controller:t}}])}(ProfileTab||(ProfileTab={}));var ProjectHeaderSelection;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("projectHeaderSelection",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/ProjectSelection/ProjectHeaderSelection.tpl.html",link:function(e,t,r){},replace:!0,transclude:!0,controller:e.ProjectHeaderSelectionCtrl}}])}(ProjectHeaderSelection||(ProjectHeaderSelection={}));var ProjectHeaderSelection;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.$layerService=t,this.$dashboardService=r,this.$mapService=i,this.$messageBusService=a,e.vm=this}return e.$inject=["$scope","layerService","dashboardService","mapService","messageBusService"],e}();e.ProjectHeaderSelectionCtrl=t}(ProjectHeaderSelection||(ProjectHeaderSelection={}));var ProjectSettings;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("projectSettings",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/ProjectSettings/ProjectSettings.tpl.html",replace:!0,controller:e.ProjectSettingsCtrl}}])}(ProjectSettings||(ProjectSettings={}));var ProjectSettings;!function(e){var t=function(){function e(e,t,r,i,a,o,s){this.$scope=e,this.$timeout=t,this.$layerService=r,this.dashboardService=i,this.mapService=a,this.messageBus=o,this.$localStorageService=s,e.vm=this}return e.prototype.toggleTouchMode=function(){this.dashboardService.touchMode=!this.dashboardService.touchMode,this.$localStorageService.set("touchmode",this.dashboardService.touchMode)},e.prototype.toggleRenderer=function(){"cesium"===this.$layerService.activeMapRenderer.title?this.$layerService.selectRenderer("leaflet"):this.$layerService.selectRenderer("cesium")},e.prototype.toggleShowLocation=function(){this.messageBus.publish("map","showLocation")},e.prototype.toggleAdminMode=function(){this.mapService.expertMode!==csComp.Services.Expertise.Admin?(this.mapService.expertMode=csComp.Services.Expertise.Admin,this.messageBus.publish("expertMode","newExpertise",csComp.Services.Expertise.Admin)):(this.mapService.expertMode=csComp.Services.Expertise.Expert,this.messageBus.publish("expertMode","newExpertise",csComp.Services.Expertise.Expert))},e.prototype.saveSettings=function(){var e=this;this.$timeout(function(){var t=e.$layerService.project.serialize();console.log("Save settings: "),csComp.Helpers.saveData(t,"project","json")},0)},e.prototype.updateProject=function(){this.$layerService.saveProject()},e.prototype.updateProjectReady=function(e){"OK"!==e.success().statusText?console.error("Error update project.json: "+JSON.stringify(e)):console.log("Project.json updated succesfully!")},e.$inject=["$scope","$timeout","layerService","dashboardService","mapService","messageBusService","localStorageService"],e}();e.ProjectSettingsCtrl=t}(ProjectSettings||(ProjectSettings={}));var Helpers;!function(e){var t;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("resize",["$window",function(e){return{terminal:!1,restrict:"A",scope:{resizeX:"@",resizeY:"@"},link:function(t,r,i){t.onResizeFunction=function(){
if(t.resizeX){var i=e.innerWidth;r.width(i-t.resizeX+"px")}if(t.resizeY){var a=e.innerHeight;r.height(a-t.resizeY+"px")}},t.onResizeFunction(),angular.element(e).bind("resize",function(){t.onResizeFunction(),t.$apply()})}}}]);angular.module("inputresizer",[]);e.myModule.directive("expandTo",function(){return{restrict:"A",link:function(e,t,r){var i=r.expandTo||"50px",a=t.width();t.on("focus",function(){t.animate({width:i},500,function(){})}).on("blur",function(){t.animate({width:a+"px"},500,function(){})})}}})}(t=e.Resize||(e.Resize={}))}(Helpers||(Helpers={}));var ShowModal;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("showModal",["$parse",function(e){return{restrict:"A",link:function(t,r,i){t.showModalDialog=function(e,t){t||(t=r);var i=$(t);e?i.appendTo("body").modal("show"):i.modal("hide")},t.$watch(i.showModal,function(e,r){t.showModalDialog(e,i.$$element)}),$(r).bind("hide.bs.modal",function(){e(i.showModal).assign(t,!1),t.$$phase||t.$root.$$phase||t.$apply()})}}}])}(ShowModal||(ShowModal={}));var StyleList;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.filter("reverse",function(){return function(e){return e.slice().reverse()}}).directive("styleList",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/StyleList/StyleList.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.StyleListCtrl}}])}(StyleList||(StyleList={}));var StyleList;!function(e){var t=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$timeout=t,this.$layerService=r,this.messageBus=i,e.vm=this,this.activeStyles=[],i.subscribe("layer",function(e){switch(e){case"activated":case"deactivate":a.initWizard()}}),i.subscribe("updatelegend",function(e,t){if("updatedstyle"===e&&a.selectedGroup){var r=a.$layerService.findGroupById(a.selectedGroup.id);r.styles&&a.$timeout(function(){a.activeStyles=_.map(r.styles.filter(function(e){return e.enabled}),function(e){return e.property})},0)}})}return e.prototype.selectGroup=function(e){if(this.selectedGroup=e,e._gui.showSections)setTimeout(function(){$("#styles_sections").collapse("show")},100);else for(var t in e._gui.sections)this.selectSection(e._gui.sections[t])},e.prototype.selectSection=function(e){this.selectedSection=e,setTimeout(function(){$("#styles_properties").collapse("show")},100)},e.prototype.initWizard=function(){console.log("init wizard"),this.selectedSection=null,this.selectedGroup=null,this.$layerService.project.groups&&this.$layerService.project.groups.length>0&&(this.$layerService.project.groups.forEach(function(e){if(delete e._gui.sections,delete e._gui.showSections,e.layers){var t={};e.layers.forEach(function(e){if(e.enabled&&e._gui.sections)for(var r in e._gui.sections){var i=e._gui.sections[r];t.hasOwnProperty(r)||(t[r]=new csComp.Services.Section);for(var a in i.properties)t[r].properties.hasOwnProperty(a)||(t[r].properties[a]=i.properties[a])}}),_.keys(t).length>0&&(e._gui.sections=t),_.keys(t).length>1&&(e._gui.showSections=!0)}}),this.selectGroup(this.$layerService.project.groups[0]))},e.prototype.setStyle=function(e,t){this.$layerService.setGroupStyle(e,t)},e.prototype.getStyle=function(e,t,r){return{"float":"left",position:"relative",top:"10px",background:"linear-gradient(to bottom, "+t.color+", "+e.legendEntries[e.legendEntries.length-r-2].color+")"}},e.$inject=["$scope","$timeout","layerService","messageBusService"],e}();e.StyleListCtrl=t}(StyleList||(StyleList={}));var Timeline;!function(e){var t=function(){function e(){this.timelineOptions={width:"100%",height:"100px",editable:!1,layout:"box"}}return e.prototype.setTimelineOptions=function(e){this.timelineOptions=e},e.prototype.$get=function(){var e=this;return{getTimelineOptions:function(){return e.timelineOptions},setTimelineOptions:function(t){return e.setTimelineOptions}}},e}(),r="csComp";try{e.myModule=angular.module(r)}catch(i){e.myModule=angular.module(r,[])}e.myModule.provider("TimelineService",t).directive("timeline",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Timeline/Timeline.tpl.html",replace:!0,transclude:!0,controller:e.TimelineCtrl}}])}(Timeline||(Timeline={}));var Timeline;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$mapService=r,this.$messageBusService=i,this.TimelineService=a,this.locale="en-us",this.timelineGroups=new vis.DataSet,this.timelineItems=new vis.DataSet,this.isPinned=!0,this.expandButtonBottom=52,this.datePickerBottom=120,this.items=new vis.DataSet,this.ids=[],this.setFocusContainerDebounce=_.debounce(function(e){o.updateFocusTimeContainer(e)},300,!0),this.throttleTimeSpanUpdate=_.debounce(this.triggerTimeSpanUpdated,1e3),this.loadLocales(),this.options={width:"100%",editable:!1,margin:0,height:54,moveable:!1,zoomMax:1728e8,zoomMin:36e5},this.debounceUpdate=_.debounce(this.updateFeatures,500),this.debounceSetItems=_.debounce(function(e){o.addItems(e)},500),e.$watch("datePickerDate",function(e){if("undefined"!=typeof e){var t=new Date(e);o.updateTimeline(t,new Date(t.getTime()+864e5))}}),e.vm=this,e.datePickerOptions={customClass:this.getDayClass,minDate:new Date(2015,1,1),maxDate:new Date},this.$messageBusService.subscribe("dashboard-main",function(e,t){"activated"===e&&(o.updatePanelHeights(),o.updateTimelineHeight())}),this.$messageBusService.subscribe("project",function(e,t){setTimeout(function(){o.$scope.timeline.setItems(o.timelineItems),o.$scope.timeline.setGroups(o.timelineGroups),null!==o.activeDateRange&&(_.isUndefined(o.activeDateRange.zoomMax)||(o.$scope.timeline.options.zoomMax=o.activeDateRange.zoomMax),_.isUndefined(o.activeDateRange.zoomMin)||(o.$scope.timeline.options.zoomMin=o.activeDateRange.zoomMin)),o.updateFocusTime(),o.updateDragging(),o.myTimer(),o.activeDateRange&&o.activeDateRange.isLive&&o.goLive()},0)}),this.initTimeline(),this.$messageBusService.subscribe("timeline",function(e,t){o.update(e,t)}),this.$messageBusService.subscribe("feature",function(e,t){"onFeatureSelect"===e&&t&&-1!==o.ids.indexOf(t.id)&&o.$scope.timeline.setSelection(t.id)}),this.$messageBusService.subscribe("language",function(e,t){switch(e){case"newLanguage":o.initTimeline()}}),this.$messageBusService.subscribe("layer",function(e,t){switch(e){case"timelineUpdated":o.addTimelineItemsInLayer(t);break;case"activated":o.addTimelineItemsInLayer(t);break;case"deactivate":o.removeTimelineItemsInLayer(t)}})}return e.prototype.updateTimeline=function(e,t){var r=this.$layerService.project.activeDashboard;if(r.showTimeline&&(r.timeline||this.$layerService.project.timeLine)){var i=r.timeline?r.timeline:this.$layerService.project.timeLine;i.start=e.getTime(),i.end=t.getTime(),this.$messageBusService.publish("timeline","updateTimerange",i)}},e.prototype.getDayClass=function(e){var t=e.date,r=e.mode;if("day"===r){new Date(t).setHours(0,0,0,0)}return""},e.prototype.addTimelineItemsInLayer=function(e){if(e.timeAware&&e.data&&e.data.features){var t=e.timelineConfig,r=[];e.data.features.forEach(function(i){var a=i.properties,o=i.fType.timelineConfig;if(o||t){var s=o&&o.classProperty||t&&t.classProperty,n=o&&o.groupClassProperty||t&&t.groupClassProperty,c=o&&o.contentProperty||t&&t.contentProperty,l=o&&o.startTimeProperty||t&&t.startTimeProperty,p=o&&o.endTimeProperty||t&&t.endTimeProperty,u=o&&o.groupProperty||t&&t.groupProperty,d={id:i.id,layerId:e.id,className:a.hasOwnProperty(s)?a[s]:o&&o["class"]||t&&t["class"],groupClass:a.hasOwnProperty(n)?a[n]:o&&o.groupClass||t&&t.groupClass,group:a.hasOwnProperty(u)?a[u]:o&&o.group||t&&t.group||"",start:a.hasOwnProperty(l)?a[l]:null,end:a.hasOwnProperty(p)?a[p]:null,type:a.hasOwnProperty("type")?a.type:null,content:a.hasOwnProperty(c)?a[c]:""};d.start&&r.push(d)}}),this.addItems(r)}},e.prototype.removeTimelineItemsInLayer=function(e){if(e.timeAware&&e.data&&e.data.features){var t=[];this.timelineItems.forEach(function(r){r.layerId===e.id&&t.push(r)}),this.deleteItems(t)}},e.prototype.updateGroups=function(){var e=this;this.timelineGroups.clear();var t=[];this.timelineItems.forEach(function(r){t.indexOf(r.group)>=0||(t.push(r.group),e.timelineGroups.add({className:r.groupClass,content:r.group,id:r.group,title:r.group}))})},e.prototype.update=function(e,t){switch(e){case"updateTimerange":this.$scope.timeline.setWindow(t.start,t.end),this.updateFocusTime();break;case"loadProjectTimeRange":if("undefined"==typeof this.$layerService.project||null===this.$layerService.project||"undefined"==typeof this.$layerService.project.timeLine||null===this.$layerService.project.timeLine)return;this.$scope.timeline.setWindow(this.$layerService.project.timeLine.start,this.$layerService.project.timeLine.end),this.updateFocusTime();break;case"setFocus":this.setFocusContainerDebounce(t);break;case"updateFeatures":this.debounceUpdate();break;case"setItems":this.debounceSetItems(t);break;case"setGroups":this.setGroups(t)}},e.prototype.addItems=function(e){var t=this;if(e){var r=[];e.forEach(function(e){-1===t.timelineItems.getIds().indexOf(e.id)&&r.push(e)}),this.timelineItems.add(r),this.updateGroups()}},e.prototype.deleteItems=function(e){e&&(this.timelineItems.remove(e),this.updateGroups())},e.prototype.setGroups=function(e){e&&1!==e.length&&this.timelineGroups.add(e)},e.prototype.updateFeatures=function(){var e=this,t=[],r=!1;this.$layerService.project.features.forEach(function(i){if(r=!0,i.layer.showOnTimeline&&i.properties.hasOwnProperty("date")&&(t.push(i.id),-1===e.ids.indexOf(i.id))){var a={id:i.id,group:"all",content:i.properties.Name,start:new Date(i.properties.date)};e.items.update(a),e.ids.push(i.id)}}),this.ids.forEach(function(i){if(r=!0,-1===t.indexOf(i)){e.items.remove(i);e.ids=e.ids.filter(function(e){return i!==e})}}),r&&this.$scope.timeline.redraw()},e.prototype.initTimeline=function(){for(var e=this,t=document.getElementById("timeline");t.firstChild;)t.removeChild(t.firstChild);this.$layerService.timeline=this.$scope.timeline=new vis.Timeline(t,this.items,this.options),this.$scope.timeline.addCustomTime(this.focusDate,"1"),this.$scope.timeline.on("timechange",function(e){console.log(e.time)}),this.$layerService.timeline.redraw(),this.$layerService.project&&null!==this.activeDateRange&&(this.$scope.timeline.setWindow(this.activeDateRange.start,this.activeDateRange.end),this.activeDateRange&&this.activeDateRange.isLive&&this.goLive()),this.updateDragging(),this.updateFocusTime(),this.$scope.timeline.on("select",function(t){if(t.items&&t.items.length>0){var r=t.items[0],i=e.$layerService.findFeatureById(r);i?e.$layerService.selectFeature(i):e.$layerService.project.eventTab&&e.$messageBusService.publish("eventtab","zoomto",{id:r})}}),this.$scope.timeline.addEventListener("rangechange",_.throttle(function(t){return e.onRangeChanged(t)},200))},e.prototype.selectDate=function(){},e.prototype.updateDragging=function(){var e=this;this.activeDateRange&&this.activeDateRange.isLive?$("#focustimeContainer").draggable("disable"):($("#focustimeContainer").draggable({axis:"x",containment:"parent",drag:_.throttle(function(){return e.updateFocusTime()},200)}),$("#focustimeContainer").draggable("enable"))},e.prototype.expandToggle=function(){this.activeDateRange.isExpanded=!this.activeDateRange.isExpanded,this.updateTimelineHeight(),this.updatePanelHeights()},e.prototype.updateTimelineHeight=function(){this.options.moveable=this.activeDateRange.ismoveable,this.options.height=this.activeDateRange.isExpanded?this.activeDateRange.expandHeight:54,this.expandButtonBottom=this.activeDateRange.isExpanded?this.activeDateRange.expandHeight-1:52,this.datePickerBottom=this.expandButtonBottom+170,this.$layerService.timeline.setOptions(this.options),this.$layerService.timeline.redraw()},e.prototype.updatePanelHeights=function(){this.activeDateRange=this.$layerService.project.activeDashboard.timeline?this.$layerService.project.activeDashboard.timeline:this.$layerService.project.timeLine;var e=this.activeDateRange.isExpanded&&this.$layerService.project.activeDashboard.showTimeline?this.activeDateRange.expandHeight:54;$(".leftpanel-container").css("bottom",e+20),$(".rightpanel").css("bottom",e)},e.prototype.triggerTimeSpanUpdated=function(){this.$messageBusService.publish("timeline","timeSpanUpdated","")},e.prototype.onRangeChanged=function(e){this.updateFocusTime(),this.throttleTimeSpanUpdate()},e.prototype.start=function(){var e=this;this.stop(),this.isPlaying=!0,this.timer&&(this.timer=null),this.timer=setInterval(function(){e.myTimer()},500)},e.prototype.goLive=function(){this.stop(),this.activeDateRange.isLive=!0,this.isPlaying=!1,this.activeDateRange.isLive&&(this.myTimer(),this.start()),this.updateDragging()},e.prototype.stopLive=function(){this.activeDateRange&&(this.stop(),this.activeDateRange.isLive=!1,this.isPlaying=!1,this.updateDragging())},e.prototype.myTimer=function(){var e=this.$scope.timeline;if(this.activeDateRange.isLive){var t=e._toScreen(new Date);$("#focustimeContainer").css("left",t-65),this.isPinned&&e.moveTo(new Date,{animation:{duration:500,easingFunction:"linear"}}),this.updateFocusTime()}else if(this.isPlaying){var r=e.getWindow(),i=(r.end.getTime()-r.start.getTime())/200;e.setWindow(r.start.getTime()+i,r.end.getTime()+i,{animation:{duration:500,easingFunction:"linear"}}),this.updateFocusTime()}},e.prototype.mouseEnter=function(){this.updateFocusTime(),isNaN(this.focusDate.getTime())||(this.showControl=!0)},e.prototype.mouseLeave=function(){this.isPlaying||(this.showControl=!1)},e.prototype.pin=function(){this.isPinned=!0},e.prototype.unPin=function(){this.isPinned=!1},e.prototype.pinToNow=function(){this.isPinned=!0,this.start()},e.prototype.stop=function(){this.isPlaying=!1,this.timer&&clearInterval(this.timer)},e.prototype.timelineSelect=function(){},e.prototype.updateFocusTimeContainer=function(e){this.$scope.timeline.moveTo(e),this.$scope.timeline.redraw(),"$apply"!==this.$scope.$$phase&&"$digest"!==this.$scope.$$phase&&this.$scope.$apply();var t=this.$scope.timeline._toScreen(e);$("#focustimeContainer").css("left",t-$("#focustimeContainer").width()/2)},e.prototype.updateFocusTime=function(){var e=this;this.$layerService.project&&setTimeout(function(){var t=e.$scope.timeline;t.showCustomTime=!0;var r=e.$scope.timeline.getWindow(),i=$("#focustimeContainer").position().left+$("#focustimeContainer").width()/2;if(e.activeDateRange.isLive?e.focusDate=new Date:e.focusDate=new Date(e.$scope.timeline._toTime(i)),e.startDate=r.start,e.endDate=r.end,null!=e.activeDateRange){e.activeDateRange.setFocus(e.focusDate,e.startDate,e.endDate),e.$layerService.project.timeLine.setFocus(e.focusDate,e.startDate,e.endDate);var a=e.focusDate.toLocaleString(e.locale,{month:"long"});switch(e.activeDateRange.zoomLevelName){case"decades":e.line1=e.focusDate.getFullYear().toString(),e.line2="";break;case"years":e.line1=e.focusDate.getFullYear().toString(),e.line2=a;break;case"weeks":e.line1=e.focusDate.getFullYear().toString(),e.line2=moment(e.focusDate).format("DD")+" "+a;break;case"milliseconds":e.line1=moment(e.focusDate).format("MM - DD - YYYY"),e.line2=moment(e.focusDate).format("HH:mm:ss.SSS");break;default:e.line1=moment(e.focusDate).format("MM - DD - YYYY"),e.line2=moment(e.focusDate).format("HH:mm:ss")}}"$apply"!==e.$scope.$$phase&&"$digest"!==e.$scope.$$phase&&e.$scope.$apply(),e.$messageBusService.publish("timeline","focusChange",e.focusDate),t.setCustomTime(e.focusDate,"1")},0)},e.prototype.loadLocales=function(){"undefined"==typeof vis?(vis={},vis.locales={}):"undefined"==typeof vis.locales&&(vis.locales={}),vis.locales.en={MONTHS:["January","February","March","April","May","June","July","August","September","October","November","December"],MONTHS_SHORT:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],DAYS:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],DAYS_SHORT:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ZOOM_IN:"Zoom in",ZOOM_OUT:"Zoom out",MOVE_LEFT:"Move left",MOVE_RIGHT:"Move right",NEW:"New",CREATE_NEW_EVENT:"Create new event"},vis.locales.en_US=vis.locales.en,vis.locales.en_UK=vis.locales.en,vis.locales.fr={MONTHS:["Janvier","Fvrier","Mars","Avril","Mai","Juin","Juillet","Aot","Septembre","Octobre","Novembre","Dcembre"],MONTHS_SHORT:["Jan","Fev","Mar","Avr","Mai","Jun","Jul","Aou","Sep","Oct","Nov","Dec"],DAYS:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],DAYS_SHORT:["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"],ZOOM_IN:"Zoomer",ZOOM_OUT:"Dzoomer",MOVE_LEFT:"Dplacer  gauche",MOVE_RIGHT:"Dplacer  droite",NEW:"Nouveau",CREATE_NEW_EVENT:"Crer un nouvel vnement"},vis.locales.fr_FR=vis.locales.fr,vis.locales.fr_BE=vis.locales.fr,vis.locales.fr_CA=vis.locales.fr,vis.locales.de={MONTHS:["Januar","Februar","Mrz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],MONTHS_SHORT:["Jan","Feb","Mr","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],DAYS:["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"],DAYS_SHORT:["Son","Mon","Die","Mit","Don","Fre","Sam"],ZOOM_IN:"Vergrern",ZOOM_OUT:"Verkleinern",MOVE_LEFT:"Nach links verschieben",MOVE_RIGHT:"Nach rechts verschieben",NEW:"Neu",CREATE_NEW_EVENT:"Neues Ereignis erzeugen"},vis.locales.de_DE=vis.locales.de,vis.locales.de_CH=vis.locales.de,vis.locales.nl={MONTHS:["januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december"],MONTHS_SHORT:["jan","feb","mrt","apr","mei","jun","jul","aug","sep","okt","nov","dec"],DAYS:["zondag","maandag","dinsdag","woensdag","donderdag","vrijdag","zaterdag"],DAYS_SHORT:["zo","ma","di","wo","do","vr","za"],ZOOM_IN:"Inzoomen",ZOOM_OUT:"Uitzoomen",MOVE_LEFT:"Naar links",MOVE_RIGHT:"Naar rechts",NEW:"Nieuw",CREATE_NEW_EVENT:"Nieuwe gebeurtenis maken"},vis.locales.nl_NL=vis.locales.nl,vis.locales.nl_BE=vis.locales.nl},e.$inject=["$scope","layerService","mapService","messageBusService","TimelineService"],e}();e.TimelineCtrl=t}(Timeline||(Timeline={}));var TripPlanner;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("tripplanner",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/TripPlanner/TripPlanner.tpl.html",replace:!0,transclude:!0,controller:e.TripPlannerCtrl}}])}(TripPlanner||(TripPlanner={}));var TripPlanner;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$mapService=t,this.$layerService=r,this.$messageBusService=i,this.$dashboardService=a,this.urlKeys=["arriveBy","fromPlace","toPlace","intermediatePlaces","date","time","mode","maxWalkDistance","walkSpeed","bikeSpeed","maxTimeSec","precisionMeters","zDataType","coordinateOrigin"],this.scope=e,e.vm=this,this.layer=e.$parent.data,this.tabs=[],this.tabs.push({icon:"fa-edit",title:"Edit"}),this.tabs.push({icon:"fa-map-marker",title:"Route"}),this.activeTab="Edit",this.urlParameters={},this.urlKeys.forEach(function(e){o.urlParameters[e]=0}),this.bikeSpeedKm,this.walkSpeedKm,this.transportModes={},this.transportModes.Walking="WALK",this.transportModes.Biking="BICYCLE",this.transportModes["Public transport"]="TRANSIT"}return e.prototype.planRoute=function(){this.urlParameters.time=encodeURIComponent(this.time),this.urlParameters.mode=this.transportMode,this.walkSpeedKm&&(this.urlParameters.walkSpeed=csComp.Helpers.GeoExtensions.convertKmToMile(this.walkSpeedKm)),this.bikeSpeedKm&&(this.urlParameters.bikeSpeed=csComp.Helpers.GeoExtensions.convertKmToMile(this.bikeSpeedKm)),this.layer.url=csComp.Helpers.joinUrlParameters(this.urlParameters,"?","&","="),this.layer.enabled?this.layer.layerSource&&this.layer.layerSource.refreshLayer(this.layer):this.$layerService.addLayer(this.layer),this.$layerService.visual.rightPanelVisible=!0},e.prototype.parseUrl=function(){this.urlParameters=csComp.Helpers.parseUrlParameters(this.layer.url,"?","&","=");var e=new Date(Date.now());this.time=("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2),this.urlParameters.date=e.getMonth()+1+"-"+e.getDate()+"-"+e.getFullYear(),this.transportMode=this.urlParameters.mode,this.urlParameters.hasOwnProperty("walkSpeed")&&(this.walkSpeedKm=+csComp.Helpers.GeoExtensions.convertMileToKm(this.urlParameters.walkSpeed).toFixed(2)),this.urlParameters.hasOwnProperty("bikeSpeed")&&(this.bikeSpeedKm=+csComp.Helpers.GeoExtensions.convertMileToKm(this.urlParameters.bikeSpeed).toFixed(2)),"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply()},e.prototype.featureTabActivated=function(e){var t=this;if(console.log("activated tab"+e),"Route"===e){var r=this.$layerService.findLayer("tripplanner");if(!r)return;if(!r.data.features||0===r.data.features.length)return;this.itineraries=[],r.data.features.forEach(function(e){t.itineraries.push(e.properties)}),this.activeTab="Route"}else this.activeTab="Edit"},e.$inject=["$scope","mapService","layerService","messageBusService","dashboardService"],e}();e.TripPlannerCtrl=t}(TripPlanner||(TripPlanner={}));var Voting;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("voting",["$timeout",function(e){return{restrict:"EA",require:"^ngModel",scope:{min:"=",max:"=",ngModel:"=",ngChange:"&"},template:'<div style="line-height: 12px; vertical-align: top; margin: 0; background: rgba(0, 0, 0, 0.1); border-radius: 6px; padding: 4px 6px;"><a href="" data-ng-click="decrement()" data-ng-disabled="ngModel <= min" style="float: left;"><i class="fa" data-ng-class="{true: \'fa-minus-square\', false: \'fa-minus-square-o\'}[ngModel > min]"></i></a><span style="float: left; width:28px; text-align: center;">{{ngModel}}</span><a href="" data-ng-click="increment()" data-ng-disabled="ngModel >= max"><i class="fa" data-ng-class="{true: \'fa-plus-square\' , false: \'fa-plus-square-o\' }[ngModel < max]"></i></a></div>',link:function(t){t.increment=function(){t.ngModel>=t.max||(t.ngModel++,e(t.ngChange,0))},t.decrement=function(){t.ngModel<=t.min||(t.ngModel--,e(t.ngChange,0))}}}}])}(Voting||(Voting={}));var csComp;!function(e){var t;!function(t){var r=function(){function e(e,t){this.action=e,this.data=t}return e}();t.ClientMessage=r;var i=function(){function e(e,t){this.topic=e,this.callback=t}return e}();t.MessageBusHandle=i;var a=function(){function e(){this._listeners=[]}return e.prototype.add=function(e){this._listeners.push(e)},e.prototype.remove=function(e){if("function"==typeof e){for(var t=0,r=this._listeners.length;r>t;r++)if(this._listeners[t]===e){this._listeners.splice(t,1);break}}else this._listeners=[]},e.prototype.trigger=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];for(var r={},i=this._listeners.slice(0),a=0,o=i.length;o>a;a++)i[a].apply(r,e||[])},e}();t.TypedEvent=a;var o=function(){function e(e,t,r){this.id=e,this.url=t,this.bus=r,this.cache={},this.subscriptions={},this.events=new a}return e.prototype.unsubscribe=function(e,t){if(this.subscriptions.hasOwnProperty(e)){var r=this.subscriptions[e];r.callbacks=r.callbacks.filter(function(e){return e!==t}),0===r.callbacks.length&&(this.socket.emit(e,{action:"unsubscribe"}),this.socket.removeListener(e,r.serverCallback),r.serverCallback=null,delete this.subscriptions[e])}},e.prototype.reSubscribeAll=function(){console.log("resubscribing...");for(var e in this.subscriptions){console.log("reconnecting "+e);var t=this.subscriptions[e];this.socket.emit("subscribe",{id:t.id,target:t.target,type:t.type})}},e.prototype.disconnectAll=function(){console.log("resubscribing...");for(var e in this.subscriptions){var t=this.subscriptions[e];t.callbacks.forEach(function(e){return e(t.id,{action:"unsubscribed"})})}},e.prototype.subscribe=function(e,t,r){var i=this;if(this.socket){var a,o=[];for(var s in this.subscriptions)this.subscriptions[s].target===e&&this.subscriptions[s].type===t&&o.push(this.subscriptions[s]);return null==o||0===o.length?(a=new c(e,t),this.socket.emit("subscribe",{id:a.id,target:a.target,type:a.type}),a.callbacks.push(r),this.subscriptions[a.id]=a,a.serverCallback=function(r){"key"===t&&i.bus.publish("keyupdate",e,r),a.callbacks.forEach(function(e){return e(a.id,r)})},this.socket.on(a.id,a.serverCallback)):(a=o[0],a.callbacks.push(r)),a}},e.prototype.connect=function(e){var t=this;this.isConnected||this.isConnecting||"undefined"==typeof io||(this.socket=io(),this.isConnecting=!0,this.socket.on("connect",function(){console.log("socket.io connected"),t.isConnecting=!1,t.isConnected=!0,t.events.trigger("connected"),t.reSubscribeAll(),e()}),this.socket.on("disconnect",function(){t.isConnecting=!1,t.isConnected=!1,t.disconnectAll(),t.events.trigger("disconnected")}),this.socket.on("reconnect_attempt",function(){console.log("socket.io reconnect attempt"),t.isConnecting=!0,t.isConnected=!1}),this.socket.on("reconnect_failed",function(){console.log("socket.io reconnect failed"),t.isConnecting=!1}))},e.prototype.disconnect=function(){},e}();t.Connection=o,function(e){e[e.BottomRight=0]="BottomRight",e[e.BottomLeft=1]="BottomLeft",e[e.TopRight=2]="TopRight",e[e.TopLeft=3]="TopLeft",e[e.TopBar=4]="TopBar"}(t.NotifyLocation||(t.NotifyLocation={}));var s=t.NotifyLocation;!function(e){e[e.Normal=0]="Normal",e[e.Info=1]="Info",e[e.Error=2]="Error",e[e.Success=3]="Success"}(t.NotifyType||(t.NotifyType={}));var n=t.NotifyType,c=function(){function t(t,r){this.target=t,this.type=r,this.callbacks=[],this.id=e.Helpers.getGuid()}return t}();t.ServerSubscription=c;var l=function(){function e(e){this.$translate=e,this.connections={},this.notifications=[],this.confirms=[],PNotify.prototype.options.styling="fontawesome"}return e.prototype.getConnection=function(e){return this.connections.hasOwnProperty(e)?this.connections[e]:null},e.prototype.initConnection=function(e,t,r){null==e&&(e="");var i=this.getConnection(e);null==i&&(i=new o(e,t,this),this.connections[i.id]=i),this.connections[e].connect(function(){r()})},e.prototype.serverPublish=function(e,t,r){void 0===r&&(r="");var i=this.getConnection(r);return null==i?null:void i.socket.emit(e,t)},e.prototype.serverSendMessage=function(e,t){void 0===t&&(t="");var r=this.getConnection(t);return null===r||null===r.socket?null:void r.socket.emit("msg",e)},e.prototype.serverSendMessageAction=function(e,t,i){void 0===i&&(i="");var a=new r(e,t);this.serverSendMessage(a,i)},e.prototype.serverSubscribe=function(e,t,r,a){void 0===a&&(a="");var o=this.getConnection(a);if(null==o)return null;var s=o.subscribe(e,t,r);return s?new i(s.id,r):null},e.prototype.serverUnsubscribe=function(e,t){if(void 0===t&&(t=""),e){var r=this.getConnection(t);return null==r?null:void r.unsubscribe(e.topic,e.callback)}},e.prototype.notifyWithTranslation=function(e,t,r,i,a){var o=this;void 0===r&&(r=s.BottomRight),void 0===i&&(i=n.Normal),void 0===a&&(a=4e3),this.$translate(e).then(function(e){o.$translate(t).then(function(t){o.notify(e,t,r,i,a)})})},e.prototype.notifyError=function(e,t){this.notify(e,t,s.TopBar,n.Error)},e.prototype.notify=function(e,t,r,i,a){if(void 0===r&&(r=s.TopBar),void 0===i&&(i=n.Normal),void 0===a&&(a=4e3),this.notifications){this.notifications=this.notifications.filter(function(e){return e.state&&"closed"!==e.state});var o;if(this.notifications.some(function(r){if("closed"===r.state)return!1;if(r.options.title===e){var i=!1,a=r.options.text.split("\n");return a.some(function(e,r,a){if(e.replace(/(\ \<\d+\>$)/,"")===t){var o,s=e.replace(/(\ \<\d+\>$)/,""),n=e.match(/(\ \<\d+\>$)/);return o=n?+n[0].match(/\d+/)+1:2,a[r]=s+" <"+o+">",i=!0,!0}return!1}),i||a.push(t),o=a.join("\n"),r.update({text:o}),!0}return!1}),o)return}var c={title:e,text:t,cornerclass:"ui-pnotify-sharp",shadow:!1,addclass:"csNotify",width:"500px",animation:"fade",mouse_reset:!0,animate_speed:"slow",nonblock:{nonblock:!0,nonblock_opacity:.2},buttons:{closer:!0,sticker:!1},hide:!0};"undefined"!=typeof a&&(c.delay=a);var l=new PNotify(c);return this.notifications.push(l),l},e.prototype.confirmButtons=function(e,t,r,i){var a=[],o={title:e,text:t,addclass:"csNotify",width:"500px",animation:"fade",hide:!1,confirm:{confirm:!0,buttons:a},buttons:{closer:!1,sticker:!1},history:{history:!1},icon:"fa fa-question-circle",cornerclass:"ui-pnotify-sharp"},s=new PNotify(o).get().on("pnotify.confirm",function(e,t){i("ok")}).on("pnotify.cancel",function(){i(null)});return s},e.prototype.confirm=function(e,t,r,i){if(void 0===i&&(i=!0),i||!this.confirms||!_.any(this.confirms,function(r){return!r.options.closed&&r.options.title===e&&r.options.text===t})){var a={title:e,text:t,addclass:"csNotify",width:"500px",animation:"fade",hide:!1,closed:!1,confirm:{confirm:!0},buttons:{closer:!0,sticker:!0},history:{history:!1},icon:"fa fa-question-circle",cornerclass:"ui-pnotify-sharp",duration:6e4},o=new PNotify(a).get().on("pnotify.confirm",function(e){a.closed=!0,r(!0)}).on("pnotify.cancel",function(e){a.closed=!0,r(!1)});return o.options=a,this.confirms.push(o),o}},e.prototype.notifyBottom=function(e,t){var r={dir1:"up",dir2:"right",spacing1:0,spacing2:0},i={title:"Over Here",text:"Check me out. I'm in a different stack.",addclass:"stack-bar-bottom",cornerclass:"",width:"70%",stack:r};new PNotify(i)},e.prototype.notifyData=function(e){new PNotify(e)},e.prototype.publish=function(t,r,i){e.cache[t]&&e.cache[t].forEach(function(e){return e(r,i)})},e.prototype.subscribe=function(t,r){return e.cache[t]||(e.cache[t]=new Array),e.cache[t].push(r),new i(t,r)},e.prototype.unsubscribe=function(t){var r=t.topic,i=t.callback;e.cache[r]&&e.cache[r].forEach(function(t,a){return t===i?void e.cache[r].splice(a,1):void 0})},e.cache={},e.$inject=["$translate"],e}();t.MessageBusService=l;var p=function(){function e(){}return e.prototype.bind=function(e,t){this.myEvents=this.myEvents||{},this.myEvents[e]=this.myEvents[e]||[],this.myEvents[e].push(t)},e.prototype.unbind=function(e,t){this.myEvents=this.myEvents||{},e in this.myEvents!=!1&&this.myEvents[e].splice(this.myEvents[e].indexOf(t),1)},e.prototype.unbindEvent=function(e){this.myEvents=this.myEvents||{},this.myEvents[e]=[]},e.prototype.unbindAll=function(){this.myEvents=this.myEvents||{};for(var e in this.myEvents)this.myEvents[e]=!1},e.prototype.trigger=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(this.myEvents=this.myEvents||{},e in this.myEvents!=!1)for(var i=0;i<this.myEvents[e].length;i++)this.myEvents[e][i].apply(this,Array.prototype.slice.call(arguments,1))},e.prototype.registerEvent=function(e){this[e]=function(t,r){return"function"==typeof t&&(r&&this.unbindEvent(e),this.bind(e,t)),this}},e.prototype.registerEvents=function(e){var t=this;e.forEach(function(e){t.registerEvent(e)})},e}();t.EventObj=p;var u="csComp";try{t.myModule=angular.module(u)}catch(d){t.myModule=angular.module(u,[])}t.myModule.service("messageBusService",e.Services.MessageBusService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(e,t){this.messageBusService=e,this.$timeout=t,this.actions={}}return t.prototype.init=function(t){var r=this;this.layerService=t,this.actions["select feature"]=function(){var t=e.Helpers.createRightPanelTab("featureprops","featureprops",null,"Selected feature",'{{"FEATURE_INFO" | translate}}',"info",!1,!0);r.messageBusService.publish("rightpanel","activate",t),r.layerService.visual.rightPanelVisible=!0},this.actions["select agenda"]=function(){var t=e.Helpers.createRightPanelTab("agenda","agenda",null,"Selected agenda",'{{"AGENDA_INFO" | translate}}',"info",!1,!0);r.messageBusService.publish("rightpanel","activate",t)},this.actions["show style tab"]=function(){r.layerService.visual.leftPanelVisible=!0,$("#style-tab").click();
},this.actions["show filter tab"]=function(){r.layerService.visual.leftPanelVisible=!0,$("#filter-tab").click()},this.actions["activate timerange"]=function(){console.log("Activate timerange action called"),r.layerService.project.timeLine.start=(new Date).getTime()-72e5,r.layerService.project.timeLine.end=(new Date).getTime()+72e5,r.layerService.project.timeLine.focus=(new Date).getTime()},this.actions["activate layer"]=function(e){console.log("Activate layer action called");var t=r.layerService.findLayer(e.layerId);"undefined"!=typeof t&&r.layerService.toggleLayer(t)},this.actions["activate style"]=function(e){if(console.log("Activate style action called"),e.layerId){var t=r.layerService.findLayer(e.layerId);if("undefined"!=typeof t){if(!t.enabled)return void r.layerService.toggleLayer(t,function(){r.$timeout(function(){r.activateStyle(e.groupId,e.propertyId)},50)});if(t.isLoading){var i=r.messageBusService.subscribe("layer",function(t,a){"activated"===t&&a.id===e.layerId&&(r.$timeout(function(){r.activateStyle(e.groupId,e.propertyId)},50),r.messageBusService.unsubscribe(i))});return}}}r.activateStyle(e.groupId,e.propertyId)},this.actions["activate baselayer"]=function(e){console.log("Activate baselayer action called");var t=r.layerService.$mapService.getBaselayer(e.layerId);r.layerService.activeMapRenderer.changeBaseLayer(t),r.layerService.$mapService.changeBaseLayer(e.layerId)},this.actions["zoom map"]=function(e){console.log("Zoom map action called"),e.zoomLevel&&r.$timeout(function(){r.layerService.map.getMap().setZoom(+e.zoomLevel)},0)},this.actions["center on map"]=function(e){console.log("Center map action called"),r.layerService.centerFeatureOnMap(r.layerService.selectedFeatures)},this.actions["reload project"]=function(e){console.log("Reload project action called"),r.layerService.openProject(r.layerService.projectUrl),r.layerService.checkViewBounds()}},t.prototype.execute=function(e,t){var r=e.toLowerCase();return this.actions.hasOwnProperty(r)?void this.actions[r](t):void console.log("Warning: action "+e+" is not defined!")},t.prototype.addAction=function(e,t){return this.actions.hasOwnProperty(e)?void console.log("Warning: action "+e+" is already defined!"):void(this.actions[e.toLowerCase()]=t)},t.prototype.getActions=function(){var e;return ng.copy(this.actions,e),e},t.prototype.activateStyle=function(e,t){var r=this.layerService.findGroupById(e);if("undefined"!=typeof r){var i=this.layerService.findPropertyTypeById(t);"undefined"!=typeof i&&this.layerService.setGroupStyle(r,i)}},t.$inject=["messageBusService","$timeout"],t}();t.ActionService=r;var i="csComp";try{t.myModule=angular.module(i)}catch(a){t.myModule=angular.module(i,[])}t.myModule.service("actionService",e.Services.ActionService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(e,t){this.$layerService=e,this.$dashboardService=t,this.mb=this.$layerService.$messageBusService}return e.prototype.start=function(e){var t=this;this.ctrl=e,this.options=e.$scope.data.generator,e.widget.enabled=!1,$("#"+this.ctrl.widget.elementId+"-container").css("display","none"),this.mb.subscribe("feature",function(e,r){t.options.hasOwnProperty("trigger")&&"hover"===t.options.trigger.toLowerCase()&&"onFeatureHover"===e&&t.selectFeature(r),t.options.hasOwnProperty("trigger")&&"click"===t.options.trigger.toLowerCase()&&"onFeatureSelect"===e&&t.selectFeature(r)}),e.initChart()},e.prototype.selectFeature=function(e){if(!this.options.hasOwnProperty("featureType")||this.options.featureType===e.fType.name){$("#"+this.ctrl.widget.elementId+"-container").css("display","block"),this.lastSelectedFeature=e;var t=[];if(this.options.hasOwnProperty("properties")){var r=parseInt(this.ctrl.widget.width.toLowerCase().replace("px","").replace("%",""))-50,i=parseInt(this.ctrl.widget.height.toLowerCase().replace("px","").replace("%",""))-75;this.options.properties instanceof Array?t=this.options.properties:this.options.properties instanceof String&&(t=[this.options.properties]);var a=[];t.forEach(function(t){e.properties.hasOwnProperty(t)&&a.push({category:t,position:0,value:e.properties[t]})}),this.ctrl.widget.enabled=!1;var o={width:r,height:i,padding:{top:10,left:30,bottom:30,right:10},data:[{name:"table",values:a}],scales:[{name:"cat",type:"ordinal",domain:{data:"table",field:"category"},range:"height",padding:.2},{name:"val",type:"linear",domain:{data:"table",field:"value"},range:"width",round:!0,nice:!0},{name:"color",type:"ordinal",domain:{data:"table",field:"position"},range:"category20"}],axes:[{type:"y",scale:"cat",tickSize:0,tickPadding:8}],marks:[{type:"group",from:{data:"table",transform:[{type:"facet",groupby:["category"]}]},properties:{enter:{y:{scale:"cat",field:"key"},height:{scale:"cat",band:!0}}},scales:[{name:"pos",type:"ordinal",range:"height",domain:{field:"position"}}],marks:[{name:"bars",type:"rect",properties:{enter:{y:{scale:"pos",field:"position"},height:{scale:"pos",band:!0},x:{scale:"val",field:"value"},x2:{scale:"val",value:0},fill:{scale:"color",field:"position"}}}},{type:"text",from:{mark:"bars"},properties:{enter:{x:{field:"x2",offset:-15},y:{field:"y"},dy:{field:"height",mult:.5},fill:{value:"white"},align:{value:"right"},baseline:{value:"middle"},text:{field:"datum.value"}}}}]}]};this.ctrl.$scope.data._spec=o,this.ctrl.updateChart()}}},e.prototype.stop=function(){},e}();e.PropertyBarChartGenerator=t;var r=function(){function e(e,t){this.$layerService=e,this.$dashboardService=t,this.mb=this.$layerService.$messageBusService}return e.prototype.start=function(e){var t=this;this.ctrl=e,this.options=e.$scope.data.generator,e.widget.enabled=!1,$("#"+this.ctrl.widget.elementId+"-container").css("display","none"),this.mb.subscribe("timeline",function(e,r){"sensorLinkUpdated"===e&&t.lastSelectedFeature&&t.selectFeature(t.lastSelectedFeature)}),this.mb.subscribe("feature",function(e,r){switch(e){case"onFeatureSelect":t.selectFeature(r)}}),this.$layerService.lastSelectedFeature&&this.selectFeature(this.$layerService.lastSelectedFeature),e.initChart()},e.prototype.selectFeature=function(e){var t=this;if(!e.sensors)return void $("#"+this.ctrl.widget.elementId+"-container").css("display","none");if(!this.options.hasOwnProperty("featureType")||this.options.featureType===e.fType.name){$("#"+this.ctrl.widget.elementId+"-container").css("display","block"),this.lastSelectedFeature=e;var r=[];if(this.options.hasOwnProperty("properties")){var i=parseInt(this.ctrl.widget._width.toLowerCase().replace("px","").replace("%",""))-50,a=parseInt(this.ctrl.widget._height.toLowerCase().replace("px","").replace("%",""))-75;this.options.properties instanceof Array?r=this.options.properties:this.options.properties instanceof String&&(r=[this.options.properties]);var o=[],s=[];this.ctrl.$scope.data._csv="",r.forEach(function(r){var i,a;if("string"==typeof r?i=a=r:(i=r.label,a=r.source),e.sensors.hasOwnProperty(a)){var n=0;e.timestamps?e.timestamps.forEach(function(r){s=e.timestamps;var c=e.sensors[a][n];-1===c&&(c=null),e.sensors[a].length>n&&(o.push({x:r,y:c,c:i}),t.ctrl.$scope.data._csv+=new Date(r).toLocaleString()+","+c+"\n"),n+=1}):e.layer.timestamps&&e.layer.timestamps.forEach(function(r){s=e.layer.timestamps;var c=e.sensors[a][n];-1===c&&(c=null),e.sensors[a].length>n&&(o.push({x:r,y:c,c:i}),t.ctrl.$scope.data._csv+=new Date(r).toLocaleString()+","+c+"\n"),n+=1})}}),this.ctrl.widget.enabled=!1;var n={width:i,height:a,padding:{top:10,left:30,bottom:30,right:10},data:[{values:o,name:"table"},{name:"stats",source:"table",transform:[{type:"aggregate",groupby:["x"],summarize:[{field:"y",ops:["sum"]}]}]}],scales:[{name:"x",type:"time",range:"width",points:!0,domain:{data:"table",field:"x"},domainMin:s[0],domainMax:s[s.length-1]},{name:"y",type:"linear",range:"height",nice:!0,domain:{data:"stats",field:"sum_y"}},{name:"color",type:"ordinal",range:"category10",domain:{data:"table",field:"c"}}],axes:[{type:"x",scale:"x",ticks:300>=i?4:8},{type:"y",scale:"y",ticks:300>=i?4:8}],marks:[{type:"group",from:{data:"table",transform:[{type:"stack",groupby:["x"],sortby:["c"],field:"y"},{type:"facet",groupby:["c"]}]},marks:[{type:"line",properties:{enter:{interpolate:{value:"monotone"},x:{scale:"x",field:"x"},y:{scale:"y",field:"y"},stroke:{scale:"color",field:"c"},strokeWidth:{value:2}},update:{strokeOpacity:{value:1}},hover:{strokeOpacity:{value:.5}}}}],legends:[{fill:"color",offset:0}]}]};this.ctrl.$scope.data._spec=n,this.ctrl.updateChart()}}},e.prototype.stop=function(){},e}();e.propertySensordataGenerator=r;var i=function(){function e(e,t){this.$layerService=e,this.$dashboardService=t,this.mb=this.$layerService.$messageBusService}return e.prototype.start=function(e){var t=this;this.ctrl=e,this.options=e.$scope.data.generator,this.mb.subscribe("timeline",function(e,r){"timeSpanUpdated"===e&&t.selectLayer(t.layer)}),this.mb.subscribe("layer",function(e,r){switch(e){case"onFeatureSelect":break;default:t.selectLayer(r)}}),e.initChart()},e.prototype.selectLayer=function(e){if(this.layer=e,this.options.hasOwnProperty("layer")){var t=[];if(this.options.hasOwnProperty("properties")){var r=parseInt(this.ctrl.widget.width.toLowerCase().replace("px","").replace("%",""))-50,i=parseInt(this.ctrl.widget.height.toLowerCase().replace("px","").replace("%",""))-75;this.options.properties instanceof Array?t=this.options.properties:this.options.properties instanceof String&&(t=[this.options.properties]);var a,o,s=[];t.forEach(function(t){var r,i;"string"==typeof t?r=i=t:(r=t.label,i=t.source),e.data.features.forEach(function(e){if(e.sensors&&e.sensors.hasOwnProperty(t)){var n=0;e.layer.timestamps.forEach(function(t){("undefined"==typeof a||a>t)&&(a=t),("undefined"==typeof a||t>o)&&(o=t);var c=e.sensors[i][n];-1===c&&(c=null),e.sensors[i].length>n&&s.push({x:t,y:c,c:r}),n+=1})}})});var n={width:r,height:i,padding:{top:10,left:30,bottom:30,right:10},data:[{values:s,name:"table"},{name:"stats",source:"table",transform:[{type:"aggregate",groupby:["x"],summarize:[{field:"y",ops:["sum"]}]}]}],scales:[{name:"x",type:"time",range:"width",points:!0,domain:{data:"table",field:"x"},domainMin:a,domainMax:o},{name:"y",type:"linear",range:"height",nice:!0,domain:{data:"stats",field:"sum_y"}},{name:"color",type:"ordinal",range:"category10",domain:{data:"table",field:"c"}}],axes:[{type:"x",scale:"x",ticks:300>=r?4:8},{type:"y",scale:"y"}],marks:[{type:"group",from:{data:"table",transform:[{type:"stack",groupby:["x"],sortby:["c"],field:"y"},{type:"facet",groupby:["c"]}]},marks:[{type:"area",properties:{enter:{interpolate:{value:"monotone"},x:{scale:"x",field:"x"},y:{scale:"y",field:"layout_start"},y2:{scale:"y",field:"layout_end"},fill:{scale:"color",field:"c"}},update:{fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}}]}]};this.ctrl.$scope.data._spec=n,this.ctrl.updateChart()}}},e.prototype.stop=function(){},e}();e.layerPropertySensordataGenerator=i;var a=function(){function e(e,t){this.$layerService=e,this.$dashboardService=t,this.mb=this.$layerService.$messageBusService}return e.prototype.start=function(e){var t=this;if(this.ctrl=e,this.options=e.$scope.data.generator,this.mb.subscribe("timeline",function(e,r){"sensorLinkUpdated"===e&&t.selectLayer(t.layer)}),this.mb.subscribe("layer",function(e,r){switch(e){case"activated":t.selectLayer(r)}}),this.options.hasOwnProperty("layer")){var r=this.$layerService.findLayer(this.options.layer);this.selectLayer(r)}e.initChart()},e.prototype.selectLayer=function(e){var t=this;if(this.layer=e,e&&(this.ctrl.$scope.data._csv="",_.isArray(e.kpiTimestamps)&&this.options.hasOwnProperty("layer")&&this.options.layer===e.id)){var r=[];if(this.options.hasOwnProperty("sensors")){var i=parseInt(this.ctrl.widget._width.toLowerCase().replace("px","").replace("%",""))-50,a=parseInt(this.ctrl.widget._height.toLowerCase().replace("px","").replace("%",""))-75;this.options.sensors instanceof Array?r=this.options.sensors:this.options.sensors instanceof String&&(r=[this.options.sensors]);var o=[];if(!r)return;var s=-1;r.forEach(function(r){var i,a;"string"==typeof r?i=a=r:(i=r.label,a=r.source);var n="";if(s+=1,e.sensors&&e.sensors.hasOwnProperty(a)){var c=0;e.kpiTimestamps.forEach(function(t){var r=e.sensors[a][c];-1===r&&(r=null),e.sensors[a].length>c&&(o.push({x:t,y:r,c:i}),n+=new Date(t).toLocaleString()+","+r+"\n"),c+=1}),t.ctrl.$scope.data._csv+=n+"\n"}});var n={width:i,height:a,padding:{top:10,left:30,bottom:30,right:10},data:[{values:o,name:"table"},{name:"stats",source:"table",transform:[{type:"aggregate",groupby:["x"],summarize:[{field:"y",ops:["sum"]}]}]}],scales:[{name:"x",type:"time",range:"width",points:!0,format:"dd-MM-YY",nice:!0,domain:{data:"table",field:"x"},domainMin:e.kpiTimestamps[0],domainMax:e.kpiTimestamps[e.kpiTimestamps.length-1]},{name:"y",type:"linear",range:"height",nice:!0,domain:{data:"stats",field:"sum_y"}},{name:"color",type:"ordinal",range:"category10",domain:{data:"table",field:"c"}}],axes:[{type:"x",scale:"x",ticks:300>=i?4:8},{type:"y",scale:"y",ticks:300>=a?4:8}],marks:[{type:"group",from:{data:"table",transform:[{type:"stack",groupby:["x"],sortby:["c"],field:"y"},{type:"facet",groupby:["c"]}]},marks:[{type:"line",properties:{enter:{interpolate:{value:"monotone"},x:{scale:"x",field:"x"},y:{scale:"y",field:"y"},stroke:{scale:"color",field:"c"},strokeWidth:{value:2}},update:{fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}}],legends:[{fill:"color",offset:0}]}]};this.ctrl.$scope.data._spec=n,this.ctrl.updateChart()}}},e.prototype.stop=function(){},e}();e.layerKpiGenerator=a}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function e(){this.icon="tachometer",this.popover="",this.open=!0,this.replace=!0,this.canClose=!0}return e}();t.RightPanelTab=r;var i=function(){function r(t,r,i,a,o,s,n,c,l,p){var u=this;this.$rootScope=t,this.$compile=r,this.$injector=i,this.$location=a,this.$timeout=o,this.$translate=s,this.$messageBusService=n,this.$layerService=c,this.$mapService=l,this.$localStorageService=p,this.widgetTypes={},this.chartGenerators={},this._search={isActive:!1,query:""},this.rightPanelTabs={},this.mainDashboard=new e.Services.Dashboard,this.dashboards=[],this.dashboards.main=this.mainDashboard,this.touchMode=p.get("touchmode"),this.chartGenerators.propertyBarChart=function(){return new e.Services.PropertyBarChartGenerator(u.$layerService,u)},this.chartGenerators.sensordata=function(){return new e.Services.propertySensordataGenerator(u.$layerService,u)},this.chartGenerators.layerSensorData=function(){return new e.Services.layerPropertySensordataGenerator(u.$layerService,u)},this.chartGenerators.kpi=function(){return new e.Services.layerKpiGenerator(u.$layerService,u)},this.chartGenerators.top10=function(){return new e.Services.top10Generator(u.$layerService,u)},this.$messageBusService.subscribe("rightpanel",function(e,t){switch(e){case"activate":u.activateTab(t);break;case"deactivate":u.deactivateTab(t);break;case"deactiveContainer":u.deactivateTabContainer(t)}}),this.widgetTypes.agenda={id:"agenda",icon:"bower_components/csweb/dist-bower/images/widgets/agenda.png",description:"Show an event calendar."},this.widgetTypes.presentation={id:"presentation",icon:"bower_components/csweb/dist-bower/images/widgets/presentation.png",description:"Create and share presentations."},this.widgetTypes.buttonwidget={id:"buttonwidget",icon:"bower_components/csweb/dist-bower/images/widgets/touchbutton.png",description:"Simple on/off button for executing an action."},this.widgetTypes.focustimewidget={id:"focustimewidget",icon:"bower_components/csweb/dist-bower/images/widgets/touchbutton.png",description:"Widget showing focus time"},this.widgetTypes.indicators={id:"indicators",icon:"bower_components/csweb/dist-bower/images/widgets/indicators.png",description:"Showing sensor data using charts"},this.widgetTypes.charts={id:"charts",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show custom chart"},this.widgetTypes.markdownwidget={id:"markdownwidget",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show custom markdown or html content"},this.widgetTypes.headerwidget={id:"headerwidget",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Shows a header"},this.widgetTypes.tablewidget={id:"tablewidget",icon:"bower_components/csweb/dist-bower/images/widgets/table.png",description:"Shows a data table"},this.widgetTypes.mcawidget={id:"mcawidget",icon:"bower_components/csweb/dist-bower/images/widgets/mca.png",description:"Show available MCA's"},this.widgetTypes.iframewidget={id:"iframewidget",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show custom iframe"},this.widgetTypes.kanbanboard={id:"kanbanboard",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show kanbanboard"},this.widgetTypes.legendDirective={id:"legendDirective",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show Legend"},this.widgetTypes.navigator={id:"navigatorwidget",icon:"bower_components/csweb/dist-bower/images/widgets/markdown.png",description:"Show navigator"},this.widgetTypes.postman={id:"postman",icon:"bower_components/csweb/dist-bower/images/widgets/Script.png",description:"POST messages"},this.widgetTypes.simtimecontroller={id:"simtimecontroller",icon:"bower_components/csweb/dist-bower/images/widgets/Media-Play.png",description:"Show simulation time controller"},this.widgetTypes.simstate={id:"simstate",icon:"bower_components/csweb/dist-bower/images/widgets/ServerStatus.png",description:"Show status of simulation services."},this.widgetTypes.locationwidget={id:"locationwidget",icon:"bower_components/csweb/dist-bower/images/widgets/search.png",description:"Show reverse geocode info."},this.widgetTypes.filterstylewidget={id:"filterstylewidget",icon:"bower_components/csweb/dist-bower/images/widgets/filter.png",description:"A widget combining legend, style and filter."}}return Object.defineProperty(r.prototype,"search",{get:function(){return this._search},set:function(e){this._search=e,e.query&&e.query.length>0?($("#navigate_header").trigger("click"),this._search.isActive=e.isActive=this.$layerService.visual.leftPanelVisible=!0,this.$messageBusService.publish("search","update",e)):($("#navigate_header").is(":visible")&&$("#left_menu_headers li:visible:first").next().trigger("click"),this._search.isActive=e.isActive=!1,this.$messageBusService.publish("search","reset"))},enumerable:!0,configurable:!0}),r.prototype.leftMenuVisible=function(e){var t=this.$layerService.project.activeDashboard;return t.visibleLeftMenuItems?t.visibleLeftMenuItems.indexOf(e)>=0:!0},r.prototype.selectDashboard=function(e,t){e&&(this.$location.search("dashboard",e.id),!_.isUndefined(e.refreshPage)&&e.refreshPage?location.reload():(this.$messageBusService.publish("updatelegend","removelegend"),e._initialized=!1,this.$messageBusService.publish("dashboard-"+t,"activated",e)))},r.prototype.closeContainer=function(){alert("close container")},r.prototype.activateTab=function(e){var r=this;if("string"==typeof e)$('#rightpanelTabs a[data-target="#'+e+'-content"]').tab("show"),this.$layerService.visual.rightPanelVisible=!0;else{var i=e;if(!i.hasOwnProperty("container"))return;var a=i.container+"-content";if(this.rightPanelTabs.hasOwnProperty(i.container)&&this.rightPanelTabs[i.container].directive===i.directive&&!i.replace)return void $('#rightpanelTabs a[data-target="#'+a+'"]').tab("show");$("#"+i.container+"-tab").remove();var o=$("#"+a);try{o&&o.remove()}catch(s){return}var n="";""===i.popover||this.$mapService.expertMode!==t.Expertise.Beginner&&this.$mapService.expertMode!==t.Expertise.Intermediate||(n='popover="'+i.popover+'" popover-placement="left" popover-trigger="mouseenter" popover-append-to-body="true"'),$("#rightpanelTabs").append(this.$compile('<li id="'+i.container+'-tab" class="rightPanelTab rightPanelTabAnimated" '+n+'><a id="'+i.container+'-tab-a" data-target="#'+a+'" data-toggle="tab"><span class="fa fa-'+i.icon+' fa-lg"></span></a></li>')(this.$rootScope)),$("#rightpanelTabPanes").append('<div class="tab-pane" style="width:355px" id="'+a+'"></div>'),$("#"+i.container+"-tab-a").click(function(){r.$layerService.visual.rightPanelVisible=!0,console.log("rp visible"),"$apply"!==r.$rootScope.$root.$$phase&&"$digest"!==r.$rootScope.$root.$$phase&&r.$rootScope.$apply()});var c=this.$rootScope;c.data=i.data;var l=this.$compile("<"+i.directive+"></"+i.directive+">")(c);$("#"+a).append(l),i.canClose&&($("#"+a).append('<div id="closebutton-'+i.container+'" class="fa fa-times rightpanel-closebutton" />'),$("#closebutton-"+i.container).click(function(){r.deactivateTabContainer(i.container)})),(_.isUndefined(i.open)||i.open===!0)&&($('#rightpanelTabs a[data-target="#'+a+'"]').tab("show"),this.$layerService.visual.rightPanelVisible=!0),this.rightPanelTabs[i.container]=i}},r.prototype.deactivateTabContainer=function(e){this.$layerService.visual.rightPanelVisible=!1,delete this.rightPanelTabs[e];var t=e+"-content";$("#"+e+"-tab").remove();try{var r=$("#"+t);r&&r.remove()}catch(i){return}"$apply"!==this.$rootScope.$root.$$phase&&"$digest"!==this.$rootScope.$root.$$phase&&this.$rootScope.$apply()},r.prototype.deactivateTab=function(e){e.hasOwnProperty("container")&&this.deactivateTabContainer(e.container)},r.prototype.editWidget=function(t){this.activeWidget=t,this.editWidgetMode=!0;var r=e.Helpers.createRightPanelTab("widget","widgetedit",t,"Edit widget","Edit widget","th-large");if(this.$messageBusService.publish("rightpanel","activate",r),t._ctrl&&t._ctrl.startEdit(),this.$injector.has(t.directive+"EditDirective")){var i=e.Helpers.createRightPanelTab("widget-content",t.directive+"-edit",t,"Edit widget","Edit widget","cog");this.$messageBusService.publish("rightpanel","activate",i)}},r.prototype.stopEditWidget=function(){this.activeWidget=null,this.editWidgetMode=!1,$("#widgetEdit").removeClass("active")},r.prototype.removeWidget=function(){var e=this;this.activeWidget&&this.mainDashboard&&(this.mainDashboard.widgets=this.mainDashboard.widgets.filter(function(t){return t.id!==e.activeWidget.id}),this.activeWidget=null,$('#leftPanelTab a[data-target="#basewidgets"]').tab("show"))},r.$inject=["$rootScope","$compile","$injector","$location","$timeout","$translate","messageBusService","layerService","mapService","localStorageService"],r}();t.DashboardService=i;var a="csComp";try{t.myModule=angular.module(a)}catch(o){t.myModule=angular.module(a,[])}t.myModule.service("dashboardService",e.Services.DashboardService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(e,t){this.$layerService=e,this.$dashboardService=t,this.mb=this.$layerService.$messageBusService}return e.prototype.start=function(e){var t=this;this.ctrl=e,this.options=e.$scope.data.generator,e.initChart(),this.layerSub=this.mb.subscribe("layer",function(e,r){switch(e){case"deactivated":t.styleSub&&t.mb.unsubscribe(t.styleSub);break;case"activated":t.layer=r,t.options.layer&&r.id!==t.options.layer||(t.options.property?t.property=t.options.property:t.styleSub=t.mb.subscribe("updatelegend",function(e,r){"updatedstyle"===e&&(t.property=r.property,t.updateChart(t.layer))}),t.updateChart(t.layer))}})},e.prototype.updateChart=function(e){var t=this;if(e&&e.data&&this.property){var r=parseInt(this.ctrl.widget.width.toLowerCase().replace("px","").replace("%",""))-50,i=parseInt(this.ctrl.widget.height.toLowerCase().replace("px","").replace("%",""))-80;this.ctrl.$scope.data.lite=!1;var a=[];e.data.features.forEach(function(e){if(e.properties.hasOwnProperty(t.property)&&e.properties.hasOwnProperty(e.fType.style.nameLabel)){var r={value:e.properties[t.property],name:" "+e.properties[e.fType.style.nameLabel].toString()};a.push(r)}}),this.ctrl.$scope.data.spec={width:r,height:i,padding:"auto",data:[{name:"source",values:_.first(_.sortBy(a,function(e){return-e.value}),10),format:{type:"json",parse:{value:"number"}},transform:[{type:"filter",test:"datum.value!==null"}]},{name:"layout",source:"source",transform:[{type:"aggregate",summarize:[{field:"name",ops:["distinct"]}]},{type:"formula",field:"cellHeight",expr:"(datum.distinct_name + 1) * 21"}]}],marks:[{name:"root",type:"group",from:{data:"layout"},properties:{update:{width:{value:200},height:{field:"cellHeight"}}},marks:[{type:"rect",properties:{update:{x:{scale:"x",field:"value"},x2:{value:0},yc:{scale:"y",field:"name"},height:{value:21,offset:-1},fill:{value:"#4682b4"}}},from:{data:"source"}}],scales:[{name:"x",type:"linear",domain:{data:"source",field:"value",sort:!0},rangeMin:0,rangeMax:200,round:!0,clamp:!0,nice:!0},{name:"y",type:"ordinal",domain:{data:"source",field:"name"},rangeMin:0,rangeMax:{data:"layout",field:"cellHeight"},round:!0,clamp:!0,bandWidth:21,padding:1,points:!0}],axes:[{type:"x",scale:"x",format:"s",grid:!0,layer:"back",ticks:5,title:"value"},{type:"y",scale:"y",grid:!1,title:"name",properties:{labels:{text:{template:"{{ datum.data | truncate:25}}"}}}}]}]},this.ctrl.$scope.data.title=this.property,this.ctrl.initChart()}},e.prototype.stop=function(){this.mb.unsubscribe(this.layerSub),this.mb.unsubscribe(this.styleSub)},e}();e.top10Generator=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function e(){}return e}();t.Coordinates=r;var i=function(){function e(){}return e}();t.Geoposition=i;var a=function(){function e(e,t,r,i){this.bus=e,this.$rootScope=t,this.$window=r,this.$q=i,this.geolocation_msgs={"errors.location.unsupportedBrowser":"Browser does not support location services","errors.location.permissionDenied":"You have rejected access to your location","errors.location.positionUnavailable":"Unable to determine your location","errors.location.timeout":"Service timeout has been reached"}}return e.prototype.getLocation=function(){return this.position},e.prototype.start=function(e){var t=this;e||(e={enableHighAccuracy:!0,maximumAge:3e3}),this.$window.navigator&&this.$window.navigator.geolocation&&this.$window.navigator.geolocation.watchPosition(function(e){t.position=e,t.bus.publish("geo","pos",e)},function(e){switch(alert(e),e.code){case 1:break;case 2:break;case 3:}},e)},e.$inject=["messageBusService","$rootScope","$window","$q"],e}();t.GeoService=a;var o="csComp";try{t.myModule=angular.module(o)}catch(s){t.myModule=angular.module(o,[])}t.myModule.service("geoService",e.Services.GeoService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function r(e,t,r){var i=this;this.$localStorageService=e,this.$timeout=t,this.$messageBusService=r,this.showLocation=!1,this.mapVisible=!0,this.rightMenuVisible=!0,this._timelineVisible=!1,this.initExpertMode(),this.baseLayers={},r.subscribe("timeline",function(e,t){switch(e){case"isEnabled":i.timelineVisible=t,i.timelineVisible&&i.$timeout(function(){i.$messageBusService.publish("timeline","loadProjectTimeRange")},100)}});var a=function(e){return i.mapClicked(e)};r.subscribe("map",function(e,t){switch(e.toLowerCase()){case"setextent":i.map.fitBounds(new L.LatLngBounds(t.southWest,t.northEast),{paddingTopLeft:new L.Point(370,50)});break;case"setzoom":i.map.setZoomAround(t.loc,t.zoom||16);break;case"showscale":t?i.scale=L.control.scale({position:"bottomleft",maxWidth:100,metric:!0,imperial:!1,updateWhenIdle:!0}).addTo(i.map):i.scale&&i.map.removeControl(i.scale);break;case"showlocation":"undefined"!=typeof t&&(i.showLocation=!t),i.showLocation?(i.showLocation=!1,i.map.off("click",a)):(i.showLocation=!0,i.map.on("click",a))}})}return Object.defineProperty(r.prototype,"timelineVisible",{get:function(){return this._timelineVisible},set:function(e){var t=this;this._timelineVisible=e,setTimeout(function(){var e=$(window).height();$("#map").height(e-(t._timelineVisible?$("#timeline").height():0))},300)},enumerable:!0,configurable:!0}),r.prototype.mapClicked=function(e){this.$messageBusService&&this.$messageBusService.publish("geocoding","reverselookup",e.latlng)},r.prototype.initExpertMode=function(){var i=this;this.expertMode=this.$localStorageService.get(r.expertModeKey),this.expertMode||(this.expertMode=t.Expertise.Expert,this.$messageBusService.subscribe("project",function(e,t){switch(e){case"loaded":null!=t&&"undefined"!=typeof t.expertMode&&i.$messageBusService.publish("expertMode","newExpertise",t.expertMode)}})),this.$messageBusService.subscribe("expertMode",function(t,r){"newExpertise"===t&&(i.expertMode=r,i.$localStorageService.set(e.Services.MapService.expertModeKey,r))})},Object.defineProperty(r.prototype,"isExpert",{get:function(){return this.expertMode===t.Expertise.Expert||this.expertMode===t.Expertise.Admin},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isIntermediate",{get:function(){return this.expertMode===t.Expertise.Expert||this.expertMode===t.Expertise.Intermediate||this.expertMode===t.Expertise.Admin},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isAdminExpert",{get:function(){return this.expertMode===t.Expertise.Admin},enumerable:!0,configurable:!0}),r.prototype.getBaselayer=function(e){var t=this.baseLayers[e];return t},r.prototype.changeBaseLayer=function(e){var t=this.getBaselayer(e);this.activeBaseLayer=t,this.activeBaseLayerId=e,this.$messageBusService.publish("baselayer","activated",e)},r.prototype.invalidate=function(){this.map.invalidateSize(!0)},r.prototype.zoomToLocation=function(e,t){this.map.setView(e,t||14)},r.prototype.zoomTo=function(e,t){var r=this;void 0===t&&(t=14);try{var i;if("POINT"===e.geometry.type.toUpperCase())i=new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]),this.map.setView(i,t);else{var a;e.geometry.type.toUpperCase().indexOf("MULTI")<0?a=this.getBoundingBox(e.geometry.coordinates[0]):(a=[1e3,-1e3,1e3,-1e3],e.geometry.coordinates.forEach(function(e){var t=r.getBoundingBox(e[0]);a=[Math.min(a[0],t[0]),Math.max(a[1],t[1]),Math.min(a[2],t[2]),Math.max(a[3],t[3])]}));var o=.05,s=L.latLng(Math.min(a[2],a[3]),Math.min(a[0],a[1])-o),n=L.latLng(Math.max(a[2],a[3]),Math.max(a[0],a[1])+o);this.map.fitBounds(new L.LatLngBounds(s,n))}this.$messageBusService.publish("sidebar","show"),this.$messageBusService.publish("feature","onFeatureSelect",e)}catch(c){console.log("error zooming to feature")}},r.prototype.zoomIn=function(){this.map.zoomIn()},r.prototype.zoomOut=function(){this.map.zoomOut()},r.prototype.getBoundingBox=function(e){return e.reduce(function(e,t){return[Math.min(e[0],t[0]),Math.max(e[1],t[0]),Math.min(e[2],t[1]),Math.max(e[3],t[1])]},[1e3,-1e3,1e3,-1e3])},r.prototype.getMap=function(){return this.map},r.prototype.initDraw=function(t){var r=this;this.map.on("draw:created",function(i){if(r.drawingLayer){r.drawingNotification&&r.drawingNotification.remove();var a="Point",o=[];switch(r.drawingFeatureType.style.drawingMode){case"Line":a="LineString",i.layer._latlngs.forEach(function(e){o.push([e.lng,e.lat])});break;case"Polygon":a="Polygon",i.layer._latlngs.forEach(function(e){var t=[];e.forEach(function(e){t.push([e.lng,e.lat])}),t.length>1&&!_.isEqual(_.first(t),_.last(t))&&t.push(_.first(t)),o.push(t)})}var s={type:"Feature",geometry:{type:a,coordinates:o},fType:r.drawingFeatureType,properties:{}};if(s.properties.featureTypeId=e.Helpers.getFeatureTypeName(r.drawingFeatureType.id),_.isArray(r.drawingFeatureType._propertyTypeData))for(var n in r.drawingFeatureType._propertyTypeData){r.drawingFeatureType._propertyTypeData[n];r.drawingFeatureType._propertyTypeData.forEach(function(e){s.properties[e.label]=_.isUndefined(e.defaultValue)?"":e.defaultValue})}var c=r.drawingLayer;c.data||(c.data={}),c.data.features||(c.data.features=[]),c.data.features.push(s),t.initFeature(s,c),t.calculateFeatureStyle(s),t.activeMapRenderer.addFeature(s),s.type="Feature",t.saveFeature(s),console.log(s)}r.drawInstance.removeHooks(),
r.drawingFeatureType=null})},r.prototype.startDraw=function(e,t){var r=this;if(!this.drawingFeatureType){this.drawingLayer=e,this.drawingFeatureType=t;var i={stroke:!0,color:this.drawingFeatureType.style.strokeColor,weight:4,opacity:.5,fill:!1,clickable:!0};switch(t.style.drawingMode){case"Line":this.drawInstance=new L.Draw.Polyline(this.map,i);break;case"Polygon":i.showArea=!0,this.drawInstance=new L.Draw.Polygon(this.map,i),i.fill=!0}this.drawInstance.addHooks(),this.drawingNotification=this.$messageBusService.confirm("Drawing started","Use double-click or one of these options to end your drawing",function(e){e?r.drawInstance.completeShape():(r.drawInstance.removeHooks(),r.drawingFeatureType=null)})}},r.expertModeKey="expertMode",r.$inject=["localStorageService","$timeout","messageBusService"],r}();t.MapService=r;var i="csComp";try{t.myModule=angular.module(i)}catch(a){t.myModule=angular.module(i,[])}t.myModule.service("mapService",e.Services.MapService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var ContourAction;!function(e){var t=function(){function e(){this.id="ContourActionModel"}return e.prototype.stop=function(){},e.prototype.addFeature=function(e){},e.prototype.removeFeature=function(e){},e.prototype.selectFeature=function(e){},e.prototype.addLayer=function(e){},e.prototype.removeLayer=function(e){},e.prototype.getFeatureActions=function(e){return[]},e.prototype.getLayerActions=function(e){return null},e.prototype.getFeatureHoverActions=function(e){if(!e)return[];var t={title:"show"};t.callback=this.showContour;var r={title:"hide"};return r.callback=this.hideContour,[t,r]},e.prototype.deselectFeature=function(e){},e.prototype.updateFeature=function(e){},e.prototype.showContour=function(e,t){t.currentContour&&t.map.map.removeLayer(t.currentContour);var r=t.getFeatureType(e);if(r&&r.hasOwnProperty("contourProperty")&&e.properties.hasOwnProperty(r.contourProperty)){var i=e.properties[r.contourProperty],a="object"==typeof i?i:JSON.parse(i);t.currentContour=L.geoJson(a),t.currentContour.addTo(t.map.map)}},e.prototype.hideContour=function(e,t){t.currentContour&&t.map.map.removeLayer(t.currentContour)},e.prototype.init=function(e){console.log("init ContourActionService")},e}();e.ContourActionModel=t}(ContourAction||(ContourAction={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(e,t){var r=this;this.$parse=e,this.messageBusService=t,this.ops={Math:Math,count:function(e,t){for(var r=0,i=0,a=e;i<a.length;i++){var o=a[i];o.properties.hasOwnProperty(t)&&r++}return r},min:function(e,t){for(var r=Number.MAX_VALUE,i=0,a=e;i<a.length;i++){var o=a[i];o.properties.hasOwnProperty(t)&&(r=Math.min(r,o.properties[t]))}return r},max:function(e,t){for(var r=Number.MIN_VALUE,i=0,a=e;i<a.length;i++){var o=a[i];o.properties.hasOwnProperty(t)&&(r=Math.max(r,o.properties[t]))}return r},sum:function(e,t){for(var r=0,i=0,a=e;i<a.length;i++){var o=a[i];o.properties.hasOwnProperty(t)&&(r+=o.properties[t])}return r},avg:function(e,t){for(var r=0,i=0,a=0,o=e;a<o.length;a++){var s=o[a];s.properties.hasOwnProperty(t)&&(r+=s.properties[t],i++)}return r/i},std:function(e,t){for(var r=function(e){var t=e.reduce(function(e,t){return e+t},0);return t/e.length},i=[],a=0,o=e;a<o.length;a++){var s=o[a];s.properties.hasOwnProperty(t)&&i.push(s.properties[t])}var n=r(i),c=i.map(function(e){return Math.pow(e-n,2)}),l=r(c);return Math.sqrt(l)},percentage:function(e,t,i){var a=r.ops.sum(e,t),o=r.ops.sum(e,i);return a/o}}}return t.prototype.evalLayer=function(e,t){var r=this;if(e&&e.data&&e.data.features){var i=e.typeUrl+"#"+e.defaultFeatureType;if(i&&t.hasOwnProperty(i)){var a=t[i];a._propertyTypeData.forEach(function(t){return r.evalExpressions(t,e.data.features)})}e.data.features.forEach(function(i){if(i.properties.hasOwnProperty("featureTypeId")){var a=e.url+i.properties.featureTypeId;if(t.hasOwnProperty(a)){var o=t[a];r.evalExpressions(o,e.data.features,!1)}}})}},t.prototype.evalResourceExpressions=function(e,t){if(e&&e.propertyTypeData)for(var r in e.propertyTypeData){var i=e.propertyTypeData[r];this.evalExpressions(i,t)}},t.prototype.evalExpressions=function(e,t,r){if(void 0===r&&(r=!0),e.expression)for(var i=this.$parse(e.expression),a={features:t,properties:{}},o=0,s=t;o<s.length;o++){var n=s[o];if(n.properties){var c=n.properties.hasOwnProperty("featureTypeId");(c&&n.properties.featureTypeId===e.label||!c&&r)&&(a.properties=n.properties,n.properties[e.label]=i(a,this.ops))}}},t.prototype.evalExpression=function(e,t,r){var i=this.$parse(e),a={features:t,properties:r?r.properties:null,sensors:r?r.sensors:null};return i(a,this.ops)},t.prototype.evalSensorExpression=function(e,t,r,i){if(!r.sensors||0===_.keys(r.sensors).length)return null;var a=this.$parse(e),o={timeIndex:i,features:t,properties:r?r.properties:null,sensors:r?r.sensors:null};return a(o,this.ops)},t.prototype.evalPropertyType=function(t,r,i){return!t.expression||t.isSensor?null:e.Helpers.convertPropertyInfo(t,this.evalExpression(t.expression,r,i))},t.$inject=["$parse"],t}();t.ExpressionService=r;var i="csComp";try{t.myModule=angular.module(i)}catch(a){t.myModule=angular.module(i,[])}t.myModule.service("expressionService",e.Services.ExpressionService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){"use strict";!function(e){e[e.Context=0]="Context",e[e.Hover=1]="Hover"}(t.ActionType||(t.ActionType={}));var r=(t.ActionType,function(){function e(){}return e.prototype.stop=function(){},e.prototype.addFeature=function(e){},e.prototype.removeFeature=function(e){},e.prototype.selectFeature=function(e){},e.prototype.getLayerActions=function(e){return[]},e.prototype.getFeatureActions=function(e){return[]},e.prototype.getFeatureHoverActions=function(e){return[]},e.prototype.deselectFeature=function(e){},e.prototype.addLayer=function(e){},e.prototype.removeLayer=function(e){},e.prototype.updateFeature=function(e){},e.prototype.search=function(e,t){t(null,[])},e.prototype.init=function(e){this.layerService=e},e}());t.BasicActionService=r;var i=function(t){function r(){t.apply(this,arguments),this.id="LayerActions"}return __extends(r,t),r.prototype.addLayer=function(e){e.fitToMap&&e.layerSource&&_.isFunction(e.layerSource.fitMap)&&e.layerSource.fitMap(e)},r.prototype.getLayerActions=function(e){var t=this;if(e){var r=[];if(e.isEditable&&this.layerService.$mapService.isExpert&&e.enabled&&r.push({title:"Edit Layer",icon:"pencil",callback:function(e,r){t.layerService.$messageBusService.publish("layer","startEditing",e)}}),e.enabled&&e.layerSource){var i={title:"Refresh Layer",icon:"refresh"};if(i.callback=function(e,t){e.layerSource.refreshLayer(e)},r.push(i),_.isFunction(e.layerSource.fitMap)){var a={title:"Fit Map",icon:"map"};a.callback=function(e,t){e.layerSource.fitMap(e)},r.push(a)}if(e.hasSensorData&&_.isFunction(e.layerSource.fitTimeline)){var a={title:"Fit Timeline",icon:"map"};a.callback=function(e,t){e.layerSource.fitTimeline(e)},r.push(a)}}if(e.enabled&&e.isEditable&&!e.isDynamic&&e.layerSource){var o={title:"Reset Layer",icon:"reset"};o.callback=function(e,t){console.log("Resetting layer: "+e.title),e.data.features=[],e.layerSource.refreshLayer(e)},r.push(o)}if(this.layerService.$mapService.isAdminExpert){var s={title:"Remove Layer",icon:"trash"};s.callback=function(e,t){t.$messageBusService.confirm("Delete layer","Are you sure",function(r){r&&t.removeLayer(e,!0)})},r.push(s)}return r}},r.prototype.getFeatureActions=function(e){var t=[];if(e.timestamps&&e.timestamps.length>0){var r={title:"Zoom on timeline"};r.callback=this.zoomFeatureTimeline,t.push(r)}if(e.layer.isDynamic){var i={title:"Edit"};i.callback=this.setAsFilter,t.push(i)}return t},r.prototype.getFeatureHoverActions=function(e){return[]},r.prototype.zoomFeatureTimeline=function(e,t){var r=new Date(e.timestamps[0]),i=new Date(e.timestamps[e.timestamps.length-1]);t.$messageBusService.publish("timeline","updateTimerange",{start:r,end:i})},r.prototype.setAsFilter=function(e,t){t.editFeature(e)},r.prototype.search=function(t,r){var i=this,a=.5,o=[],s=[];this.layerService.project.features.forEach(function(r){var i=[];if(!r._gui.hasOwnProperty("searchString")){var o=e.Helpers.getFeatureTitle(r);i.push(o);for(var n in r.properties)i.push(r.properties[n]);i.length>0&&(r._gui.searchString=i.join(" "),r._gui.title=o)}if(r._gui.hasOwnProperty("searchString")&&r._gui.hasOwnProperty("title")){var c;c=t.query.toLowerCase()===r._gui.title.toLowerCase()?1:r._gui.searchString.score(t.query,null),c>a&&s.push({score:c,feature:r,title:r._gui.title})}}),s.sort(function(e,t){return t.score-e.score}).forEach(function(e){if(o.length<10){var t=e.feature,r={title:e.title,description:t.layer.title,feature:t,score:e.score,icon:"bower_components/csweb/dist-bower/images/large-marker.png",service:i.id,click:function(){i.layerService.$mapService.zoomTo(t),i.layerService.selectFeature(t),i.layerService.$messageBusService.publish("search","reset"),i.layerService.visual.leftPanelVisible=!1}};o.push(r)}}),r(null,o)},r.prototype.init=function(e){t.prototype.init.call(this,e)},r}(r);t.LayerActions=i}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function r(e,r,i,a,o,s,n,c,l,p,u){var d=this;this.$location=e,this.$compile=r,this.$translate=i,this.$messageBusService=a,this.$mapService=o,this.$rootScope=s,this.geoService=n,this.$http=c,this.expressionService=l,this.actionService=p,this.$storage=u,this.noFilters=!0,this.loadedLayers={},this.actionServices=[],this.visual=new t.VisualState,this.throttleSensorDataUpdate=function(){},this.throttleBBOXUpdate=_.debounce(this.updateBBOX,1e3),this.actionService.init(this),this.mb=a,this.map=o,this.openSingleProject=!1,this.emptySolutionUrl="data/api/defaultSolution.json",this.accentColor="",this.title="",this.typesResources={},this._featureTypes={},this.propertyTypeData={},this.selectedFeatures=[],this.mapRenderers={},this.visual=new t.VisualState,this.setLanguage(),this.mapRenderers.leaflet=new t.LeafletRenderer,this.mapRenderers.leaflet.init(this),this.mapRenderers.cesium=new t.CesiumRenderer,this.mapRenderers.cesium.init(this),this.initLayerSources(),$("body").keyup(function(e){46===e.keyCode&&"input"!==e.target.localName&&(d.selectedFeatures.length>1?d.$messageBusService.confirm("Delete objects","Do you want to remove all ("+d.selectedFeatures.length+") selected objects ?",function(e){d.selectedFeatures.forEach(function(e){d.removeFeature(e,!0)})}):1===d.selectedFeatures.length&&d.$messageBusService.confirm("Delete object","Are you sure",function(e){d.removeFeature(d.selectedFeatures[0],!0)}))}),a.subscribe("timeline",function(e,t){switch(e){case"focusChange":d.throttleSensorDataUpdate();break;case"timeSpanUpdated":d.updateSensorLinks()}}),a.subscribe("language",function(e,t){"newLanguage"===e&&(d.currentLocale=t,a.notifyWithTranslation("LAYER_SERVICE.RELOAD_PROJECT_TITLE","LAYER_SERVICE.RELOAD_PROJECT_MSG"),d.openProject(d.projectUrl))}),a.subscribe("mapbbox",function(e,t){if("update"===e){var r=[];t.split(",").forEach(function(e){return r.push(parseFloat(e))}),d.throttleBBOXUpdate(t,[[r[0],r[1]],[r[2],r[1]],[r[2],r[3]],[r[0],r[3]]])}}),a.subscribe("menu",function(e,t){"show"===e&&"boolean"==typeof t&&(d.visual.leftPanelVisible=t)}),this.addActionService(new t.LayerActions),this.addActionService(new MatrixAction.MatrixActionModel),this.addActionService(new RelationAction.RelationActionModel),this.checkMobile(),this.enableDrop()}return r.prototype.setLanguage=function(e){var t=this.$location.search();t.hasOwnProperty("language")?this.currentLocale=t.language:e&&e.preferedLanguage?this.currentLocale=e.preferedLanguage:this.currentLocale=this.$translate.preferredLanguage()},r.prototype.refreshActiveLayers=function(){for(var e in this.loadedLayers){var t=this.loadedLayers[e];t.timeDependent&&t.layerSource.refreshLayer(t)}},r.prototype.updateBBOX=function(t,r){var i,a=function(){if(i=o.loadedLayers[s],i.BBOX=t,i.refreshBBOX&&i.layerSource.refreshLayer(i),i.partialBoundingBoxUpdates){var a=!1;i.data.features.forEach(function(t){var i=e.Helpers.GeoExtensions.featureInsideBoundingBox(t,r);t._gui.insideBBOX!==i&&(t._gui.insideBBOX=i,a=!0)}),a&&o.updateLayerSensorData(i)}},o=this;for(var s in this.loadedLayers)a()},r.prototype.updateLayerKpiLink=function(e){var t=this;if(e.sensorLink&&e.sensorLink.kpiUrl){if(!_.isUndefined(e._gui.loadingKpiLink)&&e._gui.loadingKpiLink)return;var r=this.project.timeLine;this.project.activeDashboard.timeline&&(r=this.project.activeDashboard.timeline);var i=(this.timeline.range.end-this.timeline.range.start,e.sensorLink.kpiUrl);if(this.project.activeDashboard.isLive){var a="1h";_.isUndefined(e.sensorLink.liveIntervalKPI)?_.isUndefined(e.sensorLink.liveInterval)||(a=e.sensorLink.liveInterval):a=e.sensorLink.liveIntervalKPI,i+="?tbox="+a}else i+="?tbox="+r.start+","+r.end;console.log("kpi:"+i),e._gui.loadingKpiLink=!0,this.$http.get(i).success(function(r){e._gui.loadingKpiLink=!1,e.kpiTimestamps=r.timestamps,"undefined"!=typeof r.kpis&&(e.sensors=r.kpis),t.$messageBusService.publish("timeline","sensorLinkUpdated")}).error(function(t){e._gui.loadingKpiLink=!1,console.log("error loading sensor data")})}},r.prototype.updateLayerSensorLink=function(e){var t=this;if(e.sensorLink){if(e.sensorLink._requestReference&&(console.log("aborting request"),e.sensorLink._requestReference.abort(),e.sensorLink._requestReference=null,e._gui.loadingSensorLink=!1),!_.isUndefined(e._gui.loadingSensorLink)&&e._gui.loadingSensorLink)return;var r=this.timeline.range.end-this.timeline.range.start;if(e.sensorLink._outOfRange=e._gui.outOfRange=!this.project.activeDashboard.isLive&&r>e.sensorLink.zoomMaxTimeline&&r<e.sensorLink.zoomMaxTimeline,e.sensorLink._outOfRange)return;var i=this.project.timeLine;this.project.activeDashboard.timeline&&(i=this.project.activeDashboard.timeline);var a=e.sensorLink.url;a+=this.project.activeDashboard.isLive?_.isUndefined(e.sensorLink.liveInterval)?"?tbox=15m":"?tbox="+e.sensorLink.liveInterval:"?tbox="+i.start+","+i.end,e._gui.lastSensorLink=a;var o=(new Date).getTime();console.log("downloading "+a),e._gui.loadingSensorLink=!0,e.sensorLink._requestReference=$.ajax({type:"GET",url:a,success:function(r){var i=JSON.parse(r);e.sensorLink._requestReference=null;var a=(new Date).getTime();console.log("sensor data loaded "+(a-o).toString()),e._gui.loadingSensorLink=!1,e.sensorLink.actualInterval=1e3*i.timewindow*60,e.timestamps=i.timestamps,e.data.features.forEach(function(e){e.sensors={},i.features&&i.features.hasOwnProperty(e.id)&&(e.sensors=i.features[e.id])}),console.log("sensor data processed "+((new Date).getTime()-a).toString()),i.timestamps&&e.data.features.forEach(function(e){e.fType._expressions.forEach(function(r){if(r.isSensor&&r.label){e.sensors[r.label]=[];for(var a=0;a<i.timestamps.length;a++)try{e.sensors[r.label].push(t.expressionService.evalSensorExpression(r.expression,e.layer.data.features,e,a))}catch(o){e.sensors[r.label].push(null)}}})}),t.throttleSensorDataUpdate(),t.$messageBusService.publish("timeline","sensorLinkUpdated")},error:function(t){e._gui.loadingSensorLink=!1,console.log("error loading sensor data")}}),this.updateLayerKpiLink(e)}},r.prototype.updateSensorLinks=function(){console.log("updating sensorlinks");for(var e in this.loadedLayers){var t=this.loadedLayers[e];this.updateLayerSensorLink(t),console.log(t.title)}},r.prototype.enableDrop=function(){var e=this,t=window;if(t.File&&t.FileList&&t.FileReader){var r=$("body");r.on("dragenter",function(t){t.stopPropagation(),t.preventDefault(),$(e).css("border","2px solid #0B85A1")}),r.on("dragover",function(e){e.stopPropagation(),e.preventDefault()}),r.on("drop",function(t){$(e).css("border","2px dotted #0B85A1"),t.preventDefault();var i=t.originalEvent,a=i.dataTransfer.files;a.length>1?e.$messageBusService.notify("File upload","Only one file at a time permitted"):e.handleFileUpload(a,r)})}},r.prototype.handleFileUpload=function(t,r){for(var i=this,a=0;a<t.length;a++){var o=t[a];console.log(o);var s=new FileReader;s.onload=function(t){var r=t.target.result,a=JSON.parse(r);if(a&&a.type&&["featurecollection","geojson","dynamicgeojson"].indexOf(a.type.toLowerCase())>=0){var s=new e.Services.ProjectLayer,n=o.name.toLowerCase().replace(".json","").replace(".geojson","");s.id=n,s.title=n,s.type="dynamicgeojson",s.groupId=i.project.groups[0].id,s.group=i.project.groups[0],s.data=a,i.$messageBusService.publish("layerdrop","new",s)}else i.$messageBusService.notify("File upload","File format not recognized")},s.readAsText(o)}},r.prototype.checkMobile=function(){screen.width<=719&&(this.isMobile=!0)},r.prototype.getActions=function(e,r){if(e&&"number"==typeof r){var i=[];return r===t.ActionType.Context?(this.actionServices.forEach(function(t){var r=t.getFeatureActions(e);r&&(i=i.concat(r))}),i.forEach(function(t){t.feature=e})):r===t.ActionType.Hover&&(this.actionServices.forEach(function(t){var r=t.getFeatureHoverActions(e);r&&(i=i.concat(r))}),i.forEach(function(t){t.feature=e})),i}},r.prototype.addActionService=function(e){var t=!1;this.actionServices.some(function(r){return r.id===e.id?(t=!0,!0):!1}),t?console.log("Actionservice "+e.id+" already exists."):(this.actionServices.push(e),e.init(this))},r.prototype.removeActionService=function(e){e.stop()},r.prototype.checkViewBounds=function(){this.project&&this.project.activeDashboard&&this.project.activeDashboard.viewBounds?this.activeMapRenderer.fitBounds(this.project.activeDashboard.viewBounds):this.project&&this.project.viewBounds?this.activeMapRenderer.fitBounds(this.project.viewBounds):this.solution&&this.solution.viewBounds&&this.activeMapRenderer.fitBounds(this.solution.viewBounds)},r.prototype.findDashboardById=function(e){var t;return this.project.dashboards.some(function(r){return r.id!==e?!1:(t=r,!0)}),t},r.prototype.findWidgetById=function(e,t){var r,i;if(t){if(r=this.findDashboardById(t),!r)return null;r.widgets.some(function(t){return t.id!==e?!1:(i=t,!0)})}else this.project.dashboards.some(function(t){return t.widgets.some(function(t){return t.id!==e?!1:(i=t,!0)}),!!i});return i},r.prototype.initLayerSources=function(){this.layerSources={};var e=new t.GeoJsonSource(this,this.$http,this.$storage);this.layerSources.geojson=e,this.layerSources.topojson=e,this.layerSources.editablegeojson=new t.EditableGeoJsonSource(this,this.$http,this.$storage),this.layerSources.dynamicgeojson=new t.DynamicGeoJsonSource(this,this.$http,this.$storage),this.layerSources.esrijson=new t.EsriJsonSource(this,this.$http,this.$storage);var r=new t.KmlDataSource(this,this.$http,this.$storage);this.layerSources.kml=r,this.layerSources.gpx=r,this.layerSources.wms=new t.WmsSource(this),this.layerSources.tilelayer=new t.TileLayerSource(this),this.layerSources.heatmap=new t.HeatmapSource(this),this.layerSources.hierarchy=new t.HierarchySource(this,this.$http),this.layerSources.grid=new t.GridDataSource(this,this.$http,this.$storage),this.layerSources.daynight=new t.NightDayDataSource(this,this.$http,this.$storage),this.layerSources.rss=new t.RssDataSource(this,this.$http,this.$storage),this.layerSources.database=new t.DatabaseSource(this),this.layerSources.vectortile=new t.VectorTileSource(this,this.$http,this.$storage),this.checkFeatureSubLayers()},r.prototype.removeSubLayers=function(t){var r=this;if(t&&t.fType){var i=e.Helpers.getPropertyTypes(t.fType,this.propertyTypeData);i.forEach(function(e){if("layer"===e.type&&t.properties.hasOwnProperty(e.label)){var i=t.properties[e.label];if(r.loadedLayers.hasOwnProperty(i)){r.loadedLayers[i];r.removeLayer(r.loadedLayers[i],!0)}}})}},r.prototype.checkFeatureSubLayers=function(){var r=this;this.$messageBusService.subscribe("feature",function(i,a){if(a&&a.fType)switch(i){case"onFeatureDeselect":break;case"onFeatureSelect":var o=e.Helpers.getPropertyTypes(a.fType,r.propertyTypeData);o.forEach(function(e){if("layer"===e.type&&a.properties.hasOwnProperty(e.label)&&(e.layerProps&&"automatic"===e.layerProps.activation&&r.removeSubLayers(a.layer._lastSelectedFeature),"undefined"==typeof e.layerProps.dashboard||e.layerProps.dashboard===r.project.activeDashboard.id)){a.layer._lastSelectedFeature=a;var i=a.properties[e.label],o=r.findLayer(i);o?r.addLayer(o):("string"==typeof i?(o=new t.ProjectLayer,o.url=i):o=i,o.id||(o.id=i),o.groupId=e.layerProps.groupId,o.group?"string"==typeof o.group&&(o.group=r.findGroupById(o.group)):o.groupId?o.group=r.findGroupById(o.groupId):o.group=a.layer.group,o.type||(o.type=a.layer.type),o.title||(o.title=a.properties.Name+" "+e.title),o.defaultFeatureType||(o.defaultFeatureType=e.layerProps.defaultFeatureType),o.typeUrl||(o.typeUrl=e.layerProps.typeUrl),o.defaultLegendProperty||(o.defaultLegendProperty=e.layerProps.defaultLegendProperty),o.hasSensorData=!0,o.group.layers.push(o)),r.addLayer(o)}})}})},r.prototype.loadRequiredLayers=function(e){var t=this,r=e.type.toLowerCase();if(this.layerSources.hasOwnProperty(r)&&this.layerSources[r].requiresLayer){var i=this.layerSources[r].getRequiredLayers(e)||[];i.forEach(function(e){t.addLayer(e)})}},r.prototype.addLayer=function(e,t,r){var i=this;void 0===r&&(r=null),(!this.loadedLayers.hasOwnProperty(e.id)||e.quickRefresh&&e.quickRefresh!==!1)&&(e.isLoading||(e.isLoading=!0,this.$messageBusService.publish("layer","loading",e),async.series([function(t){e.group.oneLayerActive&&e.group.layers.forEach(function(t){t.id!==e.id&&t.enabled&&(i.removeLayer(t),t.enabled=!1)}),t(null,null)},function(t){e.typeUrl?i.loadTypeResources(e.typeUrl,e.dynamicResource||!1,function(){return t(null,null)}):t(null,null)},function(a){i.loadRequiredLayers(e),"featurecollection"===e.type.toLowerCase()&&(e.type="geojson");var o=e.type.toLowerCase();return i.layerSources.hasOwnProperty(o)?(e.layerSource=i.layerSources[o],e.layerSource.addLayer(e,function(r){r.enabled&&(i.loadedLayers[e.id]=r,i.updateSensorData(),i.activeMapRenderer.addLayer(e),e.defaultLegendProperty&&i.checkLayerLegend(e,e.defaultLegendProperty),i.checkLayerTimer(e),i.actionServices&&i.actionServices.forEach(function(t){t.addLayer&&t.addLayer(e)}),i.updateLayerSensorLink(e),i.updateLayerSensorDataWithDate(e,i.project.timeLine.focusDate()),i.$messageBusService.publish("layer","activated",e),i.$messageBusService.publish("updatelegend","updatedstyle"),i.expressionService.evalLayer(r,i._featureTypes)),t&&t(e)},r),e.timeAware&&i.$messageBusService.publish("timeline","updateFeatures"),void a(null,null)):(e.isLoading=!1,i.$messageBusService.publish("layer","error",e),void a(null,null))}])))},r.prototype.getLayerLegend=function(e){var t=this.findResourceByLayer(e);return t&&t.legends&&t.legends.hasOwnProperty(e.defaultLegend)?t.legends[e.defaultLegend]:null},r.prototype.evaluateLayerExpressions=function(e,t){this.expressionService.evalLayer(e,t)},r.prototype.evaluateFeatureExpressions=function(e){this.expressionService.evalResourceExpressions(this.findResourceByFeature(e),[e])},r.prototype.saveResource=function(t){console.log("saving feature type"),t.url&&this.$http.put("/api/resources",e.Helpers.cloneWithoutUnderscore(t)).success(function(e){console.log("resource saved")}).error(function(e){console.log("error saving resource")})},r.prototype.expandGroup=function(e){if(e&&e.group){var t="#layergroup_"+e.group.id;$(t).collapse("show"),$('*[data-target="'+t+'"]').removeClass("collapsed"),this.apply()}},r.prototype.collapseAll=function(){this.project.groups.forEach(function(e){var t=!1;if(e.layers.some(function(e){return e.enabled&&(t=!0),e.enabled}),!t){var r="#layergroup_"+e.id;$(r).collapse("hide"),$('*[data-target="'+r+'"]').addClass("collapsed")}})},r.prototype.expandAll=function(){this.project.groups.forEach(function(e){var t="#layergroup_"+e.id;$(t).hasClass("in")||($(t).collapse("show"),$('*[data-target="'+t+'"]').removeClass("collapsed"))})},r.prototype.loadTypeResources=function(e,t,r){var i=this;if(e)if("string"==typeof e)if(!this.typesResources.hasOwnProperty(e)||t){var a=!1;this.$http.get(e).success(function(t){if(a=!0,!t||"string"==typeof t&&"null"!==t)i.$messageBusService.notifyError("Error loading resource type",e);else{var o=t;o&&(o.url=e,i.initTypeResources(o),i.$messageBusService.publish("typesource",e,o))}r()}).error(function(t){i.$messageBusService.notifyError("ERROR loading TypeResources","While loading: "+e),console.log(t)}),setTimeout(function(){a||r()},3e3)}else this.initTypeResources(this.typesResources[e]),r();else r()},r.prototype.allLayers=function(){var e=[];return null==this.project||null==this.project.groups?[]:(this.project.groups.forEach(function(t){t.layers&&(e=e.concat(t.layers))}),e)},r.prototype.initTypeResources=function(e){this.typesResources[e.url]=e,e.title||(e.title=e.url),"undefined"==typeof e.isDynamic&&(e.isDynamic=0===e.url.indexOf("api/")||0===e.url.indexOf("/api/"));var t=e.featureTypes;if(e.propertyTypeData)for(var r in e.propertyTypeData){var i=e.propertyTypeData[r];i.id=e.url+"#"+r,this.initPropertyType(i,e.legends),i.label||(i.label=r),this.propertyTypeData[r]=i}if(t)for(var a in t){var o=e.url+"#"+a,s=t[a];s.id=o,this.initFeatureType(s,e),this._featureTypes[o]=s}},r.prototype.getLayerPropertyTypes=function(e){var t=[];return t},r.prototype.checkLayerLegend=function(r,i){var a=this,o=this.propertyTypeData[i];if(o&&o.legend){var s;r.group.styles&&r.group.styles.length>0?s=r.group.styles[0]:(s=new t.GroupStyle(this.$translate),r.group.styles.push(s)),s.title=o.title,s.id=e.Helpers.getGuid(),s.activeLegend=o.legend,s.group=r.group,s.property=o.label,s.legends[o.title]=o.legend,s.colorScales[o.title]=["purple","purple"],s.enabled=!0,s.visualAspect=o.legend.visualAspect?o.legend.visualAspect:"strokeColor",this.saveStyle(r.group,s),this.project.features.forEach(function(e){e.layer===r&&(a.calculateFeatureStyle(e),a.activeMapRenderer.updateFeature(e))}),this.mb.publish("updatelegend","title",i)}else this.project.features.some(function(e){if(e.properties.hasOwnProperty(i)){var t=a.getPropertyType(e,i);return a.setStyle({feature:e,property:i,key:t.title||i}),!0}return!1})},r.prototype.checkLayerTimer=function(e){e.refreshTimeInterval&&(e.enabled?e.timerToken||(e.timerToken=setInterval(function(){e.layerSource.refreshLayer(e)},1e3*e.refreshTimeInterval),console.log("Timer started for "+e.title+": "+e.timerToken)):e.timerToken&&(clearInterval(e.timerToken),e.timerToken=null))},r.prototype.removeStyle=function(e){var t=e.group;t.styles=t.styles.filter(function(t){return t.id!==e.id}),this.$messageBusService.publish("updatelegend","updatedstyle"),this.updateGroupFeatures(t)},r.prototype.updatePropertyStyle=function(e,t,r){var i;if(i=r.style.legends[e],i&&i.legendEntries.length>0){var a=i.legendEntries[0],o=i.legendEntries[i.legendEntries.length-1];r.style.colors=[a.color,o.color]}else r.style.colors=t;r.style.activeLegend=i,this.$messageBusService.publish("updatelegend","updatedstyle")},r.prototype.updateStyle=function(e){if(null!=e)if(e.property&&"gridlayer"===e.property){if(!e.group||!e.group.layers)return;e.group.layers.forEach(function(t){if(t.mapLayer&&t.enabled){var r=t.mapLayer.getLayers();r.forEach(function(t){t.redraw&&"function"==typeof t.redraw&&(t.params({minColor:e.colors[0],maxColor:e.colors[1],areColorsUpdated:!0}),t.redraw())})}})}else null!=e.group&&null!=e.group.styles[0]&&(e.group.styles[0].fixedColorRange?e.info=e.group.styles[0].info:e.info=this.calculatePropertyInfo(e.group,e.property),e.canSelectColor=e.visualAspect.toLowerCase().indexOf("color")>-1,this.updateGroupFeatures(e.group))},r.prototype.updateGroupFeatures=function(e){var t=this;e&&this.project.features.forEach(function(r){r.layer.group===e&&(t.calculateFeatureStyle(r),t.activeMapRenderer.updateFeature(r))})},r.prototype.updateLayerFeatures=function(e){var t=this;e&&this.project.features.forEach(function(r){r.layer.id===e.id&&(t.calculateFeatureStyle(r),t.activeMapRenderer.updateFeature(r))})},r.prototype.updateCanvasOverlay=function(e){if(e&&e.mapLayer){var t=e.mapLayer.getLayers();t.forEach(function(t){if(t.redraw&&"function"==typeof t.redraw){var r=+e.opacity/100;r=Math.min(1,Math.max(0,r)),t.params({opacity:r}),t.redraw()}})}},r.prototype.updateFeatureTypes=function(e){var t=this;this.project.features.forEach(function(r){r.featureTypeName===e.id&&(t.calculateFeatureStyle(r),t.activeMapRenderer.updateFeature(r))})},r.prototype.selectRenderer=function(e){e&&(this.activeMapRenderer&&this.activeMapRenderer.title===e||this.mapRenderers.hasOwnProperty(e)&&(this.activeMapRenderer&&this.activeMapRenderer.disable(),this.activeMapRenderer=this.mapRenderers[e],this.activeMapRenderer.enable(this.$mapService.activeBaseLayer)))},r.prototype.centerFeatureOnMap=function(t){if(t&&_.isArray(t)&&0!==t.length){var r,i=t[0];r="point"===i.geometry.type.toLowerCase()?i.geometry.coordinates:e.Helpers.GeoExtensions.getCentroid(i.geometry.coordinates).coordinates,!r||r.length<2||this.map.getMap().panTo(new L.LatLng(r[1],r[0]))}},r.prototype.editFeature=function(e,t){void 0===t&&(t=!0),e._gui.editMode=!0,this.updateFeature(e),t&&this.selectFeature(e)},r.prototype.deselectFeature=function(e){e.isSelected=!1,this.calculateFeatureStyle(e),this.activeMapRenderer.updateFeature(e)},r.prototype.selectFeature=function(t,r,i){var a=this;void 0===r&&(r=!1),void 0===i&&(i=!1),i?t.isSelected=!0:t.isSelected=!t.isSelected,t._gui.title=e.Helpers.getFeatureTitle(t),null==this.lastSelectedFeature||this.lastSelectedFeature===t||r||(this.deselectFeature(this.lastSelectedFeature),this.actionServices.forEach(function(e){return e.deselectFeature(t)}),this.$messageBusService.publish("feature","onFeatureDeselect",this.lastSelectedFeature)),this.actionServices.forEach(function(e){t.isSelected?e.selectFeature(t):e.deselectFeature(t)}),t.isSelected&&(this.lastSelectedFeature=t),this.calculateFeatureStyle(t),this.activeMapRenderer.updateFeature(t),r?t.isSelected?-1===this.selectedFeatures.indexOf(t)&&this.selectedFeatures.push(t):this.selectedFeatures.indexOf(t)>=0&&(this.selectedFeatures=this.selectedFeatures.filter(function(e){return e.id!==t.id})):(this.selectedFeatures.forEach(function(e){e!==t&&a.deselectFeature(e)}),this.selectedFeatures=t.isSelected?[t]:[]),t.isSelected?(t.fType.selectActions?t.fType.selectActions.forEach(function(e){a.actionService.execute(e,{layerId:t.layerId})}):this.actionService.execute("Select feature"),this.$messageBusService.publish("feature","onFeatureSelect",t)):this.$messageBusService.publish("feature","onFeatureDeselect",t)},r.prototype.lookupLog=function(e,t){if(!e||0===e.length)return{};var r=e;if(t<=r[0].ts)return r[0];if(t>=r[e.length-1].ts)return r[r.length-1];for(var i={},a=0;a<r.length;a++)if(r[a].ts>t){i=r[a];break}return i},r.prototype.updateLog=function(e){var t=this.project.timeLine.focus,r=!1;if(e.logs&&!this.isLocked(e)){for(var i in e.logs){var a=this.lookupLog(e.logs[i],t);"~geometry"===i?a.value!==e.geometry&&(e.geometry=a.value,r=!0):e.properties.hasOwnProperty(i)?e.properties[i]!==a.value&&(e.properties[i]=a.value,r=!0):(e.properties[i]=a.value,r=!0)}r&&this.updateFeature(e)}},r.prototype.updateFeature=function(e){this.calculateFeatureStyle(e),this.activeMapRenderer.updateFeature(e),e===this.lastSelectedFeature&&this.$messageBusService.publish("feature","onFeatureUpdated")},r.prototype.getSensorIndex=function(e,t){if(this.project.activeDashboard&&this.project.activeDashboard.isLive)return t.length-1;for(var r=1;r<t.length;r++)if(t[r]>e)return r-1;return t.length-1},r.prototype.updateFeatureSensorData=function(e,t){var r=e.layer;e.timestamps?e.timestamps:r.timestamps;if(e.sensors||e.coordinates){var i=!1,a=0;if(e.timestamps?a=this.getSensorIndex(t,e.timestamps):r.timestamps&&(r._gui.hasOwnProperty("timestampIndex")?a=r._gui.timestampIndex:(a=this.getSensorIndex(t,r.timestamps),r._gui.timestampIndex=a,r._gui.timestamp=r.timestamps[a])),a>=0&&e.coordinates&&e.geometry&&e.coordinates.length>a&&e.coordinates[a]!==e.geometry.coordinates&&(e.geometry.coordinates=e.coordinates[a],
r.group.markers.hasOwnProperty(e.id))){var o=r.group.markers[e.id];o.setLatLng(new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]))}if(e.sensors){for(var s in e.sensors){var n=e.sensors[s];if(n.length>0){var c=n[a];c!==e.properties[s]&&(e.properties[s]=c,i=!0)}}i&&(this.calculateFeatureStyle(e),this.activeMapRenderer.updateFeature(e),e.isSelected&&this.$messageBusService.publish("feature","onFeatureUpdated",e))}}},r.prototype.updateLayerSensorDataWithDate=function(e,t){var r=this;delete e._gui.timestampIndex,delete e._gui.timestamp,(e.hasSensorData||e.sensorLink)&&e.data.features&&(e.data.features.forEach(function(i){(e.partialBoundingBoxUpdates&&i._gui.insideBBOX||!e.partialBoundingBoxUpdates)&&r.updateFeatureSensorData(i,t)}),this.mb.publish("layer","sensordataUpdated",e)),e.isDynamic&&e.useLog&&e.data.features.forEach(function(e){r.updateLog(e)})},r.prototype.updateSensorData=function(){if(null!=this.project&&null!=this.project.timeLine&&null!=this.project.features)for(var e in this.loadedLayers){var t=this.loadedLayers[e];this.updateLayerSensorData(t)}},r.prototype.updateLayerSensorData=function(e){var t=this.project.timeLine.focus;this.project.activeDashboard&&this.project.activeDashboard.isLive?!_.isUndefined(e.timestamps)&&_.isArray(e.timestamps)&&(t=e.timestamps[e.timestamps.length-1],this.updateLayerSensorDataWithDate(e,t)):this.updateLayerSensorDataWithDate(e,t)},r.prototype.filterProperties=function(e){var t=[];return null!=e.filters&&e.filters.length>0&&e.filters.forEach(function(e){t.push(e.property)}),t},r.prototype.initFeature=function(t,r,i,a){var o=this;if(void 0===i&&(i=!1),void 0===a&&(a=!0),!t._isInitialized){if(t._isInitialized=!0,t.type="Feature",t._gui={included:!0,insideBBOX:!0},t.logs||(t.logs={}),null==t.properties&&(t.properties={}),t.index=r.count++,null==t.id&&(t.id=e.Helpers.getGuid()),t.layerId=r.id,t.layer=r,this.project.features.push(t),t.fType=this.getFeatureType(t),this.evaluateFeatureExpressions(t),r.group.ndx.add([t]),t.fType.defaultLegendProperty&&("string"==typeof t.fType.defaultLegendProperty?this.checkLayerLegend(r,t.fType.defaultLegendProperty):t.fType.defaultLegendProperty.forEach(function(e){return o.checkLayerLegend(r,t.fType.defaultLegendProperty)})),t.properties.hasOwnProperty("Name")||e.Helpers.setFeatureName(t,this.propertyTypeData),t.sensors)for(var s in t.sensors)this.cleanSensorData(t,s);this.calculateFeatureStyle(t),t.propertiesOld={},r.useLog&&this.trackFeature(t),i&&this.apply(),r.timeAware&&a&&this.$messageBusService.publish("timeline","updateFeatures")}return t.fType},r.prototype.cleanSensorData=function(e,t){for(var r=0;r<e.sensors[t].length;r++)-1===e.sensors[t][r]&&(e.sensors[t][r]=NaN)},r.prototype.removeFeature=function(e,t){if(void 0===t&&(t=!1),this.project.features=this.project.features.filter(function(t){return t!==e}),e.layer.data.features=e.layer.data.features.filter(function(t){return t!==e}),e.layer.group.filterResult&&(e.layer.group.filterResult=e.layer.group.filterResult.filter(function(t){return t!==e})),e.layer.group.ndx.remove([e]),this.activeMapRenderer.removeFeature(e),this.$messageBusService.publish("feature","onFeatureRemoved",e),t&&e.layer.isDynamic){var r=new i;r.layerId=e.layerId,r.action=a.deleteFeature,r.item=e.id,this.$messageBusService.serverSendMessageAction("layer",r)}e.isSelected&&(this.lastSelectedFeature=null,this.selectedFeatures.some(function(t,r,i){return t.id===e.id?(i.splice(r,1),!0):void 0}))},r.prototype.calculateFeatureStyle=function(t){var r=e.Helpers.getDefaultFeatureStyle(t),i=this.getFeatureType(t),a=i.style,o=t.properties;a&&(a.nameLabel&&(r.nameLabel=a.nameLabel),a.marker&&(r.marker=a.marker),a.iconUri&&(r.iconUri=a.iconUri),a.fillOpacity>=0&&(r.fillOpacity=a.fillOpacity),a.strokeOpacity>=0&&(r.strokeOpacity=a.strokeOpacity),a.opacity>=0&&(r.opacity=a.opacity),a.fillColor&&(r.fillColor=e.Helpers.getColorString(a.fillColor)),"undefined"!=typeof a.stroke&&(r.stroke=a.stroke),a.strokeColor&&(r.strokeColor=e.Helpers.getColorString(a.strokeColor,"#fff")),"undefined"!=typeof a.strokeWidth&&(r.strokeWidth=a.strokeWidth),a.selectedStrokeColor&&(r.selectedStrokeColor=e.Helpers.getColorString(a.selectedStrokeColor,"#000")),a.selectedFillColor&&(r.selectedFillColor=e.Helpers.getColorString(a.selectedFillColor)),a.selectedStrokeWidth&&(r.selectedStrokeWidth=a.selectedStrokeWidth),a.iconWidth&&(r.iconWidth=a.iconWidth),a.iconHeight&&(r.iconHeight=a.iconHeight),a.heightAboveSeaProperty&&(r.heightAboveSeaProperty=a.heightAboveSeaProperty),a.modelUri&&(r.modelUri=a.modelUri),a.modelScale&&(r.modelScale=a.modelScale),a.modelMinimumPixelSize&&(r.modelMinimumPixelSize=a.modelMinimumPixelSize),a.innerTextProperty&&(r.innerTextProperty=a.innerTextProperty),a.innerTextSize&&(r.innerTextSize=a.innerTextSize),a.cornerRadius&&(r.cornerRadius=a.cornerRadius),a.rotateProperty&&o.hasOwnProperty(a.rotateProperty)&&(r.rotate=Number(o[a.rotateProperty])),a.heightProperty&&o.hasOwnProperty(a.heightProperty)?r.height=Number(o[a.heightProperty]):r.height=a.height,a.modelUriProperty&&o.hasOwnProperty(a.modelUriProperty)?r.modelUri=o[a.modelUriProperty]:r.modelUri=a.modelUri,a.modelScaleProperty&&o.hasOwnProperty(a.modelScaleProperty)?r.modelScale=o[a.modelScaleProperty]:r.modelScale=a.modelScale,a.modelMinimumPixelSizeProperty&&o.hasOwnProperty(a.modelMinimumPixelSizeProperty)?r.modelMinimumPixelSize=o[a.modelMinimumPixelSizeProperty]:r.modelMinimumPixelSize=a.modelMinimumPixelSize),t._gui.style={},t.layer&&(r.opacity=t.layer.isTransparent?0:r.opacity*(t.layer.opacity/100),r.fillOpacity=t.layer.isTransparent?0:r.fillOpacity*(t.layer.opacity/100),r.iconHeight=t.layer.isTransparent?0:r.iconHeight,r.iconWidth=t.layer.isTransparent?0:r.iconWidth,r.strokeWidth=t.layer.isTransparent?0:r.strokeWidth),t.layer&&t.layer.group&&t.layer.group.styles&&t.layer.group.styles.forEach(function(i){if(i.enabled&&t.properties.hasOwnProperty(i.property)){var a=Number(t.properties[i.property]);try{if(isNaN(a)){var o=t.properties[i.property].toString();switch(i.visualAspect){case"strokeColor":r.strokeColor=e.Helpers.getColorFromStringValue(o,i),t._gui.style[i.property]=r.strokeColor;break;case"fillColor":r.fillColor=e.Helpers.getColorFromStringValue(o,i),t._gui.style[i.property]=r.fillColor}}else switch(i.visualAspect){case"strokeColor":r.strokeColor=e.Helpers.getColor(a,i),t._gui.style[i.property]=r.strokeColor;break;case"fillColor":r.fillColor=e.Helpers.getColor(a,i),t._gui.style[i.property]=r.fillColor,t.geometry&&t.geometry.type&&"linestring"===t.geometry.type.toLowerCase()&&(r.strokeColor=r.fillColor);break;case"strokeWidth":r.strokeWidth=(a-i.info.min)/(i.info.max-i.info.min)*10+1;break;case"height":r.height=(a-i.info.min)/(i.info.max-i.info.min)*25e3}}catch(s){console.log("Error setting style for feature "+s.message)}}}),t.isSelected&&(r.strokeWidth=r.selectedStrokeWidth||3,r.strokeColor=r.selectedStrokeColor||"black",r.selectedFillColor&&(r.fillColor=r.selectedFillColor)),t.effectiveStyle=r},r.prototype.initFeatureType=function(e,t){if(!e._isInitialized){if(e._isInitialized=!0,this.initIconUri(e),null!=e.languages&&this.currentLocale in e.languages){var r=e.languages[this.currentLocale];r.name&&(e.name=r.name)}e._propertyTypeData&&0!==e._propertyTypeData.length||(e._propertyTypeData=[],e.propertyTypeKeys&&e.propertyTypeKeys.length>0&&e.propertyTypeKeys.split(/[,;]+/).forEach(function(r){if(t.propertyTypeData)if(t.propertyTypeData.hasOwnProperty(r))e._propertyTypeData.push(t.propertyTypeData[r]);else{var i={label:r,title:r,type:"text"};t.propertyTypeData[r]=i,e._propertyTypeData.push(i)}}),e._expressions=[],e._propertyTypeData.forEach(function(t){t.expression&&e._expressions.push(t)}))}},r.prototype.initIconUri=function(e){if(e.style.iconUri){var t=/^(http[s]?:\/\/[:a-zA-Z0-9_\.]+)\/.*$/g,r=t.exec(e.id);r&&r.length>1&&(e.style.iconUri=r[1]+"/"+e.style.iconUri)}},r.prototype.initPropertyType=function(e,t){this.setDefaultPropertyType(e),e.legendType&&t&&t.hasOwnProperty(e.legendType)&&(e.legend=t[e.legendType]),null!=e.languages&&this.localizePropertyType(e)},r.prototype.setDefaultPropertyType=function(e){if(e.type||(e.type="text"),"undefined"==typeof e.title&&(e.title=e.label),"undefined"==typeof e.canEdit&&(e.canEdit=!1),"undefined"==typeof e.visibleInCallOut&&(e.visibleInCallOut=!0),"undefined"==typeof e.isSearchable&&"text"===e.type&&(e.isSearchable=!0),e.options&&_.isArray(e.options)){var t=e.options;e.options={};var r=0;t.forEach(function(t){e.options[r]=t,r+=1})}},r.prototype.localizePropertyType=function(e){if(null!=e.languages&&this.currentLocale in e.languages){var t=e.languages[this.currentLocale];t.title&&(e.title=t.title),t.description&&(e.description=t.description),t.section&&(e.section=t.section),null!=t.options&&(e.options=t.options)}},r.prototype.findResourceByLayer=function(e){return e&&e.typeUrl&&this.typesResources.hasOwnProperty(e.typeUrl)?this.typesResources[e.typeUrl]:null},r.prototype.findResourceByFeature=function(e){if(e.layer&&e.layer.typeUrl){var t=e.layer.typeUrl;return this.typesResources.hasOwnProperty(t)?this.typesResources[t]:null}return null},r.prototype.findPropertyTypeById=function(e){if(-1===e.indexOf("#"))return null;for(var t in this.typesResources)if(0===e.indexOf(t)){var r=this.typesResources[t].propertyTypeData,i=e.split("#")[1];if(r.hasOwnProperty(i))return r[i]}return null},r.prototype.findFilter=function(e,t){if(e&&t){null==e.filters&&(e.filters=[]);var r=e.filters.filter(function(e){return e.property===t});return r.length>0?r[0]:null}},r.prototype.findFeatureByIndex=function(e,t){for(var r=0;r<this.project.features.length;r++){var i=this.project.features[r];if(t===i.index&&e===i.layerId)return i}},r.prototype.findFeatureById=function(e){return _.find(this.project.features,function(t){return t.id===e})},r.prototype.findFeatureByPropertyValue=function(e,t){return _.find(this.project.features,function(r){return r.properties.hasOwnProperty(e)&&r.properties[e]===t})},r.prototype.findFeature=function(e,t){return e.data&&e.data.features?_.find(e.data.features,function(e){return e.id===t}):null},r.prototype.findGroupById=function(e){for(var t=0;t<this.project.groups.length;t++)if(this.project.groups[t].id===e)return this.project.groups[t];return null},r.prototype.findGroupByLayerId=function(e){if(!e.id)return null;var t;return this.project.groups.some(function(r){return r.layers&&r.layers.some(function(i){return i.id===e.id?(t=r,!0):!1}),!!t}),t},r.prototype.findFeatureByName=function(e){for(var t=0;t<this.project.features.length;t++){var r=this.project.features[t];if(r.hasOwnProperty("Name")&&e===r.properties.Name)return r}},r.prototype.findLoadedLayer=function(e){return this.loadedLayers.hasOwnProperty(e)?this.loadedLayers[e]:null},r.prototype.findLayer=function(e){if(this.loadedLayers.hasOwnProperty(e))return this.loadedLayers[e];var t;return this.project.groups.forEach(function(r){r.layers.forEach(function(r){r.id===e&&(t=r)})}),t},r.prototype.setGroupStyle=function(r,i){var a=this;if("undefined"!=typeof i&&null!==i&&"undefined"!=typeof r&&null!==r){var o=new t.GroupStyle(this.$translate);o.id=e.Helpers.getGuid(),o.title=i.title,o.visualAspect="fillColor",o.canSelectColor=o.visualAspect.toLowerCase().indexOf("color")>-1,o.info=this.calculatePropertyInfo(r,i.label),o.enabled=!0,o.property=i.label,o.group=r,i.legend?(o.activeLegend=i.legend,o.activeLegend.visualAspect&&(o.visualAspect=o.activeLegend.visualAspect)):o.colors=["white","#FF5500"],this.saveStyle(r,o),this.project.features.forEach(function(e){e.layer.group===r&&(a.calculateFeatureStyle(e),a.activeMapRenderer.updateFeature(e))}),this.$messageBusService.publish("updatelegend","updatedstyle",o)}},r.prototype.setStyleForProperty=function(e,t){this.setStyle({feature:{featureTypeName:e.url+"#"+t,layer:e},property:t,key:t},!1)},r.prototype.setStyle=function(r,i,a,o){var s=this;void 0===i&&(i=!1);var n=r.feature;if(null!=n){var c,l=this.getFeatureType(n);if(o)c=o,c.info=this.calculatePropertyInfo(n.layer.group,r.property);else{c=new t.GroupStyle(this.$translate),c.id=e.Helpers.getGuid(),c.title=r.key,c.meta=r.meta,c.visualAspect=l.style&&l.style.drawingMode&&"line"===l.style.drawingMode.toLowerCase()?"strokeColor":"fillColor",c.canSelectColor=c.visualAspect.toLowerCase().indexOf("color")>-1,c.property=r.property,a?(c.info=a,c.fixedColorRange=!0):null==c.info&&(c.info=this.calculatePropertyInfo(n.layer.group,r.property)),c.enabled=!0,c.group=n.layer.group,c.meta=r.meta;var p=this.propertyTypeData[r.property];p&&p.legend&&(c.activeLegend=p.legend,p.legend.visualAspect&&(c.visualAspect=p.legend.visualAspect),c.legends[p.title]=p.legend,c.colorScales[p.title]=["purple","purple"]),l.style&&l.style.fillColor?c.colors=["white","#FF5500"]:c.colors=["red","white","blue"]}return this.saveStyle(n.layer.group,c),this.project.features.forEach(function(e){e.layer.group===n.layer.group&&(s.calculateFeatureStyle(e),s.activeMapRenderer.updateFeature(e))}),i&&$('#leftPanelTab a[data-target="#styles"]').tab("show"),this.$messageBusService.publish("updatelegend","updatedstyle",c),c}return null},r.prototype.toggleStyle=function(e,t,r,i){var a=this;void 0===r&&(r=!1);var o=e.feature.layer.group.styles;o.some(function(t){return t.property===e.property})?o.filter(function(t){return t.property===e.property}).forEach(function(e){return a.removeStyle(e)}):this.setStyle(e,r,i),this.$messageBusService.publish("updatelegend","updatedstyle")},r.prototype.saveStyle=function(e,t){var r=e.styles.filter(function(e){return e.visualAspect===t.visualAspect});if(r.length>0){var i=e.styles.indexOf(r[0]);e.styles.splice(i,1)}e.styles.push(t)},r.prototype.updateFilterAvailability=function(){var e=this;this.noFilters=!0,this.project.groups.forEach(function(t){t.filters.length>0&&e.noFilters&&(e.noFilters=!1)})},r.prototype.addFilter=function(e,r){var i=this.findFilter(e,r);if(null==i){var a=new t.GroupFilter;a.property=r,a.title=r,a.rangex=[0,1],e.filters.push(a)}else{var o=e.filters.indexOf(i);-1!==o&&e.filters.slice(o,1)}this.visual.leftPanelVisible=!0,$('#leftPanelTab a[data-target="#filters"]').tab("show")},r.prototype.setFilter=function(e,t){e.group=t,t.filters.push(e),this.visual.leftPanelVisible=!0,$('#leftPanelTab a[data-target="#filters"]').tab("show"),this.triggerUpdateFilter(t.id)},r.prototype.setLocationFilter=function(r){if(!r.filters.some(function(e){return"location"===e.filterType})){var i=new t.GroupFilter;i.id=e.Helpers.getGuid(),i.group=r,i.filterType="location",i.title="Location",i.rangex=[0,1],r.filters.push(i),$('#leftPanelTab a[data-target="#filters"]').tab("show"),this.triggerUpdateFilter(r.id)}},r.prototype.setFeatureAreaFilter=function(r){this.project.groups.forEach(function(i){if(i.id!==r.layer.group.id&&!i.filters.some(function(e){return"area"===e.filterType})){var a=new t.GroupFilter;a.id=e.Helpers.getGuid(),a.group=i,a.filterType="area",a.title="Area",a.rangex=[0,1],a.value=r,i.filters.push(a),i.filterResult=i.filterResult||[]}}),this.triggerUpdateFilter(r.layer.group.id)},r.prototype.resetFeatureAreaFilter=function(){var e=this;this.project.groups.forEach(function(t){t.filters.some(function(t){return"area"===t.filterType?(e.removeFilter(t),!0):!1})})},r.prototype.setPropertyFilter=function(r){var i=r.property,a=r.feature;if(null!=a){var o=a.layer;if(null!=o){var s=this.findFilter(o.group,i);if(null==s){var n=new t.GroupFilter;if(n.property=i,n.id=e.Helpers.getGuid(),n.group=o.group,n.meta=r.propertyType,n.filterType="bar",null!=n.meta)if(null!=n.meta.filterType)n.filterType=n.meta.filterType;else switch(n.meta.type){case"boolean":n.filterType="boolean";break;case"date":n.filterType="date";break;case"number":n.filterType="bar";break;case"options":n.filterType="row",n.filterLabel=a.properties[i];break;case"text":n.filterType="row",n.filterLabel=a.properties[i];break;default:n.filterType="text",n.stringValue=r.value,n.value=r.value}n.title=r.key,n.rangex=[0,1],o.group.filters.push(n)}else this.removeFilter(s)}$('#leftPanelTab a[data-target="#filters"]').tab("show")}this.triggerUpdateFilter(o.group.id)},r.prototype.createScatterFilter=function(r,i,a){var o=new t.GroupFilter;o.property=i,o.property2=a,o.id=e.Helpers.getGuid(),o.group=r,o.filterType="scatter",o.title="Scatter",o.rangex=[0,1],r.filters.push(o),$('#leftPanelTab a[data-target="#filters"]').tab("show"),this.triggerUpdateFilter(r.id)},r.prototype.triggerUpdateFilter=function(e){this.mb.publish("filters","updated",e),this.updateFilterAvailability()},r.prototype.removeFilter=function(e){e&&(e.group.filterResult=e.dimension.filterAll().top(1/0),e.dimension.dispose(),e.group.filters=e.group.filters.filter(function(t){return t!==e}),this.resetMapFilter(e.group),this.updateMapFilter(e.group),this.triggerUpdateFilter(e.group.id))},r.prototype.getPropertyType=function(e,t){var r;if(e.fType&&e.fType._propertyTypeData&&e.fType._propertyTypeData.length>0&&(r=_.find(e.fType._propertyTypeData,function(e){return e.label===t})))return r;if(!e.layer.typeUrl||!this.typesResources.hasOwnProperty(e.layer.typeUrl))return r;if(!r){var i=this.typesResources[e.layer.typeUrl];r=_.find(i.propertyTypeData,function(e){return e.label===t})}return r||(r={label:t,type:"text",title:t}),r},r.prototype.getFeatureTypeId=function(e){e.hasOwnProperty("layer")||(e.layer=new t.ProjectLayer);var r=e.properties.FeatureTypeId||e.properties.featureTypeId||e.layer.defaultFeatureType||"Default";return/^http:\/\//.test(r.toLowerCase())?r:e.layer.typeUrl?e.layer.typeUrl+"#"+r:e.layer.url?e.layer.url+"#"+r:this.project.url+"#"+r},r.prototype.getFeatureTypeById=function(e){return this._featureTypes.hasOwnProperty(e)?this._featureTypes[e]:void 0},r.prototype.getFeatureType=function(e){e.featureTypeName||(e.featureTypeName=this.getFeatureTypeId(e));var t=e.featureTypeName.indexOf("_{")>=0;if(!t&&e.fType)return e.fType;var r=e.featureTypeName;if(t){var i=/_{([a-zA-Z_0-9]+)}/g,a=i.exec(r);if(a)for(var o=1;o<a.length;o++){var s=a[o];r=e.properties.hasOwnProperty(s)?r.replace("{"+s+"}",e.properties[s]):r.replace("_{"+s+"}","")}}return this._featureTypes.hasOwnProperty(r)||this.createMissingFeatureType(e),e.fType=this._featureTypes[r],e.fType},r.prototype.createMissingFeatureType=function(t){var r=this,i=Object.getOwnPropertyNames(this._featureTypes),a=i.map(function(e){return r._featureTypes[e]}).filter(function(e){return e.name===t.featureTypeName});a.length>0?this._featureTypes[t.featureTypeName]=a[0]:this._featureTypes[t.featureTypeName]=e.Helpers.createDefaultType(t,null)},r.prototype.resetFilters=function(){dc.filterAll(),dc.redrawAll()},r.prototype.getGroupFeatures=function(e){var t=[];e.layers.forEach(function(e){e.enabled&&t.push(e.id)});var r=this.project.features.filter(function(e){return t.indexOf(e.layerId)>-1});return r},r.prototype.rebuildFilters=function(e){e.ndx=crossfilter([]);var t=this.getGroupFeatures(e);e.ndx.add(t)},r.prototype.removeLayer=function(e,t){void 0===t&&(t=!1);var r=e.group;try{e.enabled=!1,e.isLoading=!1,e._gui&&(e._gui.more=!1),this.checkLayerTimer(e),delete this.loadedLayers[e.id],e.layerSource||(e.layerSource=this.layerSources[e.type.toLowerCase()]),e.layerSource.removeLayer(e),null!=this.lastSelectedFeature&&this.lastSelectedFeature.layerId===e.id&&(this.lastSelectedFeature=null,this.visual.rightPanelVisible=!1,this.$messageBusService.publish("feature","onFeatureDeselect")),this.selectedFeatures.length>0&&(this.selectedFeatures=this.selectedFeatures.filter(function(t){return t.layerId!==e.id})),this.activeMapRenderer.removeLayer(e),this.project.features=this.project.features.filter(function(t){return t.layerId!==e.id});e.id+"_",this._featureTypes;this.removeAllFilters(r),this.removeAllStyles(r),this.rebuildFilters(r),t&&(e.group.layers=e.group.layers.filter(function(t){return t!==e})),this.apply(),this.$messageBusService.publish("layer","deactivate",e),this.$messageBusService.publish("rightpanel","deactiveContainer","edit"),e.timeAware&&this.$messageBusService.publish("timeline","updateFeatures"),t&&this.saveProject()}catch(i){}},r.prototype.removeAllFilters=function(e){var t=this;e.filters.forEach(function(e){t.removeFilter(e)}),e.filters.length=0},r.prototype.removeAllStyles=function(e){var t=this;e.styles.forEach(function(e){t.removeStyle(e)}),e.styles.length=0},r.prototype.openSolution=function(e,r,i){var a=this;this.loadedLayers={};var o=this.$location.search();o.hasOwnProperty("project")&&(e=this.emptySolutionUrl,this.openSingleProject=!0),this.$http.get(e).success(function(e){if("object"!=typeof e)return void console.log("Error: obtained solution is not a json object!");if(e.maxBounds&&(a.maxBounds=e.maxBounds,a.$mapService.map.setMaxBounds(new L.LatLngBounds(L.latLng(e.maxBounds.southWest[0],e.maxBounds.southWest[1]),L.latLng(e.maxBounds.northEast[0],e.maxBounds.northEast[1])))),e.viewBounds&&a.activeMapRenderer.fitBounds(e.viewBounds),e.baselayers&&e.baselayers.forEach(function(e){var r=new t.BaseLayer;null!=e.subdomains&&(r.subdomains=e.subdomains),null!=e.maxZoom&&(r.maxZoom=e.maxZoom),null!=e.minZoom&&(r.minZoom=e.minZoom),null!=e.maxNativeZoom&&(r.maxNativeZoom=e.maxNativeZoom),null!=e.errorTileUrl&&(r.errorTileUrl=e.errorTileUrl),null!=e.attribution&&(r.attribution=e.attribution),null!=e.id&&(r.id=e.id),null!=e.title&&(r.title=e.title),null!=e.subtitle&&(r.subtitle=e.subtitle),null!=e.preview&&(r.preview=e.preview),null!=e.url&&(r.url=e.url),null!=e.cesium_url&&(r.cesium_url=e.cesium_url),null!=e.cesium_tileUrl&&(r.cesium_tileUrl=e.cesium_tileUrl),null!=e.cesium_maptype&&(r.cesium_maptype=e.cesium_maptype),a.$mapService.baseLayers[e.title]=r,e.isDefault&&(a.activeMapRenderer.changeBaseLayer(r),a.$mapService.changeBaseLayer(e.title))}),a.openSingleProject){var s=o.project,n="api/projects/"+s;if(i)a.$http.get(n).success(function(e){e&&a.parseProject(e,{title:e.title,url:e.url,dynamic:!0},[])}).error(function(e){a.$messageBusService.notify("ERROR loading project","while loading: "+n)});else{var c=e.projects.some(function(e){return e.id!==s?!1:(i=e.title,!0)});c||a.$http.get(n).success(function(e){e&&a.parseProject(e,{title:e.title,url:e.url,dynamic:!0},[])}).error(function(e){a.$messageBusService.notify("ERROR loading project","while loading: "+n)})}}if(e.projects&&e.projects.length>0){var l=e.projects.filter(function(e){return e.title===i})[0];null!=l?a.openProject(l,r):a.openProject(e.projects[0],r)}if(e.widgetStyles||(e.widgetStyles={}),!e.widgetStyles.hasOwnProperty("default")){var p=new t.WidgetStyle;p.background="red",e.widgetStyles["default"]=p}a.solution=e}).error(function(){a.$messageBusService.notify("ERROR loading solution","while loading: "+e)})},r.prototype.clearLayers=function(){var e=this;null!=this.project&&null!=this.project.groups&&this.project.groups.forEach(function(t){t.layers.forEach(function(t){t.enabled&&(e.removeLayer(t),t.enabled=!1)})})},r.prototype.openProject=function(e,t,r){var i=this;this.projectUrl=e;var a=[];t&&t.split(";").forEach(function(e){a.push(e.toLowerCase())}),this.clearLayers(),this._featureTypes={},this.propertyTypeData={};var o=this.$location.search();o.hasOwnProperty("dashboard")&&(this.startDashboardId=o.dashboard),r?this.parseProject(r,e,a):this.$http.get(e.url).success(function(t){i.parseProject(t,e,a),i.throttleSensorDataUpdate=_.debounce(i.updateSensorData,i.project.timeLine.updateDelay);_.debounce(function(e){i.refreshActiveLayers()},i.project.timeLine.updateDelay)}).error(function(){i.$messageBusService.notify("ERROR loading project","while loading: "+e.url)})},r.prototype.parseProject=function(r,i,a){var o=this;if(r.solution=this.solution,this.setLanguage(r),this.project=(new t.Project).deserialize(r),this.$mapService.initDraw(this),"undefined"==typeof this.project.isDynamic&&(this.project.isDynamic=i.dynamic),this.project.timeLine?this.$messageBusService.publish("timeline","updateTimerange",this.project.timeLine):this.project.timeLine=new t.DateRange,this.project.viewBounds&&this.activeMapRenderer.fitBounds(this.project.viewBounds),this.$messageBusService.publish("map","showScale",this.project.showScale),this.$messageBusService.publish("map","showLocation",this.project.showLocation),this.initTypeResources(this.project),this.project.eventTab){var s=e.Helpers.createRightPanelTab("eventtab","eventtab",{},"Events",'{{"EVENT_INFO" | translate}}',"book");this.$messageBusService.publish("rightpanel","activate",s)}if(this.project.dashboards)this.project.dashboards.forEach(function(t){t=e.Helpers.translateObject(t,o.currentLocale,!1),t.id||(t.id=e.Helpers.getGuid()),t.widgets&&t.widgets.length>0&&t.widgets.forEach(function(t){if(t.datasource){var r=o.findWidgetById(t.datasource);t.data=e.Helpers.translateObject(r.data,o.currentLocale,!0)}else t.data=e.Helpers.translateObject(t.data,o.currentLocale,!0);t.id||(t.id=e.Helpers.getGuid()),t.enabled||(t.enabled=!0),t.position||(t.position="dashboard")})});else{this.project.dashboards=[];var n=new t.Dashboard;n.id="map",n.name="Home",n.showMap=!0,n.showLeftmenu=!0,n.widgets=[],this.project.dashboards.push(n);var c=new t.Dashboard;c.id="datatable",c.name="Table",c.showMap=!1,c.showLeftmenu=!1,c.showRightmenu=!1,c.showTimeline=!1,c.widgets=[{id:"datatable_id",directive:"datatable",elementId:"widget-datatable_id",enabled:!0,width:"100%",height:"100%"}],this.project.dashboards.push(c)}if(async.series([function(e){o.project.typeUrls&&o.project.typeUrls.length>0?async.eachSeries(o.project.typeUrls,function(e,t){o.loadTypeResources(e,!1,function(){return t(null)})},function(){e(null,null)}):e(null,null)},function(e){o.project.datasources||(o.project.datasources=[])}]),this.project.dataSets||(this.project.dataSets=[]),this.project.features=[],this.project.groups&&this.project.groups.length>0&&this.project.groups.forEach(function(e){o.initGroup(e,a),r.startposition&&o.$mapService.zoomToLocation(new L.LatLng(r.startposition.latitude,r.startposition.longitude))}),this.project.isDynamic&&(this.project.layerDirectory||(this.project.layerDirectory="/api/layers"),this.$messageBusService.initConnection("","",function(){o.$messageBusService.subscribe("keyupdate",function(e,t){if("key"===t.action){var r="keys/"+t.data.keyId;o.findSensorSet(r,function(e){var r=(new Date).getTime();t.data.item.hasOwnProperty("time")?r=t.data.item.time:(e.timestamps=[],e.values=[]),e.addValue((new Date).getTime(),t.data.item),e.activeValue=t.data.item})}})})),i.dynamic&&(this.directoryHandle||(this.directoryHandle=this.$messageBusService.serverSubscribe("","directory",function(e,t){if("subscribed"!==t.action){if("layer"===t.action&&t.data&&t.data.item&&o.openSingleProject===!1){var r=t.data.item;if(r){o.findLayer(r.id)}}if("project"===t.action&&t.data&&t.data.item){var a=t.data.item;if(a){var s=o.project.id===a.id;s||o.openSingleProject?a.id===o.project.id&&o.$messageBusService.confirm("New update available for project "+a.title,"Do you want to reload the project?",function(e){e&&o.openProject(i,null,a)},!1):(o.$messageBusService.notify("New project available",a.title),a.url&&"json"!==a.url.substring(a.url.length-4)&&(a.url="/data"+a.url+".json"),o.solution.projects.some(function(e){return e.title===a.title})?console.log("Project already exists ("+a.title+")"):o.solution.projects.push({title:a.title,url:a.url,dynamic:!0}))}}}})),this.$messageBusService.getConnection(this.project.id)||this.$messageBusService.serverSubscribe(this.project.id,"project",function(e,r){"layer-update"===r.action&&r.data.layer.forEach(function(e){var i;e.groupId?i=o.findGroupById(e.groupId):e.groupId="main",i?(i.clustering=r.data.group.clustering,i.clusterLevel=r.data.group.clusterLevel):(i=new t.ProjectGroup,i.id=e.groupId,i.title=r.data.group.title,i.clustering=r.data.group.clustering,i.clusterLevel=r.data.group.clusterLevel,o.project.groups.push(i),o.initGroup(i));var a=!1,s=0;if(i.layers.forEach(function(t,r){t.id===e.id&&(a=!0,s=r)}),a){var n=i.styles;o.lastSelectedFeature&&o.lastSelectedFeature.isSelected&&o.selectFeature(o.lastSelectedFeature),e.layerSource||(e.layerSource=o.layerSources[e.type.toLowerCase()]),e.group=i,o.removeLayer(i.layers[s]),o.addLayer(i.layers[s],function(){n&&n.length>0&&o.setStyle({feature:{featureTypeName:e.url+"#"+e.defaultFeatureType,layer:e},property:n[0].property,key:n[0].title,meta:n[0].meta},!1,null,n[0])})}else i.layers.push(e),o.initLayer(i,e),e.layerSource||(e.layerSource=o.layerSources[e.type.toLowerCase()]),e.layerSource.refreshLayer(i.layers[i.layers.length-1]);o.apply()}),"layer-remove"===r.action&&r.data.forEach(function(e){var t;e.groupId?t=o.findGroupById(e.groupId):e.groupId="main",null!=t&&(t.layers.forEach(function(t){t.id===e.id&&o.removeLayer(t,!0)}),0===t.layers.length&&o.removeGroup(t))})})),r.hasOwnProperty("collapseAllLayers")&&r.collapseAllLayers===!0&&(this.apply(),this.collapseAll()),this.$messageBusService.publish("project","loaded",this.project),this.project.dashboards&&this.project.dashboards.length>0){var l=this.project.dashboards[Object.keys(this.project.dashboards)[0]];this.startDashboardId&&this.findDashboardById(this.startDashboardId)&&(l=this.findDashboardById(this.startDashboardId)),this.$messageBusService.publish("dashboard-main","activated",l)}this.project.searchProviders.forEach(function(e){switch(e.name.toLowerCase()){case"offline":o.addActionService(new t.OfflineSearchActions(o.$http,e.url));break;case"bag":o.addActionService(new t.OnlineSearchActions(o.$http,e.url));break;case"bing":if(!e.key)break;o.addActionService(new t.BingSearchAction(o.$http,e.key,e.url,e.data));break;case"opencagedata":if(!e.key)break;var r=e.data;r||(r={countrycode:"nl",bounds:"3.357962,50.7503838,7.2275102,53.5551999"}),r.messageBus=o.$messageBusService,o.addActionService(new t.OpenCageDataSearchAction(o.$http,e.key,e.url,r));break;case"esribagsearch":o.addActionService(new t.EsriBagSearchAction(o.$http,e.key,e.url,e.data))}})},r.prototype.apply=function(){"$apply"!==this.$rootScope.$root.$$phase&&"$digest"!==this.$rootScope.$root.$$phase&&this.$rootScope.$apply()},r.prototype.toggleLayer=function(e,t){_.isUndefined(e.enabled)||e.enabled===!1?(e.enabled=!0,this.addLayer(e,function(){t&&t()})):(e.enabled=!e.enabled,this.removeLayer(e),t&&t())},r.prototype.enableLayer=function(e,t){e.enabled=!0,this.addLayer(e,function(){t&&t()})},r.prototype.removeGroup=function(e){var t=this;e.layers&&e.layers.forEach(function(e){e.enabled&&t.removeLayer(e,!0)}),e.ndx=null,this.project.groups=this.project.groups.filter(function(t){return t!==e}),this.apply()},r.prototype.initGroup=function(t,r){var i=this;if(null==t.id&&(t.id=e.Helpers.getGuid()),t.ndx=crossfilter([]),t.styles&&t.styles.length>0){t.styles[0].id}if(null==t.styles&&(t.styles=[]),null==t.filters&&(t.filters=[]),t.markers={},null!=t.languages&&this.currentLocale in t.languages){var a=t.languages[this.currentLocale];a.title&&(t.title=a.title),a.description&&(t.description=a.description)}this.activeMapRenderer.addGroup(t),t.layers||(t.layers=[]),t.layers.forEach(function(e){i.initLayer(t,e,r)}),t.styles.forEach(function(t){null!=t.id&&(t.id=e.Helpers.getGuid())}),t.filters.forEach(function(t){null!=t.id&&(t.id=e.Helpers.getGuid())})},r.prototype.initLayer=function(t,r,i){if(null==r.id&&(r.id=e.Helpers.getGuid()),r.type=r.type?r.type.toLowerCase():"geojson",r._gui={},r.renderType=r.renderType?r.renderType.toLowerCase():r.type,"dynamicgeojson"===r.type&&(r.isDynamic=!0),("editablegeojson"===r.type||r.isDynamic)&&(r.isEditable=!0),null==r.reference&&(r.reference=r.id),null==r.title&&(r.title=r.id),null!=r.languages&&this.currentLocale in r.languages){var a=r.languages[this.currentLocale];a.title&&(r.title=a.title),a.description&&(r.description=a.description)}r.group=t,r.groupId||(r.groupId=t.id),(r.enabled||i&&i.indexOf(r.reference.toLowerCase())>=0)&&(r.enabled=!0,this.addLayer(r))},r.prototype.checkDataSourceSubscriptions=function(e){var t=this;for(var r in e.sensors)this.$messageBusService.serverSubscribe(r,"sensor",function(r,i){if("sensor-update"===i.action){var a=i.data[0],o=e.sensors[a.sensor];if(null!=o){for(o.timestamps.push(a.date),o.values.push(a.value);o.timestamps.length>30;)o.timestamps.shift(),
o.values.shift();o.activeValue=a.value,t.$messageBusService.publish("sensor-"+e.id+"/"+a.sensor,"update",o.activeValue),t.apply()}}})},r.prototype.checkSubscriptions=function(){var e=this;this.project.datasources.forEach(function(t){t.url&&"dynamic"===t.type&&e.checkDataSourceSubscriptions(t)})},r.prototype.closeProject=function(){var e=this;null!=this.project&&this.project.groups.forEach(function(t){t.layers.forEach(function(t){t.enabled&&e.removeLayer(t)})})},r.prototype.findSensorSet=function(e,r){var i=e.split("/");if(2===i.length){var a=i[0],o=i[1],s=this.project.datasources.filter(function(e){return e.id===a});if(0===s.length){var n=new t.DataSource;n.id=a,n.type="dynamic",n.sensors={},s.push(n),this.project.datasources.push(n)}if(n=s[0],n.sensors.hasOwnProperty(o))r(n.sensors[o]);else{var c=new t.SensorSet;c.id=o,c.title=o,c.timestamps=[],c.values=[],n.sensors[o]=c,r(c)}}return null},r.prototype.getPropertyValues=function(e,t){var r=[],i=[];return i=this.selectedFeatures.length>1?this.selectedFeatures:e.group.filterResult?e.group.filterResult:e.data.features,i&&i.forEach(function(t){t.layerId===e.id&&r.push(t.properties)}),0===r.length&&(r=e.data.features),r},r.prototype.calculatePropertyInfo=function(e,t){var r=this,i={count:0,max:Number.MIN_VALUE,min:Number.MAX_VALUE},a=0,o=0;if(e.layers.forEach(function(e){e.enabled&&r.project.features.forEach(function(r){if(r.layerId===e.id&&r.properties.hasOwnProperty(t)){var s=Number(r.properties[t]);if(isNaN(s))return;i.count++,a+=s,o+=s*s,s>i.max&&(i.max=s),s<i.min&&(i.min=s)}})}),isNaN(a)||0===i.count||(i.mean=a/i.count,i.varience=o/i.count-i.mean*i.mean,i.sd=Math.sqrt(i.varience)),this.propertyTypeData.hasOwnProperty(t)){var s=this.propertyTypeData[t];i.userMin=s.min,i.userMax=s.max}return i},r.prototype.updateFilterGroupCount=function(e){null!=e.filterResult&&$("#filtergroupcount_"+e.id).text(e.filterResult.length+" objecten geselecteerd")},r.prototype.trackGeometry=function(e,t){var r="~geometry",i={ts:(new Date).getTime(),prop:r,value:e.geometry};e.propertiesOld[r]=JSON.parse(JSON.stringify(e.geometry)),e.logs.hasOwnProperty(r)||(e.logs[r]=[]),t.hasOwnProperty(r)||(t[r]=[]),e.logs[r].push(i),t[r].push(i),e._gui.lastUpdate=i.ts},r.prototype.trackPropertyLog=function(e,t,r){var i={ts:(new Date).getTime(),prop:t,value:e.properties[t]};e.propertiesOld[t]=JSON.parse(JSON.stringify(e.properties[t])),e.logs.hasOwnProperty(t)||(e.logs[t]=[]),r.hasOwnProperty(t)||(r[t]=[]),e.logs[t].push(i),r[t].push(i),e._gui.lastUpdate=i.ts},r.prototype.trackFeature=function(e){var t={};for(var r in e.properties)e.propertiesOld.hasOwnProperty(r)?JSON.stringify(e.propertiesOld[r])!==JSON.stringify(e.properties[r])&&this.trackPropertyLog(e,r,t):this.trackPropertyLog(e,r,t);return JSON.stringify(e.propertiesOld["~geometry"])!==JSON.stringify(e.geometry)&&this.trackGeometry(e,t),t},r.prototype.isLocked=function(e){return e._gui.hasOwnProperty("lock")||e._gui.hasOwnProperty("editMode")&&e._gui.editMode},r.prototype.lockFeature=function(e){return e._gui.hasOwnProperty("lock")?!1:(e._gui.lock=!0,!0)},r.prototype.unlockFeature=function(e){delete e._gui.lock},r.prototype.stopEditingLayer=function(e){var t=this;this.project.groups.forEach(function(r){delete r._gui.editing,r.layers.forEach(function(r){delete e._gui.editing,delete e._gui.featureTypes,e.data&&e.data.features&&_.isArray(e.data.features)&&e.data.features.forEach(function(e){delete e._gui.editMode,t.updateFeature(e),t.saveFeature(e)})})}),this.editing=!1},r.prototype.saveProject=function(){var e=this;this.project.isDynamic&&(console.log("saving project"),setTimeout(function(){var t=e.project.serialize(),r=(e.projectUrl.url,{projectId:e.project.id,action:o.updateProject,item:t});e.$messageBusService.serverSendMessageAction("project",r)},0))},r.prototype.updateProjectReady=function(e){},r.prototype.createFeature=function(e,t){t&&t.isDynamic&&t.data&&t.data.features&&(t.data.features.push(e),this.initFeature(e,t),this.activeMapRenderer.addFeature(e),this.saveFeature(e))},r.prototype.saveFeature=function(e,r){if(void 0===r&&(r=!1),e.properties.updated=(new Date).getTime(),e.layer.isDynamic)if(e.layer.useLog){var o=this.trackFeature(e),s=new i;s.layerId=e.layerId,s.action=a.updateLog,s.item={featureId:e.id,logs:o},this.$messageBusService.serverSendMessageAction("layer",s)}else{var s=new i;s.layerId=e.layerId,s.action=a.updateFeature,s.item=t.Feature.serialize(e),this.$messageBusService.serverSendMessageAction("layer",s)}},r.prototype.updateFilterStatusFeature=function(e){this.project.features.forEach(function(t){t.layer.group===e&&(t._gui.included=!1)}),e.filterResult.forEach(function(e){e._gui.included=!0})},r.prototype.updateMapFilter=function(e){this.updateFilterStatusFeature(e),this.activeMapRenderer.updateMapFilter(e),this.$messageBusService.publish("timeline","updateFeatures",e.id)},r.prototype.resetMapFilter=function(e){var t=this;this.updateFilterStatusFeature(e),$.each(e.markers,function(r,i){e.clustering?e._cluster.hasLayer(i)||e._cluster.addLayer(i):t.map.map.hasLayer(i)||t.map.map.addLayer(i)})},r.$inject=["$location","$compile","$translate","messageBusService","mapService","$rootScope","geoService","$http","expressionService","actionService","localStorageService"],r}();t.LayerService=r;var i=function(){function e(){}return e}();t.LayerUpdate=i,function(e){e[e.updateFeature=0]="updateFeature",e[e.updateLog=1]="updateLog",e[e.deleteFeature=2]="deleteFeature",e[e.updateLayer=3]="updateLayer",e[e.deleteLayer=4]="deleteLayer",e[e.addUpdateFeatureBatch=5]="addUpdateFeatureBatch"}(t.LayerUpdateAction||(t.LayerUpdateAction={}));var a=t.LayerUpdateAction;!function(e){e[e.Create=0]="Create",e[e.Update=1]="Update",e[e.Delete=2]="Delete"}(t.ChangeType||(t.ChangeType={}));t.ChangeType;!function(e){e[e.updateProject=0]="updateProject",e[e.deleteProject=1]="deleteProject"}(t.ProjectUpdateAction||(t.ProjectUpdateAction={}));var o=t.ProjectUpdateAction,s=function(){function e(){}return e}();t.ProjectUpdate=s;var n="csComp";try{t.myModule=angular.module(n)}catch(c){t.myModule=angular.module(n,[])}t.myModule.service("layerService",e.Services.LayerService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},MatrixAction;!function(e){var t=function(e){function t(){e.apply(this,arguments),this.id="MatrixActionModel"}return __extends(t,e),t.prototype.init=function(t){e.prototype.init.call(this,t)},t.prototype.selectFeature=function(e){var t=this,r=csComp.Helpers.getPropertyTypes(e.fType,this.layerService.propertyTypeData);r.forEach(function(r){if("matrix"===r.type&&e.properties.hasOwnProperty(r.label)){var i=e.properties[r.label];t.layerService.project.features.forEach(function(t){if(t.layer===e.layer&&t.properties.hasOwnProperty(r.targetid)&&i.hasOwnProperty(t.properties[r.targetid])){var a=i[t.properties[r.targetid]];for(var o in a)t.properties[o]=a[o]}});var a={};a[e.featureTypeName]=e.fType,t.layerService.evaluateLayerExpressions(e.layer,a),t.layerService.updateGroupFeatures(e.layer.group)}})},t.prototype.addLayer=function(e){var t=this;e.data&&e.data.features&&e.data.features.forEach(function(e){var r=csComp.Helpers.getPropertyTypes(e.fType,t.layerService.propertyTypeData);r.forEach(function(r){if("matrix"===r.type&&e.properties.hasOwnProperty(r.label)){var i=e.properties[r.label];for(var a in i){var o=i[a];if(o.hasOwnProperty("b")&&o.b>0&&o.hasOwnProperty("h")&&o.h>0){var s=t.layerService.findFeatureByPropertyValue(r.targetid,a);if(s){var n=r.label+"_h",c=r.label+"_b";s.properties.hasOwnProperty(n)||(s.properties[n]=0),s.properties.hasOwnProperty(c)||(s.properties[c]=0),s.properties[n]+=o.h,s.properties[c]+=o.b}}}}})})},t}(csComp.Services.BasicActionService);e.MatrixActionModel=t}(MatrixAction||(MatrixAction={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},RelationAction;!function(e){var t=function(e){function t(){e.apply(this,arguments),this.id="RelationActionModel"}return __extends(t,e),t.prototype.init=function(t){e.prototype.init.call(this,t)},t.prototype.selectFeature=function(e){var t=this,r=csComp.Helpers.getPropertyTypes(e.fType,this.layerService.propertyTypeData);if(e._gui||(e._gui={}),e._gui.relations={},r&&_.isArray(r)){var i=[];r.forEach(function(r){if("relation"===r.type){var a=!r.target,o=!r.subject,s=o?e.id:e.properties[r.subject],n=[];r.targetlayers?r.targetlayers.length>0&&"*"===r.targetlayers[0]?n=t.layerService.project.features:r.targetlayers.forEach(function(e){var r=t.layerService.findLayer(e);r&&r.data&&r.data.features&&(n=n.concat(r.data.features))}):n=e.layer.data.features||[],i=n.filter(function(t){if(a){if(t.id===s&&t.id!==e.id)return!0}else if(t.properties&&t.properties.hasOwnProperty(r.target)&&t.properties[r.target]===s&&t.id!==e.id)return!0;return!1}),e._gui.relations[r.label]=i}})}},t.prototype.addLayer=function(e){},t}(csComp.Services.BasicActionService);e.RelationActionModel=t}(RelationAction||(RelationAction={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function t(e,t,r){this.$localStorageService=e,this.$timeout=t,this.$messageBusService=r}return t.prototype.startLogin=function(){var t=e.Helpers.createRightPanelTab("profile","profiletab",null,"Selected feature",'{{"FEATURE_INFO" | translate}}',"user",!0,!1);this.$messageBusService.publish("rightpanel","activate",t)},t.prototype.validateUser=function(e,t){var r=this;_.isFunction(this.validate)&&!this.isValidating&&(this.isValidating=!0,this.validate(e,t,function(e,t){r.isValidating=!1,r.loggedIn=e,r.loggedIn||r.$messageBusService.notify("Login Result","Login Failed")}))},t.prototype.logoutUser=function(){this.loggedIn=!1,_.isFunction(this.logout)&&this.logout()},t.$inject=["localStorageService","$timeout","messageBusService"],t}();t.ProfileService=r;var i="csComp";try{t.myModule=angular.module(i)}catch(a){t.myModule=angular.module(i,[])}t.myModule.service("profileService",e.Services.ProfileService)}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(e,t){this.$scope=e,this.$mapService=t,e.vm=this,e.location=new L.LatLng(0,0)}return e.prototype.doSearch=function(){if(0===this.$scope.location.lat&&0===this.$scope.location.lng)alert("Directive did not update the location property in parent controller.");else{var e=new L.LatLng(this.$scope.location.lat,this.$scope.location.lng);this.$mapService.zoomToLocation(e)}},e.$inject=["$scope","mapService"],e}();e.SearchFormCtrl=t}(t=e.Search||(e.Search={}))}(csComp||(csComp={}));var Dashboard;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("feature",["$interpolate",function(e){return{restrict:"A",priority:Number.MAX_VALUE,link:function(e,t,r){if(r.hasOwnProperty("feature")){var i=r.feature;"mca"===i&&t.hide()}}}}]),e.myModule.directive("whenReady",["$interpolate",function(e){return{restrict:"A",priority:Number.MIN_VALUE,link:function(t,r,i){function a(e){e.forEach(function(e){t.$eval(e)})}var o=i.whenReady.split(";"),s=!1,n=!1;0!==i.whenReady.trim().length&&(i.waitForInterpolation&&t.$eval(i.waitForInterpolation)&&(s=!0),i.readyCheck&&(n=!0),s||n?requestAnimationFrame(function c(){var l=!1,p=!1;l=!(s&&r.text().indexOf(e.startSymbol())>=0),p=!n||t.$eval(i.readyCheck),l&&p?a(o):requestAnimationFrame(c)}):a(o))}}}]),e.myModule.directive("dashboardirective",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{container:"="},templateUrl:"directives/DashboardDirectives/Dashboard/Dashboard.tpl.html",link:function(e,r,i){angular.element(t).bind("resize",function(){e.$apply()}),e.container=i.container,e.initDashboard()},replace:!1,transclude:!0,controller:e.DashboardCtrl}}])}(Dashboard||(Dashboard={}));var Dashboard;!function(e){var t=function(){function e(e,t,r,i,a,o,s,n){var c=this;this.$scope=e,this.$compile=t,this.$layerService=r,this.$mapService=i,this.$messageBusService=a,this.$dashboardService=o,this.$templateCache=s,this.$timeout=n,e.vm=this,a.subscribe("project",function(t,r){"loaded"===t&&(e.dashboard=null)}),e.initDashboard=function(){a.subscribe("dashboard-main",function(t,i){switch(c.project=r.project,c.project.activeDashboard&&c.closeDashboard(),c.project.activeDashboard=i,t){case"activated":e.dashboard=i,c.updateDashboard()}}),c.$messageBusService.subscribe("expertMode",function(e,t){"newExpertise"===e&&setTimeout(function(){if(c.project&&c.project.activeDashboard){var e=c.project.activeDashboard;!c.$mapService.isIntermediate||e.hasOwnProperty("showTimeline")&&e.showTimeline!==!0?c.$messageBusService.publish("timeline","isEnabled",!1):c.$messageBusService.publish("timeline","isEnabled",!0)}},50)})}}return e.prototype.closeDashboard=function(){this.project.activeDashboard.widgets.forEach(function(e){if(e.stop)e.stop();else if(e.elementId)try{var t=document.getElementById(e.elementId),r=angular.element(t.children[0].children[0]).scope();r&&r.vm&&r.vm.stop&&r.vm.stop()}catch(i){}})},e.prototype.updateWidgetPosition=function(e){if(e._isFullscreen){var t=$("#dashboard-main");e._top="10px",e._bottom="10px",e._width=t.width()-20+"px",e._height=t.height()-20+"px",e._left="10px",e._right="10px",e._zindex="100"}else e._width=e.width,e._height=e.height,e._top=e.top,e._bottom=e.bottom,e._left=e.left,e._right=e.right,e._zindex="1"},e.prototype.toggleWidget=function(e){e.canCollapse&&(e.collapse=!e.collapse)},e.prototype.getOptions=function(e){var t=this,r=[];e._ctrl&&e._ctrl.getOptions&&e._ctrl.getOptions().forEach(function(e){return r.push(e)}),this.$mapService.isAdminExpert&&(r.push({title:"Widget Settings",action:function(e){return t.$dashboardService.editWidget(e)}}),"dashboard"===e.position&&(e._interaction?r.push({title:"Disable drag",action:function(e){return t.toggleInteract(e)}}):r.push({title:"Enable drag",action:function(e){return t.toggleInteract(e)}}))),e.allowFullscreen&&(e._isFullscreen?r.push({title:"Minimize",action:function(e){t.$layerService.project.activeDashboard._fullScreenWidget=null,e._isFullscreen=!1,e._initialized=!1,t.updateWidget(e)}}):r.push({title:"Fullscreen",action:function(e){t.$layerService.project.activeDashboard._fullScreenWidget=e,e._isFullscreen=!0,e._initialized=!1,t.updateWidget(e)}})),e._options=r},e.prototype.triggerOption=function(e,t){_.isFunction(e.action)&&e.action(t)},e.prototype.updateWidget=function(e){if(!e._initialized||!this.$scope.dashboard._initialized){e._initialized=!0;var t,r=this.$scope;if(r.widget=e,"rightpanel"===e.position){var i=csComp.Helpers.createRightPanelTab(e.id,e.directive,e.data,e.title,'{{"FEATURE_INFO" | translate}}',e.icon,!0,!1);i.open=!1,this.$messageBusService.publish("rightpanel","activate",i)}else t=e.template?this.$compile(this.$templateCache.get(e.template))(r):e.url?this.$compile("<div>url</div>")(this.$scope):e.directive?this.$compile("<"+e.directive+"></"+e.directive+">")(r):this.$compile("<div></div>")(this.$scope);if(this.getOptions(e),t){this.updateWidgetPosition(e);var a=$("#"+e.elementId);a.empty(),a.append(t)}"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()}},e.prototype.toggleInteract=function(e){e._interaction=!e._interaction,e._interaction?interact("#"+e.elementId+"-parent").draggable(!0):interact("#"+e.elementId+"-parent").draggable(!1)},e.prototype.checkMap=function(){if(this.$scope.dashboard.showMap!==this.$layerService.visual.mapVisible&&(this.$scope.dashboard.showMap?this.$layerService.visual.mapVisible=!0:this.$layerService.visual.mapVisible=!1,"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()),this.$layerService.visual.mapVisible&&this.$scope.dashboard.mapWidth&&(this.$layerService.visual.mapWidth=this.$scope.dashboard.mapWidth,this.$scope.dashboard.alignMapRight?this.$layerService.visual.alignMapRight=!0:this.$layerService.visual.alignMapRight=!1),this.$scope.dashboard.viewBounds&&(console.log("set bound"),this.$layerService.activeMapRenderer.fitBounds(this.$scope.dashboard.viewBounds)),this.$scope.dashboard.showMap&&this.$scope.dashboard.baselayer){var e=this.$layerService.$mapService.getBaselayer(this.$scope.dashboard.baselayer);this.$layerService.activeMapRenderer.changeBaseLayer(e),this.$layerService.$mapService.changeBaseLayer(this.$scope.dashboard.baselayer)}},e.prototype.checkDescription=function(){var e=this.$layerService.project.activeDashboard;if(e.description){var t=csComp.Helpers.createRightPanelTab("headerinfo","infowidget",{title:e.name,mdText:e.description},"Selected feature",'{{"FEATURE_INFO" | translate}}',"question",!0,!1);this.$messageBusService.publish("rightpanel","activate",t)}},e.prototype.checkLayers=function(){var e=this,t=this.$layerService.project.activeDashboard;t.visiblelayers&&t.visiblelayers.length>0&&this.$layerService.project.groups&&this.$layerService.project.groups.forEach(function(r){r.layers.forEach(function(r){r.enabled&&-1===t.visiblelayers.indexOf(r.reference)&&(e.$layerService.removeLayer(r),r.enabled=!1),!r.enabled&&t.visiblelayers.indexOf(r.reference)>=0&&(e.$layerService.addLayer(r),r.enabled=!0)})})},e.prototype.checkViewbound=function(){this.project.activeDashboard&&this.project.activeDashboard.viewBounds&&this.$layerService.activeMapRenderer.fitBounds(this.project.activeDashboard.viewBounds)},e.prototype.checkTimeline=function(){var e=this.$scope.dashboard;if(e.showTimeline!==this.$mapService.timelineVisible&&(this.$mapService.timelineVisible=e.showTimeline&&this.$mapService.isIntermediate,"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$root.$apply()),e.showTimeline&&(e.timeline||this.project.timeLine)){var t=e.timeline?e.timeline:this.project.timeLine;if(!_.isUndefined(t.fixedRange))switch(t.fixedRange){case"24h":t.end=Date.now(),t.start=Date.now()-144e4}if(this.$messageBusService.publish("timeline","updateTimerange",t),t.focus&&t.start&&t.end&&t.focus>t.start&&t.focus<t.end){var r=(t.focus-t.start)/(t.end-t.start),i=$("#map").width(),a=r*i-$("#focustimeContainer").width()/2;$("#focustimeContainer").css("left",a)}t.isExpanded&&(t.enableEvents=!0)}},e.prototype.setValue=function(e,t){if(!t||t.indexOf("%")>=0)return t;var r=parseInt(t.replace("px",""),10);return r+=e,r+"px"},e.prototype.removeWidget=function(e){this.$scope.dashboard.widgets=this.$scope.dashboard.widgets.filter(function(t){return t!==e})},e.prototype.isReady=function(e){var t=this;setTimeout(function(){e._ijs||(e._ijs=interact("#"+e.elementId+"-parent").resizable({inertia:!0}).on("down",function(t){e._interaction&&(e._isMoving=!0)}).on("up",function(t){return e._isMoving=!1}).on("dragmove",function(r){e.left||!e.left&&""!==e.left?(e.left=t.setValue(r.dx,e.left),e.width&&""!==e.width?e.right="":e.right=t.setValue(-r.dx,e.right)):(e.right&&""!==e.right||(e.right="1000px"),e.right=t.setValue(-r.dx,e.right)),e.top&&""!==e.top?(e.top=t.setValue(r.dy,e.top),e.bottom&&(e.height?e.bottom="":e.bottom=t.setValue(-r.dy,e.bottom))):e.bottom=t.setValue(-r.dy,e.bottom),"$apply"!==t.$scope.$root.$$phase&&"$digest"!==t.$scope.$root.$$phase&&t.$scope.$apply()}).on("resizemove",function(r){e.height=t.setValue(r.dy,e.height),e.left&&e.right?e.right=t.setValue(-r.dx,e.right):(e.width||(e.width="300px"),e.width=t.setValue(r.dx,e.width)),"$apply"!==t.$scope.$root.$$phase&&"$digest"!==t.$scope.$root.$$phase&&t.$scope.$apply()}))},10)},e.prototype.checkLegend=function(e){if(e.showLegend){var t=!1;if(e.widgets.forEach(function(e){"Legend"===e.id&&(t=!0)}),!t){var r={};r.directive="legend-directive",r.id=csComp.Helpers.getGuid(),r.elementId="widget-"+r.id,r.parentDashboard=e,r.title="Legend",r.data={mode:"lastSelectedStyle"},r.left="20px",r.customStyle={background:"White",borderColor:"Black",borderWidth:"1px"},r.top="80px",r.hideIfLeftPanel=!0,r.width="",r.enabled=!0,e.widgets.push(r)}}},e.prototype.updateDashboard=function(){var e=this,t=this.$scope.dashboard;t&&(this.checkLegend(t),this.checkMap(),this.checkTimeline(),this.checkLayers(),this.checkViewbound(),this.checkDescription(),t._initialized||(this.$layerService.visual.leftPanelVisible=t.showLeftmenu,this.$layerService.visual.rightPanelVisible=t.showRightmenu),this.$timeout(function(){t.widgets.forEach(function(t){t._initialized=!1,e.updateWidget(t)}),t._initialized=!0},500),"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply())},e.$inject=["$scope","$compile","layerService","mapService","messageBusService","dashboardService","$templateCache","$timeout"],e}();e.DashboardCtrl=t}(Dashboard||(Dashboard={}));var DashboarHeaderdSelection;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("dashboardHeaderSelection",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/DashboardDirectives/DashboardSelection/DashboardHeaderSelection.tpl.html",replace:!0,transclude:!0,controller:e.DashboardHeaderSelectionCtrl}}])}(DashboarHeaderdSelection||(DashboarHeaderdSelection={}));var DashboarHeaderdSelection;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.$layerService=t,this.$dashboardService=r,this.$mapService=i,this.$messageBusService=a,e.vm=this}return e.prototype.childDashboards=function(e){var t=this.$layerService.project.dashboards.filter(function(t){return t.parents&&t.parents.indexOf(e.id)>-1});return t},e.$inject=["$scope","layerService","dashboardService","mapService","messageBusService"],e}();e.DashboardHeaderSelectionCtrl=t}(DashboarHeaderdSelection||(DashboarHeaderdSelection={}));var DashboardSelection;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("dashboardSelection",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/DashboardDirectives/DashboardSelection/DashboardSelection.tpl.html",link:function(e,r,i){e.onResizeFunction=function(){var r=50,i=100,a=60;e.numberOfItems=Math.floor((t.innerHeight-r-i)/a)},e.onResizeFunction(),angular.element(t).bind("resize",function(){e.onResizeFunction(),e.$apply()})},replace:!0,transclude:!0,controller:e.DashboardSelectionCtrl}}]).directive("bsPopover",function(){return function(e,t,r){t.find("a[rel=popover]").popover({placement:"right",html:"true"})}})}(DashboardSelection||(DashboardSelection={}));var DashboardSelection;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$dashboardService=r,this.$mapService=i,this.$messageBusService=a,e.vm=this,this.$messageBusService.subscribe("project",function(e,t){o.style="default",o.selectStyle()})}return e.prototype.initDrag=function(e){var t,r,i=this;interact("#widgettype-"+e).draggable({max:1/0}).on("dragstart",function(e){t=0,r=0,e.interaction.x=parseInt(e.target.getAttribute("data-x"),10)||0,e.interaction.y=parseInt(e.target.getAttribute("data-y"),10)||0,e.target.style.width="300px",e.target.style.height="300px"}).on("dragmove",function(e){e.interaction.x+=e.dx,e.interaction.y+=e.dy,e.target.style.left=e.interaction.x+"px",e.target.style.top=e.interaction.y+"px"}).on("dragend",function(t){setTimeout(function(){var r={};r.directive=e,r.id=csComp.Helpers.getGuid(),r.left=t.clientX-350+"px",r.top=t.clientY-50+"px",r.data={},r.width="300px",r.height="300px",r.style=i.style,r.enabled=!0,csComp.Services.Dashboard.addNewWidget(r,i.$layerService.project.activeDashboard,i.$layerService.solution),i.$dashboardService.editWidget(r)},100),t.target.setAttribute("data-x",0),t.target.setAttribute("data-y",0),t.target.style.left="0px",t.target.style.top="0px",t.target.style.width="75px",t.target.style.height="75px"})},e.prototype.startWidgetEdit=function(e){this.$dashboardService.editWidget(e)},e.prototype.startDashboardEdit=function(e){var t=new csComp.Services.RightPanelTab;t.container="dashboard",t.data=e,t.directive="dashboardedit",this.$messageBusService.publish("rightpanel","activate",t),this.$layerService.project.dashboards.forEach(function(t){t.id!==e.id&&(t.editMode=!1,t.disabled=!0)}),this.$dashboardService.stopEditWidget()},e.prototype.stopDashboardEdit=function(e){this.$layerService.project.dashboards.forEach(function(e){e.disabled=!1,e.editMode=!1}),this.$dashboardService.stopEditWidget()},e.prototype.stopEdit=function(){this.stopDashboardEdit(this.$layerService.project.activeDashboard)},e.prototype.startEdit=function(){},e.prototype.widgetHighlight=function(e){e.hover=!0},e.prototype.widgetStopHighlight=function(e){e.hover=!1},e.prototype.addDashboard=function(e){var t=new csComp.Services.Dashboard;t.id=csComp.Helpers.getGuid(),t.showLeftmenu=!0,t.showMap=!0,t.name="New Dashboard",this.$layerService.project.dashboards.push(t)},e.prototype.removeDashboard=function(e){this.$layerService.project.dashboards=this.$layerService.project.dashboards.filter(function(t){return t.id!==e})},e.prototype.selectStyle=function(){this.$scope.widgetStyle=this.$layerService.solution.widgetStyles[this.style],console.log(this.$scope.widgetStyle)},e.prototype.publishDashboardUpdate=function(){this.$messageBusService.publish("dashboard","onDashboardSelected",this.$layerService.project.activeDashboard)},e.prototype.selectDashboard=function(e){var t=this;for(var r in this.$layerService.project.dashboards)this.$layerService.project.dashboards[r].editMode=!1;e&&("$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply(),setTimeout(function(){t.publishDashboardUpdate()},100))},e.$inject=["$scope","layerService","dashboardService","mapService","messageBusService"],e}();e.DashboardSelectionCtrl=t}(DashboardSelection||(DashboardSelection={}));var Search;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("searchHeader",["$window","$compile",function(t,r){return{terminal:!1,restrict:"E",scope:{container:"="},templateUrl:"directives/DashboardDirectives/Search/Search.tpl.html",link:function(e,t,r){},replace:!1,transclude:!0,controller:e.SearchCtrl}}])}(Search||(Search={}));var Search;!function(e){var t=function(){function e(e,t,r,i,a,o,s,n){var c=this;this.$scope=e,this.$compile=t,this.$layerService=r,this.$mapService=i,this.$messageBusService=a,this.$dashboardService=o,this.$templateCache=s,this.$timeout=n,e.vm=this,e.$watch("vm.query",_.throttle(function(e){c.$dashboardService.search={query:e}},700,{leading:!1})),this.$messageBusService.subscribe("search",function(e,t){switch(e){case"reset":c.closeSearch()}})}return e.prototype.startSearch=function(){this.$scope.sv&&setTimeout(function(){$("#searchInput").focus()},100)},e.prototype.closeSearch=function(){var e=this;this.$timeout(function(){$("#searchInput").val(""),e.$scope.sv=!1},0)},e.prototype.selectFirst=function(){this.$messageBusService.publish("search","selectFirstResult")},e.$inject=["$scope","$compile","layerService","mapService","messageBusService","dashboardService","$templateCache","$timeout"],e}();e.SearchCtrl=t}(Search||(Search={}));var DashboardEdit;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("dashboardedit",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/DashboardDirectives/WidgetEdit/DashboardEdit.tpl.html",replace:!0,transclude:!0,controller:e.DashboardEditCtrl}}])}(DashboardEdit||(DashboardEdit={}));var DashboardEdit;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.$mapService=t,this.$layerService=r,this.$messageBusService=i,this.$dashboardService=a,this.scope=e,e.vm=this,this.dashboard=e.$parent.data,this.dashboard.parents&&this.dashboard.parents.length>0&&(this.parent=this.dashboard.parents[0]),this.updateHasParent(),console.log(this.$dashboardService.widgetTypes)}return e.prototype.updateHasParent=function(){},e.prototype.toggleTimeline=function(){this.checkTimeline(),this.$layerService.project.dashboards},e.prototype.toggleLegend=function(){this.checkLegend(),this.$layerService.project.dashboards},e.prototype.setExtent=function(){this.dashboard.viewBounds=this.$layerService.activeMapRenderer.getExtent(),console.log("set extent")},e.prototype.setVisibleLayers=function(){this.dashboard.visiblelayers=[];for(var e in this.$layerService.loadedLayers)this.dashboard.visiblelayers.push(e)},e.prototype.setBaseLayer=function(){this.dashboard.baselayer=this.$mapService.activeBaseLayerId},e.prototype.toggleMap=function(){var e=this;setTimeout(function(){e.checkMap()},100)},e.prototype.checkMap=function(){var e=this.$layerService.project.activeDashboard;if(e.showMap!==this.$layerService.visual.mapVisible&&(e.showMap?this.$layerService.visual.mapVisible=!0:this.$layerService.visual.mapVisible=!1,"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()),e.showMap&&this.dashboard.baselayer){var t=this.$layerService.$mapService.getBaselayer(this.dashboard.baselayer);this.$layerService.activeMapRenderer.changeBaseLayer(t),this.$layerService.$mapService.changeBaseLayer(this.dashboard.baselayer),this.$layerService.$mapService.changeBaseLayer(this.dashboard.baselayer)}},e.prototype.checkTimeline=function(){},e.prototype.checkLegend=function(){var e=this.$layerService.project.activeDashboard;if(!e.showLegend){var t=-1;e.widgets.forEach(function(e,r){"legend"===e.id&&(t=r)}),t>-1&&e.widgets.splice(t,1)}this.$dashboardService.selectDashboard(e,"main"),"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},e.$inject=["$scope","mapService","layerService","messageBusService","dashboardService"],e}();e.DashboardEditCtrl=t}(DashboardEdit||(DashboardEdit={}));var WidgetEdit;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("widgetedit",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/DashboardDirectives/WidgetEdit/WidgetEdit.tpl.html",replace:!0,transclude:!0,controller:e.WidgetEditCtrl}}])}(WidgetEdit||(WidgetEdit={}));var WidgetEdit;!function(e){var t=function(){function e(e,t,r,i,a){this.$scope=e,this.mapService=t,this.layerService=r,this.messageBusService=i,this.dashboardService=a,this.scope=e,e.vm=this,e.widget=a.activeWidget}return e.prototype.selectStyle=function(){var e=this.$scope.widget.style;"custom"===e?(this.$scope.widget.customStyle=JSON.parse(JSON.stringify(this.$scope.widget.effectiveStyle)),this.$scope.widget.effectiveStyle=this.$scope.widget.customStyle):(this.$scope.widget.effectiveStyle=this.layerService.solution.widgetStyles[e],this.$scope.widget.customStyle=null)},e.prototype.removeWidget=function(e){e.parentDashboard.widgets=e.parentDashboard.widgets.filter(function(t){return e.id!=t.id}),this.dashboardService.deactivateTabContainer("widget-content"),this.dashboardService.deactivateTabContainer("widget")},e.$inject=["$scope","mapService","layerService","messageBusService","dashboardService"],e}();e.WidgetEditCtrl=t}(WidgetEdit||(WidgetEdit={}));var FeatureTypeEditor;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featureTypeEditor",["$compile",function(t){return{terminal:!1,restrict:"E",scope:{featureTypeId:"="},templateUrl:"directives/Editors/FeatureTypeEditor/FeatureTypeEditor.tpl.html",replace:!0,transclude:!0,controller:e.FeatureTypeEditorCtrl}}]).directive("errSrc",function(){return{link:function(e,t,r){t.bind("error",function(){r.src!=r.errSrc&&r.$set("src",r.errSrc)})}}})}(FeatureTypeEditor||(FeatureTypeEditor={}));var FeatureTypeEditor;!function(e){var t=function(){function e(e,t,r){
this.$scope=e,this.$layerService=t,this.$messageBusService=r,this.$scope.vm=this,this.$scope.$parent.$parent.vm.hasOwnProperty("selectedFeatureType")?e.featureType=this.$scope.$parent.$parent.vm.selectedFeatureType:this.$scope.$root.hasOwnProperty("data")?e.featureType=e.$root.data:console.log("no feature type")}return e.prototype.updateFeatureTypes=function(e){_.isUndefined(e._resource)||this.$layerService.saveResource(e._resource),console.log("updating .."),this.$layerService.updateFeatureTypes(e)},e.prototype.apply=function(){this.$layerService.updateFeatureTypes(this.$scope.featureType)},e.prototype.cancel=function(){this.$messageBusService.publish("featuretype","stopEditing")},e.prototype.saveFeatureType=function(){this.$scope.featureType._isInitialized||(this.$scope.featureType.id=this.$scope.featureType.name,this.$layerService.initFeatureType(this.$scope.featureType,null),this.$scope.featureType._resource.featureTypes[this.$scope.featureType.id]=this.$scope.featureType),this.$layerService.saveResource(this.$scope.featureType._resource),this.$layerService.updateFeatureTypes(this.$scope.featureType),this.$messageBusService.publish("featuretype","stopEditing")},e.$inject=["$scope","layerService","messageBusService"],e}();e.FeatureTypeEditorCtrl=t}(FeatureTypeEditor||(FeatureTypeEditor={}));var FeatureTypes;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("featuretypes",["$compile",function(t){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/Editors/FeatureTypeEditor/FeatureTypes.tpl.html",replace:!0,transclude:!0,controller:e.FeatureTypesCtrl}}]).directive("errSrc",function(){return{link:function(e,t,r){t.bind("error",function(){r.src!=r.errSrc&&r.$set("src",r.errSrc)})}}})}(FeatureTypes||(FeatureTypes={}));var FeatureTypes;!function(e){var t=function(){function e(e,t,r){this.$scope=e,this.$layerService=t,this.$messageBusService=r,this.$scope.vm=this,this.$scope.$root.hasOwnProperty("data")&&(e.data=e.$root.data,this.selectedResourceUrl=e.data.layer.typeUrl,this.selectResource()),console.log(this.$scope)}return e.prototype.updateFeatureTypes=function(e){this.$layerService.updateFeatureTypes(e)},e.prototype.selectResource=function(){this.$layerService.typesResources.hasOwnProperty(this.selectedResourceUrl)&&(this.selectedResource=this.$layerService.typesResources[this.selectedResourceUrl])},e.$inject=["$scope","layerService","messageBusService"],e}();e.FeatureTypesCtrl=t}(FeatureTypes||(FeatureTypes={}));var GroupEdit;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("groupedit",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Editors/GroupEditor/GroupEdit.tpl.html",replace:!0,transclude:!0,controller:e.GroupEditCtrl}}])}(GroupEdit||(GroupEdit={}));var GroupEdit;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$mapService=t,this.$layerService=r,this.$messageBusService=i,this.$dashboardService=a,this.noLayerSelected=!0,this.scope=e,e.vm=this,e.group=e.$parent.data,console.log(e.group),this.updateLayers(),this.$messageBusService.subscribe("layer",function(){o.updateLayers()})}return e.prototype.updateLayers=function(){this.noLayerSelected=this.$scope.group.layers.some(function(e){return e.enabled})},e.prototype.removeGroup=function(){this.$layerService.removeGroup(this.$scope.group)},e.prototype.toggleClustering=function(){console.log("toggle clustering")},e.prototype.updateOws=function(){this.$scope.group.loadLayersFromOWS()},e.$inject=["$scope","mapService","layerService","messageBusService","dashboardService"],e}();e.GroupEditCtrl=t}(GroupEdit||(GroupEdit={}));var LayerEdit;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("layeredit",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Editors/LayerEditor/LayerEdit.tpl.html",replace:!1,transclude:!0,controller:e.LayerEditCtrl}}])}(LayerEdit||(LayerEdit={}));var LayerEdit;!function(e){var t=function(){function e(e,t,r,i,a,o){this.$scope=e,this.$http=t,this.$mapService=r,this.$layerService=i,this.$messageBusService=a,this.$dashboardService=o,this.scope=e,e.vm=this,this.layer=e.$parent.data,this.getTypes()}return e.prototype.addLayer=function(){},e.prototype.removeLayer=function(){this.$layerService.removeLayer(this.layer,!0)},e.prototype.addFeatureType=function(){var e=this;this.layer.typeUrl&&this.$layerService.loadTypeResources(this.layer.typeUrl,this.layer.dynamicResource||!1,function(){if(e.$layerService.typesResources.hasOwnProperty(e.layer.typeUrl)){var t=e.$layerService.typesResources[e.layer.typeUrl],r={},i=e.layer.typeUrl+"#"+e.layer.defaultFeatureType;if(r.id=e.layer.defaultFeatureType,r.name=r.id,r.style=csComp.Helpers.getDefaultFeatureStyle(null),!t.featureTypes.hasOwnProperty(i)){var r={};r.id=e.layer.defaultFeatureType,r.name=r.id,e.$layerService._featureTypes[i]=r,t.featureTypes[r.id]=r}}})},e.prototype.getTypes=function(){var e=this;console.log("its me babe"),this.$http.get(this.layer.typeUrl).success(function(t){setTimeout(function(){e.availabeTypes=t.featureTypes,console.log(e.availabeTypes)},0)}).error(function(){console.log("LayerEditCtl: error with $http")})},e.$inject=["$scope","$http","mapService","layerService","messageBusService","dashboardService"],e}();e.LayerEditCtrl=t}(LayerEdit||(LayerEdit={}));var LayerEditor;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("layereditor",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{view:"@",layer:"="},templateUrl:"directives/Editors/LayerEditor/LayerEditor.tpl.html",replace:!1,transclude:!0,controller:e.LayerEditorCtrl}}])}(LayerEditor||(LayerEditor={}));var LayerEditor;!function(e){var t=function(){function e(e,t,r,i,a,o){this.$scope=e,this.$http=t,this.$mapService=r,this.$layerService=i,this.$messageBusService=a,this.$dashboardService=o,this.scope=e,e.vm=this,this.scope.layer?this.layer=this.scope.layer:e.$parent.hasOwnProperty("b")?this.layer=e.$parent.b._layer:e.$parent.$parent.hasOwnProperty("vm")&&(this.layer=e.$parent.$parent.vm.layer)}return e.prototype.startDraw=function(e,t){t&&t.stopPropagation(),this.$mapService.startDraw(this.layer,e)},e.prototype.initDrag=function(e,t){var r=this,i=this.$layerService.findResourceByLayer(t);interact("#layerfeaturetype-"+i.featureTypes[e]._guid).draggable({onmove:function(e){var t=e.target,r=(parseFloat(t.getAttribute("data-x"))||0)+e.dx,i=(parseFloat(t.getAttribute("data-y"))||0)+e.dy;t.style.webkitTransform=t.style.transform="translate("+r+"px, "+i+"px)",t.setAttribute("data-x",r),t.setAttribute("data-y",i)},onend:function(a){console.log("Draggable: ",a),setTimeout(function(){var o=a.clientX,s=a.clientY,n=r.$layerService.activeMapRenderer.getLatLon(o,s);console.log(n);var c=new csComp.Services.Feature;c.layerId=t.id,c.geometry={type:"Point",coordinates:[n.lon,n.lat]},c.properties={featureTypeId:e,Name:l};var l="new object";if(i.featureTypes.hasOwnProperty(e)){var p=i.featureTypes[e];if(p._isInitialized||r.$layerService.initFeatureType(p,i),_.isArray(p._propertyTypeData))for(var u in p._propertyTypeData){p._propertyTypeData[u];p._propertyTypeData.forEach(function(e){c.properties[e.label]=_.isUndefined(e.defaultValue)?"":e.defaultValue})}l=p.name}t.data.features.push(c),r.$messageBusService.publish("feature","dropped",c),r.$layerService.initFeature(c,t),r.$layerService.activeMapRenderer.addFeature(c),r.$layerService.saveFeature(c),r.$layerService.editFeature(c,!0)},10),$(a.target).remove()}}).on("move",function(e){var t=e.interaction;if(t.pointerIsDown&&!t.interacting()&&e.currentTarget.classList.contains("drag-element-source")){var r=(e.target,{left:0,top:0}),i=e.currentTarget.cloneNode(!0);i.className=i.className.replace(/\bdrag-element-source\b/,""),r.left=e.clientX-20,r.top=e.clientY-20,$(i).css("left",r.left),$(i).css("top",r.top),$(i).css("z-index",1e3),$(document.body).append(i),t.start({name:"drag"},e.interactable,i)}else t.start({name:"drag"},e.interactable,e.currentTarget)})},e.prototype.deleteFeaturetype=function(e){var t=this;this.$messageBusService.confirm("Delete type","Are you sure?",function(r){if(r){var i=t.$layerService.findResourceByLayer(t.layer);if(i){for(var a in i.featureTypes)i.featureTypes[a].id!==i.url+"#"+e.id&&i.featureTypes[a].id!==e.id||delete i.featureTypes[a];t.$layerService.saveResource(i),t.$messageBusService.publish("featuretype","stopEditing",e)}}})},e.prototype.editFeaturetype=function(e){this.$messageBusService.publish("featuretype","startEditing",e)},e.$inject=["$scope","$http","mapService","layerService","messageBusService","dashboardService"],e}();e.LayerEditorCtrl=t}(LayerEditor||(LayerEditor={}));var LayerSettings;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("layersettings",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Editors/LayerEditor/LayerSettings.tpl.html",replace:!1,transclude:!0,controller:e.LayerSettingsCtrl}}])}(LayerSettings||(LayerSettings={}));var LayerSettings;!function(e){var t=function(){function e(e,t,r,i,a,o){this.$scope=e,this.$http=t,this.$mapService=r,this.$layerService=i,this.$messageBusService=a,this.$dashboardService=o,this.scope=e,e.vm=this,this.layer=e.$parent.data,this.getTypes()}return e.prototype.saveLayer=function(){this.$layerService.saveProject()},e.prototype.removeLayer=function(){this.$layerService.removeLayer(this.layer,!0)},e.prototype.addFeatureType=function(){var e=this;this.layer.typeUrl&&this.$layerService.loadTypeResources(this.layer.typeUrl,this.layer.dynamicResource||!1,function(){if(e.$layerService.typesResources.hasOwnProperty(e.layer.typeUrl)){var t=e.$layerService.typesResources[e.layer.typeUrl],r={},i=e.layer.typeUrl+"#"+e.layer.defaultFeatureType;if(r.id=e.layer.defaultFeatureType,r.name=r.id,r.style=csComp.Helpers.getDefaultFeatureStyle(null),!t.featureTypes.hasOwnProperty(i)){var r={};r.id=e.layer.defaultFeatureType,r.name=r.id,r.style={},r.style.drawingMode="Point",e.$layerService._featureTypes[i]=r,t.featureTypes[r.id]=r}}})},e.prototype.getTypes=function(){var e=this;this.$http.get(this.layer.typeUrl).success(function(t){setTimeout(function(){e.availabeTypes=t.featureTypes,"$apply"!==e.$scope.$root.$$phase&&"$digest"!==e.$scope.$root.$$phase&&e.$scope.$apply()},0)}).error(function(){console.log("LayerEditCtl.getTypes: error with $http")})},e.$inject=["$scope","$http","mapService","layerService","messageBusService","dashboardService"],e}();e.LayerSettingsCtrl=t}(LayerSettings||(LayerSettings={}));var PropertyTypes;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("propertytypes",["$compile",function(t){return{terminal:!1,restrict:"E",scope:{},templateUrl:"directives/Editors/PropertyTypeEditor/PropertyTypes.tpl.html",replace:!0,transclude:!0,controller:e.PropertyTypesCtrl}}]).directive("ngEnter",function(){return function(e,t,r){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(r.ngEnter)}),t.preventDefault())})}})}(PropertyTypes||(PropertyTypes={}));var PropertyTypes;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBusService=r,this.editModeMessageReceived=function(e){switch(e){case"enable":i.$messageBusService.publish("sidebar","showEdit"),i.$scope.vm=i,i.$scope.propertyTypes=i.$layerService.project.propertyTypeData;break;case"disable":i.$messageBusService.publish("sidebar","hideEdit")}"$apply"!==i.$scope.$root.$$phase&&"$digest"!==i.$scope.$root.$$phase&&i.$scope.$apply()},this.sidebarMessageReceived=function(e){switch(e){case"toggle":i.$scope.showMenu=!i.$scope.showMenu;break;case"show":i.$scope.showMenu=!0;break;case"showEdit":i.$scope.showMenuEdit=!0;break;case"hide":i.$scope.showMenu=!1;break;case"hideEdit":i.$scope.showMenuEdit=!1}"$apply"!=i.$scope.$root.$$phase&&"$digest"!=i.$scope.$root.$$phase&&i.$scope.$apply()},console.log("prop editor"),this.$scope.vm=this,this.$scope.showMenu=!1,this.$scope.showMenuEdit=!1,"$apply"!=this.$scope.$root.$$phase&&"$digest"!=this.$scope.$root.$$phase&&this.$scope.$apply(),this.$messageBusService.subscribe("editmode",this.editModeMessageReceived),this.$messageBusService.subscribe("sidebar",this.sidebarMessageReceived),e.getSections=function(){var t=i.selectedResource.propertyTypeData,r=new Array;for(var a in t){var o=!0;if(void 0!=t[a].section){0==r.length&&r.push(t[a].section);for(var s in r)t[a].section==r[s]&&(o=!1);o&&r.push(t[a].section)}}e.sections=r},e.addSection=function(t){var r=e.sections,i=!0;for(var a in r)t==r[a]&&(i=!1);i&&e.sections.push(t)},e.filterProperty=function(t){var r=i.selectedResource.propertyTypeData,a=new Array;if(void 0==t){for(var o in r)a.push(r[o]);e.propertyTypes=a}else{var s;void 0!==t.propertyTypeKeys&&(s=t.propertyTypeKeys.split(";"));for(var n in s)for(var c in r)r.hasOwnProperty(c)&&s[n]==r[c].label&&a.push(r[c]);e.propertyTypes=a}}}return e.prototype.selectResource=function(){this.$layerService.typesResources.hasOwnProperty(this.selectedResourceUrl)&&(this.selectedResource=this.$layerService.typesResources[this.selectedResourceUrl])},e.$inject=["$scope","layerService","messageBusService"],e}();e.PropertyTypesCtrl=t}(PropertyTypes||(PropertyTypes={}));var ButtonWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("buttonwidgetEdit",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/ButtonWidget/ButtonWidget-edit.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i){this.$scope=e,this.$timeout=t,this.$messageBus=r,this.$dashboardService=i,e.vm=this,e.methods=[{name:"GET"},{name:"PUT"},{name:"POST"},{name:"DELETE"}];var a=e.$parent;this.widget=a.data,e.data=this.widget.data,e.data.messages?e.selectedMessage=e.data.messages[0]:(e.data.messages=[],this.addMessage())}return e.prototype.addMessage=function(){this.$scope.selectedMessage={name:"New message...",httpMethod:this.$scope.methods[2]},this.$scope.data.messages.push(this.$scope.selectedMessage)},e.prototype.deleteMessage=function(){if(this.$scope.selectedMessage){var e=this.$scope.data.messages.indexOf(this.$scope.selectedMessage);0>e||(this.$scope.data.messages.slice(e,1),0===this.$scope.data.messages.length?this.addMessage():this.$scope.selectedMessage=this.$scope.data.messages[0])}},e.$inject=["$scope","$timeout","messageBusService","dashboardService"],e}();e.ButtonWidgetEditCtrl=i}(ButtonWidget||(ButtonWidget={}));var ButtonWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("buttonwidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/ButtonWidget/ButtonWidget.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$http=t,this.layerService=r,this.messageBusService=i,this.actionService=a,this.$timeout=o,this.$sce=s,this.activeGroups={},this.activeGroupsCollection={},e.vm=this;var c=e.$parent;e.data=c.widget.data,"undefined"==typeof e.data.buttons&&(e.data.buttons=[]),_.isUndefined(e.data.featureLayer)?_.isUndefined(e.data.layerGroup)?(this.$scope.buttons=this.$scope.data.buttons,this.initButtons()):this.initLayerGroup():this.initFeatureLayer(),e.$watchCollection("buttons",function(){n.initButtons()}),this.messageBusService.subscribe("viewmode",function(e,t){var r="";n.$scope.buttons.forEach(function(e){e._active&&e.buttongroup&&(r=e.buttongroup)}),"tag"===e&&(n.$scope.buttons.forEach(function(e){e.buttongroup&&e.tag&&(e._visible=e.tag===t),e._visible&&""!==r&&e.buttongroup===r&&n.click(e)}),console.log(t))})}return e.prototype.initButtons=function(){var e=this;this.$scope.buttons.forEach(function(t){t=csComp.Helpers.translateObject(t,e.layerService.currentLocale);var r=t.action.split(";");t._visible=!0,t.buttongroup&&(e.activeGroups.hasOwnProperty(t.buttongroup)?(e.activeGroups[t.buttongroup]!==t&&(t._visible=!1),e.activeGroupsCollection[t.buttongroup].push(t)):(e.activeGroups[t.buttongroup]=t,e.activeGroupsCollection[t.buttongroup]=[t]),t._groupbuttons=e.activeGroupsCollection[t.buttongroup]),r.forEach(function(r){switch(r.toLowerCase()){case"activate timerange":break;case"activate layer":e.checkLayer(t),e.messageBusService.subscribe("layer",function(r,i){e.checkLayer(t)});break;case"activate style":e.checkStyle(t),e.messageBusService.subscribe("updatelegend",function(r,i){return e.checkStyle(t)});break;case"activate baselayer":e.checkBaselayer(t),e.messageBusService.subscribe("baselayer",function(r,i){return e.checkBaselayer(t)})}}),t.defaultEnabled&&e.click(t)})},e.prototype.initFeatureLayer=function(){var e=this;this.checkFeatureLayer(),this.messageBusService.subscribe("layer",function(t,r){return e.checkFeatureLayer()})},e.prototype.initLayerGroup=function(){var e=this;this.checkLayerGroup(),this.messageBusService.subscribe("layer",function(t,r){return e.checkLayerGroup()})},e.prototype.switchButtonGroup=function(e){console.log(e)},e.prototype.checkFeatureLayer=function(){var e=this;this.$scope.buttons=[];var t=this.layerService.findLayer(this.$scope.data.featureLayer);t&&t.data&&t.data.features&&t.data.features.forEach(function(t){var r={title:csComp.Helpers.getFeatureTitle(t),action:"Activate Feature",description:"Snelheid:",_feature:t,_featureIcon:e.$sce.trustAsHtml(csComp.Helpers.createIconHtml(t).html)};e.$scope.buttons.push(r)})},e.prototype.checkLayerGroup=function(){var e=this,t=this.layerService.findGroupById(this.$scope.data.layerGroup);this.$scope.buttons=[],_.isUndefined(t)||t.layers.forEach(function(t){var r={title:t.title,action:"Activate Layer",layer:t.id,showLegend:!1};e.$scope.buttons.push(r),e.checkLayer(r)})},e.prototype.checkBaselayer=function(e){e._active=this.layerService.$mapService.activeBaseLayerId===e.layer},e.prototype.toggleEditLayer=function(e){var t=this;if(!_.isUndefined(e._layer)){var r=e._layer;r._gui.hasOwnProperty("editing")&&r._gui.editing===!0?(r.layerSource.stopEditing(r),r.data.features.forEach(function(e){delete e._gui.editMode,t.layerService.updateFeature(e),t.layerService.saveFeature(e)})):(r.layerSource.startEditing(r),r.data.features.forEach(function(e){t.layerService.editFeature(e,!1)}))}},e.prototype.updateLegendLabels=function(e){e._legend&&e._legend.legendEntries&&e._legend.legendEntries.length>0&&(e._firstLegendLabel=e._legend.legendEntries[e._legend.legendEntries.length-1].label,e._lastLegendLabel=e._legend.legendEntries[0].label)},e.prototype.checkLayer=function(e){var t=this;e._layer=this.layerService.findLayer(e.layer),e._layer&&(e.showLegend&&(e._layer.defaultLegend?(e._legend=this.layerService.getLayerLegend(e._layer),this.updateLegendLabels(e)):e._layer.group.styles.length>0&&e._layer.group.styles.forEach(function(r){r.activeLegend&&(e._legend=r.activeLegend,t.updateLegendLabels(e))})),_.isUndefined(e.image)&&!_.isUndefined(e._layer.image)&&(e.image=e._layer.image),_.isUndefined(e._layer)?e._disabled=!0:(e._disabled=!1,e._active=e._layer.enabled,e._canEdit=e._layer.enabled&&e._layer.isEditable))},e.prototype.checkStyle=function(e){var t=this.layerService.findGroupById(e.group);if(!t)return void(e._disabled=!0);e._disabled=!1;var r=e.property;if(r.indexOf("#")>-1&&(r=r.split("#")[1]),"undefined"!=typeof t){if(!t.styles)return;var i=t.styles.filter(function(e){return e.property===r});if(0===i.length?e._active=!1:e.layer?e._active=!!this.layerService.findLoadedLayer(e.layer):e._active=!0,e._active&&e.showLegend)e._legend=i[0].activeLegend,e.moreInfo=e._legend.description,this.checkLegend(e);else{var a=this.layerService.findPropertyTypeById(r);a&&a.legend&&(e.moreInfo=a.legend.description),e._legend=null}}},e.prototype.checkLegend=function(e){e._legend&&e._legend.legendEntries.length>0&&("undefined"==typeof e._lastLegendLabel&&(e._lastLegendLabel=e._legend.legendEntries[0].label),"undefined"==typeof e._firstLegendLabel&&(e._firstLegendLabel=e._legend.legendEntries[e._legend.legendEntries.length-1].label))},e.prototype.click=function(e){var t=this,r=e.action.split(";");r.forEach(function(r){t.actionService.execute(r.toLowerCase(),{layerId:e.layer,groupId:e.group,propertyId:e.property,zoomLevel:e.zoomLevel})}),this.$scope.data.toggleMode&&this.$timeout(function(){t.$scope.activeIndex++,t.$scope.activeIndex>=t.$scope.buttons.length&&(t.$scope.activeIndex=0)},0)},e.prototype.toggleFilter=function(e,t,r){var i=this;if(e){var a=this.layerService.findGroupById(t),o=this.layerService.findPropertyTypeById(r),s=a.filters.some(function(e){return e.property===o.label?(i.layerService.removeFilter(e),!0):void 0});if(!s){var n=new csComp.Services.GroupFilter;n.property=r.split("#").pop(),n.id="buttonwidget_filter",n.group=a,n.filterType="row",n.title=o.title,n.rangex=[e.interval.min,e.interval.max],n.filterLabel=e.label,console.log("Setting filter"),this.layerService.rebuildFilters(a),a.filters=a.filters.filter(function(e){return e.id!==n.id}),this.layerService.setFilter(n,a),this.layerService.visual.leftPanelVisible=!0,$("#filter-tab").tab("show")}}},e.$inject=["$scope","$http","layerService","messageBusService","actionService","$timeout","$sce"],e}();e.ButtonWidgetCtrl=i}(ButtonWidget||(ButtonWidget={}));var Agenda;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("agendaEdit",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/Agenda/AgendaWidget-edit.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$http=t,this.layerService=r,this.messageBusService=i,this.$timeout=a,this.layers=[],e.vm=this;var s=e.$parent;if(this.widget=s.widget||s.data,this.widget){e.data=this.widget.data;var n=e.data.selectedLayerId;r.project.groups.forEach(function(e){e.layers.forEach(function(e){o.layers.push(e),e.id===n&&(o.selectedLayer=e)})})}}return e.prototype.update=function(){this.selectedLayer&&(this.widget.data.selectedLayerId=this.selectedLayer.id)},e.$inject=["$scope","$http","layerService","messageBusService","$timeout"],e}();e.AgendaWidgetEditCtrl=i}(Agenda||(Agenda={}));var Agenda;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("agenda",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/Agenda/AgendaWidget.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$http=t,this.layerService=r,this.messageBusService=i,this.$timeout=a,this.agenda=[],e.vm=this;var s=e.$parent;this.widget=s.widget,this.widget?e.data=this.widget.data:e.data=s.data;var n=e.data.selectedLayerId;r.project?this.selectedLayer=r.findLayer(n):i.subscribe("project",function(e){o.selectedLayer=r.findLayer(n)}),i.subscribe("feature",function(e,t){switch(e){case"onFeatureSelect":case"onRelationsUpdated":o.updateAgenda(t);break;case"onFeatureDeselect":o.clearAgenda()}})}return e.prototype.clearAgenda=function(){this.title="",this.agenda.length=0},e.prototype.updateAgenda=function(e){var t=this;if(e&&e._gui){var r=e.fType.eventStyle;if(r&&e._gui.hasOwnProperty("relations")&&e._gui.relations.hasOwnProperty(r.relationName)){this.clearAgenda(),this.title=e.properties.Name;var i=r.title||"Name",a=r.description||"description",o=r.startTime||"startTime",s=r.endTime||"endTime",n=e._gui.relations[r.relationName];n.forEach(function(e){t.agenda.push({title:t.getProperty(e,i),description:t.getProperty(e,a),startTime:t.getProperty(e,o),endTime:t.getProperty(e,s)})})}}},e.prototype.getProperty=function(e,t,r){void 0===r&&(r="");var i=e.properties,a=i.hasOwnProperty(t)?i[t]:r;return e.fType._propertyTypeData.some(function(e){return e.label!==t?!1:(a=csComp.Helpers.convertPropertyInfo(e,a),!0)}),a},e.$inject=["$scope","$http","layerService","messageBusService","$timeout"],e}();e.AgendaWidgetCtrl=i}(Agenda||(Agenda={}));var ChartsWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("chartsEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Charts/Charts-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function e(e,t,r,i,a,o,s,n){this.$scope=e,this.$timeout=t,this.$compile=r,this.$layerService=i,this.$templateCache=a,this.$messageBus=o,this.$mapService=s,this.$dashboardService=n,e.vm=this;var c=e.$parent;this.widget=c.data,e.data=this.widget.data,this.loadChart()}return e.prototype.setupEditor=function(){this.editor=ace.edit("vegaeditor"),this.editor.getSession().setMode("ace/mode/json"),this.editor.setValue(JSON.stringify(this.$scope.data.spec,null,"	")),this.editor.clearSelection(),this.editor.focus()},e.prototype.loadChart=function(){this.$scope.spec=JSON.stringify(this.$scope.data.spec)},e.prototype.updateChart=function(){this.$scope.data.spec=JSON.parse(this.editor.getValue()),this.refreshChart(),this.editor.focus()},e.prototype.refreshChart=function(){var e=this;vg.parse.spec(this.$scope.data.spec,function(t){t({el:"#vis"+e.$scope.data._id}).update()})},e.$inject=["$scope","$timeout","$compile","layerService","$templateCache","messageBusService","mapService","dashboardService"],e}();e.ChartsEditCtrl=i}(ChartsWidget||(ChartsWidget={}));var ChartsWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("charts",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/Charts/Charts.tpl.html",replace:!0,transclude:!1,controller:e.ChartCtrl}}])}(ChartsWidget||(ChartsWidget={}));var ChartsWidget;!function(e){var t=function(){function e(){}return e}();e.ChartData=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,this.$dashboardService=o,this.defaultSpec={width:300,height:200,padding:{top:10,left:30,bottom:30,right:10},data:[{name:"table",values:[{x:1,y:28},{x:2,y:55},{x:3,y:43},{x:4,y:91},{x:5,y:81},{x:6,y:53},{x:7,y:19},{x:8,y:87},{x:9,y:52},{x:10,y:48},{x:11,y:24},{x:12,y:49},{x:13,y:87},{x:14,y:66},{x:15,y:17},{x:16,y:27},{x:17,y:68},{x:18,y:16},{x:19,y:49},{x:20,y:15}]}],scales:[{name:"x",type:"ordinal",range:"width",domain:{data:"table",field:"x"}},{name:"y",type:"linear",range:"height",domain:{data:"table",field:"y"},nice:!0}],axes:[{type:"x",scale:"x"},{type:"y",scale:"y"}],marks:[{type:"rect",from:{data:"table"},properties:{enter:{x:{scale:"x",field:"x"},width:{scale:"x",band:!0,offset:-1},y:{scale:"y",field:"y"},y2:{scale:"y",value:0}},update:{fill:{value:"steelblue"}},hover:{fill:{value:"red"}}}}]},e.vm=this;var n=e.$parent;this.widget=n.widget,this.widget._ctrl=this,e.data=this.widget.data,e.data._id=this.widget.id,$("#"+this.widget.elementId).on("remove",function(){s.generator&&s.generator.stop()})}return e.prototype.startEdit=function(){},e.prototype.goFullscreen=function(){},e.prototype.getOptions=function(){var e=this,t=[];return t.push({title:"Export to image",action:function(t){e.savePng()}}),this.$scope.data._csv&&t.push({title:"Export to csv",action:function(t){var r=new Blob([e.$scope.data._csv],{type:"text/plain;charset=utf-8"});saveAs(r,e.widget.data.title+"_export.csv")}}),t},e.prototype.savePng=function(){var e=this;domtoimage.toPng(document.querySelector("#"+this.widget.elementId)).then(function(t){csComp.Helpers.saveImage(t,e.widget.data.title,"png")})["catch"](function(t){e.$layerService.$messageBusService.notify("Error saving chart","When saving charts, only the latest version of chrome is supported")})},e.prototype.initChart=function(){try{var e=this.$scope.data,t=e._spec||{};if(e.lite&&(t=vl.compile(e._spec)),t){vg.embed("#vis"+e._id,t,function(t,r){e._view=t,e._view.renderer("svg").update()})}}catch(r){}},e.prototype.updateChart=function(){var e=this;try{var t=this.$scope.data,r=t._spec;t.lite&&(r=vl.compile(t._spec)),vg.parse.spec(r,function(t){t({el:"#vis"+e.$scope.data._id,renderer:"svg"}).update()})}catch(i){}},e.prototype.startChart=function(){var e=this,t=this.$scope.data;if(t.generator){if(t.generator.type&&this.$dashboardService.chartGenerators.hasOwnProperty(t.generator.type))return this.generator=this.$dashboardService.chartGenerators[t.generator.type](),void this.generator.start(this)}else t._spec=t.spec||this.defaultSpec,this.initChart(),t.key&&(this.keyHandle=this.$layerService.$messageBusService.serverSubscribe(t.key,"key",function(r,i){switch(i.action){case"key":i.data.item.hasOwnProperty("values")?t._spec.data=i.data.item.values:i.data.item.hasOwnProperty("data")&&(t._spec=i.data.item),e.initChart()}}))},e.$inject=["$scope","$timeout","layerService","messageBusService","mapService","dashboardService"],e}();e.ChartCtrl=r}(ChartsWidget||(ChartsWidget={}));var AreaFilter;!function(e){var t=function(){function e(){this.id="AreaFilterModel"}return e.prototype.stop=function(){},e.prototype.addFeature=function(e){},e.prototype.removeFeature=function(e){},e.prototype.selectFeature=function(e){},e.prototype.addLayer=function(e){},e.prototype.removeLayer=function(e){},e.prototype.getLayerActions=function(e){return null},e.prototype.getFeatureActions=function(e){if(e.geometry.type)switch(e.geometry.type){case"MultiPolygon":case"Polygon":var t={title:"Set as area filter"};t.callback=this.setAsFilter;var r={title:"Reset area filter"};return r.callback=this.resetFilter,[t,r];default:return void console.log("Feature type name: "+e.featureTypeName)}},e.prototype.getFeatureHoverActions=function(e){return[]},e.prototype.deselectFeature=function(e){},e.prototype.updateFeature=function(e){},e.prototype.setAsFilter=function(e,t){if(e.geometry.type)switch(e.geometry.type){case"MultiPolygon":case"Polygon":t.setFeatureAreaFilter(e)}},e.prototype.resetFilter=function(e,t){if(e.geometry.type)switch(e.geometry.type){case"MultiPolygon":case"Polygon":t.resetFeatureAreaFilter()}},e.prototype.init=function(e){console.log("init AreaFilterActionService"),this.layerService=e},e}();e.AreaFilterModel=t}(AreaFilter||(AreaFilter={}));var Filters;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,this.$translate=a,e.vm=this,a("REMOVE").then(function(t){e.removeString=t});var s=e.$parent.$parent;s.hasOwnProperty("filter")&&(e.filter=s.filter),e&&e.filter&&(setTimeout(function(){return o.initAreaFilter()}),e.options=function(){var t=[];return t.push([e.removeString,function(){return o.remove()}]),t})}return e.prototype.setAreaFilter=function(e){"Polygon"===e.geometry.type?this.isInsideFunction=csComp.Helpers.GeoExtensions.pointInsidePolygon:"MultiPolygon"===e.geometry.type?this.isInsideFunction=csComp.Helpers.GeoExtensions.pointInsideMultiPolygon:this.isInsideFunction=function(){return!1}},e.prototype.initAreaFilter=function(){var e=this,t=this.$scope.filter,r=(t.value,t.group),i="filter_"+t.id;this.setAreaFilter(t.value),this.dcChart=dc.pieChart("#"+i),this.$scope.$apply();var a=r.ndx.dimension(function(e){if(e.id&&e.layer&&e.layer.group&&e.layer.group.markers&&e.layer.group.markers.hasOwnProperty(e.id)){var t=e.layer.group.markers[e.id];return t.feature.geometry.coordinates}return null});t.dimension=a,this.helperDim=crossfilter([{title:"inside"},{title:"outside"}]).dimension(function(e){return e.title}),this.helperGroup=this.helperDim.group(function(e){return e}),this.dcChart.width(175).height(200).slicesCap(4).innerRadius(0).dimension(this.helperDim).group(this.helperGroup).legend(dc.legend()).renderLabel(!0).label(function(e){return e.value}).on("renderlet",function(t){
e.updateAreaFilter(e.$scope.filter.value,!1)}),this.updateAreaFilter(this.$scope.filter.value)},e.prototype.updateAreaFilter=function(e,t){var r=this;if(void 0===t&&(t=!0),e){var i=this.$scope.filter;if(i.dimension){var a=i.group;this.setAreaFilter(e),i.dimension.filterFunction(function(t){return null!=t?r.isInsideFunction(t,e.geometry.coordinates):!1}),this.helperGroup.all().forEach(function(e){"inside"===e.key&&(e.value=i.dimension.top(1/0).length),"outside"===e.key&&(e.value=i.dimension.groupAll().value()-i.dimension.top(1/0).length)}),this.isEmpty=!this.helperGroup.all().some(function(e){return 0!==e.value}),a.filterResult=i.dimension.top(1/0),t&&(this.$layerService.updateMapFilter(a),dc.renderAll())}}},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService","$timeout","$translate"],e}();e.AreaFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,this.$translate=a,e.vm=this,e.editMode=!0,a("REMOVE").then(function(t){e.removeString=t}),a("CREATE_SCATTER").then(function(t){e.createScatterString=t});var s=e.$parent.$parent;s.hasOwnProperty("filter")&&(e.filter=s.filter),e&&e.filter&&(setTimeout(function(){return o.initBarFilter()}),e.options=function(){var t=[];return t.push([e.removeString,function(){return o.remove()}]),e.filter.group.filters.forEach(function(r){"bar"===r.filterType&&r.property!==e.filter.property&&t.push([e.createScatterString+" "+r.title,function(){return o.createScatter(r)}])}),t})}return e.prototype.createScatter=function(e){this.$layerService.createScatterFilter(this.$scope.filter.group,this.$scope.filter.property,e.property)},e.prototype.displayFilterRange=function(e,t){+e>+t&&(e=t);var r=this.$scope.filter;r.from=r.rangex[0]<e?e:r.rangex[0],r.to=r.rangex[1]>t?t:r.rangex[1],this.$scope.$apply()},e.prototype.initBarFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i="filter_"+t.id;this.dcChart=dc.barChart("#"+i),this.$scope.$apply();var a=t.meta.propertyInfo?t.meta.propertyInfo:this.$layerService.calculatePropertyInfo(r,t.property),o=t.meta.numberOfBins?t.meta.numberOfBins:Math.ceil(Math.sqrt(Object.keys(r.markers).length)),s=a.min,n=a.max,c=Math.ceil(Math.abs(n-s)/o);n=s+o*c;var l=Math.round(c/2);t.from=t.rangex[0]=s-l,t.to=t.rangex[1]=n;var p=r.ndx.dimension(function(e){if(!e.properties.hasOwnProperty(t.property))return null;var r=e.properties[t.property];if(null===r)return null;var i=parseFloat(r)-s;return s+Math.floor(i/c)*c});t.dimension=p;var u=p.group();this.dcChart.width(275).height(110).dimension(p).group(u).transitionDuration(10).centerBar(!0).gap(0).elasticY(!0).x(d3.scale.linear().domain([s-l,n]).range([-1,o+1])).filterPrinter(function(t){var r="";if(t.length>0){var i=t[0];e.displayFilterRange(parseFloat(i[0]).toFixed(2),parseFloat(i[1]).toFixed(2)),r+=i[0]}return r}).on("renderlet",function(t){var i="";if(t.filters.length>0){var a=t.filters[0];e.displayFilterRange(+a[0].toFixed(2),(+a[1]).toFixed(2)),i+=a[0]}dc.events.trigger(function(){e.$layerService.updateFilterGroupCount(r)},0),dc.events.trigger(function(){r.filterResult=p.top(1/0),e.$layerService.updateMapFilter(r)},100)}),this.dcChart.selectAll(),this.dcChart.xUnits(function(){return 100/o}),this.dcChart.yAxis().ticks(5),this.dcChart.xAxis().ticks(5),dc.renderAll(),this.updateRange()},e.prototype.updateFilter=function(){var e=this;setTimeout(function(){e.dcChart.filter([e.$scope.filter.from,e.$scope.filter.to]),e.dcChart.render(),dc.renderAll(),e.$layerService.updateMapFilter(e.$scope.filter.group)},10)},e.prototype.updateRange=function(){var e=this;setTimeout(function(){var t=e.$scope.filter,r=t.group;e.displayFilterRange(t.from,t.to),e.dcChart.filterAll(),e.dcChart.filter(dc.filters.RangedFilter(t.from,t.to)),e.dcChart.render(),dc.redrawAll(),r.filterResult=t.dimension.top(1/0),e.$layerService.updateMapFilter(t.group),e.$scope.$apply()},0)},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService","$timeout","$translate"],e}();e.BarFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,e.vm=this;var a=e.$parent.$parent;a.hasOwnProperty("filter")&&(e.filter=a.filter),e&&e.filter&&(this.initBoolFilter(),e.$watch("filter.value",function(){i.updateBoolFilter()}))}return e.prototype.initBoolFilter=function(){var e=this.$scope.filter,t=e.group,r=t.ndx.dimension(function(t){return t.properties.hasOwnProperty(e.property)?t.properties[e.property]:null});e.dimension=r,e.group=t,r.filterFunction(function(e){return!1})},e.prototype.updateBoolFilter=function(){var e=this.$scope.filter;if(e.dimension){var t=e.group;e.dimension.filterFunction(function(t){return null!=t?t=e.value:!1}),t.filterResult=e.dimension.top(1/0),this.$layerService.updateMapFilter(t),dc.renderAll()}},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService"],e}();e.BoolFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this["switch"]="after",e.vm=this;var a=e.$parent.$parent;a.hasOwnProperty("filter")&&(e.filter=a.filter),e&&e.filter&&(this.initTextFilter(),this.subHandle=r.subscribe("timeline",function(e){switch(e){case"focusChange":i.updateDateFilter()}}),e.$watch("vm.switch",function(){i.updateDateFilter()}))}return e.prototype.select=function(){},e.prototype.check=function(e){if(null!=e){var t;switch(_.isNumber(e)&&(t=e),_.isDate(e)&&(t=Date.parse(e)),this["switch"]){case"before":return t>=this.$layerService.project.timeLine.focus;case"after":return t<=this.$layerService.project.timeLine.focus;case"range":return t>=this.$layerService.project.timeLine.start&&t<=this.$layerService.project.timeLine.end}}return!1},e.prototype.initTextFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i=r.ndx.dimension(function(e){return e.properties.hasOwnProperty(t.property)?e.properties[t.property]:null});t.dimension=i,t.group=r,this.$layerService.project.timeLine.focusDate,i.filterFunction(function(t){return e.check(t)})},e.prototype.updateDateFilter=function(){var e=this,t=this.$scope.filter;if(t.dimension){var r=t.group;t.dimension.filterFunction(function(t){return e.check(t)}),r.filterResult=t.dimension.top(1/0),this.$layerService.updateMapFilter(r),dc.renderAll()}},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService"],e}();e.DateFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,this.$translate=a,e.vm=this,a("REMOVE").then(function(t){e.removeString=t});var s=e.$parent.$parent;s.hasOwnProperty("filter")&&(e.filter=s.filter),e&&e.filter&&(setTimeout(function(){return o.initLocationFilter()}),e.options=function(){var t=[];return t.push([e.removeString,function(){return o.remove()}]),t})}return e.prototype.setLocationFilter=function(){var e=this;if(this.locationFilter)this.locationFilter.isEnabled()?this.locationFilter.disable():this.locationFilter.enable();else{var t=this.$layerService.map.map.getBounds();t=t.pad(-.75),this.locationFilter=new L.LocationFilter({bounds:t}).addTo(this.$layerService.map.map),this.$scope.filter.value=t,this.locationFilter.on("change",function(t){e.updateLocationFilter(t.bounds)}),this.locationFilter.on("enabled",function(t){e.updateLocationFilter(t.bounds)}),this.locationFilter.enable(),this.updateLocationFilter(this.locationFilter.getBounds())}},e.prototype.initLocationFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i="filter_"+t.id;this.setLocationFilter(),this.dcChart=dc.pieChart("#"+i),this.$scope.$apply();var a=r.ndx.dimension(function(e){if(e.id&&e.layer&&e.layer.group&&e.layer.group.markers&&e.layer.group.markers.hasOwnProperty(e.id)){var t=e.layer.group.markers[e.id];if(t.getBounds)return t.getBounds();if(t.getLatLng)return new L.LatLngBounds(t.getLatLng(),t.getLatLng())}return null});t.dimension=a,this.helperDim=crossfilter([{title:"inside"},{title:"outside"}]).dimension(function(e){return e.title}),this.helperGroup=this.helperDim.group(function(e){return e}),this.dcChart.width(175).height(200).slicesCap(4).innerRadius(0).dimension(this.helperDim).group(this.helperGroup).legend(dc.legend()).renderLabel(!0).label(function(e){return e.value}).on("renderlet",function(t){e.updateLocationFilter(e.locationFilter.getBounds(),!1)}),this.updateLocationFilter(this.$scope.filter.value)},e.prototype.updateLocationFilter=function(e,t){void 0===t&&(t=!0);var r=this.$scope.filter;if(r.dimension&&this.locationFilter.isEnabled()){var i=r.group;r.dimension.filterFunction(function(t){return null!=t?e.contains(t):!1}),this.helperGroup.all().forEach(function(e){"inside"===e.key&&(e.value=r.dimension.top(1/0).length),"outside"===e.key&&(e.value=r.dimension.groupAll().value()-r.dimension.top(1/0).length)}),this.isEmpty=!this.helperGroup.all().some(function(e){return 0!==e.value}),i.filterResult=r.dimension.top(1/0),t&&(this.$layerService.updateMapFilter(i),dc.renderAll())}},e.prototype.remove=function(){this.$scope.filter&&(this.locationFilter&&this.locationFilter.isEnabled&&this.locationFilter.disable(),this.$layerService.removeFilter(this.$scope.filter))},e.$inject=["$scope","layerService","messageBusService","$timeout","$translate"],e}();e.LocationFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,this.$translate=a,e.vm=this,a("REMOVE").then(function(t){e.removeString=t}),a("CREATE_SCATTER").then(function(t){e.createScatterString=t}),a("SAVE_AS_IMAGE").then(function(t){e.saveAsImageString=t});var s=e.$parent.$parent;s.hasOwnProperty("filter")&&(e.filter=s.filter),window.canvg?this.exporterAvailable=!0:this.exporterAvailable=!1,this.$messageBus.subscribe("filters",function(t,r){switch(t){case"updateGroup":e.filter&&e.filter.group.id===r&&o.updateFilter()}}),e&&e.filter&&(setTimeout(function(){return o.initRowFilter()}),e.options=function(){var t=[];return t.push([e.removeString,function(){return o.remove()}]),e.filter.group.filters.forEach(function(r){"row"==r.filterType&&r.property!=e.filter.property&&t.push([e.createScatterString+" "+r.title,function(){return o.createScatter(r)}])}),o.exporterAvailable&&t.push([e.saveAsImageString,function(){return o.exportToImage()}]),t})}return e.prototype.createScatter=function(e){this.$layerService.createScatterFilter(this.$scope.filter.group,this.$scope.filter.property,e.property)},e.prototype.initRowFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i="filter_"+t.id;window.customRowChart?(dc.customRowChart=window.customRowChart,this.dcChart=dc.customRowChart("#"+i)):this.dcChart=dc.rowChart("#"+i),this.$scope.$apply();var a,o=r.ndx.dimension(function(r){if(r.properties.hasOwnProperty(t.property)){if(a||(a=e.$layerService.getPropertyType(r,t.property)),null!=r.properties[t.property]){var i=r.properties[t.property];if("options"===a.type){var o,s=i.toString();return o=a&&a.options&&a.options.hasOwnProperty(s)?s+"."+a.options[s]:s+"."+s}if("number"===a.type&&a.hasOwnProperty("legend")){var n;return a.legend.legendEntries.some(function(e){return i>=e.interval.min&&e.interval.max>=i?(n=e.label,!0):void 0}),n||(n="other"),n}if("text"===a.type||"textarea"===a.type)return i}return null}return null});t.dimension=o;var s=o.group();if(a&&a.legend){var n=[];_.each(a.legend.legendEntries,function(e){n.push(e.label)});var c=crossfilter(n),l=c.dimension(function(e){return e}),p=l.group()}var u=p?this.ensureAllBins(s,p):null;this.dcChart.width(380).height(285).margins({top:2,right:2,bottom:2,left:2}).dimension(o).group(u||s).title(function(e){return e.key}).elasticX(!0).colors(function(e){if(!a||!a.legend)return"red";if(a.options)return csComp.Helpers.getColorFromLegend(parseInt(e.split(".")[0]),a.legend);if(!a.options){var t=a.legend.legendEntries.filter(function(t){return t.label===e});return t.length>0?t[0].color:"#444444"}}).cap(10).on("renderlet",function(t){dc.events.trigger(function(){e.$layerService.updateFilterGroupCount(r)},0),dc.events.trigger(function(){r.filterResult=o.top(1/0),e.$layerService.updateMapFilter(r)},100)}).on("filtered",function(e){console.log("Filtered rowchart")}),this.dcChart.xAxis().ticks(8),this.dcChart.selectAll(),this.updateRange(),dc.renderAll()},e.prototype.ensureAllBins=function(e,t){var r=t.all().slice(0);return{all:function(){var t=e.all().slice(0),i={};return t.forEach(function(e){i[e.key]=!0}),r.forEach(function(e){i[e.key]||t.push({key:e.key,value:0})}),t},top:function(t){var i=e.all().slice(0),a={};return i.forEach(function(e){a[e.key]=!0}),r.forEach(function(e){a[e.key]||i.push({key:e.key,value:0})}),i.slice(0,t)},size:function(){return r.length}}},e.prototype.updateFilter=function(){var e=this;setTimeout(function(){e.dcChart.filter(e.$scope.filter.filterLabel),e.dcChart.render(),dc.renderAll(),e.$layerService.updateMapFilter(e.$scope.filter.group)},10)},e.prototype.updateRange=function(){var e=this;setTimeout(function(){var t=e.$scope.filter,r=t.group;e.dcChart.filterAll(),e.dcChart.filter(e.$scope.filter.filterLabel),e.dcChart.render(),dc.redrawAll(),r.filterResult=t.dimension.top(1/0),e.$layerService.updateMapFilter(e.$scope.filter.group),e.$layerService.triggerUpdateFilter(e.$scope.filter.group.id),e.$scope.$apply()},0)},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.prototype.exportToImage=function(){var e=this,t=window.canvg||void 0;if(t){var r=(new XMLSerializer).serializeToString(this.dcChart.root().node().firstChild),i=document.createElement("canvas");document.body.appendChild(i),t(i,r,{renderCallback:function(){var t=i.toDataURL("image/png"),r=e.$scope.filter.title||"rowfilter-export";csComp.Helpers.saveImage(t,r+".png","png"),i.parentElement.removeChild(i)}})}},e.$inject=["$scope","layerService","messageBusService","$timeout","$translate"],e}();e.RowFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,this.$timeout=i,e.vm=this;var o=e.$parent.$parent;o.hasOwnProperty("filter")&&(e.filter=o.filter),e&&e.filter&&(setTimeout(function(){return a.addScatterFilter()}),e.options=function(){var t=[];return t.push(["remove",function(){return a.remove()}]),e.filter.group.filters.forEach(function(r){"bar"===r.filterType&&r.property!==e.filter.property&&t.push(["create scatter with "+r.title,function(){return a.remove()}])}),t})}return e.prototype.displayFilterRange=function(e,t){var r=this.$scope.filter;r.from=e,r.to=t,this.$scope.$apply()},e.prototype.addScatterFilter=function(){var e=this,t=this.$scope.filter,r=t.group,i=this.$layerService.calculatePropertyInfo(r,t.property),a=(this.$layerService.calculatePropertyInfo(r,t.property2),"filter_"+t.id);this.dcChart=dc.scatterPlot("#"+a);var o=r.ndx.dimension(function(e){if(!e.properties.hasOwnProperty(t.property))return null;if(null!=e.properties[t.property]){var r=parseFloat(e.properties[t.property]),a=parseFloat(e.properties[t.property2]);if(r>=i.min&&r<=i.max)return[r,a]}return[0,0]});t.dimension=o;var s=o.group();this.dcChart.width(275).height(190).dimension(o).group(s).x(d3.scale.linear().domain([i.min,i.max])).yAxisLabel(t.property2).xAxisLabel(t.property).on("filtered",function(t){t.hasFilter();dc.events.trigger(function(){r.filterResult=o.top(1/0),e.$layerService.updateFilterGroupCount(r)},0),dc.events.trigger(function(){e.$layerService.updateMapFilter(r)},100)}),this.dcChart.xUnits(function(){return 13}),this.dcChart.yAxis().ticks(15),this.dcChart.xAxis().ticks(15),this.dcChart.render()},e.prototype.updateFilter=function(){var e=this;setTimeout(function(){e.dcChart.filter([e.$scope.filter.from,e.$scope.filter.to]),e.dcChart.render(),dc.renderAll(),e.$layerService.updateMapFilter(e.$scope.filter.group),console.log("update filter")},10)},e.prototype.updateRange=function(){var e=this;setTimeout(function(){e.dcChart.filter([e.$scope.filter.from,e.$scope.filter.to]),e.dcChart.render(),e.$layerService.updateMapFilter(e.$scope.filter.group),console.log("update filter")},10)},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService","$timeout"],e}();e.ScatterFilterCtrl=t}(Filters||(Filters={}));var Filters;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("txt2",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/TextFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.TextFilterCtrl}}]).directive("boolFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/BoolFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.BoolFilterCtrl}}]).directive("barFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/BarFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.BarFilterCtrl}}]).directive("rowFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/RowFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.RowFilterCtrl}}]).directive("scatterFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/ScatterFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.ScatterFilterCtrl}}]).directive("dateFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/DateFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.DateFilterCtrl}}]).directive("locationFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/LocationFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.LocationFilterCtrl}}]).directive("areaFilter",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Filters/AreaFilter.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.AreaFilterCtrl}}])}(Filters||(Filters={}));var Filters;!function(e){var t=function(){function e(e,t,r){var i=this;this.$scope=e,this.$layerService=t,this.$messageBus=r,e.vm=this;var a=e.$parent.$parent;a.hasOwnProperty("filter")&&(e.filter=a.filter),e&&e.filter&&(this.initTextFilter(),e.$watch("filter.stringValue",function(){i.updateTextFilter()}))}return e.prototype.initTextFilter=function(){var e=this.$scope.filter,t=e.group,r=t.ndx.dimension(function(t){return t.properties.hasOwnProperty(e.property)?t.properties[e.property]:null});e.dimension=r,e.group=t,r.filterFunction(function(t){return null!=t&&"function"==typeof t.toLowerCase?t.toLowerCase().indexOf(e.stringValue.toLowerCase())>-1:!1})},e.prototype.updateTextFilter=function(){var e=this.$scope.filter;if(e.dimension){var t=e.group;null==e.stringValue||""===e.stringValue?e.dimension.filterAll():e.dimension.filterFunction(function(t){return null!=t&&"function"==typeof t.toLowerCase?t.toLowerCase().indexOf(e.stringValue.toLowerCase())>-1:!1}),t.filterResult=e.dimension.top(1/0),this.$layerService.updateMapFilter(t),dc.redrawAll()}},e.prototype.remove=function(){this.$scope.filter&&this.$layerService.removeFilter(this.$scope.filter)},e.$inject=["$scope","layerService","messageBusService"],e}();e.TextFilterCtrl=t}(Filters||(Filters={}));var FilterStyleWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("filterstylewidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/FilterStyleWidget/FilterStyleWidget.tpl.html",replace:!0,transclude:!1,controller:e.FilterStyleWidgetCtrl}}])}(FilterStyleWidget||(FilterStyleWidget={}));var FilterStyleWidget;!function(e){var t=function(){function e(){}return e}();e.FilterStyleWidgetData=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$timeout=t,this.$translate=r,this.$layerService=i,this.$messageBus=a,this.$mapService=o,this.mBusHandles=[],e.vm=this;var n=e.$parent;this.widget=n.widget,this.parentWidget=$("#"+this.widget.elementId).parent(),e.data=this.widget.data,e.minimized=!1,window.canvg?this.exporterAvailable=!0:this.exporterAvailable=!1,this.parentWidget.hide(),this.mBusHandles.push(this.$messageBus.subscribe("layer",function(t,r){"activated"===t&&e.filter&&s.updateChart()})),this.mBusHandles.push(this.$messageBus.subscribe("updatelegend",function(t,r){switch(t){case"hidelegend":s.close();break;default:r&&(delete e.filter,e.style=r,s.createChart())}}))}return e.prototype.canMinimize=function(){return this.$scope.data.hasOwnProperty("canMinimize")?this.$scope.data.canMinimize:!0},e.prototype.minimize=function(){this.$scope.minimized=!this.$scope.minimized,this.$scope.minimized?this.parentWidget.css("height","30px"):this.parentWidget.css("height",this.widget.height)},e.prototype.canClose=function(){return this.$scope.data.hasOwnProperty("canClose")?this.$scope.data.canClose:!0},e.prototype.close=function(){this.parentWidget.hide()},e.prototype.stop=function(){var e=this;this.mBusHandles&&this.mBusHandles.length>0&&this.mBusHandles.forEach(function(t){e.$messageBus.unsubscribe(t)})},e.prototype.selectFeature=function(e){e&&e.isSelected&&this.parentWidget.show()},e.prototype.createChart=function(){var e=this,t=new csComp.Services.GroupFilter;t.property=this.$scope.style.property,t.id=this.widget.id,t.group=this.$scope.style.group,t.group.ndx=crossfilter([]),t.group.ndx.add(_.map(t.group.markers,function(e,t){return e.feature})),t.title=this.$scope.style.title,t.filterLabel=null,t.filterType="row",t.group.filters=[],t.group.filters.push(t),this.$timeout(function(){e.$scope.filter=t,e.$scope.filter.showInWidget=!0}),this.$timeout(function(){e.updateRowFilterScope(t)}),this.parentWidget.show()},e.prototype.updateChart=function(){var e=this;this.$scope.filter.group.ndx=crossfilter([]),this.$scope.filter.group.ndx.add(_.map(this.$scope.filter.group.markers,function(e,t){return e.feature})),this.$timeout(function(){e.updateRowFilterScope(e.$scope.filter)})},e.prototype.updateRowFilterScope=function(e){if(!e||!e.group)return void console.log("No filter provided.");var t=angular.element($("#filter_"+this.widget.id));if(!t)return void console.log("rowFilterElm not found.");var r=t.scope();return r?(r.filter=e,void r.vm.initRowFilter()):void console.log("rowFilterScope not found.")},e.prototype.exportToImage=function(){var e=this,t=window.canvg||void 0;if(t){var r=(new XMLSerializer).serializeToString(document.getElementById("filter_"+this.widget.id).firstChild),i=document.createElement("canvas");document.body.appendChild(i),t(i,r,{renderCallback:function(){var t=i.toDataURL("image/png"),r=e.$scope.filter.title||"rowfilter-export";csComp.Helpers.saveImage(t,r+".png","png"),i.parentElement.removeChild(i)}})}},e.$inject=["$scope","$timeout","$translate","layerService","messageBusService","mapService"],e}();e.FilterStyleWidgetCtrl=r}(FilterStyleWidget||(FilterStyleWidget={}));var FocusTimeWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("focustimewidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/FocusTimeWidget/FocusTimeWidget.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$http=t,this.layerService=r,this.messageBusService=i,this.$timeout=a,this.disabled=!1,this.active=!1,this.isOpen=!0,this.timeOptions={readonlyInput:!1,showMeridian:!1},e.vm=this;var s=e.$parent;switch(e.data=s.widget.data,s.widget.stop=function(){o.handle&&o.messageBusService.unsubscribe(o.handle)},e.data.mode){case"layerTimestamp":this.checkLayerTimestamp(),this.layer=this.layerService.findLayer(this.$scope.data.layer),this.handle=this.messageBusService.subscribe("layer",function(t,r){"sensordataUpdated"===t&&r.id===e.data.layer&&o.checkLayerTimestamp()});break;case"focustime":this.handle=this.messageBusService.subscribe("timeline",function(t,r){"focusChange"===t&&e.$evalAsync(function(){o.time=o.layerService.project.timeLine.focusDate().getTime()})})}}return e.prototype.openCalendar=function(e){e.preventDefault(),e.stopPropagation(),this.isOpen=!0},e.prototype.lastHour=function(){this.layer.sensorLink.liveInterval="1h",this.layerService.updateLayerSensorLink(this.layer)},e.prototype.lastDay=function(){this.layer.sensorLink.liveInterval="24h",this.layerService.updateLayerSensorLink(this.layer),console.log("last 24")},e.prototype.setTag=function(e){this.layerService.$messageBusService.publish("viewmode","tag",e),this.$scope.data.activeTag=e},e.prototype.checkLayerTimestamp=function(){var e=this;this.layer&&this.layer._gui.hasOwnProperty("timestamp")&&this.$scope.$evalAsync(function(){if(e.dateFormat="dd-MM-yyyy EEE",e.timeFormat="HH:mm ",e.layer.sensorLink.actualInterval){if(e.endTime=e.layer._gui.timestamp,e.time=e.layer._gui.timestamp+e.layer.sensorLink.actualInterval,e.time>e.endTime){var t=e.endTime;e.endTime=e.time,e.time=t}}else e.time=e.layer._gui.timestamp})},e.$inject=["$scope","$http","layerService","messageBusService","$timeout"],e}();e.FocusTimeWidgetCtrl=i}(FocusTimeWidget||(FocusTimeWidget={}));var HeaderWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("headerwidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/HeaderWidget/HeaderWidget.tpl.html",replace:!0,transclude:!1,controller:e.HeaderWidgetCtrl}}])}(HeaderWidget||(HeaderWidget={}));var HeaderWidget;!function(e){var t=function(){function e(){}return e}();e.HeaderWidgetData=t;var r=function(){function e(e,t,r,i,a){this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,e.vm=this;var o=e.$parent;this.widget=o.widget,this.widget.data&&(e.data=this.widget.data,e.data.mdText=e.data.content,e.data.autoShow&&this.showContent()),this.dataProperties={},this.parentWidget=$("#"+this.widget.elementId).parent()}return e.prototype.showContent=function(){var e=csComp.Helpers.createRightPanelTab("headerinfo","infowidget",this.$scope.data,"Selected feature",'{{"FEATURE_INFO" | translate}}',"question",!0);this.$messageBus.publish("rightpanel","activate",e),this.$layerService.visual.rightPanelVisible=!0},e.$inject=["$scope","$timeout","layerService","messageBusService","mapService"],e}();e.HeaderWidgetCtrl=r}(HeaderWidget||(HeaderWidget={}));var InfoWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("infowidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/HeaderWidget/InfoWidget.tpl.html",replace:!0,transclude:!1,controller:a}}]);var i=function(){function e(){}return e}();e.InfoWidgetData=i;var a=function(){function e(e,t,r,i,a){this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,e.vm=this;var o=e.$parent;this.widget=o,e.data=this.widget.data,e.data&&e.data.content&&(e.data.mdText=e.data.content,this.parentWidget=$("#"+this.widget.elementId).parent())}return e.$inject=["$scope","$timeout","layerService","messageBusService","mapService"],e}();e.InfoWidgetCtrl=a}(InfoWidget||(InfoWidget={}));var IFrameWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("iframewidgetEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/IFrameWidget/IFrame-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function e(e,t){this.$scope=e,this.$sce=t,e.vm=this;var r=e.$parent;this.widget=r.data,e.data=this.widget.data,this.update()}return e.prototype.update=function(){this.$scope.data._safeurl=this.$sce.trustAsResourceUrl(this.$scope.data.url)},e.$inject=["$scope","$sce"],e}();e.IFrameEditCtrl=i}(IFrameWidget||(IFrameWidget={}));var IFrameWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("iframewidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/IFrameWidget/IFrameWidget.tpl.html",replace:!0,transclude:!1,controller:e.IFrameWidgetCtrl}}])}(IFrameWidget||(IFrameWidget={}));var IFrameWidget;!function(e){var t=function(){function e(){}return e}();e.IFrameWidgetData=t;var r=function(){function e(e,t){this.$scope=e,this.$sce=t,e.vm=this;var r=e.$parent;this.widget=r.widget,e.data=this.widget.data}return e.prototype.update=function(){this.$scope.data._safeurl=this.$sce.trustAsResourceUrl(this.$scope.data.url)},e.$inject=["$scope","$sce"],e}();e.IFrameWidgetCtrl=r}(IFrameWidget||(IFrameWidget={}));var Indicators;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("indicatorsEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Indicators/Indicators-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function t(e,t,r,i,a,o,s,n){this.$scope=e,this.$timeout=t,this.$compile=r,this.$layerService=i,this.$templateCache=a,this.$messageBus=o,this.$mapService=s,this.$dashboardService=n,e.vm=this;var c=e.$parent;this.widget=c.data,this.propertyTypes=[],e.data=this.widget.data,this.indicatorVisuals={},this.indicatorVisuals.bullet={id:"bullet",title:"Bullet chart",input:{}},this.indicatorVisuals.circular={id:"circular",title:"Circular",input:{value:{type:"expression","default":"~['value']"},min:{type:"expression","default":0},max:{type:"expression","default":0}}},this.indicatorVisuals.sparkline={id:"sparkline",title:"Sparkline",input:{property:{type:"string","default":"value"},height:{type:"string","default":"50"}}},this.indicatorVisuals.bar={id:"bar",title:"Bar chart",input:{}},this.indicatorVisuals.singlevalue={id:"singlevalue",title:"Value",input:{value:{type:"expression","default":"~['value']"}}}}return t.prototype.colorUpdated=function(e,t){t.color=e},t.prototype.updatePropertyTypes=function(e){var t=this.$layerService._featureTypes[e.featureTypeName];t&&(this.propertyTypeData=csComp.Helpers.getPropertyTypes(t,this.$layerService.propertyTypeData))},t.prototype.moveUp=function(e){this.$scope.data.indicators.indexOf(e)},t.prototype.deleteIndicator=function(e){this.$scope.data.indicators=this.$scope.data.indicators.filter(function(t){return t.id!==e})},t.prototype.updateIndicator=function(e){e.propertyTypes=[],e.propertyTypeTitles=[],this.propertyTypes.forEach(function(t){e.propertyTypes.push(t.label),e.propertyTypeTitles.push(t.title)}),this.$layerService.lastSelectedFeature&&"feature"===e.source&&this.$messageBus.publish("feature","onUpdateWithLastSelected",{indicator:e,feature:void 0}),e._toggleUpdate=!e._toggleUpdate,this.updateVisual(e),"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply();
},t.prototype.initIndicator=function(e){this.updateVisual(e)},t.prototype.updateVisual=function(e){e.inputs||(e.inputs={});var t={};for(var r in this.indicatorVisuals[e.visual].input)if(e.inputs&&e.inputs.hasOwnProperty(r))t[r]=e.inputs[r];else{var i=this.indicatorVisuals[e.visual].input;t[r]=i[r]["default"]}e.inputs=t},t.prototype.addIndicator=function(){var t=new e.Indicator;t.title="New Indicator",t.visual="circular",t.sensor="",t.source="feature",t.featureTypeName="",t.propertyTypes=[],this.updateVisual(t),this.$scope.data.indicators||(this.$scope.data.indicators=[]),this.$scope.data.indicators.push(t),"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},t.prototype.sensorChanged=function(e){var t=e.sensor.split("/");t.length>1&&this.$layerService.project.datasources.forEach(function(r){r.id===t[0]&&r.sensors.hasOwnProperty(t[1])&&(e._sensorSet=r.sensors[t[1]])}),e._toggleUpdate=!e._toggleUpdate,"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},t.$inject=["$scope","$timeout","$compile","layerService","$templateCache","messageBusService","mapService","dashboardService"],t}();e.IndicatorsEditCtrl=i}(Indicators||(Indicators={}));var Indicators;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("indicators",["$compile",function(t){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/Indicators/Indicators.tpl.html",compile:function(e){var r=t(e);return function(e){r(e)}},replace:!0,transclude:!0,controller:e.IndicatorsCtrl}}]).filter("datasource",function(){return function(e,t){if(!e)return"";var r=t.$parent.$eval(e.replace("~","i._value"));return r}})}(Indicators||(Indicators={}));var Indicators;!function(e){var t=function(){function e(){this.orientation="vertical"}return e}();e.IndicatorData=t;var r=function(){function e(){this.inputs={},this._result={},this._toggleUpdate=!0,this.indicatorWidth=200}return e}();e.Indicator=r;var i=function(){function e(e,t,r,i,a,o,s){var n=this;this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,this.$dashboardService=o,this.$translate=s,e.vm=this;var c=e.$parent;c.widget&&(this.widget=c.widget,this.widget._ctrl=this,this.checkLayers(),this.$messageBus.subscribe("layer",function(e){n.checkLayers()}),e.data=this.widget.data,"undefined"!=typeof e.data.indicators&&e.data.indicators.forEach(function(e){e.id="circ-"+csComp.Helpers.getGuid()}),t(function(){return n.checkLayers()}))}return e.prototype.forceUpdateIndicator=function(e,t){var r=this;setTimeout(function(){e._value=t,e._result={},r.$scope.$apply();for(var i in e.inputs)e._result[i]=e.inputs[i];r.$scope.$apply()},0)},e.prototype.updateIndicator=function(e){var t=this.$layerService.project.timeLine.focus;this.$layerService.findSensorSet(e.sensor,function(r){e._sensorSet=r,e._focusTime=t,e._sensorSet.propertyType&&e._sensorSet.propertyType.legend&&(e.color=csComp.Helpers.getColorFromLegend(e._sensorSet.activeValue,e._sensorSet.propertyType.legend))})},e.prototype.startEdit=function(){},e.prototype.checkLayers=function(){var e=this;if(this.$layerService.visual.mapVisible){var t=this.$layerService.project.timeLine.focus;this.$scope.data&&this.$scope.data.indicators&&this.$scope.data.indicators.forEach(function(r){if(r._focusTime=t,null!=r.layer){var i=r.layer.split("/"),a=e.$layerService.findLayer(i[0]);null!=a&&(i.length>1?r.isActive=a.enabled&&a.group.styles.some(function(e){return e.property===i[1]}):r.isActive=a.enabled)}})}},e.prototype.selectIndicator=function(e){if("undefined"!=typeof e.dashboard){var t=this.$layerService.project.dashboards.filter(function(t){return t.id===e.dashboard});t.length>0&&this.$dashboardService.selectDashboard(t[0],"main")}if(this.$layerService.visual.mapVisible){if(null!=e.layer){var r=e.layer.split("/"),i=this.$layerService.findLayer(r[0]);null!=i&&(i.enabled?this.$layerService.checkLayerLegend(i,r[1]):(r.length>1&&(i.defaultLegendProperty=r[1]),this.$layerService.addLayer(i)))}this.checkLayers()}},e.prototype.indicatorInit=function(e,t){var r=this;switch(t.Math=Math,e.source){default:this.$messageBus.subscribe("feature",function(t,i){switch(t){case"onFeatureSelect":r.selectFeature(i,e);break;case"onUpdateWithLastSelected":var a,o=i.indicator;r.$layerService.lastSelectedFeature&&(a=r.$layerService.lastSelectedFeature),r.selectFeature(a,o)}});break;case"sensor":null!=e.sensor&&(this.$layerService.$messageBusService.serverSubscribe(e.sensor,"key",function(t,i){switch(i.action){case"key":r.forceUpdateIndicator(e,i.data.item)}}),this.updateIndicator(e))}},e.prototype.selectFeature=function(e,t){var r=this;if(!t._sensorSet){var i=new csComp.Services.SensorSet;i.propertyType={title:""},t._sensorSet=i}if(t.hasOwnProperty("featureTypeName")&&e.featureTypeName===t.featureTypeName){var a=t.propertyTypes,o=[],s=[];this.forceUpdateIndicator(t,e.properties),a.forEach(function(t){e.properties.hasOwnProperty(t)&&s.push(e.properties[t]),r.$layerService.propertyTypeData.hasOwnProperty(t)?o.push(r.$layerService.propertyTypeData[t].title):o.push(t)}),t._sensorSet.activeValue=s[0],t._sensorSet.propertyType.title=o[0];var n=this.$layerService.calculatePropertyInfo(e.layer.group,a[0]);if(t._sensorSet.min=n.min,t._sensorSet.max=1.05*n.max,"bullet"===t.visual){for(var c=[],l=0;l<a.length;l++){var p=this.$layerService.calculatePropertyInfo(e.layer.group,a[l]);"IMP"===a[l].substr(0,3)&&(p.sd<0?(p.min=-5,p.max=-5):(p.min=5,p.max=5));var u={title:o[l],subtitle:"",ranges:[p.max,p.max],measures:[s[l]],markers:[s[l]],barColor:s[l]<=0?"green":"red"};c.push(u)}t.indicatorWidth=200,t.data=JSON.stringify(c)}t._toggleUpdate=!t._toggleUpdate}"$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$apply()},e.$inject=["$scope","$timeout","layerService","messageBusService","mapService","dashboardService","$translate"],e}();e.IndicatorsCtrl=i}(Indicators||(Indicators={}));var LocationWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("locationwidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/LocationWidget/LocationWidget.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$http=t,this.layerService=r,this.messageBusService=i,this.actionService=a,this.$timeout=o,this.streetViewUrl="https://maps.googleapis.com/maps/api/streetview",this.location={},e.vm=this;var n=e.$parent;e.data=n.widget.data,e.data.streetViewUrl&&(this.streetViewUrl=e.data.streetViewUrl),this.parentWidget=$("#"+n.widget.elementId).parent(),this.parentWidget.hide(),i.subscribe("geocoding",function(e,t){"reverseLookupResult"===e&&(s.parentWidget.show(),s.updateWidget(t))})}return e.prototype.updateWidget=function(e){if(this.location={},e&&e.annotations&&(e.formatted&&(this.location.title=e.formatted),e.components&&(e.components.postcode&&(this.location.postcode=e.components.postcode),e.components.city&&(this.location.city=e.components.city),e.components.neighbourhood&&(this.location.neighbourhood=e.components.neighbourhood),(e.components.road||e.components.pedestrian)&&(this.location.address=e.components.road||e.components.pedestrian,e.components.house_number&&(this.location.address+=" "+e.components.house_number),this.location.streetViewUrlThumb=this.streetViewUrl+"?size=200x200&location="+this.location.address+","+this.location.city+"&key="+this.$scope.data.streetViewApiKey,this.location.streetViewUrlFull=this.streetViewUrl+"?size=640x640&location="+this.location.address+","+this.location.city+"&key="+this.$scope.data.streetViewApiKey)),this.location.locations=[],e.geometry&&this.location.locations.push(e.geometry.lat+", "+e.geometry.lng),e.annotations.DMS&&this.location.locations.push("DMS latitude: "+e.annotations.DMS.lat+", longitude: "+e.annotations.DMS.lng),e.geometry&&this.location.locations.push("WGS84 latitude: "+e.geometry.lat+", longitude: "+e.geometry.lng),e.annotations.MGRS&&this.location.locations.push("MGRS: "+e.annotations.MGRS),e.annotations.Mercator&&this.location.locations.push("Mercator x: "+e.annotations.Mercator.x+", y: "+e.annotations.Mercator.y),this.location.locations.length>0&&(this.selectedLocationFormat=this.location.locations[0]),this.location.defaultLocation=this.location.locations[0],e.annotations.sun)){var t=new Date(1e3*e.annotations.sun.rise.apparent);this.location.sunrise=String.format("{0:HH}:{0:mm}:{0:ss}",t);var r=new Date(1e3*e.annotations.sun.set.apparent);this.location.sunset=String.format("{0:HH}:{0:mm}:{0:ss}",r)}},e.prototype.close=function(){this.location={},this.parentWidget.hide()},e.$inject=["$scope","$http","layerService","messageBusService","actionService","$timeout"],e}();e.LocationWidgetCtrl=i}(LocationWidget||(LocationWidget={}));var Markdown;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("markdownwidgetEdit",["$compile",function(e){return{terminal:!0,restrict:"E",scope:{},templateUrl:"directives/Widgets/MarkdownWidget/Markdown-edit.tpl.html",replace:!0,transclude:!0,controller:i}}]);var i=function(){function e(e,t,r,i,a,o,s,n){this.$scope=e,this.$timeout=t,this.$compile=r,this.$layerService=i,this.$templateCache=a,this.$messageBus=o,this.$mapService=s,this.$dashboardService=n,e.vm=this;var c=e.$parent;this.widget=c.data,e.data=this.widget.data}return e.prototype.updateText=function(){this.$scope.data.mdText=this.$scope.data.content},e.$inject=["$scope","$timeout","$compile","layerService","$templateCache","messageBusService","mapService","dashboardService"],e}();e.MarkdownEditCtrl=i}(Markdown||(Markdown={}));var MarkdownWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("markdownwidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/MarkdownWidget/MarkdownWidget.tpl.html",replace:!0,transclude:!1,controller:e.MarkdownWidgetCtrl}}])}(MarkdownWidget||(MarkdownWidget={}));var MarkdownWidget;!function(e){var t=function(){function e(){}return e}();e.MarkdownWidgetData=t;var r=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,e.vm=this;var s=e.$parent;if(this.widget=s.widget,e.data=this.widget.data,e.data.mdText=e.data.content,e.minimized=!1,this.dataProperties={},window.jsPDF?this.exporterAvailable=!0:this.exporterAvailable=!1,this.parentWidget=$("#"+this.widget.elementId).parent(),"undefined"!=typeof e.data.featureTypeName&&"undefined"!=typeof e.data.dynamicProperties&&e.data.dynamicProperties.length>0&&(this.parentWidget.hide(),this.msgBusHandle=this.$messageBus.subscribe("feature",function(e,t){switch(e){case"onUpdateWidgets":case"onFeatureDeselect":case"onFeatureSelect":o.selectFeature(t)}})),"undefined"!=typeof e.data.url){var n=e.data.url;if(e.data.useLanguagePrefix){var c=n.split("."),l=this.$layerService.currentLocale+"."+c.pop();c.push(l),n=c.join(".")}$.get(n,function(r){t(function(){e.data.content=e.data.mdText=r},0)})}"undefined"!=typeof e.data.dataSourceUrl&&(n=e.data.dataSourceUrl,$.get(n,function(e){t(function(){o.dataProperties=JSON.parse(e),o.replaceKeys()},0)}))}return e.prototype.canMinimize=function(){return this.$scope.data.hasOwnProperty("canMinimize")?this.$scope.data.canMinimize:!0},e.prototype.minimize=function(){this.$scope.minimized=!this.$scope.minimized,this.$scope.minimized?this.parentWidget.css("height","30px"):this.parentWidget.css("height",this.widget.height)},e.prototype.canClose=function(){return this.$scope.data.hasOwnProperty("canClose")?this.$scope.data.canClose:!0},e.prototype.close=function(){this.parentWidget.hide()},e.prototype.stop=function(){this.msgBusHandle&&this.$messageBus.unsubscribe(this.msgBusHandle)},e.prototype.escapeRegExp=function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},e.prototype.replaceAll=function(e,t,r){return e.replace(new RegExp(this.escapeRegExp(t),"g"),r)},e.prototype.selectFeature=function(e){var t=this;return e&&e.isSelected&&e.featureTypeName===this.$scope.data.featureTypeName?void this.$timeout(function(){t.$scope.lastSelectedFeature=e;var r=t.$scope.data.content,i=0;t.$scope.data.dynamicProperties.forEach(function(a){var o="{{"+i++ +"}}",s="";if(e.properties.hasOwnProperty(a)){var n=t.$layerService.getPropertyType(e,a);s=csComp.Helpers.convertPropertyInfo(n,e.properties[a])}r=t.replaceAll(r,o,s)}),t.parentWidget.show(),t.$scope.data.mdText=r},0):void this.parentWidget.hide()},e.prototype.replaceKeys=function(){var e=this,t=this.$scope.data.content;this.$timeout(function(){var r=Object.keys(e.dataProperties);r.forEach(function(r){if(e.dataProperties.hasOwnProperty(r)){var i="{{"+r+"}}",a=e.dataProperties[r];t=e.replaceAll(t,i,a)}}),e.$scope.data.mdText=t},0)},e.prototype.exportToPDF=function(){var e=window.jsPDF||void 0;if(e){var t=new e("p","pt","a3");t.setFontSize(12),t.fromHTML($("#"+this.widget.elementId).get(0),15,15,{width:+this.widget.width});var r=this.$scope.lastSelectedFeature.properties.Name||"markdown-export";t.save(r+".pdf")}},e.$inject=["$scope","$timeout","layerService","messageBusService","mapService"],e}();e.MarkdownWidgetCtrl=r}(MarkdownWidget||(MarkdownWidget={}));var MarvelWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("marvelwidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/MarvelWidget/MarvelWidget.tpl.html",replace:!0,transclude:!1,controller:e.MarvelWidgetCtrl}}])}(MarvelWidget||(MarvelWidget={}));var MarvelWidget;!function(e){var t=function(){function e(){}return e}();e.MarvelWidgetData=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$timeout=t,this.$translate=r,this.$layerService=i,this.$messageBus=a,this.$mapService=o,e.vm=this;var n=e.$parent;this.widget=n.widget,this.parentWidget=$("#"+this.widget.elementId).parent(),this.defaultStates=["OK","Stressed","Failed"],this.initDependencies(),e.data=this.widget.data,e.minimized=!1,e.editmode=!1,"undefined"!=typeof e.data.featureTypeName&&(this.parentWidget.hide(),this.$messageBus.subscribe("feature",function(e,t){switch(e){case"onFeatureDeselect":case"onFeatureSelect":s.selectFeature(t)}}))}return e.prototype.initDependencies=function(){var e=this;return this.$scope.dependencyTypes={},this.$scope.dependencyTypes._dep_water={label:"",type:"number"},this.$scope.dependencyTypes._dep_UPS={label:"",type:"number"},this.$scope.dependencyTypes._dep_features={label:"",type:"stringarray"},this.$translate("MARVEL_WATER_LEVEL").then(function(t){e.$scope.dependencyTypes._dep_water.label=t}),this.$translate("MARVEL_UPS_DURATION").then(function(t){e.$scope.dependencyTypes._dep_UPS.label=t}),this.$translate("MARVEL_FEATURE_DEP").then(function(t){e.$scope.dependencyTypes._dep_features.label=t}),this.$scope.states=this.defaultStates,{}},e.prototype.minimize=function(){this.$scope.minimized=!this.$scope.minimized,this.$scope.minimized?this.parentWidget.css("height","30px"):this.parentWidget.css("height",this.widget.height)},e.prototype.edit=function(){var e=this;this.$scope.editmode=!this.$scope.editmode,this.$scope.editmode||this.$timeout(function(){var t=$("#"+e.widget.elementId);Marvelous.refreshView(t)},50)},e.prototype.close=function(){this.parentWidget.hide()},e.prototype.save=function(){var e=this.$scope.selectedFeature,t=new csComp.Services.LayerUpdate;t.layerId=e.layerId,t.action=csComp.Services.LayerUpdateAction.updateFeature,t.item=csComp.Services.Feature.serialize(e),this.$messageBus.serverSendMessageAction("layer",t),this.edit(),console.log("Published feature changes")},e.prototype.saveAll=function(){var e=this.$scope.selectedFeature,t=new csComp.Services.LayerUpdate;t.layerId=e.layerId,t.action=csComp.Services.LayerUpdateAction.updateFeature,t.item=csComp.Services.Feature.serialize(e),t.item.changeAllFeaturesOfType=!0,this.$messageBus.serverSendMessageAction("layer",t),this.edit(),console.log("Published feature changes")},e.prototype.escapeRegExp=function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},e.prototype.replaceAll=function(e,t,r){return e.replace(new RegExp(this.escapeRegExp(t),"g"),r)},e.prototype.addDependency=function(e,t){if(this.$scope.selectedFeature.properties.hasOwnProperty(e))delete this.$scope.selectedFeature.properties[e];else switch(t.type){case"number":this.$scope.selectedFeature.properties[e]=0;break;case"string":this.$scope.selectedFeature.properties[e]="";break;case"stringarray":this.$scope.selectedFeature.properties[e]=[];break;default:this.$scope.selectedFeature.properties[e]=null}},e.prototype.addDependencyFeature=function(e){if(this.$scope.selectedFeature.properties.hasOwnProperty(e)){var t=$("#add-"+e).val();t&&""!==t&&(this.$scope.selectedFeature.properties[e].some(function(e){return t===e})||(this.$scope.selectedFeature.properties[e].push(t),$("#add-"+e).val("")))}},e.prototype.removeDependencyFeature=function(e,t){this.$scope.selectedFeature.properties.hasOwnProperty(e)&&(this.$scope.selectedFeature.properties[e]=this.$scope.selectedFeature.properties[e].filter(function(e){return t!==e}))},e.prototype.selectFeature=function(e){var t=this;if(!e||!e.isSelected)return void this.parentWidget.hide();if("undefined"!=typeof this.$scope.data.marvelFolder&&e.fType&&e.fType.id){var r=csComp.Helpers.getPropertyTypes(e.fType,{});r.forEach(function(e){e.hasOwnProperty&&e.hasOwnProperty("label")&&"state"===e.label&&(t.$scope.states=_.values(e.options))}),this.$scope.selectedFeature=e;var i=e.fType.id.split("#").pop().replace(/(\_\d$)/,""),a=this.$scope.data.marvelFolder+i+".mrvjson";this.parentWidget.show(),$.ajax({url:a,success:function(r){t.$timeout(function(){t.$scope.data.title=e.fType.name;var a=$("#"+t.widget.elementId);Marvelous.model(r,i,a)},0)},error:function(){t.parentWidget.hide()}})}},e.$inject=["$scope","$timeout","$translate","layerService","messageBusService","mapService"],e}();e.MarvelWidgetCtrl=r}(MarvelWidget||(MarvelWidget={}));var MCAWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("mcawidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/MCAWidget/MCAWidget.tpl.html",replace:!0,transclude:!1,controller:e.MCAWidgetCtrl}}])}(MCAWidget||(MCAWidget={}));var MCAWidget;!function(e){var t=function(){function e(){}return e}();e.MCAWidgetData=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$timeout=t,this.$controller=r,this.$layerService=i,this.$messageBus=a,this.$mapService=o,e.vm=this;var n=e.$parent;this.widget=n.widget,e.data=this.widget.data,e.data.filterByDefaultFeatureType=e.data.filterByDefaultFeatureType||!1,"undefined"!=typeof e.data.layerId&&(this.parentWidget=$("#"+this.widget.elementId).parent(),this.parentWidget.hide(),this.$messageBus.subscribe("layer",function(e,t){switch(e){case"activated":case"deactivate":s.activateLayer(t)}}))}return e.prototype.activateLayer=function(e){var t=this;return this.mcaScope=this.getMcaScope(),this.mcaScope?e.id!==this.$scope.data.layerId||e.id===this.$scope.data.layerId&&!e.enabled?void this.parentWidget.hide():void this.$timeout(function(){t.parentWidget.show()},0):void 0},e.prototype.getMcaScope=function(){var e=angular.element('div[id="mca"]');if(!e)return void console.log("Mca element not found.");var t=e.scope();if(!t)return void console.log("Mca controller scope not found.");var r=this.$layerService.findLoadedLayer(this.$scope.data.layerId);return r&&this.$scope.data.filterByDefaultFeatureType?this.$scope.data.availableMcas=t.vm.availableMcas.filter(function(e){return e.featureIds[0].split("#").pop()===r.defaultFeatureType}):this.$scope.data.availableMcas=t.vm.availableMcas,t},e.prototype.setMcaAsStyle=function(e){if(!this.mcaScope||!this.mcaScope.vm.mca)return void console.log("Mca controller scope not found.");if(!this.$layerService.lastSelectedFeature)return void this.$messageBus.notifyWithTranslation("SELECT_A_FEATURE","SELECT_FEATURE_FOR_STYLE");var t=this.mcaScope.vm,r=t.findMcaById(e);return t.updateAvailableMcas(r),t.updateSelectedFeature(this.$layerService.lastSelectedFeature),t.showFeature?void(t.properties.length>0&&(t.updateMca(),console.log("Set mca style."),t.setStyle(t.properties[0]))):void this.$messageBus.notifyWithTranslation("SELECT_A_FEATURE","SELECT_FEATURE_FOR_STYLE")},e.$inject=["$scope","$timeout","$controller","layerService","messageBusService","mapService"],e}();e.MCAWidgetCtrl=r}(MCAWidget||(MCAWidget={}));var NavigatorWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("navigatorwidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/Navigator/NavigatorWidget.tpl.html",replace:!0,transclude:!1,controller:e.NavigatorWidgetCtrl}}])}(NavigatorWidget||(NavigatorWidget={}));var NavigatorWidget;!function(e){var t=function(){function e(){}return e}();e.NavigatorWidgetData=t;var r=function(){function e(e,t,r,i,a){this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,e.vm=this;var o=e.$parent;this.widget=o.widget,this.widget.data&&(e.data=this.widget.data),"undefined"!=typeof e.data.featureTypeName&&"undefined"!=typeof e.data.dynamicProperties&&e.data.dynamicProperties.length>0&&(this.parentWidget=$("#"+this.widget.elementId).parent(),this.parentWidget.hide())}return e.$inject=["$scope","$timeout","layerService","messageBusService","mapService"],e}();e.NavigatorWidgetCtrl=r}(NavigatorWidget||(NavigatorWidget={}));var PostMan;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("postmanEdit",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/PostMan/PostMan-edit.tpl.html",replace:!0,transclude:!1,controller:e.PostManEditCtrl}}])}(PostMan||(PostMan={}));var PostMan;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("postman",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/PostMan/PostMan.tpl.html",replace:!0,transclude:!1,controller:e.PostManCtrl}}])}(PostMan||(PostMan={}));var PostMan;!function(e){var t=function(){function e(e,t,r,i){this.$scope=e,this.$http=t,this.messageBusService=r,this.$timeout=i,e.vm=this;var a=e.$parent;e.data=a.widget.data,e.data.messages&&(e.selectedMessage=e.data.messages[0])}return e.prototype.execute=function(){var e=this;if(this.$scope.selectedMessage){var t=this.$scope.selectedMessage;switch(this.result="",t.httpMethod.name.toUpperCase()){case"POST":this.$http.post(t.url,t.message).success(function(){e.result="OK"}).error(function(t){e.result="Error: "+t});break;case"PUT":this.$http.put(t.url,t.message).success(function(){e.result="OK"}).error(function(t){e.result="Error: "+t});break;case"GET":this.$http.get(t.url,t.message).success(function(t){e.result="Result: "+t}).error(function(t){e.result="Error: "+t});break;case"DELETE":this.$http["delete"](t.url,t.message).success(function(){e.result="OK"}).error(function(t){e.result="Error: "+t})}}},e.$inject=["$scope","$http","messageBusService","$timeout"],e}();e.PostManCtrl=t}(PostMan||(PostMan={}));var PostMan;!function(e){var t=function(){function e(e,t,r,i){this.$scope=e,this.$timeout=t,this.$messageBus=r,this.$dashboardService=i,e.vm=this,e.methods=[{name:"GET"},{name:"PUT"},{name:"POST"},{name:"DELETE"}];var a=e.$parent;this.widget=a.data,e.data=this.widget.data,e.data.messages?e.selectedMessage=e.data.messages[0]:(e.data.messages=[],this.addMessage())}return e.prototype.addMessage=function(){this.$scope.selectedMessage={name:"New message...",httpMethod:this.$scope.methods[2]},this.$scope.data.messages.push(this.$scope.selectedMessage)},e.prototype.deleteMessage=function(){if(this.$scope.selectedMessage){var e=this.$scope.data.messages.indexOf(this.$scope.selectedMessage);0>e||(this.$scope.data.messages.slice(e,1),0===this.$scope.data.messages.length?this.addMessage():this.$scope.selectedMessage=this.$scope.data.messages[0])}},e.$inject=["$scope","$timeout","messageBusService","dashboardService"],e}();e.PostManEditCtrl=t}(PostMan||(PostMan={}));var Presentation;!function(e){var t=function(){function e(e,t,r,i){var a=this;this.$rootScope=e,this.layerService=t,this.messageBusService=r,this.dashboardService=i,this.presentations={},this.activePresentation={},r.subscribe("layer",function(e,t){if(!(t&&!t.tags||t.tags&&t.tags.indexOf("presentation")<0))switch(e){case"activated":a.addSlidesFromLayer(t);break;case"deactivate":a.removeSlidesFromLayer(t)}})}return e.prototype.createPresentation=function(e){if(!this.presentations.hasOwnProperty(e.id)){var t={title:e.title,slides:[]};return this.presentations[e.id]=t,t}},e.prototype.addSlidesFromLayer=function(e){this.removeSlidesFromLayer(e);var t=this.createPresentation(e),r=csComp.Services.ProjectLayer.getFeatures(e);r&&r.length&&(r.forEach(function(e){if(e.properties.hasOwnProperty("_slide")){var r=e.properties._slide;r.featureId=e.id,t.slides.push(r)}}),t.slides.sort(function(e,t){return e.index-t.index})),this.messageBusService.publish("presentation","added",e.id)},e.prototype.removeSlidesFromLayer=function(e){this.presentations.hasOwnProperty(e.id)&&(delete this.presentations[e.id],this.messageBusService.publish("presentation","removed",e.id))},e.prototype.save=function(e){var t=this;if(this.presentations.hasOwnProperty(e.id)){var r=this.presentations[e.id];r.slides.forEach(function(r){var i=t.layerService.findFeature(e,r.featureId);if(i)i.properties._slide=r,t.layerService.saveFeature(i);else{var a=new csComp.Services.Feature;a.id=r.featureId=csComp.Helpers.getGuid(),a.properties={},a.properties._slide=r,t.layerService.createFeature(a,e)}})}},e.prototype.isFirstPresentation=function(e){return 0===Object.keys(this.presentations).length||e===this.presentations[Object.keys(this.presentations)[0]]},e.prototype.isLastPresentation=function(e){return 0===Object.keys(this.presentations).length||e===this.presentations[Object.keys(this.presentations)[Object.keys(this.presentations).length-1]]},e.prototype.getNextPrevPresentation=function(e,t){var r,i=!1;for(var a in this.presentations)if(this.presentations.hasOwnProperty(a)){if(i)return this.presentations[a];if(this.presentations[a]===e){if(!t)return this.presentations[r];i=!0}r=a}return this.presentations[r]},e.$inject=["$rootScope","layerService","messageBusService","dashboardService"],e}();e.PresentationService=t;var r="csComp";try{e.myModule=angular.module(r)}catch(i){e.myModule=angular.module(r,[])}e.myModule.service("presentationService",e.PresentationService)}(Presentation||(Presentation={}));var Presentation;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("presentationEdit",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/Presentation/PresentationWidget-edit.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i,a){var o=this;this.$scope=e,this.$http=t,this.layerService=r,this.messageBusService=i,this.$timeout=a,this.layers=[],e.vm=this;var s=e.$parent;this.widget=s.widget||s.data,e.data=this.widget.data;var n=e.data.selectedLayerId;r.project.groups.forEach(function(e){e.layers.forEach(function(e){o.layers.push(e),e.id===n&&(o.selectedLayer=e)})})}return e.prototype.update=function(){this.selectedLayer&&(this.widget.data.selectedLayerId=this.selectedLayer.id)},e.$inject=["$scope","$http","layerService","messageBusService","$timeout"],e}();e.PresentationWidgetEditCtrl=i}(Presentation||(Presentation={}));var Presentation;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("presentation",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/Presentation/PresentationWidget.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.layerService=t,this.messageBusService=r,this.presentationService=i,this.isEditing=!1,e.vm=this;var o=e.$parent;this.widget=o.widget,this.widget||(this.widget={id:"rightPanel"}),i.activePresentation.hasOwnProperty(this.widget.id)?(this.activeSlideIndex=0,this.updateActiveSlide()):this.activePresentation={},r.subscribe("presentation",function(e,t){switch(e){case"added":if(a.activePresentation&&a.activePresentation.slides&&a.activePresentation.slides.length>0)return;a.activeLayerId=t,a.activePresentation=i.presentations[t],a.activeSlideIndex=0,a.updateActiveSlide();break;case"removed":a.activeLayerId===t&&(a.activePresentation=null)}})}return Object.defineProperty(e.prototype,"activePresentation",{get:function(){return this.presentationService.activePresentation[this.widget.id]},set:function(e){this.presentationService.activePresentation[this.widget.id]=e},enumerable:!0,configurable:!0}),e.prototype.updateActiveSlide=function(){this.activeSlide={},this.activePresentation&&this.activePresentation.slides&&0!==this.activePresentation.slides.length&&(this.activeSlide=this.activePresentation.slides[this.activeSlideIndex],this.activeSlide&&this.activeSlide.boundingBox&&this.layerService.activeMapRenderer.fitBounds(this.activeSlide.boundingBox))},e.prototype.selectSlide=function(e){e>=this.activePresentation.slides.length||(this.activeSlideIndex=e,this.updateActiveSlide())},Object.defineProperty(e.prototype,"isFirstSlide",{get:function(){return!this.activePresentation||!this.activePresentation.slides||0===this.activeSlideIndex},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isLastSlide",{get:function(){return!this.activePresentation||!this.activePresentation.slides||this.activeSlideIndex===this.activePresentation.slides.length-1},enumerable:!0,configurable:!0}),e.prototype.isActiveSlide=function(e){return this.activeSlideIndex===e},e.prototype.nextSlide=function(){this.isLastSlide||(this.activeSlideIndex++,this.updateActiveSlide())},e.prototype.previousSlide=function(){this.isFirstSlide||(this.activeSlideIndex--,this.updateActiveSlide())},Object.defineProperty(e.prototype,"isFirstPresentation",{get:function(){return this.presentationService.isFirstPresentation(this.activePresentation)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isLastPresentation",{get:function(){return this.presentationService.isLastPresentation(this.activePresentation)},enumerable:!0,configurable:!0}),e.prototype.nextPresentation=function(){this.activePresentation=this.presentationService.getNextPrevPresentation(this.activePresentation,!0),this.activeSlideIndex=0,this.updateActiveSlide()},e.prototype.previousPresentation=function(){this.activePresentation=this.presentationService.getNextPrevPresentation(this.activePresentation,!1),this.activeSlideIndex=0,this.updateActiveSlide()},e.prototype.toggleEdit=function(){this.isEditing=!this.isEditing,this.isEditing?this.layerService.visual.leftPanelVisible=!1:this.save()},e.prototype.addSlide=function(){this.activeSlide={content:""},this.activeSlideIndex++,this.activeSlideIndex===this.activePresentation.slides.length?this.activePresentation.slides.push(this.activeSlide):this.activePresentation.slides.splice(this.activeSlideIndex,0,this.activeSlide),this.reindexSlides(),this.toggleEdit(),this.save()},e.prototype.reindexSlides=function(){var e=0;this.activePresentation.slides.forEach(function(t){return t.index=e++})},e.prototype.deleteSlide=function(){var e=this;this.messageBusService.confirm("Delete slide?","Are you sure you want to delete this slide?",function(t){if(t){var r=e.activeSlide.featureId,i=e.layerService.findLayer(e.activeLayerId),a=e.layerService.findFeature(i,r);if(a.properties.hasOwnProperty("Name")&&"_slide"!==a.properties.Name)delete a.properties._slide;else if(i.data&&i.data.features){
var o=i.data.features.indexOf(a);i.data.features.splice(o,1),e.layerService.removeFeature(a,!0)}var s=e.activeSlideIndex,n=e.activePresentation.slides;if(n.splice(s,1),0===n.length)return e.toggleEdit(),void e.save();s>=n.length&&(s--,e.activeSlideIndex=s),e.reindexSlides(),e.updateActiveSlide(),e.save()}})},e.prototype.saveLocation=function(){this.activeSlide.boundingBox=this.layerService.activeMapRenderer.getExtent(),this.messageBusService.notify("Location saved","The current location has been saved with this slide."),this.save()},e.prototype.save=function(){var e=this.layerService.findLayer(this.activeLayerId);e&&("$apply"!==this.$scope.$root.$$phase&&"$digest"!==this.$scope.$root.$$phase&&this.$scope.$digest(),this.presentationService.save(e))},e.$inject=["$scope","layerService","messageBusService","presentationService"],e}();e.PresentationWidgetCtrl=i}(Presentation||(Presentation={}));var RangeWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("rangewidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/RangeWidget/RangeWidget.tpl.html",replace:!0,transclude:!1,controller:e.RangeWidgetCtrl}}])}(RangeWidget||(RangeWidget={}));var RangeWidget;!function(e){var t=function(){function e(){}return e}();e.RangeWidgetData=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$timeout=t,this.$translate=r,this.$layerService=i,this.$messageBus=a,this.$mapService=o,this.mBusHandles=[],this.filterValue=0,e.vm=this;var n=e.$parent;this.widget=n.widget,this.parentWidget=$("#"+this.widget.elementId).parent(),e.data=this.widget.data,e.minimized=!1,this.parentWidget.hide(),this.mBusHandles.push(this.$messageBus.subscribe("filters",function(t,r){if(r&&r===e.data.groupId)switch(s.group=s.$layerService.findGroupById(r),t){case"updated":s.parentWidget.show(),s.createFilter(r)}})),this.mBusHandles.push(this.$messageBus.subscribe("updatelegend",function(e,t){switch(e){case"hidelegend":s.close()}}))}return e.prototype.minimize=function(){this.$scope.minimized=!this.$scope.minimized,this.$scope.minimized?this.parentWidget.css("height","30px"):this.parentWidget.css("height",this.widget.height)},e.prototype.canClose=function(){return this.$scope.data.hasOwnProperty("canClose")?this.$scope.data.canClose:!0},e.prototype.close=function(){this.parentWidget.hide()},e.prototype.stop=function(){var e=this;this.mBusHandles&&this.mBusHandles.length>0&&this.mBusHandles.forEach(function(t){e.$messageBus.unsubscribe(t)})},e.prototype.selectFeature=function(e){e&&e.isSelected&&this.parentWidget.show()},e.prototype.createFilter=function(e){if(this.group){var t=(this.$layerService.findPropertyTypeById(this.$scope.data.propId),this.$scope.data.propId.split("#").pop());this.group.ndx&&(this.filterDim=this.group.ndx.dimension(function(e){if(!e.properties.hasOwnProperty(t))return null;var r=e.properties[t];return null===r||void 0===r||isNaN(r)?null:r}),this.applyFilter())}},e.prototype.applyFilter=function(){null===this.filterValue||void 0===this.filterValue||isNaN(this.filterValue)||this.filterDim&&(this.filterValue>0?this.filterDim.filter([this.filterValue,1/0]):this.filterDim.filterAll(),this.group.filterResult=this.filterDim.top(1/0),this.$messageBus.publish("filters","updateGroup",this.group.id))},e.$inject=["$scope","$timeout","$translate","layerService","messageBusService","mapService"],e}();e.RangeWidgetCtrl=r}(RangeWidget||(RangeWidget={}));var SimState;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("simstateEdit",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/SimState/SimState.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i){this.$scope=e,this.$http=t,this.messageBusService=r,this.$timeout=i,e.vm=this}return e.$inject=["$scope","$http","messageBusService","$timeout"],e}();e.SimStateEditCtrl=i}(SimState||(SimState={}));var SimState;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("simstate",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/SimState/SimState.tpl.html",replace:!0,transclude:!1,controller:i}}]);var i=function(){function e(e,t,r,i){var a=this;this.$scope=e,this.$http=t,this.messageBusService=r,this.$timeout=i,this.states={},e.vm=this,r.serverSubscribe("Sim.SimState.","key",function(e,t){t&&t.hasOwnProperty("data")&&t.data.hasOwnProperty("item")&&a.$timeout(function(){var e=t.data.item;"Exit"===e.state?delete a.states[e.id]:a.states[e.name]=e},0)})}return e.$inject=["$scope","$http","messageBusService","$timeout"],e}();e.SimStateCtrl=i}(SimState||(SimState={}));var SimTimeController;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("simtimecontrollerEdit",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/SimTimeController/SimTimeController-edit.tpl.html",replace:!0,transclude:!1,controller:e.SimTimeControllerEditCtrl}}])}(SimTimeController||(SimTimeController={}));var SimTimeController;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("simtimecontroller",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/SimTimeController/SimTimeController.tpl.html",replace:!0,transclude:!1,controller:e.SimTimeControllerCtrl}}])}(SimTimeController||(SimTimeController={}));var SimTimeController;!function(e){!function(e){e[e.Stopped=0]="Stopped",e[e.Playing=1]="Playing",e[e.Paused=2]="Paused"}(e.PlayState||(e.PlayState={}));var t=e.PlayState;!function(e){e[e.Start=0]="Start",e[e.Pause=1]="Pause",e[e.Stop=2]="Stop",e[e.Run=3]="Run",e[e.Finish=4]="Finish",e[e.Exit=5]="Exit"}(e.SimCommand||(e.SimCommand={}));var r=e.SimCommand,i=function(){function e(e,i,a,o){var s=this;this.$scope=e,this.$http=i,this.messageBusService=a,this.$timeout=o,this.timeSinceStartString="00:00",this.speed=1,this.startTime=new Date,this.time=this.startTime,this.isOpen=!1,this.timeOptions={readonlyInput:!1,showMeridian:!1},this.isPlaying=!1,this.isPaused=!1,this.isStopped=!0,e.vm=this;var n=e.$parent;this.editorData=n.widget.data,this.httpMethod="POST",this.editorData.hasOwnProperty("httpMethod")&&this.editorData.httpMethod.hasOwnProperty("name")&&(this.httpMethod=this.editorData.httpMethod.name.toUpperCase()),this.url=this.editorData.url||"api/keys/simTime",this.fsm=new FSM.FiniteStateMachine(t.Stopped),this.fsm.fromAny(t).to(t.Stopped).on(r.Stop),this.fsm.from(t.Stopped).to(t.Playing).on(r.Start),this.fsm.from(t.Playing).to(t.Stopped).on(r.Stop),this.fsm.from(t.Playing).to(t.Paused).on(r.Pause),this.fsm.from(t.Paused).to(t.Stopped).on(r.Stop),this.fsm.from(t.Paused).to(t.Playing).on(r.Start),this.fsm.onTransition=function(e,r){console.log("Moving from "+t[e]+" to "+t[r]+".")},this.fsm.onEnter(t.Stopped,function(e){return s.$timeout(function(){s.time=s.startTime,s.timeSinceSimulationStart=0,s.updateTimeSinceSimStart(),s.isStopped=!0,s.isPlaying=!1,s.isPaused=!1},0),s.sendSimTimeMessage(r.Stop),!0}),this.fsm.onEnter(t.Playing,function(e){return s.$timeout(function(){s.isPlaying=!0,s.isStopped=!1,s.isPaused=!1},0),s.sendSimTimeMessage(r.Start),!0}),this.fsm.onEnter(t.Paused,function(e){return s.$timeout(function(){s.isPaused=!0,s.isStopped=!1,s.isPlaying=!1},0),s.sendSimTimeMessage(r.Pause),!0}),console.log("Simtimecontroller constructed")}return e.prototype.updateTimeSinceSimStart=function(){var e=this.time.valueOf()-this.startTime.valueOf(),t=Math.floor(e/864e5);e-=864e5*t;var r=Math.floor(e/36e5);e-=36e5*r;var i=Math.floor(e/6e4);e-=6e4*i;var a=(Math.floor(e/1e3),"");t>0&&(a=t+"d "),a+=(10>r?"0"+r:r)+":"+(10>i?"0"+i:i),this.timeSinceStartString=a},e.prototype.subscribeToSimTime=function(){var e=this;this.messageBusHandle=this.messageBusService.serverSubscribe("Sim.SimTime","key",function(t,r){r&&r.hasOwnProperty("data")&&r.data.hasOwnProperty("item")&&r.data.item&&e.$timeout(function(){r.data.item.hasOwnProperty("simTime")?e.time=new Date(+r.data.item.simTime):e.time=new Date(r.data.item),isNaN(e.time.getTime())?console.log("ERROR processing Sim.SimTime message! Received: (input: "+JSON.stringify(r.data.item,null,2)):(e.updateTimeSinceSimStart(),e.messageBusService.publish("timeline","setFocus",e.time))},0)})},e.prototype.play=function(){this.messageBusHandle||this.subscribeToSimTime(),this.fsm.trigger(r.Start)},e.prototype.pause=function(){this.fsm.trigger(r.Pause)},e.prototype.stop=function(){this.messageBusHandle&&(this.messageBusService.serverUnsubscribe(this.messageBusHandle),this.messageBusHandle=null),this.fsm.trigger(r.Stop)},e.prototype.increaseSpeed=function(){this.speed*=2,this.speedChanged()},e.prototype.decreaseSpeed=function(){this.speed/=2,this.speedChanged()},e.prototype.setSpeed=function(e){this.speed=e,this.speedChanged()},e.prototype.setTime=function(e){this.fsm.currentState===t.Stopped&&(this.startTime=this.time=new Date(e))},e.prototype.openCalendar=function(e){e.preventDefault(),e.stopPropagation(),this.isOpen=!0},e.prototype.speedChanged=function(){this.fsm.currentState===t.Playing&&this.sendSimTimeMessage(r.Start)},e.prototype.sendSimTimeMessage=function(e){var t={simTime:this.time.valueOf().toString(),simSpeed:this.speed.toString(),simCmd:r[e],type:"simTime"};switch(this.httpMethod){case"POST":this.$http.post(this.url,t).error(function(e){return alert("Failed to deliver message: "+JSON.stringify({err:e}))});break;case"PUT":this.$http.put(this.url,t).error(function(e){return alert("Failed to deliver message: "+JSON.stringify({err:e}))})}},e.$inject=["$scope","$http","messageBusService","$timeout"],e}();e.SimTimeControllerCtrl=i}(SimTimeController||(SimTimeController={}));var SimTimeController;!function(e){var t=function(){function e(e,t,r,i){this.$scope=e,this.$timeout=t,this.$messageBus=r,this.$dashboardService=i,e.vm=this,e.methods=[{name:"GET"},{name:"PUT"},{name:"POST"},{name:"DELETE"}];var a=e.$parent;this.widget=a.data,e.data=this.widget.data,e.data.httpMethod||(e.data.httpMethod=e.methods[2]),e.data.url||(e.data.url="api/keys/simTime")}return e.$inject=["$scope","$timeout","messageBusService","dashboardService"],e}();e.SimTimeControllerEditCtrl=t}(SimTimeController||(SimTimeController={}));var TableWidget;!function(e){var t="csComp";try{e.myModule=angular.module(t)}catch(r){e.myModule=angular.module(t,[])}e.myModule.directive("tablewidget",[function(){return{restrict:"E",scope:{},templateUrl:"directives/Widgets/TableWidget/TableWidget.tpl.html",replace:!0,transclude:!1,controller:e.TableWidgetCtrl}}])}(TableWidget||(TableWidget={}));var TableWidget;!function(e){var t=function(){function e(){}return e}();e.TableWidgetData=t;var r=function(){function e(e,t,r,i,a,o){var s=this;this.$scope=e,this.$timeout=t,this.$layerService=r,this.$messageBus=i,this.$mapService=a,this.$sce=o,e.vm=this;var n=e.$parent;if(this.widget=n.widget,this.widget.directive&&"tablewidget"!==this.widget.directive&&console.log("Warning: "+this.widget.directive+" does not belong in TableWidgetCtrl!!! Id: "+this.widget.id),e.data=this.widget.data,e.data.tableHtml="<table></table>",e.minimized=!1,this.dataProperties={},this.parentWidget=$("#"+this.widget.elementId).parent(),"undefined"!=typeof e.data.featureTypeName&&"undefined"!=typeof e.data.dynamicProperties&&e.data.dynamicProperties.length>0&&(this.parentWidget.hide(),this.$messageBus.subscribe("feature",function(e,t){switch(e){case"onFeatureDeselect":case"onFeatureSelect":s.selectFeature(t)}})),"undefined"!=typeof e.data.url){var c=e.data.url;if(e.data.useLanguagePrefix){var l=c.split("."),p=this.$layerService.currentLocale+"."+l.pop();l.push(p),c=l.join(".")}$.get(c,function(r){t(function(){try{e.data.content=JSON.parse(r),s.createTable(),s.updateTable()}catch(t){console.log("Error parsing table: "+t.message),console.log("Table type: "+typeof r)}},0)})}"undefined"!=typeof e.data.dataSourceUrl&&(c=e.data.dataSourceUrl,$.get(c,function(e){t(function(){s.dataProperties=JSON.parse(e),s.replaceKeys()},0)}))}return e.prototype.createTable=function(){var e=this.$scope.data.content,t='<table style="width:100%">';e.hasOwnProperty("columnHeaders")&&(t+='<tr class="tablewidget-row">',e.columnHeaders.forEach(function(r){t+='<th class="tablewidget-cell border-bottom" style="width:'+100/(e.nrOfCols+1)+'%">'+r+"</th>"}),t+="</tr>",e.hasOwnProperty("rowTitles")&&e.hasOwnProperty("datagrid")&&(e.datagrid.forEach(function(r,i){t+='<tr class="tablewidget-row">',t+='<th class="border-right">'+e.rowTitles[i]+"</th>",r.forEach(function(r,a){var o=e.stylegrid?e.stylegrid[i][a]:"";t+='<td class="tablewidget-cell" style="'+o+'">'+e.datagrid[i][a]+"</td>"}),t+="</tr>"}),t+="</table>",this.$scope.data.tableHtml=t))},e.prototype.updateTable=function(){var e=$("#"+this.widget.elementId).find("#widgettable-container");e.html(this.$scope.data.tableHtml)},e.prototype.minimize=function(){this.$scope.minimized=!this.$scope.minimized,this.$scope.minimized?this.parentWidget.css("height","30px"):this.parentWidget.css("height",this.widget.height)},e.prototype.canClose=function(){return this.$scope.data.hasOwnProperty("canClose")?this.$scope.data.canClose:!0},e.prototype.close=function(){this.parentWidget.hide()},e.prototype.escapeRegExp=function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},e.prototype.replaceAll=function(e,t,r){return e.replace(new RegExp(this.escapeRegExp(t),"g"),r)},e.prototype.selectFeature=function(e){var t=this;return e&&e.isSelected&&e.featureTypeName===this.$scope.data.featureTypeName?void this.$timeout(function(){var r=t.$scope.data.tableHtml,i=0;t.$scope.data.dynamicProperties.forEach(function(a){var o="{{"+i++ +"}}",s="";if(e.properties.hasOwnProperty(a)){var n=t.$layerService.getPropertyType(e,a);s=csComp.Helpers.convertPropertyInfo(n,e.properties[a])}r=t.replaceAll(r,o,s)}),t.parentWidget.show(),t.$scope.data.tableHtml=r,t.updateTable()},0):void this.parentWidget.hide()},e.prototype.replaceKeys=function(){var e=this,t=this.$scope.data.tableHtml;this.$timeout(function(){var r=Object.keys(e.dataProperties);r.forEach(function(r){if(e.dataProperties.hasOwnProperty(r)){var i="{{"+r+"}}",a=e.dataProperties[r];t=e.replaceAll(t,i,a)}}),e.$scope.data.tableHtml=t,e.updateTable()},0)},e.prototype.toTrusted=function(e){try{return void 0===e||null===e?this.$sce.trustAsHtml(e):this.$sce.trustAsHtml(e.toString())}catch(t){return console.log(t+": "+e),""}},e.$inject=["$scope","$timeout","layerService","messageBusService","mapService","$sce"],e}();e.TableWidgetCtrl=r}(TableWidget||(TableWidget={}));var L;!function(e){function t(e,t,i){return new r(e,t,i)}var r=e.Class.extend({initialize:function(t,r,i){this._layer=r,this._userDrawFunc=t,this._layerAdd=this,e.Util.setOptions(this,i)},call:function(e){this.onAdd(e._mapToAdd)},fire:function(e){},drawing:function(e){return this._userDrawFunc=e,this},params:function(t){return e.Util.setOptions(this,t),this},canvas:function(){return this._canvas},redraw:function(){return this._frame||(this._frame=e.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){var r=this;this._map=t,this._canvas=e.DomUtil.create("canvas","leaflet-overlay-layer");var i=this._map.getSize();this._canvas.width=i.x,this._canvas.height=i.y,this._context=this._canvas.getContext("2d"),this._popup=null,this.onMouseMoveDelay=_.throttle(function(t){var i=r._getCanvasPos(),a=r._context.getImageData(t.x-i.left,t.y-i.top,1,1).data;if(a[0]+a[1]+a[2]>0){var o=r._map.containerPointToLatLng(new e.Point(t.x-i.left,t.y-i.top)),s=Math.floor((o.lat-r.options.topLeftLat)/r.options.deltaLat),n=Math.floor((o.lng-r.options.topLeftLon)/r.options.deltaLon),c="";s>=0&&s<r.options.data.length&&n>=0&&n<r.options.data[0].length&&(c=String.format("{0:0.00}",r.options.data[s][n])),r._layer.dataSourceParameters.legendStringFormat?c=String.format(r._layer.dataSourceParameters.legendStringFormat,c):null;var l="<table><td>"+c+"</td></tr></table>";r._popup&&r._map._popup&&r._map._popup._isOpen?r._popup.setLatLng(r._map.containerPointToLatLng(new e.Point(t.x,t.y))).setContent(l):r._popup=e.popup({offset:new e.Point(-25,-15),closeOnClick:!0,autoPan:!1,className:"featureTooltip"}).setLatLng(r._map.containerPointToLatLng(new e.Point(t.x,t.y))).setContent(l).openOn(r._map)}else r._map.closePopup(r._popup),r._popup=null},500),t.getPanes().overlayPane.addEventListener("mousemove",this.onMouseMoveDelay);var a=this._map.options.zoomAnimation&&e.Browser.any3d;e.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(a?"animated":"hide")),t._panes.overlayPane.firstChild?t._panes.overlayPane.insertBefore(this._canvas,t._panes.overlayPane.firstChild):t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this),t.on("resize",this._resize,this),t.options.zoomAnimation&&e.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(e){e.getPanes().overlayPane.removeChild(this._canvas),e.off("moveend",this._reset,this),e.off("resize",this._resize,this),e.getPanes().overlayPane.removeEventListener("mousemove",this.onMouseMoveDelay),e.closePopup(this._popup),this._popup=null,e.options.zoomAnimation&&e.off("zoomanim",this._animateZoom,this),this._canvas=null},addTo:function(e){return e.addLayer(this),this},_getCanvasPos:function(){for(var e=this._canvas,t=0,r=0;e&&"BODY"!=e.tagName;)t+=e.offsetTop,r+=e.offsetLeft,e=e.offsetParent;return{top:t,left:r}},_resize:function(e){this._canvas.width=e.newSize.x,this._canvas.height=e.newSize.y},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);e.DomUtil.setPosition(this._canvas,t),this._redraw()},_redraw:function(){var e=this._map.getSize(),t=this._map.getBounds(),r=180*e.x/(20037508.34*(t.getEast()-t.getWest())),i=this._map.getZoom();this._userDrawFunc&&this._userDrawFunc(this,this._layer,{canvas:this._canvas,bounds:t,size:e,zoomScale:r,zoom:i,options:this.options}),this._frame=null},_animateZoom:function(t){var r=this._map.getZoomScale(t.zoom),i=this._map._getCenterOffset(t.center)._multiplyBy(-r).subtract(this._map._getMapPanePos());e.DomUtil.getTranslateString?this._canvas.style[e.DomUtil.TRANSFORM]=e.DomUtil.getTranslateString(i)+" scale("+r+")":this._canvas.style[e.DomUtil.TRANSFORM]="scale("+r+")"}});e.canvasOverlay=t}(L||(L={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.render=function(e,t,r){t.mapLayer=new L.LayerGroup,e.map.map.addLayer(t.mapLayer),t.data&&t.data.features&&t.data.features.forEach(function(e){var i=r.addFeature(e);i&&(t.group.markers[e.id]=i)})},e.remove=function(e,t){var r=t.group;if(r.clustering){var i=r._cluster;e.project.features.forEach(function(e){if(e.layerId===t.id)try{i.removeLayer(t.group.markers[e.id]),delete t.group.markers[e.id]}catch(r){}})}else if(e.project.features.forEach(function(r){r.layerId===t.id&&(t.group.markers.hasOwnProperty(r.id)?delete t.group.markers[r.id]:r.geometry&&"Overlay"===r.geometry.type&&e.map.map.removeLayer(r._gui.imageOverlay))}),e.map.map&&t.mapLayer)try{e.map.map.removeLayer(t.mapLayer)}catch(a){}},e}();e.GeojsonRenderer=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function r(){}return r.render=function(i,a){var o,s=a.dataSourceParameters,n=[];if("number"==typeof s.contourLevels){o=[];for(var c=s.contourLevels,l=(s.maxThreshold-s.minThreshold)/c,p=s.minThreshold+l/2;p<s.maxThreshold;p+=l)o.push(Math.round(10*p)/10)}else o=s.contourLevels;var u=new t.GroupStyle(i.$translate);u.id=e.Helpers.getGuid(),u.title=s.legendDescription?s.legendDescription:a.title,u.meta=null,u.visualAspect="fillColor",u.availableAspects=["fillColor"],u.info={min:0,max:0,count:0,mean:0,varience:0,sd:0},u.fixedColorRange=!0,u.enabled=!0,u.group=a.group,s.legend?(u.property="",u.canSelectColor=!1,u.colors=["#ffffff","#000000"],u.activeLegend=s.legend,u.activeLegend.legendEntries.forEach(function(e){n.push({val:e.value,color:e.color})})):(u.property="gridlayer",u.canSelectColor=!0,u.colors=[s.minColor?s.minColor:"#00fbff",s.maxColor?s.maxColor:"#0400ff"],u.activeLegend={legendKind:"interpolated",description:u.title,visualAspect:"fillColor",legendEntries:[]}),i.saveStyle(a.group,u);var d=L.canvasOverlay(r.drawFunction,a,{data:a.data,noDataValue:s.noDataValue,topLeftLat:s.startLat,topLeftLon:s.startLon,deltaLat:s.deltaLat,deltaLon:s.deltaLon,min:s.minThreshold,max:s.maxThreshold,minColor:u.colors[0],maxColor:u.colors[1],areColorsUpdated:!1,levels:o,legend:n,opacity:a.opacity?+a.opacity/100:.3});a.mapLayer=new L.LayerGroup,i.map.map.addLayer(a.mapLayer),a.mapLayer.addLayer(d)},r.drawFunction=function(e,t,r){var i=this._map,a=r.options,o=a.data;if(o){var s=o.length,n=o[0].length,c=r.size,l=a.legend;if(0===l.length||a.areColorsUpdated){l=[],"#"!==a.minColor[0]&&(a.minColor=ColorExt.Utils.colorNameToHex(a.minColor)),"#"!==a.maxColor[0]&&(a.maxColor=ColorExt.Utils.colorNameToHex(a.maxColor));for(var p=ColorExt.Utils.rgbToHue(a.minColor),u=ColorExt.Utils.rgbToHue(a.maxColor),d=0;d<a.levels.length;d++){var h=a.levels[d];l.push({val:h,color:ColorExt.Utils.toColor(h,a.levels[0],a.levels[a.levels.length-1],p,u)})}t.group.styles&&t.group.styles.length>0&&(t.group.styles[0].activeLegend={legendKind:"interpolated",description:t.group.styles[0].title,visualAspect:"fillColor",legendEntries:[]},l.forEach(function(e){var r={label:String.format(t.dataSourceParameters.legendStringFormat||"{0:00}",e.val),value:e.val,color:e.color};t.group.styles[0].activeLegend.legendEntries.push(r)})),e.options.legend=a.legend=l,a.areColorsUpdated=!1}var f=a.min||Number.MIN_VALUE,y=a.max||Number.MAX_VALUE,m=i.latLngToContainerPoint(new L.LatLng(a.topLeftLat,a.topLeftLon)),g=i.latLngToContainerPoint(new L.LatLng(a.topLeftLat+s*a.deltaLat,a.topLeftLon+n*a.deltaLon)),v=m.x,S=m.y,b=(g.x-m.x)/n,$=i.latLngToContainerPoint(new L.LatLng(a.topLeftLat+a.deltaLat,a.topLeftLon)),w=$.y-m.y,T=r.canvas.getContext("2d");if(T.clearRect(0,0,c.x,c.y),!(v>c.x||S>c.y||g.x<0||g.y<0)){var E=0,C=s,M=n;-b>v&&(E=-Math.ceil(v/b),v+=E*b),g.x>c.x&&(M-=Math.floor((g.x-c.x)/b)),g.y>c.y&&w>0&&(C-=Math.floor((g.y-c.y)/w));var P=a.noDataValue;T.globalAlpha=a.opacity||.3;for(var _=S,F=a.topLeftLat,x=0;C>x;x++){F+=a.deltaLat;var O=i.latLngToContainerPoint(new L.LatLng(F,a.topLeftLon)).y;if(w=O-_,-w>=_||0===w)_=O;else{for(var A=v,I=E;M>I;I++){var k=o[x][I];if(k===P||f>k||k>y)A+=b;else{var D=l.reduce(function(e,t){return Math.abs(t.val-k)<Math.abs(e.val-k)?t:e});T.fillStyle=D.color,T.fillRect(A,_,b,w),A+=b}}_=O}}}}},r}();t.GridLayerRenderer=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.render=function(e,t,r){if(!t.quickRefresh||1!=t.quickRefresh){(new Date).getTime();if(t.isLoading=!0,t.group.clustering){var i=L.geoJson(t.data,{pointToLayer:function(e,t){return r.createFeature(e)},onEachFeature:function(e,i){t.group.markers[e.id]=i,i.on({mouseover:function(e){return r.showFeatureTooltip(e,t.group)},mouseout:function(e){return r.hideFeatureTooltip(e)}})}});t.group._cluster.addLayer(i)}else{if(t.mapLayer=new L.LayerGroup,e.map.map.addLayer(t.mapLayer),t.data&&t.data.features)var a=L.geoJson(t.data,{onEachFeature:function(e,i){t.group.markers[e.id]=i,i.on({mouseover:function(e){return r.showFeatureTooltip(e,t.group)},mouseout:function(e){return r.hideFeatureTooltip(e)},mousemove:function(e){return r.updateFeatureTooltip(e)},click:function(t){r.selectFeature(e)}})},style:function(e,r){return t.group.markers[e.id]=r,e.effectiveStyle},pointToLayer:function(e,t){return r.createFeature(e)}});else var a=L.geoJson([]);e.project.features.forEach(function(r){if(r.layerId===t.id){var i=e.getFeatureType(r);r.properties.Name=r.properties[i.style.nameLabel]}}),t.mapLayer.addLayer(a),t.isLoading=!1;(new Date).getTime()}}},e}();e.HeatmapRenderer=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.render=function(e,t){var r=t.url.split("|"),i=(r[0],new L.TileLayer.MVTSource({url:"bagbuurt/{z}/{x}/{y}.json",debug:!0,clickableLayers:[],getIDForLayerFeature:function(e){return e.properties.id},style:function(e){var t={},r=e.type;switch(r){case 1:t.color="rgba(49,79,79,1)",t.radius=5,t.selected={color:"rgba(255,255,0,0.5)",radius:6};break;case 2:t.color="rgba(161,217,155,0.8)",t.size=3,t.selected={color:"rgba(255,25,0,0.5)",size:4};break;case 3:t.color=a,t.outline={color:o,size:1},t.selected={color:"rgba(255,140,0,0.3)",outline:{color:"rgba(255,140,0,1)",size:2}}}return t}})),a="rgba(149,139,255,0.4)",o="rgb(20,20,20)";t.mapLayer=new L.LayerGroup,i.setOpacity(t.opacity/100),e.map.map.addLayer(t.mapLayer),t.mapLayer.addLayer(i),i.on("loading",function(r){t.isLoading=!0,e.$rootScope.$apply(),"$apply"!==e.$rootScope.$$phase&&"$digest"!==e.$rootScope.$$phase&&e.$rootScope.$apply()}),i.on("load",function(r){t.isLoading=!1,"$apply"!==e.$rootScope.$$phase&&"$digest"!==e.$rootScope.$$phase&&e.$rootScope.$apply()}),t.isLoading=!0},e}();e.MVTLayerRenderer=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function r(){}return r.render=function(t,i){var a=i.url.split("|"),o=a[0];if(i.timeDependent){var s=t.project.timeLine.focus;if(i.timeResolution){var n=i.timeResolution;s=Math.floor(s/n)*n}var c=new Date(0);c.setUTCSeconds(s/1e3);var l=c.yyyymmdd(),p=c.getHours(),u=c.getMinutes(),d=c.getSeconds(),h=e.Utils.twoDigitStr(p)+e.Utils.twoDigitStr(u)+e.Utils.twoDigitStr(d);o+="&time="+l+h}else i.disableCache&&(i.cacheKey=(new Date).getTime().toString(),o+="&cache="+i.cacheKey);var f=L.tileLayer(o,{attribution:i.description});i.mapLayer=new L.LayerGroup,f.setOpacity(i.opacity/100),t.map.map.addLayer(i.mapLayer),a.length>1&&r.addUtfGrid(t,i,a[1]),i.mapLayer.addLayer(f),f.on("loading",function(e){i.isLoading=!0,t.$rootScope.$apply(),"$apply"!==t.$rootScope.$$phase&&"$digest"!==t.$rootScope.$$phase&&t.$rootScope.$apply()}),f.on("load",function(e){i.isLoading=!1,"$apply"!==t.$rootScope.$$phase&&"$digest"!==t.$rootScope.$$phase&&t.$rootScope.$apply()}),i.isLoading=!0},r.addUtfGrid=function(r,i,a){var o=new L.UtfGrid(a,{resolution:4,useJsonP:!1});o.on("click",function(a){if(a.data){var o=new t.Feature;o.properties=a.data,o.layer=i,o.featureTypeName=i.typeUrl+"#"+i.defaultFeatureType,o.fType=r.getFeatureType(o),o.properties.hasOwnProperty("Name")||e.Helpers.setFeatureName(o,this.propertyTypeData),r.$messageBusService.publish("feature","onFeatureSelect",o),console.log("Clicked: "+JSON.stringify(a.data,null,2))}else console.log("click: nothing")}),r.map.map.addLayer(o)},r}();t.TileLayerRenderer=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.render=function(t,r){var i=(r.dataSourceParameters,L.canvasOverlay(e.drawFunction,r,{features:r.data.features,opacity:r.opacity?+r.opacity/100:.3}));r.mapLayer=new L.LayerGroup,t.map.map.addLayer(r.mapLayer),r.mapLayer.addLayer(i)},e.drawFunction=function(e,t,r){var i=(this._map,r.options),a=i.features;if(a){var o=4096,s=0,n=r.canvas.getContext("2d");n.clearRect(0,0,r.canvas.width,r.canvas.height),n.strokeStyle="red",n.fillStyle="rgba(255,255,0,0.1)";for(var c=0;c<a.length;c++){var l=a[c],p=l.type;n.beginPath();for(var u=0;u<l.geometry.length;u++){var d=l.geometry[u];if(1!==p)for(var h=0;h<d.length;h++){var f=d[h],y=f[0]/o*256,m=f[1]/o*256;h?n.lineTo(y+s,m+s):n.moveTo(y+s,m+s)}else n.arc(d[0],d[1],2,0,2*Math.PI,!1)}3!==p&&1!==p||n.fill("evenodd"),n.stroke()}}},e}();e.VectorTileRenderer=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e.getUrl=function(e,t){var r=e.url;return e.timeDependent&&(t.setMinutes(5*Math.floor(t.getMinutes()/5)),e.url+="&time="+moment(t).format("YYYY-MM-DDTHH:mm:SS")+"Z"),e._gui.wmsurl=r,r},e.render=function(t,r){var i=(e.getUrl(r,t.project.timeLine.focusDate()),L.tileLayer.wms(r.url,{layers:r.wmsLayers,opacity:r.opacity/100,format:"image/png",transparent:!0,attribution:r.description,tiled:!0}));r.mapLayer=new L.LayerGroup,t.map.map.addLayer(r.mapLayer),r.mapLayer.addLayer(i),r._gui.wmsleaflet=i,i.on("loading",function(e){r.isLoading=!0,t.$rootScope.$apply(),"$apply"!=t.$rootScope.$$phase&&"$digest"!=t.$rootScope.$$phase&&t.$rootScope.$apply()}),i.on("load",function(e){r.isLoading=!1,"$apply"!=t.$rootScope.$$phase&&"$digest"!=t.$rootScope.$$phase&&t.$rootScope.$apply()}),r.isLoading=!0},e}();e.WmsRenderer=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(e){var t=function(e){function t(t,r){e.call(this),this.$http=t,this.isReady=!0,this.id="OnlineSearchActions",this.searchUrl=r}return __extends(t,e),t.prototype.search=function(e,t){var r=this,i=[];this.getHits(e.query,15,function(e){e.forEach(function(e){i.push({title:e.title,description:e.description,icon:"bower_components/csweb/dist-bower/images/large-marker.png",service:r.id,location:JSON.parse(e.location),score:.99,click:function(){return r.onSelect(e)}})}),t(null,i)})},t.prototype.getHits=function(e,t,r){if(void 0===t&&(t=15),!this.isReady||null===e||e.length<2)return void r([]);var i=e.toLowerCase().split(" "),a=i.join(" & "),o={query:a,nrItems:t},s=[];$.ajax({type:"POST",url:this.searchUrl,data:JSON.stringify(o),contentType:"application/json",dataType:"json",statusCode:{200:function(e){console.log("Received online search result"),e.hasOwnProperty("result")&&(s=e.result),r(s)},404:function(e){console.log("Could not get online search result"),r(s)}},error:function(){console.log("Error getting online search results"),r(s)}})},t.prototype.init=function(t){e.prototype.init.call(this,t)},t.prototype.onSelect=function(e){var t;if("string"==typeof e.location)try{t=JSON.parse(e.location)}catch(r){console.log(r)}t&&t.hasOwnProperty("coordinates")&&this.layerService.$mapService.zoomToLocation(new L.LatLng(t.coordinates[1],t.coordinates[0]),19)},t.prototype.selectFeatureById=function(e,t){},t.prototype.selectFeature=function(e){},t}(e.BasicActionService);e.OnlineSearchActions=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(e){var t=function(e){function t(t,r,i,a){var o=this;void 0===i&&(i="http://dev.virtualearth.net/REST/v1/Locations"),void 0===a&&(a={culture:"nl",userLocation:"52.077857,4.316639"}),e.call(this),this.$http=t,this.apiKey=r,this.searchUrl=i,this.data=a,this.isReady=!0,this.id="BingSearchActions",this.searchCache={},this.debouncedFn=_.debounce(function(e,t){return o.bingRestRequest(e,t)},2500)}return __extends(t,e),t.prototype.init=function(t){e.prototype.init.call(this,t)},t.prototype.search=function(e,t){e.query.length<4||this.debouncedFn(e,t)},t.prototype.bingRestRequest=function(e,t){var r=this;if(this.searchCache.hasOwnProperty(e.query))return void this.geocodeCallback(this.searchCache[e.query],t,e.query);var i=this.searchUrl+"?query="+encodeURIComponent(e.query)+("&culture="+this.data.culture+"&userLocation="+this.data.userLocation+"&maxResults=10&jsonp=JSON_CALLBACK&key="+this.apiKey);this.callRestService(i,function(e,t,i){return r.geocodeCallback(e,t,i)},t,e.query)},t.prototype.callRestService=function(e,t,r,i){this.$http.jsonp(e).success(function(e){t(e,r,i)}).error(function(e,t,r,i){alert(r)})},t.prototype.geocodeCallback=function(e,t,r){var i=this;console.log("BING location search result:"),console.log(JSON.stringify(e,null,2)),this.searchCache[r]=e;
var a=[];e.resourceSets.forEach(function(t){t.resources.forEach(function(t){a.push({type:t.entityType,description:t.entityType,title:t.name,score:"High"===t.confidence?1:.3,icon:e.brandLogoUri,service:i.id,click:function(){return i.onSelect(t)},location:i.swapLatLonInPoint(t.point)})})}),t(null,a)},t.prototype.swapLatLonInPoint=function(e){return{type:e.type,coordinates:[e.coordinates[1],e.coordinates[0]]}},t.prototype.onSelect=function(e){var t=e.point;e.bbox?this.layerService.map.getMap().fitBounds(new L.LatLngBounds(e.bbox.slice(0,2),e.bbox.slice(2,4))):this.layerService.$mapService.zoomToLocation(new L.LatLng(t.coordinates[1],t.coordinates[0]),19)},t}(e.BasicActionService);e.BingSearchAction=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(t){function r(e,r,i,a){var o=this;void 0===i&&(i="https://services.arcgisonline.nl/arcgis/rest/services/Geocoder_BAG/GeocodeServer/findAddressCandidates"),t.call(this),this.$http=e,this.apiKey=r,this.searchUrl=i,this.data=a,this.isReady=!0,this.id="EsriBagSearchAction",this.searchCache={},this.queryUrl=this.searchUrl+"?f=pjson",this.debouncedFn=_.debounce(function(e,t){return o.esriRestRequest(e,t)},1e3)}return __extends(r,t),r.prototype.init=function(e){t.prototype.init.call(this,e)},r.prototype.search=function(e,t){e.query.length<3||this.debouncedFn(e,t)},r.prototype.esriRestRequest=function(e,t){var r=this;if(this.searchCache.hasOwnProperty(e.query))return void this.geocodeCallback(this.searchCache[e.query],t,e.query);var i=this.queryUrl+"&SingleLine="+encodeURIComponent(e.query);this.callRestService(i,function(e,t,i){return r.geocodeCallback(e,t,i)},t,e.query)},r.prototype.callRestService=function(e,t,r,i){this.$http.get(e).success(function(e){t(e,r,i)}).error(function(e,t,r,i){console.log("Error contacting Esri")})},r.prototype.geocodeCallback=function(e,t,r){var i=this;this.searchCache[r]=e;var a=[];e.candidates.forEach(function(e){a.push({title:e.address,type:"BAG",service:i.id,description:"",score:e.score/101,icon:"bower_components/csweb/dist-bower/images/large-marker.png",click:function(){return i.onSelect(e)},location:{type:"Point",coordinates:[e.location.x,e.location.y]}})}),t(null,a)},r.prototype.convertRD=function(t){var r=e.Helpers.GeoExtensions.convertRDToWGS84(t.x,t.y);return{type:"Point",coordinates:[r.latitude,r.longitude]}},r.prototype.onSelect=function(e){this.layerService.$mapService.zoomToLocation(new L.LatLng(e.location.y,e.location.x),16)},r}(t.BasicActionService);t.EsriBagSearchAction=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(e){var t=function(){function e(){}return e}();e.KeywordIndex=t;var r=function(){function e(e,t,r){this.v=Array(2),"number"==typeof e?(this.v[0]=e,this.v[1]=t):this.v=e}return Object.defineProperty(e.prototype,"layerIndex",{get:function(){return this.v[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"featureIndex",{get:function(){return this.v[1]},enumerable:!0,configurable:!0}),e}();e.Entry=r;var i=function(){function e(e,t,r,i,a){this.title=e,this.layerTitle=t,this.groupTitle=r,this.entry=i,this.score=a,this.firstInGroup=!1}return e.prototype.toString=function(){return this.title},Object.defineProperty(e.prototype,"fullTitle",{get:function(){return this.groupTitle+" >> "+this.layerTitle+" >> "+this.title},enumerable:!0,configurable:!0}),e}();e.OfflineSearchResult=i;var a=function(e){function t(t,r){e.call(this),this.$http=t,this.isReady=!0,this.id="OfflineSearchActions";var i=r.replace("project.json","offline_search_result.json");this.loadIndex(i)}return __extends(t,e),t.prototype.loadIndex=function(e){var t=this;this.$http.get(e).success(function(e){t.offlineSearchResult=e;var i=e.keywordIndex,a={};for(var o in i)i.hasOwnProperty(o)&&i[o].forEach(function(e){a.hasOwnProperty(o)||(a[o]=[]),a[o].push(new r(e))});t.offlineSearchResult.keywordIndex=a,t.isReady=!0}).error(function(){console.log("OfflineSearch: error with $http ")})},t.prototype.search=function(e,t){var r=this,i=[],a=this.getHits(e.query,15);a.sort(function(e,t){return t.score-e.score}).forEach(function(e){i.push({title:e.title,description:e.layerTitle+" ("+e.groupTitle+")",score:e.score,icon:"bower_components/csweb/dist-bower/images/large-marker.png",service:r.id,click:function(){return r.onSelect(e)}})}),t(null,i)},t.prototype.getHits=function(e,t){if(void 0===t&&(t=15),!this.isReady||null===e||e.length<1)return[];var r,a=e.toLowerCase().split(" ");for(var o in a){var s=this.getKeywordHits(a[o]);r=r?this.mergeResults(r,s):s}for(var n=[],c=this.offlineSearchResult.layers,l=t,p=0;l>0&&p<r.length;)for(var u=r[p++],d=Math.min(l,u.entries.length),h=0;d>h;h++){var f=u.entries[h],y=c[f.layerIndex];l--,n.push(new i(y.featureNames[f.featureIndex],y.title,y.groupTitle,f,u.score))}var m={};n.forEach(function(e){var t=e.groupTitle+" >> "+e.layerTitle;m.hasOwnProperty(t)||(m[t]=[]),m[t].push(e)}),n=[];for(var g in m)if(m.hasOwnProperty(g)){var v=!0;m[g].forEach(function(e){e.firstInGroup=v,n.push(e),v=!1})}return n},t.prototype.mergeResults=function(e,t){var r=[];return e.forEach(function(e){t.forEach(function(t){e.entries.forEach(function(i){t.entries.forEach(function(a){i.layerIndex===a.layerIndex&&i.featureIndex===a.featureIndex&&r.push({score:e.score*t.score,key:e.key+" "+t.key,entries:[i]})})})})}),r=r.sort(function(e,t){return t.score-e.score})},t.prototype.getKeywordHits=function(e){var t=[],r=this.offlineSearchResult.keywordIndex,i=Object.getOwnPropertyNames(r);return i.forEach(function(i){var a=i.score(e,null);.5>a||t.push({score:a,key:i,entries:r[i]})}),t=t.sort(function(e,t){return t.score-e.score})},t.prototype.init=function(t){e.prototype.init.call(this,t)},t.prototype.onSelect=function(e){var t=this,r=e.entry.layerIndex,i=this.offlineSearchResult.layers[r],a=this.layerService.findLayer(i.id);if(a){if(a.enabled)return void this.selectFeatureById(i.id,e.entry.featureIndex);var o=this.layerService.$messageBusService.subscribe("layer",function(r,i){"activated"===r&&a.url===i.url&&(t.selectFeatureById(i.id,e.entry.featureIndex),t.layerService.$messageBusService.unsubscribe(o))});this.layerService.addLayer(a);var s=$("#layergroup_"+a.groupId);s.collapse("show")}},t.prototype.selectFeatureById=function(e,t){var r=this.layerService.findFeatureByIndex(e,t);null!=r&&(this.layerService.$mapService.zoomTo(r),this.layerService.selectFeature(r,!1,!0))},t.prototype.selectFeature=function(e){},t}(e.BasicActionService);e.OfflineSearchActions=a}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(e){var t=function(e){function t(t,r){e.call(this),this.$http=t,this.isReady=!0,this.id="OnlineSearchActions",this.searchUrl=r}return __extends(t,e),t.prototype.search=function(e,t){var r=this,i=[];this.getHits(e.query,10,function(e){e.forEach(function(e){i.push({title:e.title,description:e.description,icon:"bower_components/csweb/dist-bower/images/large-marker.png",service:r.id,location:JSON.parse(e.location),score:"Gemeente"==e.description?.99:.98,click:function(){return r.onSelect(e)}})}),t(null,i)})},t.prototype.getHits=function(e,t,r){if(void 0===t&&(t=10),!this.isReady||null===e||e.length<2)return void r([]);var i=e.toLowerCase(),a={query:i,nrItems:t},o=[];$.ajax({type:"POST",url:this.searchUrl,data:JSON.stringify(a),contentType:"application/json",dataType:"json",statusCode:{200:function(e){console.log("Received online search result"),e.hasOwnProperty("result")&&(o=e.result),r(o)},404:function(e){console.log("Could not get online search result"),r(o)}},error:function(){console.log("Error getting online search results"),r(o)}})},t.prototype.init=function(t){e.prototype.init.call(this,t)},t.prototype.onSelect=function(e){var t;if("string"==typeof e.location)try{t=JSON.parse(e.location)}catch(r){console.log(r)}if(t&&t.hasOwnProperty("coordinates")&&t.hasOwnProperty("type"))switch(t.type){case"Point":this.layerService.$mapService.zoomToLocation(new L.LatLng(t.coordinates[1],t.coordinates[0]),18);break;case"MultiPolygon":case"Polygon":default:this.layerService.map.getMap().fitBounds(L.geoJson(t).getBounds())}this.layerService.visual.leftPanelVisible=!1,this.layerService.$messageBusService.publish("search","reset")},t.prototype.selectFeatureById=function(e,t){},t.prototype.selectFeature=function(e){},t}(e.BasicActionService);e.OnlineSearchActions=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(e){var t=function(e){function t(t,r,i,a){var o=this;void 0===i&&(i="https://api.opencagedata.com/geocode/v1/geojson"),e.call(this),this.$http=t,this.apiKey=r,this.searchUrl=i,this.data=a,this.isReady=!0,this.id="OpenCageDataSearchAction",this.searchCache={},this.queryUrl=this.searchUrl+("?pretty=1&no_dedupe=1&limit=10&jsonp=JSON_CALLBACK&key="+this.apiKey)+(this.data.bounds?"&bounds="+this.data.bounds:"")+(this.data.culture?"&countrycode="+this.data.culture:"&nl")+(this.data.language?"&language="+this.data.language:"&nl-NL"),this.debouncedFn=_.debounce(function(e,t){return o.ocdRestRequest(e,t)},2500),this.messageBus=a.messageBus,this.messageBus.subscribe("geocoding",function(e,t){"reverselookup"===e.toLowerCase()&&o.reverseGeocodeLookup(t)})}return __extends(t,e),t.prototype.init=function(t){e.prototype.init.call(this,t)},t.prototype.reverseGeocodeLookup=function(e){var t=this,r=this.queryUrl+"&q="+e.lat+","+e.lng;this.$http.jsonp(r).success(function(e){e.results&&0!==e.results.length&&t.messageBus.publish("geocoding","reverseLookupResult",e.results[0])}).error(function(e,t,r,i){console.log(r)})},t.prototype.search=function(e,t){e.query.length<4||this.debouncedFn(e,t)},t.prototype.ocdRestRequest=function(e,t){var r=this;if(this.searchCache.hasOwnProperty(e.query))return void this.geocodeCallback(this.searchCache[e.query],t,e.query);var i=this.queryUrl+"&q="+encodeURIComponent(e.query);this.callRestService(i,function(e,t,i){return r.geocodeCallback(e,t,i)},t,e.query)},t.prototype.callRestService=function(e,t,r,i){this.$http.jsonp(e).success(function(e){t(e,r,i)}).error(function(e,t,r,i){alert(r)})},t.prototype.geocodeCallback=function(e,t,r){var i=this;console.log("Open cache location search result:"),console.log(JSON.stringify(e,null,2)),this.searchCache[r]=e;var a=[];e.results.forEach(function(e){a.push({title:e.formatted,type:e.annotations?e.annotations.DMS.lat+", "+e.annotations.DMS.lng:"",service:i.id,description:e.annotations&&e.annotations.what3words?e.annotations.what3words.words:"",score:e.confidence/10,icon:"bower_components/csweb/dist-bower/images/large-marker.png",click:function(){return i.onSelect(e)},location:{type:"Point",coordinates:[e.geometry.lng,e.geometry.lat]}})}),t(null,a)},t.prototype.swapLatLonInPoint=function(e){return{type:e.type,coordinates:[e.coordinates[1],e.coordinates[0]]}},t.prototype.onSelect=function(e){if(e.bounds){var t=new L.LatLngBounds(e.bounds.southwest,e.bounds.northeast);this.layerService.map.getMap().fitBounds(t)}else this.layerService.$mapService.zoomToLocation(new L.LatLng(e.geometry.lat,e.geometry.lng),18)},t}(e.BasicActionService);e.OpenCageDataSearchAction=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(){this.title="cesium",this.features={}}return t.prototype.init=function(e){this.service=e},t.prototype.enable=function(t){var r=this;e.Utils.loadJsCssfile("js/Cesium.js",e.FileType.Js,function(e){var i;t&&(i=r.createImageLayerProvider(t)),r.viewer=new Cesium.Viewer("map",{selectionIndicator:!1,infoBox:!1,scene3DOnly:!0,sceneModePicker:!1,fullscreenButton:!1,homeButton:!1,baseLayerPicker:!1,animation:!1,timeline:!1,geocoder:!1,navigationHelpButton:!1,imageryProvider:i}),r.setTerrainProvider(t),r.camera=r.viewer.camera,r.scene=r.viewer.scene,r.scene.globe.enableLighting=!0,r.scene.globe.depthTestAgainstTerrain="undefined"!=typeof t.cesium_tileUrl,setTimeout(function(){for(var e=0;e<r.service.project.features.length;++e)r.addFeature(r.service.project.features[e])},0),r.setUpMouseHandlers(),r.fitBounds(r.service.$mapService.maxBounds)})},t.prototype.getLatLon=function(e,t){return{lat:53,lon:5}},t.prototype.refreshLayer=function(){},t.prototype.getExtent=function(){var e={};return e},t.prototype.getZoom=function(){return 0},t.prototype.fitBounds=function(e){Cesium.Ellipsoid.WGS84;if(e){var t=Cesium.Math.toRadians(e.southWest[1]),r=Cesium.Math.toRadians(e.southWest[0]),i=Cesium.Math.toRadians(e.northEast[1]),a=Cesium.Math.toRadians(e.northEast[0]),o=new Cesium.Rectangle(t,r,i,a);this.camera.setView({destination:o})}},t.prototype.setUpMouseHandlers=function(){var e=this;this.handler=new Cesium.ScreenSpaceEventHandler(this.scene.canvas),this.handler.setInputAction(function(t){var r=e.scene.pick(t.position);Cesium.defined(r)&&void 0!==r.id&&void 0!==r.id.feature&&e.service.selectFeature(r.id.feature)},Cesium.ScreenSpaceEventType.LEFT_CLICK),this.handler.setInputAction(function(t){var r=e.scene.pick(t.endPosition);Cesium.defined(r)&&void 0!==r.id&&void 0!==r.id.feature?e.showFeatureTooltip(r.id.feature,t.endPosition):$(".cesiumPopup").fadeOut("fast").remove()},Cesium.ScreenSpaceEventType.MOUSE_MOVE)},t.prototype.disable=function(){this.handler.destroy(),this.viewer.destroy()},t.prototype.changeBaseLayer=function(e){if(e.cesium_url){this.scene.imageryLayers.removeAll();var t=this.createImageLayerProvider(e);this.viewer.imageryLayers.addImageryProvider(t)}else alert("This layer is not cesium compatible")},t.prototype.setTerrainProvider=function(e){e.cesium_tileUrl&&(this.viewer.terrainProvider=new Cesium.CesiumTerrainProvider({url:e.cesium_tileUrl,requestWaterMask:!1,requestVertexNormals:!0}))},t.prototype.createImageLayerProvider=function(e){var t;switch(e.cesium_maptype.toUpperCase()){case"ARCGIS":t=new Cesium.ArcGisMapServerImageryProvider({url:e.cesium_url,minimumLevel:e.minZoom,maximumLevel:e.maxNativeZoom||e.maxZoom});break;case"OPENSTREETMAP":t=new Cesium.createOpenStreetMapImageryProvider({url:e.cesium_url,minimumLevel:e.minZoom,maximumLevel:e.maxNativeZoom||e.maxZoom});break;case"WEBMAPTILE":t=new Cesium.WebMapTileServiceImageryProvider({url:e.cesium_url,minimumLevel:e.minZoom,maximumLevel:e.maxNativeZoom||e.maxZoom});break;case"TILEMAP":t=new Cesium.TileMapServiceImageryProvider({url:e.cesium_url,minimumLevel:e.minZoom,maximumLevel:e.maxNativeZoom||e.maxZoom});break;default:alert("unknown maptype: "+e.cesium_maptype)}return t},t.prototype.showFeatureTooltip=function(t,r){if(void 0===this.popupShownFor||t.id!==this.popupShownFor.id){$(".cesiumPopup").fadeOut("fast").remove(),this.popupShownFor=t;var i=t.layer,a=i.group,o=t.properties.Name,s=o?o.length:1,n="<td colspan='3'>"+o+"</td></tr>";null!=a.filters&&a.filters.length>0&&a.filters.forEach(function(r){if(t.properties.hasOwnProperty(r.property)){var i=t.properties[r.property];if(i){var a=i.toString().length;null!=r.meta&&(i=e.Helpers.convertPropertyInfo(r.meta,i),"bbcode"!==r.meta.type&&(a=i.toString().length)),s=Math.max(s,a+r.title.length),n+='<tr><td><div class="fa fa-filter makeNarrow"></td><td>'+r.title+"</td><td>"+i+"</td></tr>"}}}),null!=a.styles&&a.styles.length>0&&a.styles.forEach(function(r){if(null!=a.filters&&0===a.filters.filter(function(e){return e.property===r.property}).length&&t.properties.hasOwnProperty(r.property)){var i=t.properties[r.property],o=i.toString().length;null!=r.meta&&(i=e.Helpers.convertPropertyInfo(r.meta,i),"bbcode"!==r.meta.type&&(o=i.toString().length));var c=r.title?r.title.length:10;s=Math.max(s,o+c),n+='<tr><td><div class="fa fa-paint-brush makeNarrow"></td><td>'+r.title+"</td><td>"+i+"</td></tr>"}});var c=Math.max(Math.min(7*s+15,250),130);n='<table style="width:'+c+'px;">'+n+"</table>",this.popup=$('<div class="cesiumPopup featureTooltip"></div>').html(n).css({position:"absolute",top:r.y-30,left:r.x-c/2-30,width:c}).hide().fadeIn("fast"),$("body").append(this.popup)}},t.prototype.addLayer=function(e){var t=this,r=jQuery.Deferred();switch(e.renderType){case"geojson":setTimeout(function(){e.data.features.forEach(function(e){t.addFeature(e)}),r.resolve()},0);break;case"wms":var i=this.viewer.imageryLayers.addImageryProvider(new Cesium.WebMapServiceImageryProvider({url:e.url,layers:e.wmsLayers,parameters:{format:"image/png",transparent:!0}}));i.id=e.id,i.alpha=e.opacity/100,r.resolve();break;default:alert("unknown layertype: "+e.type),r.resolve()}return r.promise()},t.prototype.removeLayer=function(e){var t=this,r=jQuery.Deferred();switch(e.type.toUpperCase()){case"GEOJSON":case"EDITABLEGEOJSON":case"DYNAMICGEOJSON":case"TOPOJSON":setTimeout(function(){return e.data&&e.data.features?(e.data.features.forEach(function(e){t.removeFeature(e)}),void r.resolve()):r.resolve()},0);break;case"WMS":this.viewer.imageryLayers._layers.forEach(function(r){r.id===e.id&&t.viewer.imageryLayers.remove(r)}),r.resolve();break;default:alert("unknown layertype: "+e.type),r.resolve()}return r.promise()},t.prototype.updateMapFilter=function(e){var t=this,r=jQuery.Deferred();return setTimeout(function(){t.viewer.entities.values.forEach(function(t){var r;e.filterResult&&(r=e.filterResult.filter(function(e){return e.id===t.feature.id}).length>0),r?t.show=!0:t.show=!1}),r.resolve()},0),r.promise()},t.prototype.addGroup=function(e){console.log("addGroup called")},t.prototype.removeGroup=function(e){console.log("removeGroup called")},t.prototype.removeFeature=function(e){var t=this,r=[];this.viewer.entities.values.forEach(function(t){t.feature.id===e.id&&r.push(t)}),r.forEach(function(e){t.viewer.entities.remove(e)})},t.prototype.removeFeatures=function(e){var t=this,r=jQuery.Deferred();return setTimeout(function(){var i=[];t.viewer.entities.values.forEach(function(t){e.forEach(function(e){t.feature.id===e.id&&t.show(!1)})}),i.forEach(function(e){t.viewer.entities.remove(e)}),r.resolve()},0),r.promise()},t.prototype.updateFeature=function(e){var t=this;this.viewer.entities.values.forEach(function(r){r.feature.id===e.id&&t.updateEntity(r,e)})},t.prototype.getFeatureHeight=function(e){return e.effectiveStyle.height||0},t.prototype.getHeightAboveSeaLevel=function(e){return e.effectiveStyle.heightAboveSeaProperty&&e.properties.hasOwnProperty(e.effectiveStyle.heightAboveSeaProperty)?e.properties[e.effectiveStyle.heightAboveSeaProperty]:void 0},t.prototype.updateEntity=function(e,t){var r=t.effectiveStyle;void 0!==t.fType.style.iconUri&&void 0!==e.billboard&&(e.billboard.width=r.iconWidth,e.billboard.height=r.iconHeight);var i=Cesium.Color.fromCssColorString(r.fillColor);switch(t.geometry.type.toUpperCase()){case"POINT":case"MULTIPOINT":var a=Cesium.Cartesian3.fromDegrees(t.geometry.coordinates[0],t.geometry.coordinates[1],t.geometry.coordinates[2]);e.position=a,e.point&&(e.point.position=a,e.point.color=i,e.point.outlineColor=Cesium.Color.fromCssColorString(r.strokeColor),e.point.outlineWidth=r.strokeWidth);break;case"POLYGON":case"MULTIPOLYGON":e.polygon.material=i,e.polygon.outlineColor=Cesium.Color.fromCssColorString(r.strokeColor),e.polygon.outlineWidth=r.strokeWidth;var o=this.getFeatureHeight(t),s=this.getHeightAboveSeaLevel(t);s?(e.polygon.perPositionHeight=!1,e.polygon.extrudedHeight=s+o,e.polygon.height=s):(e.polygon.perPositionHeight=!0,e.polygon.extrudedHeight=o);break;case"LINESTRING":case"MULTILINESTRING":e.polyline.material=i,e.polyline.width=r.strokeWidth;break;default:alert("unknown geometry type: "+t.geometry.type)}},t.prototype.addFeature=function(e){this.createFeature(e)},t.prototype.selectFeature=function(e){console.log("CesiumRenderer warning: selectFeature is not implemented!")},t.prototype.createFeature=function(e){var t,r,i=this.viewer.entities.getOrCreateEntity(e.id);i.feature=e,i.name=e.properties.Name;var a=5,o=e.fType.style,s=e.effectiveStyle,n=Cesium.Color.fromCssColorString(s.fillColor).withAlpha(s.fillOpacity);switch(e.geometry.type.toUpperCase()){case"POINT":"undefined"==typeof o.iconUri||s.modelUri?i.point={pixelSize:a,color:n,outlineColor:Cesium.Color.fromCssColorString(s.strokeColor),outlineWidth:s.strokeWidth}:(i.billboard={image:o.iconUri,width:s.iconWidth,height:s.iconHeight},a=35);var c=Cesium.Cartesian3.fromDegrees(e.geometry.coordinates[0],e.geometry.coordinates[1],e.geometry.coordinates[2]||this.getHeightAboveSeaLevel(e));i.position=c;break;case"MULTIPOINT":for(var l=0;l<e.geometry.coordinates.length;l++){var p=new Cesium.Entity;p.feature=e,p.point={pixelSize:a,position:Cesium.Cartesian3.fromDegrees(e.geometry.coordinates[l][0],e.geometry.coordinates[l][1],e.geometry.coordinates[l][2]||this.getHeightAboveSeaLevel(e)),color:n,outlineColor:Cesium.Color.fromCssColorString(s.strokeColor),outlineWidth:s.strokeWidth},this.viewer.entities.add(p)}this.viewer.entities.remove(i);break;case"POLYGON":t=this.getFeatureHeight(e),r=this.getHeightAboveSeaLevel(e),i.polygon=new Cesium.PolygonGraphics({hierarchy:this.createPolygon(e.geometry.coordinates).hierarchy,material:n,outline:o.stroke,outlineColor:Cesium.Color.fromCssColorString(s.strokeColor),outlineWidth:s.strokeWidth}),r?(i.polygon.perPositionHeight=!1,i.polygon.extrudedHeight=r+t,i.polygon.height=r):(i.polygon.perPositionHeight=!0,i.polygon.extrudedHeight=t);break;case"MULTIPOLYGON":t=this.getFeatureHeight(e),r=this.getHeightAboveSeaLevel(e);for(var u=this.createMultiPolygon(e.geometry.coordinates),l=0;l<u.length;++l){var p=new Cesium.Entity;p.feature=e;var d=new Cesium.PolygonGraphics({hierarchy:u[l].hierarchy,material:n,outline:o.stroke,outlineColor:Cesium.Color.fromCssColorString(s.strokeColor),outlineWidth:s.strokeWidth});r?(d.perPositionHeight=!1,d.extrudedHeight=r+t,d.height=r):(d.perPositionHeight=!0,d.extrudedHeight=t),p.polygon=d,this.viewer.entities.add(p)}this.viewer.entities.remove(i);break;case"LINESTRING":i.polyline=new Cesium.PolylineGraphics({positions:this.coordinatesArrayToCartesianArray(e.geometry.coordinates),material:n,width:s.strokeWidth});break;case"MULTILINESTRING":for(var l=0;l<e.geometry.coordinates.length;l++){var p=new Cesium.Entity;p.feature=e,i.polyline=new Cesium.PolylineGraphics({positions:this.coordinatesArrayToCartesianArray(e.geometry.coordinates[l]),material:n,width:s.strokeWidth}),this.viewer.entities.add(p)}this.viewer.entities.remove(i);break;default:alert("unknown geometry type: "+e.geometry.type)}if(s.modelUri&&(i.model=new Cesium.ModelGraphics({uri:"/models/"+s.modelUri,scale:s.modelScale||1,minimumPixelSize:s.modelMinimumPixelSize||32}),void 0!==i.billboard&&(i.billboard.show=!1),void 0!==i.point&&(i.point.show=!1)),s.rotate){var h=Cesium.Transforms.headingPitchRollQuaternion(Cesium.Cartesian3.fromDegrees(e.geometry.coordinates[0],e.geometry.coordinates[1],e.geometry.coordinates[2]),Cesium.Math.toRadians(s.rotate),0,0);i.orientation=h}return i},t.prototype.createPolygon=function(e){if(0!==e.length&&0!==e[0].length){for(var t=new Cesium.PolygonGraphics,r=[],i=1,a=e.length;a>i;i++)r.push(new Cesium.PolygonHierarchy(this.coordinatesArrayToCartesianArray(e[i])));var o=this.coordinatesArrayToCartesianArray(e[0]);return t.hierarchy=new Cesium.PolygonHierarchy(o,r),t}},t.prototype.createMultiPolygon=function(e){for(var t=[],r=0;r<e.length;r++)t.push(this.createPolygon(e[r]));return t},t.prototype.coordinatesArrayToCartesianArray=function(e){for(var t=new Array(e.length),r=0;r<e.length;r++)t[r]=this.defaultCrsFunction(e[r]);return t},t.prototype.defaultCrsFunction=function(e){return Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2])},t}();t.CesiumRenderer=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function r(){this.title="leaflet",this.cntrlIsPressed=!1}return r.prototype.init=function(e){var t=this;this.service=e,this.$messageBusService=e.$messageBusService,$(document).keydown(function(e){t.cntrlIsPressed=e.ctrlKey}),$(document).keyup(function(){t.cntrlIsPressed=!1})},r.prototype.enable=function(){var e=this;if(1===$("map").length){if(this.map)return void this.enableMap();var t={zoomControl:!1,maxZoom:22,attributionControl:!0};this.map=this.service.$mapService.map=L.map("map",t),this.map.on("moveend",function(t,r){return e.updateBoundingBox()}),this.map.on("zoomend",function(t,r){var i=e.service.$mapService.map.getZoom();e.$messageBusService.publish("map","zoom",i)}),this.map.once("load",function(){return e.updateBoundingBox()})}},r.prototype.disable=function(){this.disableMap()},r.prototype.enableMap=function(){this.map.dragging.enable(),this.map.touchZoom.enable(),this.map.doubleClickZoom.enable(),this.map.scrollWheelZoom.enable(),this.map.boxZoom.enable(),this.map.keyboard.enable(),this.map.tap&&this.map.tap.enable(),document.getElementById("map").style.cursor="grab"},r.prototype.disableMap=function(){this.map.dragging.disable(),this.map.touchZoom.disable(),this.map.doubleClickZoom.disable(),this.map.scrollWheelZoom.disable(),this.map.boxZoom.disable(),this.map.keyboard.disable(),this.map.tap&&this.map.tap.disable(),document.getElementById("map").style.cursor="default"},r.prototype.updateBoundingBox=function(){var e=this.map.getBounds();this.$messageBusService.publish("mapbbox","update",e.toBBoxString());var t={southWest:[e.getSouth(),e.getWest()],northEast:[e.getNorth(),e.getEast()]};this.service.$mapService.maxBounds=t},r.prototype.getLatLon=function(e,t){var r=this.map.containerPointToLatLng(new L.Point(e,t));return{lat:r.lat,lon:r.lng}},r.prototype.getExtent=function(){var e={};if(this.map){var t=this.map.getBounds(),r=t.getSouthWest(),i=t.getNorthEast();e.southWest=[r.lat,r.lng],e.northEast=[i.lat,i.lng]}return e},r.prototype.fitBounds=function(e){var t=L.latLng(e.southWest[0],e.southWest[1]),r=L.latLng(e.northEast[0],e.northEast[1]),i=L.latLngBounds(t,r);try{this.service.$mapService.map.fitBounds(i)}catch(a){}},r.prototype.getZoom=function(){return this.service.$mapService.map.getZoom()},r.prototype.refreshLayer=function(){},r.prototype.addGroup=function(e){var r=this;e.clustering?(e._cluster=new L.MarkerClusterGroup({disableClusteringAtZoom:e.clusterLevel||0}),e._cluster.on("clustermouseover",function(e){if(0===e.layer._childClusters.length){var i=e.layer.getAllChildMarkers();if(i[0]&&i[0].hasOwnProperty("feature")){var a=i[0].feature,o=r.service.getActions(a,t.ActionType.Hover);o.forEach(function(e){"show"===e.title.toLowerCase()&&e.callback(a,r.service)})}}}),e._cluster.on("clustermouseout",function(e){if(0===e.layer._childClusters.length){var i=e.layer.getAllChildMarkers();if(i[0]&&i[0].hasOwnProperty("feature")){var a=i[0].feature,o=r.service.getActions(a,t.ActionType.Hover);o.forEach(function(e){"hide"===e.title.toLowerCase()&&e.callback(a,r.service)})}}}),this.map.addLayer(e._cluster)):(e._vectors=new L.LayerGroup,this.map.addLayer(e._vectors))},r.prototype.removeLayer=function(e){switch(e.renderType){case"geojson":t.GeojsonRenderer.remove(this.service,e);break;default:this.service.map.map&&e.mapLayer&&this.service.map.map.removeLayer(e.mapLayer)}},r.prototype.changeBaseLayer=function(e,t){void 0===t&&(t=!1),(t||e!==this.service.$mapService.activeBaseLayer)&&(this.baseLayer&&this.map.hasLayer(this.baseLayer)&&this.map.removeLayer(this.baseLayer),this.baseLayer=this.createBaseLayer(e),this.map.addLayer(this.baseLayer,!0),this.baseLayer.bringToBack(),this.map.setZoom(this.service.map.map.getZoom()),this.map.fire("baselayerchange",{layer:this.baseLayer}))},r.prototype.createBaseLayer=function(r){var i={noWrap:!0};i.subtitle=r.subtitle,i.preview=r.preview,r.subdomains&&(i.subdomains=r.subdomains),r.minZoom&&(i.minZoom=r.minZoom),r.maxZoom&&(i.maxZoom=r.maxZoom),r.maxNativeZoom&&(i.maxNativeZoom=r.maxNativeZoom),r.errorTileUrl&&(i.errorTileUrl=r.errorTileUrl),r.attribution&&(i.attribution=r.attribution),r.id&&(i.id=r.id);var a=r.url.split("|"),o=L.tileLayer(a[0],i);if(a.length>1){var s=new t.ProjectLayer;s.url=a[1],e.Services.TileLayerRenderer.addUtfGrid(this.service,s,a[1])}return o},r.prototype.getLeafletStyle=function(e){var t={fillColor:e.fillColor,weight:e.strokeWidth,opacity:e.strokeOpacity,fillOpacity:e.fillOpacity};return t.color="undefined"!=typeof e.stroke&&e.stroke===!1?e.fillColor:e.strokeColor,t},r.prototype.addLayer=function(e){switch(e.renderType){case"geojson":t.GeojsonRenderer.render(this.service,e,this);break;case"tilelayer":t.TileLayerRenderer.render(this.service,e);break;case"wms":t.WmsRenderer.render(this.service,e);break;case"gridlayer":t.GridLayerRenderer.render(this.service,e);break;case"heatmap":t.HeatmapRenderer.render(this.service,e,this)}},r.prototype.updateMapFilter=function(e){var t=this;$.each(e.markers,function(r,i){var a=i.feature._gui.included;if(e.clustering){var o=e._cluster.hasLayer(i);!a&&o&&e._cluster.removeLayer(i),a&&!o&&e._cluster.addLayer(i)}else{var s=t.service.map.map.hasLayer(i);!a&&s&&t.service.map.map.removeLayer(i),a&&!s&&t.service.map.map.addLayer(i)}})},r.prototype.removeGroup=function(e){},r.prototype.removeFeature=function(e){var t=e.layer;switch(t.renderType){case"geojson":var r=t.group;if(r.clustering){var i=r._cluster;try{i.removeLayer(t.group.markers[e.id]),delete t.group.markers[e.id]}catch(a){}}else t.group.markers.hasOwnProperty(e.id)&&(t.mapLayer.removeLayer(t.group.markers[e.id]),t.group._vectors.removeLayer(t.group.markers[e.id]),delete t.group.markers[e.id])}},r.prototype.updateFeature=function(e){if(null!=e.layer.group){var t=e.layer.group.markers[e.id];null!=t&&("Point"===e.geometry.type?(t.setIcon(this.getPointIcon(e)),t.setLatLng(new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]))):(t.setStyle(this.getLeafletStyle(e.effectiveStyle)),e.isSelected&&e.layer&&!e.layer.disableMoveSelectionToFront&&e.layer.group&&(e.layer.group.clustering&&e.layer.group._cluster&&e.layer.group._cluster.hasLayer(t)||e.layer.group.markers.hasOwnProperty(t.feature.id))&&t.bringToFront()),e.layer.isEditable&&t.dragging&&(this.canDrag(e)?t.dragging.enable():t.dragging.disable()))}},r.prototype.selectFeature=function(e){e._gui.hasOwnProperty("dragged")?delete e._gui.dragged:this.service.selectFeature(e,this.cntrlIsPressed)},r.prototype.addFeature=function(e){var t=this;if(null!=e.geometry){var r=this.createFeature(e);if(r){var i=e.layer;return i.group.markers[e.id]=r,r.on({mouseover:function(e){return t.showFeatureTooltip(e,i.group)},mouseout:function(e){return t.hideFeatureTooltip(e)},mousemove:function(e){return t.updateFeatureTooltip(e)},click:function(r){t.selectFeature(e)}}),r.feature=e,i.group.clustering&&i.group._cluster?i.group._cluster.addLayer(r):i.mapLayer&&i.mapLayer.addLayer(r),r}}return null},r.prototype.canDrag=function(e){return e._gui.hasOwnProperty("editMode")&&e._gui.editMode===!0},r.prototype.createFeature=function(e){var r,i=this;switch(e.geometry.type){case"Point":if(!e.geometry.coordinates||e.geometry.coordinates.length<2||isNaN(e.geometry.coordinates[0])||isNaN(e.geometry.coordinates[1]))return;var a=this.getPointIcon(e);r=new L.Marker(new L.LatLng(e.geometry.coordinates[1],e.geometry.coordinates[0]),{icon:a,draggable:this.canDrag(e)}),r.on("contextmenu",function(r){if(i.service._activeContextMenu=i.service.getActions(e,t.ActionType.Context),i.service._activeContextMenu&&0!==i.service._activeContextMenu.length){var a=$("#map-contextmenu-button"),o=$("#map-contextmenu");a.dropdown("toggle");var s=i.map.getSize();r.originalEvent.x<s.x/2?o.css("left",r.originalEvent.x+5):o.css("left",r.originalEvent.x-5-o.width()),
r.originalEvent.y<s.y/2?o.css("top",r.originalEvent.y-35):o.css("top",r.originalEvent.y-70-o.height()),"$apply"!==i.service.$rootScope.$$phase&&"$digest"!==i.service.$rootScope.$$phase&&i.service.$rootScope.$apply()}}),r.on("dragstart",function(t){e._gui.dragged=!0}),r.on("dragend",function(t){var r=t.target,i=r.getLatLng();e.geometry.coordinates=[i.lng,i.lat]});break;case"Overlay":if(!e.properties.hasOwnProperty("imageUrl"))break;var o=e.geometry.coordinates,s=e.properties.imageUrl,n=e.properties.hasOwnProperty("opacity")?e.properties.opacity:e.fType.style.opacity,c=e.properties.hasOwnProperty("attribution")?e.properties.attribution:"",l=L.imageOverlay(s,o,{opacity:n,attribution:c});e._gui.imageOverlay=l,l.addTo(this.map);break;default:try{r=L.GeoJSON.geometryToLayer(e),r.setStyle(this.getLeafletStyle(e.effectiveStyle)),r.on("contextmenu",function(r){if(i.service._activeContextMenu=i.service.getActions(e,t.ActionType.Context),i.service._activeContextMenu&&0!==i.service._activeContextMenu.length){var a=$("#map-contextmenu-button"),o=$("#map-contextmenu");a.dropdown("toggle");var s=i.map.getSize();r.originalEvent.x<s.x/2?o.css("left",r.originalEvent.x+5):o.css("left",r.originalEvent.x-5-o.width()),r.originalEvent.y<s.y/2?o.css("top",r.originalEvent.y-35):o.css("top",r.originalEvent.y-70-o.height()),"$apply"!==i.service.$rootScope.$$phase&&"$digest"!==i.service.$rootScope.$$phase&&i.service.$rootScope.$apply()}})}catch(p){console.log("Error creating leaflet feature"),console.log(e)}}return r&&(r.feature=e,e.layer.group.markers[e.id]=r),r},r.prototype.getPointIcon=function(t){var r;if(null!=t.htmlStyle)r=new L.DivIcon({className:"",iconSize:new L.Point(t.effectiveStyle.iconWidth,t.effectiveStyle.iconHeight),html:t.htmlStyle});else{var i=e.Helpers.createIconHtml(t);r=new L.DivIcon({className:"",iconSize:new L.Point(i.iconPlusBorderWidth,i.iconPlusBorderHeight),html:i.html})}return r},r.prototype.addEntryToTooltip=function(t,r,i,a,o,s){if(!o||0===o.length)return{length:0,content:t};var n=r.properties[i];if("undefined"==typeof n||null===n)return{length:0,content:t};var c=n.toString().length;return a?(n=e.Helpers.convertPropertyInfo(a,n),"bbcode"!==a.type&&(c=n.toString().length)):r.fType._propertyTypeData&&r.fType._propertyTypeData.some(function(t){return t.label!==i?!1:(a=t,n=e.Helpers.convertPropertyInfo(t,n),!0)}),{length:c+o.length,content:t+('<tr><td><div class="fa '+(s?"fa-filter":"fa-paint-brush")+'"></td><td>'+o+"</td><td>"+n+"</td></tr>")}},r.prototype.generateTooltipContent=function(t,r){var i=this,a=t.target,o=a.feature,s=e.Helpers.getFeatureTitle(o),n=s?s.length:1,c="<td colspan='3'>"+s+"</td></tr>";null!=r.filters&&r.filters.length>0&&r.filters.forEach(function(e){if(o.properties.hasOwnProperty(e.property)){var t=i.addEntryToTooltip(c,o,e.property,e.meta,e.title,!0);c=t.content,n=Math.max(n,t.length)}}),null!=r.styles&&r.styles.length>0&&r.styles.forEach(function(e){if(null!=r.filters&&0===r.filters.filter(function(t){return t.property===e.property}).length&&o.properties.hasOwnProperty(e.property)){var t=i.addEntryToTooltip(c,o,e.property,e.meta,e.title,!1);c=t.content;var a=e.title?e.title.length:10;n=Math.max(n,t.length+a)}});var l=Math.max(Math.min(7*n+15,250),130);return{content:"<table style='width:"+l+"px;'>"+c+"</table>",widthInPixels:l}},r.prototype.showFeatureTooltip=function(e,r){var i=this,a=e.target,o=a.feature,s=this.generateTooltipContent(e,r);this.popup=L.popup({offset:new L.Point(-s.widthInPixels/2-40,-5),closeOnClick:!0,autoPan:!1,className:"featureTooltip"}).setLatLng(e.latlng).setContent(s.content).openOn(this.service.map.map);var n=this.service.getActions(o,t.ActionType.Hover);n.forEach(function(e){"show"===e.title.toLowerCase()&&e.callback(o,i.service)}),this.$messageBusService.publish("feature","onFeatureHover",o)},r.prototype.hideFeatureTooltip=function(e){var r=this;this.popup&&this.service.map.map&&(this.service.map.map.closePopup(this.popup),this.popup=null);var i=e.target,a=i.feature;if(a){var o=this.service.getActions(a,t.ActionType.Hover);o.forEach(function(e){"hide"===e.title.toLowerCase()&&e.callback(a,r.service)})}},r.prototype.updateFeatureTooltip=function(e){null!=this.popup&&null!=e.latlng&&this.popup.setLatLng(e.latlng)},r}();t.LeafletRenderer=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function r(e){this.service=e,this.title="database",this.requiresLayer=!1}return r.prototype.refreshLayer=function(e){var t=this;if(e.isLoading)var r=this.service.$messageBusService.subscribe("layer",function(i,a){"activated"===i&&a.id===e.id&&(t.service.addLayer(e),t.service.$messageBusService.unsubscribe(r))});else e.enabled?(this.service.$messageBusService.publish("layer","loading",e),this.baseAddLayer(e,function(){},!0)):this.baseAddLayer(e,function(){},!1)},r.prototype.addLayer=function(e,t){this.baseAddLayer(e,t)},r.prototype.fitMap=function(t){if(t.data.features&&0!==t.data.features.length){var r=e.Helpers.GeoExtensions.getBoundingBox(t.data);180!=r.xMax&&90!=r.yMax&&this.service.$messageBusService.publish("map","setextent",r)}},r.prototype.layerMenuOptions=function(e){var t=this;return[["Fit map",function(r){return t.fitMap(e)}],null,["Refresh",function(r){return t.refreshLayer(e)}]]},r.prototype.baseAddLayer=function(r,i,a){var o=this;void 0===a&&(a=!1),this.layer=r,async.series([function(s){r.renderType="geojson",r.isLoading=!0;var n,c,l;n=r.dataSourceParameters&&r.dataSourceParameters.hasOwnProperty("minZoom")?r.dataSourceParameters.minZoom:15,r.dataSourceParameters&&r.dataSourceParameters.hasOwnProperty("searchProperty")&&(c=r.dataSourceParameters.searchProperty),r.dataSourceParameters&&r.dataSourceParameters.hasOwnProperty("useFeatureBounds")&&(l=r.dataSourceParameters.useFeatureBounds);var p;if(o.service.$mapService.map.getZoom()<n&&"undefined"==typeof c&&!l)return o.service.$messageBusService.notifyWithTranslation("ZOOM_LEVEL_LOW","ZOOM_IN_FOR_CONTOURS",e.Services.NotifyLocation.TopRight,e.Services.NotifyType.Info,1500),void o.initLayer(r,i);var u;if("undefined"!=typeof c)u={searchProp:c,layer:t.ProjectLayer.serializeableData(r)};else if(l===!0){var d=r.dataSourceParameters.coordinates||[[[0,0],[0,0],[0,0],[0,0]]];u={bounds:JSON.stringify({type:"Polygon",coordinates:d,crs:{type:"name",properties:{name:"EPSG:4326"}}}),layer:t.ProjectLayer.serializeableData(r)}}else{p=o.service.$mapService.map.getBounds();var h=[[[p.getSouthWest().lng,p.getSouthWest().lat],[p.getNorthWest().lng,p.getNorthWest().lat],[p.getNorthEast().lng,p.getNorthEast().lat],[p.getSouthEast().lng,p.getSouthEast().lat],[p.getSouthWest().lng,p.getSouthWest().lat]]],f=JSON.stringify({type:"Polygon",coordinates:h,crs:{type:"name",properties:{name:"EPSG:4326"}}});u={bounds:f,layer:t.ProjectLayer.serializeableData(r)}}$.ajax({type:"POST",url:r.url,data:JSON.stringify(u),contentType:"application/json",dataType:"json",statusCode:{200:function(e){console.log("Received bag contours"),a?o.updateLayer(e.layer,i):o.initLayer(e.layer,i)},404:function(e){console.log("Could not get bag contours"),a?o.updateLayer(e.layer,i):o.initLayer(r,i)}},error:function(){return o.service.$messageBusService.publish("layer","error",r)}})}])},r.prototype.initLayer=function(t,r){var i=this,a=this.service.findLayer(t.id);a&&(t.count=0,a.enabled=!0,a.data=t.data);var o=0;if(a.data&&a.data.features&&a.data.features.forEach?a.data.features.forEach(function(e){o+=1,i.service.initFeature(e,a,!1,!1)}):(a.data={},a.data.features=[]),a.typeUrl&&a.defaultFeatureType){var s=a.typeUrl+"#"+a.defaultFeatureType,n=this.service.getFeatureTypeById(s),c={};c[s]=n,n._propertyTypeData&&n._propertyTypeData.length>0&&n._propertyTypeData.forEach(function(t){e.Helpers.updateSection(a,t)})}a.isLoading=!1,this.service.$messageBusService.publish("layer","activated",t),"$apply"!==this.service.$rootScope.$root.$$phase&&"$digest"!==this.service.$rootScope.$root.$$phase&&this.service.$rootScope.$apply(),console.log("Initialized "+o+" features in "+t.id),r(a)},r.prototype.updateLayer=function(e,t){var r=this,i=this.service.findLayer(e.id);if(!i||!i.data||!i.data.features)return void this.initLayer(e,t);i&&(i.enabled=!0);var a=0;e.data&&e.data.features&&e.data.features.forEach&&e.data.features.forEach(function(e){i.data.features.some(function(t){return t.id===e.id})||(i.data.features.push(e),a+=1,r.service.initFeature(e,i,!1,!1),r.service.calculateFeatureStyle(e),r.service.activeMapRenderer.addFeature(e))}),i.isLoading=!1,this.service.$messageBusService.publish("layer","activated",e),console.log("Added "+a+" features in "+e.id),"$apply"!==this.service.$rootScope.$root.$$phase&&"$digest"!==this.service.$rootScope.$root.$$phase&&this.service.$rootScope.$apply(),t(i)},r.prototype.removeLayer=function(e){var t=this,r=this.service.findLayer(e.id);r&&(r.enabled=!1),r.data&&r.data.features&&r.data.features.forEach&&r.data.features.forEach(function(e){t.service.removeFeature(e)}),e.data&&(e.data.features.length=0)},r}();t.DatabaseSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(){function t(e,t,r){this.service=e,this.$storage=r,this.title="geojson",this.requiresLayer=!1,this.$http=t}return t.prototype.refreshLayer=function(e){var t=e.enabled;this.service.removeLayer(e),this.service.addLayer(e),e.enabled=t},t.prototype.addLayer=function(e,t,r){void 0===r&&(r=null),this.baseAddLayer(e,t,r)},t.prototype.fitMap=function(t){var r=e.Helpers.GeoExtensions.getBoundingBox(t.data);this.service.$messageBusService.publish("map","setextent",r)},t.prototype.fitTimeline=function(e){if(e.hasSensorData)if(e.timestamps&&e.timestamps.length>0){var t=e.timestamps[0],r=e.timestamps[e.timestamps.length-1];this.service.$messageBusService.publish("timeline","updateTimerange",{start:t,end:r})}else{var i=null,a=null;e.data.features.forEach(function(e){e.timestamps&&(null===i?i=e.timestamps[0]:i>e.timestamps[0]&&(i=e.timestamps[0]),null===a?a=e.timestamps[e.timestamps.length-1]:a<e.timestamps[e.timestamps.length-1]&&(a=e.timestamps[e.timestamps.length-1]))}),null!==i&&null!==a&&this.service.$messageBusService.publish("timeline","updateTimerange",{start:i,end:a})}},t.prototype.layerMenuOptions=function(e){var t=this,r=[["Fit map",function(r){return t.fitMap(e)}]];return e.hasSensorData&&e.timestamps&&r.push(["Fit time",function(r){return t.fitTimeline(e)}]),r.push(null),r.push(["Refresh",function(r){return t.refreshLayer(e)}]),r},t.prototype.baseAddLayer=function(e,t,r){var i=this;void 0===r&&(r=null),this.layer=e,async.series([function(t){if(e.renderType="geojson",r)e.enabled=!0,i.initLayer(r,e),t(null,null);else if(!e.url&&e.data&&e.data.type)e.count||(e.count=0),e.enabled=!0,e.isLoading=!1,e.isConnected=!1,i.initLayer(e.data,e),t(null,null);else{e.isLoading=!0;var a=e.url.replace("[BBOX]",e.BBOX);if(e.useProxy&&(a="/api/proxy?url="+a),e.localStorage){var o=window.localStorage.getItem("layer."+e.id);o&&(e.count=0,e.isLoading=!1,e.enabled=!0,i.initLayer(JSON.parse(o),e),e.hasSensorData&&i.fitTimeline(e),t(null,null))}e.isLoading&&i.$http.get(a).success(function(r){if(e.count=0,e.isLoading=!1,e.enabled=!0,e.localStorage){var a=JSON.stringify(r);window.localStorage.setItem("layer."+e.id,a)}i.initLayer(r,e),e.hasSensorData&&i.fitTimeline(e),t(null,null)}).error(function(){e.count=0,e.isLoading=!1,e.enabled=!1,e.isConnected=!1,i.service.$messageBusService.notify("ERROR loading "+e.title,"\nwhile loading: "+a),i.service.$messageBusService.publish("layer","error",e),t(null,null)})}},function(){t(e)}])},t.prototype.initLayer=function(t,r){var i=this;if("topojson"===r.type.toLowerCase()&&(t=e.Helpers.GeoExtensions.convertTopoToGeoJson(t)),"accessibility"!==r.id.toLowerCase()&&"tripplanner"!==r.id.toLowerCase()||(r.disableMoveSelectionToFront=!0,this.processAccessibilityReply(t,r,function(e){t=r.data,r=e})),t.featureTypes)for(var a in t.featureTypes)if(t.featureTypes.hasOwnProperty(a)){var o=t.featureTypes[a];a=r.url+"#"+a,this.service._featureTypes[a]=o}if(t.timestamps&&(r.timestamps=t.timestamps),r.data=t,!_.isUndefined(r.data)&&(r.data.geometries&&!r.data.features&&(r.data.features=r.data.geometries),!_.isUndefined(r.data.features)&&(r.data.features.forEach(function(e){i.service.initFeature(e,r,!1,!1)}),t.features.length>0))){var s=t.features[0],n=this.service.findResourceByFeature(s);e.Helpers.addPropertyTypes(s,s.fType,n)}r.isTransparent=!1,(r.minZoom||r.maxZoom)&&(r.minZoom||(r.minZoom=0),r.maxZoom||(r.maxZoom=25),r.zoomHandle=this.service.$messageBusService.subscribe("map",function(e,t){!e||!t||"zoom"!==e||0>t||(t<r.minZoom||t>r.maxZoom?r.isTransparent||(r.isTransparent=!0,i.service.updateLayerFeatures(r)):r.isTransparent&&(r.isTransparent=!1,i.service.updateLayerFeatures(r)))})),r.timeAware&&this.service.$messageBusService.publish("timeline","updateFeatures")},t.prototype.removeLayer=function(e){e.isTransparent=!1,e.zoomHandle&&this.service.$messageBusService.unsubscribe(e.zoomHandle)},t.prototype.processAccessibilityReply=function(t,r,i){if(t.hasOwnProperty("error"))return console.log("Error in opentripplanner: "+t.error.msg),void i(r);var a,o=e.Helpers.parseUrlParameters(r.url,"?","&","=");if(o.hasOwnProperty("fromPlace")){var s=o.fromPlace.split("%2C");(isNaN(+s[0])||isNaN(+s[1]))&&i(r),a=new L.LatLng(+s[0],+s[1])}var n=t;if(n.hasOwnProperty("features")){var c=new Date(Date.now());if(n.features.forEach(function(e){e.properties.seconds=e.properties.time,e.properties.time=1e3*e.properties.seconds,e.properties.arriveTime=new Date(c.getTime()+e.properties.time).toISOString(),e.properties.latlng=[a.lat,a.lng]}),r.hasOwnProperty("data")&&r.data.hasOwnProperty("features")){for(var l=0;l<r.data.features.length;l++){var p=r.data.features[l];p.properties.hasOwnProperty("latlng")&&p.properties.latlng[0]===a.lat&&p.properties.latlng[1]===a.lng&&r.data.features.splice(l--,1)}n.features.forEach(function(e){r.data.features.push(e)})}else r.count=0,r.data=n}else{var u=n.plan.from,d=n.plan.to;r.data={},r.data.type="FeatureCollection",r.data.features=[],n.plan.itineraries.forEach(function(t){var i=new L.Polyline([]),a=[],o=-1;t.legs.forEach(function(t){var r=L.Polyline.fromEncoded(t.legGeometry.points);r.getLatLngs().forEach(function(e){i.addLatLng(e)});var s={mode:t.mode,start:new Date(t.startTime).toISOString(),arrive:new Date(t.endTime).toISOString(),duration:e.Helpers.convertPropertyInfo({type:"duration"},1e3*+t.duration)};t.agencyName?s.agency=t.agencyName:null,t.routeShortName?s.route=t.routeShortName:null,t.routeLongName?s.routeName=t.routeLongName:null,"WALK"!==t.mode&&"BICYCLE"!==t.mode&&(o+=1),a.push(s)});var s=i.toGeoJSON();r.data.features.push(e.Helpers.GeoExtensions.createLineFeature(s.geometry.coordinates,{fromLoc:u.name,toLoc:d.name,duration:1e3*+t.duration,startTime:new Date(t.startTime).toISOString(),arriveTime:new Date(t.endTime).toISOString(),legs:a,transfers:o>=0?o:0}))})}i(r)},t}();t.GeoJsonSource=r;var i=function(t){function r(e,r,i){t.call(this,e,r,i),this.service=e,this.title="editablegeojson"}return __extends(r,t),r.prototype.updateFeatureByProperty=function(e,t,r,i){var a=this;void 0===i&&(i=null);var o={};"newsfeed"===i.id&&(o={titleKey:"Name",descriptionKey:"news_title",dateKey:"news_date"});try{var s=i.data.features;if(null==s)return;var n=!1;if(s.some(function(s){return s.hasOwnProperty(e)&&s[e]===t?(s.properties=r.properties,s.geometry=r.geometry,a.service.updateFeature(s),n=!0,a.service.project.eventTab?a.service.$messageBusService.publish("eventtab","updated",{feature:s,config:o}):i.showFeatureNotifications&&a.service.$messageBusService.notify(i.title,s.properties.Name+" updated"),!0):!1}),!n)if(i&&i.data&&i.data.features){i.data.features.push(r),this.service.initFeature(r,i,!1);this.service.activeMapRenderer.addFeature(r);this.service.project.eventTab?this.service.$messageBusService.publish("eventtab","added",{feature:r,config:o}):i.showFeatureNotifications&&this.service.$messageBusService.notify(i.title,r.properties.Name+" added")}else{s.push(r),this.service.initFeature(r,i);this.service.activeMapRenderer.addFeature(r);this.service.project.eventTab?this.service.$messageBusService.publish("eventtab","added",{feature:r,config:o}):i.showFeatureNotifications&&this.service.$messageBusService.notify(i.title,r.properties.Name+" added")}}catch(c){console.log("error")}},r.prototype.deleteFeatureByProperty=function(e,t,r,i){try{var a=this.service.findFeature(i,t);a&&(i.showFeatureNotifications&&this.service.$messageBusService.notify(i.title,a.properties.Name+" removed"),this.service.removeFeature(a,!1))}catch(o){console.log("error")}},r.prototype.addLayer=function(e,t,r){void 0===r&&(r=null),e.isEditable=!0,this.baseAddLayer(e,function(e){t(e)},r)},r.prototype.removeLayer=function(e){e.isConnected=!1,e._gui.editing&&this.service.stopEditingLayer(e)},r.prototype.layerMenuOptions=function(e){var t=this,r=[["Fit map",function(r){return t.fitMap(e)}]];return e.hasSensorData&&e.timestamps&&r.push(["Fit time",function(r){return t.fitTimeline(e)}]),r.push(null),r.push(["Refresh",function(r){return t.refreshLayer(e)}]),r},r.prototype.startEditing=function(e){this.service.project.groups.forEach(function(t){var r=!1;t.layers.forEach(function(t){t===e?(r=!0,t._gui.editing=!0):delete t._gui.editing}),t._gui.editing=r}),this.service.editing=!0,this.initAvailableFeatureTypesEditing(e)},r.prototype.stopEditing=function(e){this.service.stopEditingLayer(e)},r.prototype.initAvailableFeatureTypesEditing=function(t){var r={};if(t._gui.featureTypes=r,t&&t.typeUrl&&this.service.typesResources.hasOwnProperty(t.typeUrl))for(var i in this.service.typesResources[t.typeUrl].featureTypes){var a=this.service.typesResources[t.typeUrl].featureTypes[i];a.style.drawingMode||(a.style.drawingMode="Point"),r[i]=this.service.typesResources[t.typeUrl].featureTypes[i],r[i].u=e.Helpers.getImageUri(i),r[i]._guid=e.Helpers.getGuid()}},r}(r);t.EditableGeoJsonSource=i;var a=function(e){function r(t,r,i){e.call(this,t,r,i),this.service=t}return __extends(r,e),r.prototype.addLayer=function(t,r,i){void 0===i&&(i=null),t.isDynamic=!0,e.prototype.addLayer.call(this,t,r,i),t.enabled&&this.initSubscriptions(t)},r.prototype.removeLayer=function(t){e.prototype.removeLayer.call(this,t),this.service.$messageBusService.serverUnsubscribe(t.serverHandle)},r.prototype.initSubscriptions=function(e){var r=this;e.serverHandle=this.service.$messageBusService.serverSubscribe(e.id,"layer",function(i,a){switch(console.log("action:"+a.action),a.action){case"unsubscribed":r.service.$rootScope.$apply(function(){e.isConnected=!1});break;case"subscribed":e.isConnected=!0;break;case"msg":var o=a.data;o.hasOwnProperty("message")&&r.service.$messageBusService.notify(e.title,o.message);break;case"layer":if(null!=a.data){try{var s=a.data;switch(s.action){case t.LayerUpdateAction.updateLog:var n=s.featureId,c=s.item,l=e.data.features;l.forEach(function(e){if(e.id===n){e.logs||(e.logs={});for(var t in c)e.logs.hasOwnProperty(t)||(e.logs[t]=[]),c[t].forEach(function(r){return e.logs[t].push(r)});return r.service.$rootScope.$apply(function(){r.service.updateLog(e)}),!0}return!1});break;case t.LayerUpdateAction.updateFeature:var p=s.item;e.id===s.layerId&&r.service.$rootScope.$apply(function(){r.updateFeatureByProperty("id",p.id,p,e)});break;case t.LayerUpdateAction.addUpdateFeatureBatch:var u=s.item;e.id===s.layerId&&u&&u.length>0&&r.service.$rootScope.$apply(function(){u.forEach(function(i){switch(i.type){case t.ChangeType.Create:case t.ChangeType.Update:r.updateFeatureByProperty("id",i.id,i.value,e);break;case t.ChangeType.Delete:r.deleteFeatureByProperty("id",i.id,i.value,e)}})});break;case t.LayerUpdateAction.deleteFeature:var d=r.service.findFeature(e,s.featureId);d&&(e.showFeatureNotifications&&r.service.$messageBusService.notify(e.title,d.properties.Name+" removed"),r.service.removeFeature(d,!1))}}catch(h){console.warn("Error updating feature: "+JSON.stringify(h,null,2))}r.service.$messageBusService.publish("layer","updated",e)}}})},r}(i);t.DynamicGeoJsonSource=a;var o=function(t){function r(e,r,i){t.call(this,e,r,i),this.service=e,this.title="esrijson"}return __extends(r,t),r.prototype.addLayer=function(t,r){var i=this;t.renderType="geojson",t.isLoading=!0;var a=t.useProxy?"/api/proxy":t.url;this.$http({url:a,method:"GET",params:{url:t.url}}).success(function(r){"string"==typeof r&&(r=JSON.parse(r));var a=new esriJsonConverter.esriJsonConverter,o=a.toGeoJson(r);t.data=o,t.data.geometries&&!t.data.features&&(t.data.features=t.data.geometries),t.dataSourceParameters&&t.dataSourceParameters.convertFromRD&&e.Helpers.GeoExtensions.convertRDFeaturesToWGS84(t.data.features),t.data.features.forEach(function(e){i.service.initFeature(e,t,!1,!1)}),t.timeAware&&i.service.$messageBusService.publish("timeline","updateFeatures")}).error(function(e){console.log("EsriJsonSource called $HTTP with errors: "+e)})["finally"](function(){t.isLoading=!1,r(t)})},r}(r);t.EsriJsonSource=o}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(t){function r(e,r,i){t.call(this,e,r,i),this.service=e,this.title="grid"}return __extends(r,t),r.prototype.addLayer=function(t,r){var i=this;if(this.layer=t,"undefined"==typeof t.dataSourceParameters)throw new Error("Undefined IGridData data property in GridDataSource.");this.gridParams=t.dataSourceParameters,this.gridParams.useContour?this.convertDataToFeatureCollection=this.convertDataToIsoLines:this.convertDataToFeatureCollection=this.convertDataToPolygonGrid,t.isLoading=!0,$.get(t.url,function(a,o){async.series([function(r){if(t.count=0,"undefined"!=typeof i.gridParams.gridType&&"esri"===i.gridParams.gridType&&i.convertEsriHeaderToGridParams(a),"gridlayer"===t.renderType)return t.data=i.convertDataToGrid(a,i.gridParams),t.isLoading=!1,void r(null,null);var o=i.convertDataToFeatureCollection(a,i.gridParams);if(o.fc.features.length>1e4&&console.warn("Grid is very big! Number of features: "+o.fc.features.length),0===o.fc.features.length)return i.service.$messageBusService.notify("Warning","Data loaded successfully, but all points are outside the specified range.",e.Services.NotifyLocation.TopRight,e.Services.NotifyType.Error),t.isLoading=!1,void r(null,null);t.data=o.fc,t.data.geometries&&!t.data.features&&(t.data.features=t.data.geometries);t.data.features.length-1;t.data.features.forEach(function(e){i.service.initFeature(e,t,!1,!1)}),t.isLoading=!1,r(null,null)},function(){r(t)}])}).fail(function(e){t.isLoading=!1,i.service.$messageBusService.notify("ERROR loading "+t.title,"\nwhile loading: "+e.statusText),i.service.$messageBusService.publish("layer","error"),console.log("Failed loading layer "+t.title+" due to "+JSON.stringify(e)+".")})},r.prototype.convertEsriHeaderToGridParams=function(t){var r=this,i=/(\S*)\s*([\d-.]*)/,a=this.getData(t);if(a){var o,s,n=a.split("\n",6),c=!1;switch(this.gridParams.skipLines=0,n.forEach(function(e){var t=e.match(i);if(3===t.length){r.gridParams.skipLines++;var a=+t[2];switch(t[1].toLowerCase()){case"ncols":r.gridParams.columns=a;break;case"nrows":r.gridParams.rows=a;break;case"xllcorner":o=a;break;case"yllcorner":s=a;break;case"xllcenter":o=a,c=!0;break;case"yllcenter":s=a,c=!0;break;case"cellsize":r.gridParams.deltaLon=a,r.gridParams.deltaLat=-a;break;case"nodata_value":r.gridParams.noDataValue=a}}}),c?(this.gridParams.startLon=o,this.gridParams.startLat=s):(this.gridParams.startLon=o+this.gridParams.deltaLon/2,this.gridParams.startLat=s-this.gridParams.deltaLat/2),this.gridParams.projection||"wgs84"){case"rd":case"RD":var l=e.Helpers.GeoExtensions.convertRDToWGS84(this.gridParams.startLon,this.gridParams.startLat-(this.gridParams.rows-1)*this.gridParams.deltaLat),p=e.Helpers.GeoExtensions.convertRDToWGS84(this.gridParams.startLon+(this.gridParams.columns-1)*this.gridParams.deltaLon,this.gridParams.startLat);this.gridParams.deltaLon=(p.longitude-l.longitude)/(this.gridParams.columns-1),this.gridParams.deltaLat=(p.latitude-l.latitude)/(this.gridParams.rows-1),this.gridParams.startLon=l.longitude,this.gridParams.startLat=l.latitude;break;case"WGS84":case"wgs84":this.gridParams.startLat-=(this.gridParams.rows-1)*this.gridParams.deltaLat;break;default:throw new Error("Current projection is not supported!")}}},r.prototype.getData=function(e){return"string"==typeof e?e:e.hasOwnProperty("data")&&"string"==typeof e.data?e.data:(console.log("GridDataSource error: could not read grid data!"),"")},r.prototype.convertDataToGrid=function(e,t){var r=this.getData(e);if(r){var i=("undefined"!=typeof t.propertyName?t.propertyName:"v","undefined"!=typeof t.noDataValue?t.noDataValue:-9999,t.skipLinesAfterComment),a=t.skipSpacesFromLine,o=t.skipFirstRow||!1,s=t.skipFirstColumn||!1,n=t.separatorCharacter||" ",c=new RegExp("[^"+n+"]+","g"),l=(t.deltaLon,t.deltaLat,t.startLat,t.startLon,"undefined"!=typeof t.maxThreshold?t.maxThreshold:Number.MAX_VALUE),p="undefined"!=typeof t.minThreshold?t.minThreshold:-Number.MAX_VALUE,u=r.split("\n"),d=0,h=[];t.skipLines&&u.splice(0,t.skipLines);var f=t.rows||Number.MAX_VALUE;return u.forEach(function(e){if(t.commentCharacter&&e.substr(0,1)===t.commentCharacter)return void console.log(e);if(i&&i>0)return void i--;if(o)return void(o=!1);if(f--,0>f)return h;var r;r=a?e.substr(a).match(c):e.match(c),s&&r.length>1&&(r=r.splice(1)),!r||!t.skipFirstColumn&&r.length<t.columns||(h[d]=[],r.forEach(function(e){return h[d].push(+e)}),d++)}),t.maxThreshold=l,t.minThreshold=p,h}},r.prototype.convertDataToIsoLines=function(t,r){var i=this.convertDataToGrid(t,r),a=r.propertyName||"v",o=[],s=[],n=r.startLat,c=r.startLon,l=r.deltaLat,p=r.deltaLon,u=r.maxThreshold,d=r.minThreshold;i.forEach(function(e){s.push(n),n+=l}),i[0].forEach(function(e){o.push(c),c+=p,c>180&&(c-=360)});var h,f,y=[],m=new e.Helpers.Conrec;if("undefined"==typeof r.contourLevels)h=10;else{var g=r.contourLevels;"number"==typeof g?h=g:(f=g,h=g.length)}if("undefined"==typeof f){f=[];for(var v=(u-d)/h,S=d+v/2;u>S;S+=v)f.push(Math.round(10*S)/10)}m.contour(i,0,i.length-1,0,i[0].length-1,s,o,h,f,r.noDataValue||-9999);var b=m.contourList;b.forEach(function(e){var t={};t[a]=e.level;var r={type:"Feature",geometry:{type:"Polygon"},properties:t},i=[];r.geometry.coordinates=[i],e.forEach(function(e){i.push([e.y,e.x])}),y.push(r)});var $="# Number of features above the threshold: "+y.length+".\r\n";return{fc:e.Helpers.GeoExtensions.createFeatureCollection(y),desc:$}},r.prototype.convertDataToPolygonGrid=function(t,r){var i=r.propertyName||"v",a=this.convertDataToGrid(t,r),o=r.startLat,s=r.deltaLat,n=r.deltaLon,c=r.noDataValue,l=r.minThreshold||-Number.MAX_VALUE,p=r.maxThreshold||Number.MAX_VALUE,u=[];a.forEach(function(t){var a=r.startLon;t.forEach(function(t){var r=+t;if(r!==c&&r>=l&&p>=r){var d={};d[i]=r;var h=[a,o+s],f=[a+n,o+s],y=[a,o],m=[a+n,o],g=e.Helpers.GeoExtensions.createPolygonFeature([[h,f,m,y,h]],d);u.push(g)}a+=n,a>180&&(a-=360)}),o+=s});var d="# Number of features above the threshold: "+u.length+".\r\n";return{fc:e.Helpers.GeoExtensions.createFeatureCollection(u),desc:d}},r}(e.Services.GeoJsonSource);t.GridDataSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){"use strict";var t=function(){function e(e){this.service=e,this.title="heatmap",this.requiresLayer=!0,this.heatmapModel=new Heatmap.HeatmapModel("ProjectHeatmap")}return e.prototype.refreshLayer=function(e){this.generateHeatmap(e)},e.prototype.layerMenuOptions=function(e){return null},e.prototype.addLayer=function(e,t,r){var i=this;void 0===r&&(r=null),async.series([function(t){if(e.renderType="heatmap",e.isLoading=!0,e.quickRefresh&&e.quickRefresh===!0){if(i.heatmapModel.deserialize(e),i.heatmapModel.id=e.id,i.heatmapModel.updateWeights(),e.heatmapItems){var r={};i.heatmapModel.heatmapItems.forEach(function(e){r[e.toString()]=e.weight});var a=i.heatmapModel.heatmapSettings.intensityScale/3*(i.heatmapModel.heatmapSettings.intensityScale/3);i.service.project.features.forEach(function(e){if(e.properties.hasOwnProperty("intensities")&&e.properties.hasOwnProperty("contributors")){var t=JSON.parse(e.properties.intensities),o=0;for(var s in t)t.hasOwnProperty(s)&&(o+=t[s]*r[s]*a);e.properties.totalIntensity=o,i.service.calculateFeatureStyle(e),i.service.activeMapRenderer.updateFeature(e)}})}}else i.generateHeatmap(e),e.enabled=!0,i.enableProjectLayer(e);e.isLoading=!1,t(null,null)},function(){t(e)}])},e.prototype.removeLayer=function(e){delete this.heatmapModel,this.heatmapModel=new Heatmap.HeatmapModel("ProjectHeatmap"),e.enabled=!1,e.data=JSON,this.enableProjectLayer(e)},e.prototype.enableProjectLayer=function(e){e.id&&this.service.project.groups.forEach(function(t){t.layers.forEach(function(t){t.id===e.id&&(t.enabled=e.enabled,t.enabled===!1&&(e.data=JSON))})})},e.prototype.getRequiredLayers=function(e){var t=this,r=[];return e.heatmapSettings&&e.heatmapSettings.referenceList&&e.heatmapSettings.referenceList.forEach(function(e){t.service.project.groups.forEach(function(t){t.layers.forEach(function(t){t.reference===e&&r.push(t)})})}),r},e.prototype.getFeatureTypes=function(e){var t=[];return e.heatmapItems.forEach(function(e){t.push(e.featureType.name)}),t},e.prototype.generateHeatmap=function(e){var t=this;console.log("Generating heatmap");var r=L.geoJson([]);this.heatmapModel.deserialize(e),this.heatmapModel.id=e.id;var i=this.service.$mapService.getMap().getZoom();if(!(i<this.heatmapModel.heatmapSettings.minZoom||i>this.heatmapModel.heatmapSettings.maxZoom)){this.heatmapModel.updateWeights(),this.heatmapModel.calculate(this.service,this.service.$mapService,r);var a=(new Date).getTime();if(e.data=r.toGeoJSON(),e.data&&e.data.features&&(e.data.features.forEach(function(r){t.service.initFeature(r,e,!1,!1),t.service.activeMapRenderer.addFeature(r)}),e.data.features[0])){var o=new FeatureProps.CallOutProperty("totalIntensity","0","totalIntensity",!0,!0,!0,e.data.features[0],!1,!1),s={};s.count=e.data.features.length,s.max=1,s.min=-1,s.userMax=s.max,s.userMin=s.min,s.mean=0,s.varience=.67,s.sd=Math.sqrt(s.varience),this.service.setStyle(o,!1,s)}var n=(new Date).getTime();console.log("Init and style features in "+(n-a).toFixed(1)+" ms")}},e}();e.HeatmapSource=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){"use strict";var r=function(){function t(e,t){this.service=e,this.title="hierarchy",this.requiresLayer=!0,this.$http=t}return t.prototype.refreshLayer=function(e){this.service.removeLayer(e),this.service.addLayer(e)},t.prototype.addLayer=function(e,t,r){void 0===r&&(r=null),this.baseAddLayer(e,t)},t.prototype.fitMap=function(t){var r=e.Helpers.GeoExtensions.getBoundingBox(this.layer.data);this.service.$messageBusService.publish("map","setextent",r)},t.prototype.layerMenuOptions=function(e){var t=this;return[["Fit map",function(r){return t.fitMap(e)}],null,["Refresh",function(r){return t.refreshLayer(e)}]]},t.prototype.getRequiredLayers=function(e){var t=this,r=[];return e.hierarchySettings&&e.hierarchySettings.referenceList&&e.hierarchySettings.referenceList.forEach(function(e){t.service.project.groups.forEach(function(t){t.layers.forEach(function(t){t.reference==e&&r.push(t)})})}),r},t.prototype.baseAddLayer=function(t,r){var i=this;this.layer=t,async.series([function(r){t.renderType="geojson",t.isLoading=!0,i.$http.get(t.url).success(function(a){if(t.count=0,t.isLoading=!1,"topojson"===t.type.toLowerCase()&&(a=e.Helpers.GeoExtensions.convertTopoToGeoJson(a)),a.featureTypes)for(var o in a.featureTypes)if(a.featureTypes.hasOwnProperty(o)){var s=a.featureTypes[o];o=t.id+"_"+o,
i.service._featureTypes[o]=s}a.timestamps&&(t.timestamps=a.timestamps),t.data=a,t.data.geometries&&!t.data.features&&(t.data.features=t.data.geometries),t.data.features.forEach(function(e){i.service.initFeature(e,t,!1,!1)}),i.service.$messageBusService.publish("timeline","updateFeatures"),r(null,null)}).error(function(){t.count=0,t.isLoading=!1,i.service.$messageBusService.notify("ERROR loading "+t.title,"\nwhile loading: "+t.url),i.service.$messageBusService.publish("layer","error",t),r(null,null)})},function(){r(t)}])},t.prototype.removeLayer=function(e){},t}();t.HierarchySource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(e){function t(t,r,i){e.call(this,t,r,i),this.service=t,this.title="kml"}return __extends(t,e),t.prototype.get=function(e,t){return e.getElementsByTagName(t)},t.prototype.attr=function(e,t){return e.getAttribute(t)},t.prototype.addLayer=function(e,t){var r=this;this.layer=e,e.renderType="geojson",e.isLoading=!0,$.ajax(e.url).done(function(i){switch(e.count=0,e.isLoading=!1,e.type.toLowerCase()){case"kml":r.convertKmlToGeoJSON(e,i);break;case"gpx":r.convertGpxToGeoJSON(e,i)}t(e)}).fail(function(i){e.isLoading=!1,r.service.$messageBusService.notify("ERROR loading "+e.title,i),r.service.$messageBusService.publish("layer","error",e),t(e)})},t.prototype.convertGpxToGeoJSON=function(e,t){var r=toGeoJSON.gpx(t);this.initLayer(r,e)},t.prototype.convertKmlToGeoJSON=function(e,t){for(var r=this,i=toGeoJSON.kml(t),a={},o=this.get(t,"Style"),s=this.get(t,"StyleMap"),n=0;n<o.length;n++)a["#"+this.attr(o[n],"id")]=o[n];for(var n=0;n<s.length;n++){var c=s[n],l=this.get(c,"Pair");if(l)for(var p=0;p<l.length;p++){var u=l[p],d=this.get(u,"key");if(d&&0!==d.length&&"normal"===d[0].childNodes[0].nodeValue){var h=this.get(u,"styleUrl");if(h&&h.length>0){var f="#"+this.attr(c,"id"),y=h[0].childNodes[0].nodeValue;a[f]=a[y]}break}}}i.features.forEach(function(t){if(t.properties.hasOwnProperty("styleUrl")){var i=t.properties.styleUrl,o=e.typeUrl+i;if(t.properties.featureTypeId=i.substring(1),delete t.properties.styleUrl,delete t.properties.styleHash,!r.service._featureTypes.hasOwnProperty(o)){var s=a[i];r.service._featureTypes[o]={name:o,showAllProperties:!1,style:{fillColor:r.getFillColor(s),strokeColor:r.getLineColor(s),strokeWidth:r.getLineWidth(s),stroke:!0,iconUri:r.getIcon(e,s)}}}}}),this.initLayer(i,e)},t.prototype.getIcon=function(e,t){try{var r=t.getElementsByTagName("href")[0].childNodes[0].nodeValue;return r.match(/^http/i)?r:e.url.substr(0,e.url.lastIndexOf("/")+1)+r}catch(i){return""}},t.prototype.getLineColor=function(e){try{return"#"+e.getElementsByTagName("LineStyle")[0].getElementsByTagName("color")[0].childNodes[0].nodeValue}catch(t){return"#000000"}},t.prototype.getLineWidth=function(e){try{return+e.getElementsByTagName("LineStyle")[0].getElementsByTagName("width")[0].childNodes[0].nodeValue}catch(t){return 1}},t.prototype.getFillColor=function(e){try{return"#"+e.getElementsByTagName("PolyStyle")[0].getElementsByTagName("color")[0].childNodes[0].nodeValue}catch(t){return"#ff0000"}},t}(e.Services.GeoJsonSource);t.KmlDataSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(r){function i(e,t){r.call(this,e,t),this.service=e,this.title="mapboxvectortile",this.requiresLayer=!1,this.tileCount=-1,this.cache={},this.cachedUrls=[]}return __extends(i,r),i.prototype.addLayer=function(t,r){var i=this;t.renderType="mvtlayer",t.isLoading=!0,t.data={},t.data.features=[];var a=this.service.$mapService.map.getZoom(),o=e.Helpers.GeoExtensions.slippyMapTiles(a,this.service.$mapService.map.getBounds());this.tileCount=o.width*o.height;for(var s=o.left;s<=o.right;s++)for(var n=o.top;n<=o.bottom;n++){var c=t.url.replace("{z}/{x}/{y}",a+"/"+s+"/"+n);this.cache.hasOwnProperty(c)?(this.addFeatures(t,this.cache[c],!0),this.checkIfFinished(t,r)):this.$http.get(c).then(function(a){var o;if(a.data.hasOwnProperty("objects")){if(!a.data.objects.hasOwnProperty("vectile"))for(var s in a.data.objects)a.data.objects[s].geometries.forEach(function(e){e.properties.featureTypeId=s});o=e.Helpers.GeoExtensions.convertTopoToGeoJson(a.data)}else o=a.data;i.addToCache(a.config.url,o),i.addFeatures(t,o),i.checkIfFinished(t,r)},function(e){console.log("VectorTileSource error: "+e),i.checkIfFinished(t,r)})}},i.prototype.addToCache=function(e,r){if(this.cache[e]=r,this.cachedUrls.push(e),!(this.cachedUrls.length<t.VectorTileSource.CACHE_SIZE)){var i=this.cachedUrls.pop();delete this.cache[i]}},i.prototype.checkIfFinished=function(e,t){this.tileCount--,this.tileCount<=0&&(e.isLoading=!1,t(e))},i.prototype.addFeatures=function(e,t,r){void 0===r&&(r=!1)},i.prototype.removeLayer=function(e){var t=this.service.findLayer(e.id);t&&(t.enabled=!1),e.data.features={}},i.CACHE_SIZE=99,i}(t.GeoJsonSource);t.MapboxVectorTileSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};L.Terminator=L.Polygon.extend({options:{color:"#00",opacity:.5,fillColor:"#00",fillOpacity:.5,resolution:2,showNight:!0},initialize:function(e){this.version="0.1.0",this._R2D=180/Math.PI,this._D2R=Math.PI/180,L.Util.setOptions(this,e);var t=this._compute(this.options.showNight,this.options.time||null);this.setLatLngs(t)},setTime:function(e){this.options.time=e;var t=this._compute(this.options.showNight,e||null);this.setLatLngs(t)},_sunEclipticPosition:function(e){var t=e-2451545,r=280.46+.9856474*t;r%=360;var i=357.528+.9856003*t;i%=360;var a=r+1.915*Math.sin(i*this._D2R)+.02*Math.sin(2*i*this._D2R),o=1.00014-.01671*Math.cos(i*this._D2R)-.0014*Math.cos(2*i*this._D2R);return{lambda:a,R:o}},_eclipticObliquity:function(e){var t=e-2451545,r=t/36525,i=23.43929111-r*(46.836769/3600-r*(1831e-7/3600+r*(5.565e-7-r*(1.6e-10-4.34e-8*r/3600))));return i},_sunEquatorialPosition:function(e,t){var r=Math.atan(Math.cos(t*this._D2R)*Math.tan(e*this._D2R))*this._R2D,i=Math.asin(Math.sin(t*this._D2R)*Math.sin(e*this._D2R))*this._R2D,a=90*Math.floor(e/90),o=90*Math.floor(r/90);return r+=a-o,{alpha:r,delta:i}},_hourAngle:function(e,t,r){var i=r+e/15;return 15*i-t.alpha},_latitude:function(e,t){var r=Math.atan(-Math.cos(e*this._D2R)/Math.tan(t.delta*this._D2R))*this._R2D;return r},_compute:function(e,t){if(null==t)var r=new Date;else var r=new Date(t);for(var i,a,o=r.getJulian(),s=r.getGMST(),n=[],c=this._sunEclipticPosition(o),l=this._eclipticObliquity(o),p=this._sunEquatorialPosition(c.lambda,l),u=0;u<=720*this.options.resolution;u++){var d=-360+u/this.options.resolution;i=this._hourAngle(d,p,s),a=this._latitude(i,p),n[u+1]=[a,d]}return e?p.delta<0?(n[0]=[90,-360],n[n.length]=[90,360]):(n[0]=[-90,-360],n[n.length]=[-90,360]):p.delta<0?(n[0]=[-90,-360],n[n.length]=[-90,360]):(n[0]=[90,-360],n[n.length]=[90,360]),n}});var csComp;!function(e){var t;!function(t){"use strict";var r=function(t){function r(e,r,i){t.call(this,e,r,i),this.service=e,this.title="Day Night regions on the Earth"}return __extends(r,t),r.prototype.addLayer=function(e,t){var r=this;this.layer=e,e.isLoading=!0,e.count=0;var i=0;e.url?this.$http.get(e.url).success(function(a){i=parseFloat(a.toString()),r.continueInit(i,e,t)}).error(function(){console.log("Error reading day/night intensity file"),r.continueInit(i,e,t)}):this.continueInit(i,e,t)},r.prototype.continueInit=function(t,r,i){var a=this,o=!0,s="Night",n="Day";if("undefined"!=typeof r.dataSourceParameters){var c=r.dataSourceParameters;"undefined"!=typeof c.showNight&&(o=c.showNight),"undefined"!=typeof c.nightName&&(s=c.nightName),"undefined"!=typeof c.dayName&&(n=c.dayName),"undefined"!=typeof c.value&&(t=c.value)}var l=new L.Terminator({showNight:o}),p=l.toGeoJSON();o?(p.properties.Name=s,p.properties.night_intensity=t):(p.properties.Name=n,p.properties.day_intensity=t);var u=[];u.push({type:"Feature",geometry:p.geometry,properties:p.properties}),r.data=e.Helpers.GeoExtensions.createFeatureCollection(u),r.data.geometries&&!r.data.features&&(r.data.features=r.data.geometries),r.data.features.forEach(function(e){a.service.initFeature(e,r,!1,!1)}),r.isLoading=!1,i(r)},r}(e.Services.GeoJsonSource);t.NightDayDataSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(e){function t(t,r,i){e.call(this,t,r,i),this.service=t,this.title="RSS datasource"}return __extends(t,e),t.prototype.addLayer=function(e,t){var r=this;this.layer=e,e.type="geojson",e.isLoading=!0,e.count=0,this.$http({url:"/api/rss",method:"GET",params:{url:e.url}}).success(function(i){e.data=i,e.data.geometries&&!e.data.features&&(e.data.features=e.data.geometries),e.data.features.forEach(function(t){r.service.initFeature(t,e,!1,!1)}),r.service.$messageBusService.publish("timeline","updateFeatures"),e.isLoading=!1,t(e)}).error(function(){console.log("RssDataSource called $HTTP with errors...")})},t}(e.Services.GeoJsonSource);t.RssDataSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(t){var r=function(){function t(e){this.service=e,this.title="tilelayer",this.requiresLayer=!1,this.prevDateTimes={}}return t.prototype.refreshLayer=function(t){if(t.mapLayer.getLayers().length>0){var r=t.mapLayer.getLayers()[0],i=t.url;if(t.timeDependent){var a=this.service.project.timeLine.focus;if(t.timeResolution){var o=t.timeResolution;a=Math.floor(a/o)*o}var s=new Date(0);s.setUTCSeconds(a/1e3);var n=s.yyyymmdd(),c=s.getHours(),l=s.getMinutes(),p=s.getSeconds(),u=n+e.Utils.twoDigitStr(c)+e.Utils.twoDigitStr(l)+e.Utils.twoDigitStr(p);if(u===this.prevDateTimes[t.id])return;this.prevDateTimes[t.id]=u,i+="&time="+u}else t.disableCache&&(t.cacheKey=(new Date).getTime().toString(),i+="&cache="+t.cacheKey);r.setUrl(i)}},t.prototype.layerMenuOptions=function(e){var t=this;return[["Refresh",function(r){return t.refreshLayer(e)}]]},t.prototype.addLayer=function(e,t,r){void 0===r&&(r=null),e.renderType="tilelayer",t(e)},t.prototype.removeLayer=function(e){},t}();t.TileLayerSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},csComp;!function(e){var t;!function(t){var r=function(t){function r(e,r,i){t.call(this,e,r,i),this.service=e,this.title="vectortile",this.requiresLayer=!1,this.tileCount=-1,this.cache={},this.cachedUrls=[]}return __extends(r,t),r.prototype.addLayer=function(t,r){var i=this;t.renderType="geojson",t.isLoading=!0,t.data={},t.data.features=[];var a=this.service.$mapService.map.getZoom(),o=e.Helpers.GeoExtensions.slippyMapTiles(a,this.service.$mapService.map.getBounds());this.tileCount=o.width*o.height;for(var s=o.left;s<=o.right;s++)for(var n=o.top;n<=o.bottom;n++){var c=t.url.replace("{z}/{x}/{y}",a+"/"+s+"/"+n);this.cache.hasOwnProperty(c)?(this.addFeatures(t,this.cache[c],!0),this.checkIfFinished(t,r)):this.$http.get(c).then(function(a){var o;if(a.data.hasOwnProperty("objects")){if(!a.data.objects.hasOwnProperty("vectile"))for(var s in a.data.objects)a.data.objects[s].geometries.forEach(function(e){e.properties.featureTypeId=s});o=e.Helpers.GeoExtensions.convertTopoToGeoJson(a.data)}else o=a.data;i.addToCache(a.config.url,o),i.addFeatures(t,o),i.checkIfFinished(t,r)},function(e){console.log("VectorTileSource error: "+e),i.checkIfFinished(t,r)})}},r.prototype.addToCache=function(e,t){if(this.cache[e]=t,this.cachedUrls.push(e),!(this.cachedUrls.length<r.CACHE_SIZE)){var i=this.cachedUrls.pop();delete this.cache[i]}},r.prototype.checkIfFinished=function(e,t){this.tileCount--,this.tileCount<=0&&(e.isLoading=!1,t(e))},r.prototype.addFeatures=function(e,t,r){var i=this;if(void 0===r&&(r=!1),t.hasOwnProperty("features")){var a=t;a.features.forEach(function(t){r&&(t._isInitialized=!1),e.data.features.push(t),i.service.initFeature(t,e,!1,!1)})}else{var o=t;for(var s in o)o.hasOwnProperty(s)&&o[s].features.forEach(function(t){r&&(t._isInitialized=!1),t.properties.featureTypeId=s,e.data.features.push(t),i.service.initFeature(t,e,!1,!1)})}},r.prototype.removeLayer=function(e){var t=this.service.findLayer(e.id);t&&(t.enabled=!1),e.data.features={}},r.CACHE_SIZE=99,r}(t.GeoJsonSource);t.VectorTileSource=r}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));var csComp;!function(e){var t;!function(e){"use strict";var t=function(){function e(e){this.service=e,this.title="wms",this.requiresLayer=!1}return e.prototype.refreshLayer=function(e){},e.prototype.layerMenuOptions=function(e){return null},e.prototype.getUrl=function(e,t){var r=e.url;return e.timeDependent&&(t.setMinutes(5*Math.floor(t.getMinutes()/5)),r=e.url.replace(/time=?([^&]*)/g,"time="+moment(t).utc().format("YYYY-MM-DDTHH:mm:SS")+"Z")),e._gui.wmsurl=r,r},e.prototype.addLayer=function(e,t,r){var i=this;void 0===r&&(r=null);this.getUrl(e,this.service.project.timeLine.focusDate());e.timeDependent&&(this.delay=_.debounce(this.updateTime,250,!1),this.service.$messageBusService.subscribe("timeline",function(t,r){"focusChange"===t&&i.delay(e,r)}));var a=L.tileLayer.wms(e.url,{layers:e.wmsLayers,styles:"default",opacity:e.opacity/100,format:"image/png",transparent:!0,attribution:e.description});e.renderType="wms",e._gui.wms=a,t(e)},e.prototype.updateTime=function(e,t){if(e._gui.hasOwnProperty("wms")){var r=(e._gui.wms,this.getUrl(e,t));e._gui.wmsleaflet.setUrl(r),console.log(r)}},e.prototype.removeLayer=function(e){},e}();e.WmsSource=t}(t=e.Services||(e.Services={}))}(csComp||(csComp={}));